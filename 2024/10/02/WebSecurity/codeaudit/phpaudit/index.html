<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="PHP代码审计入门指南  https:&#x2F;&#x2F;www.yuque.com&#x2F;burpheart&#x2F;phpaudit&#x2F;PHP-Audit-Labs https:&#x2F;&#x2F;github.com&#x2F;hongriSec&#x2F;PHP-Audit-Labs?tab&#x3D;readme-ov-file PHP 用户可控输入   框架&#x2F;全局变量 获取URL参数（GET） 获取POST参数 获取上传文件 获取Cookie参数 获取">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计">
<meta property="og:url" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="PHP代码审计入门指南  https:&#x2F;&#x2F;www.yuque.com&#x2F;burpheart&#x2F;phpaudit&#x2F;PHP-Audit-Labs https:&#x2F;&#x2F;github.com&#x2F;hongriSec&#x2F;PHP-Audit-Labs?tab&#x3D;readme-ov-file PHP 用户可控输入   框架&#x2F;全局变量 获取URL参数（GET） 获取POST参数 获取上传文件 获取Cookie参数 获取">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-2.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-3.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-4.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-5.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-6.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-7.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-8.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-9.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-10.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-11.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-12.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-13.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-14.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-15.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-16.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-17.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-18.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-19.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-20.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-21.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-22.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-24.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-23.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-25.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-26.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-27.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-28.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-30.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-31.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-32.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-33.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-34.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-36.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-37.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-38.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-39.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-40.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-41.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-42.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-43.png">
<meta property="og:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image-44.png">
<meta property="article:published_time" content="2024-10-02T04:27:24.000Z">
<meta property="article:modified_time" content="2024-11-12T13:39:04.817Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/09/30/algorithm/hash/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&text=【代码审计】PHP代码审计"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&is_video=false&description=【代码审计】PHP代码审计"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计&body=Check out this article: https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&name=【代码审计】PHP代码审计&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&t=【代码审计】PHP代码审计"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E7%94%A8%E6%88%B7%E5%8F%AF%E6%8E%A7%E8%BE%93%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">PHP 用户可控输入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E6%95%8F%E6%84%9F%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">PHP 敏感函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">3.</span> <span class="toc-text">代码注入&#x2F;文件包含</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-LDAP%E6%B3%A8%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">SQL&#x2F;LDAP注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-SSRF"><span class="toc-number">5.</span> <span class="toc-text">文件读取&#x2F;SSRF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-%E5%86%99%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">文件上传&#x2F;写入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E5%8E%9F%E7%94%9F%E8%BF%87%E6%BB%A4%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">PHP原生过滤方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E9%98%B2%E6%8A%A4"><span class="toc-number">7.1.</span> <span class="toc-text">1. 命令注入防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SQL%E6%B3%A8%E5%85%A5%E9%98%B2%E6%8A%A4"><span class="toc-number">7.2.</span> <span class="toc-text">2. SQL注入防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-XSS%E9%98%B2%E6%8A%A4"><span class="toc-number">7.3.</span> <span class="toc-text">3. XSS防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B%E8%BF%87%E6%BB%A4"><span class="toc-number">7.4.</span> <span class="toc-text">4. 数字类型过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%85%B6%E4%BB%96%E9%98%B2%E6%8A%A4%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">7.5.</span> <span class="toc-text">5. 其他防护配置项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#in-array-%E7%BC%BA%E9%99%B7"><span class="toc-number">8.</span> <span class="toc-text">in_array() 缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">8.1.</span> <span class="toc-text">案例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E9%A2%98%E7%9B%AE"><span class="toc-number">8.2.</span> <span class="toc-text">作业题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Twig-%E8%BF%87%E6%BB%A4%E4%B8%8D%E5%85%85%E5%88%86"><span class="toc-number">9.</span> <span class="toc-text">Twig 过滤不充分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">9.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E9%A2%98%E7%9B%AE-1"><span class="toc-number">9.2.</span> <span class="toc-text">作业题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snow-Flake"><span class="toc-number">10.</span> <span class="toc-text">Snow Flake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">10.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">10.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#False-Beard"><span class="toc-number">11.</span> <span class="toc-text">False Beard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">11.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">11.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">11.3.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-02T04:27:24.000Z" class="dt-published" itemprop="datePublished">2024-10-02</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Code-Audit/">Code Audit</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>PHP代码审计入门指南  <a target="_blank" rel="noopener" href="https://www.yuque.com/burpheart/phpaudit/">https://www.yuque.com/burpheart/phpaudit/</a><br>PHP-Audit-Labs <a target="_blank" rel="noopener" href="https://github.com/hongriSec/PHP-Audit-Labs?tab=readme-ov-file">https://github.com/hongriSec/PHP-Audit-Labs?tab=readme-ov-file</a></p>
<h2 id="PHP-用户可控输入"><a href="#PHP-用户可控输入" class="headerlink" title="PHP 用户可控输入"></a>PHP 用户可控输入</h2><table>
<thead>
<tr>
<th>框架&#x2F;全局变量</th>
<th>获取URL参数（GET）</th>
<th>获取POST参数</th>
<th>获取上传文件</th>
<th>获取Cookie参数</th>
<th>获取服务器参数</th>
<th>获取请求体</th>
<th>获取JSON数据</th>
<th>文件上传方法</th>
</tr>
</thead>
<tbody><tr>
<td>PHP原生</td>
<td>$_GET</td>
<td>$_POST</td>
<td>$_FILES</td>
<td>$_COOKIE</td>
<td>$_SERVER</td>
<td>php:&#x2F;&#x2F;input</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>ThinkPHP5</td>
<td>Request::instance()-&gt;get(); input(‘get.’)</td>
<td>Request::instance()-&gt;post(); input(‘post.’)</td>
<td>Request::instance()-&gt;file();</td>
<td>Request::instance()-&gt;cookie(); input(‘cookie.’)</td>
<td>Request::instance()-&gt;server(); input(‘server.’)</td>
<td>Request::instance()-&gt;request(); input(‘request.’)</td>
<td>Request::instance()-&gt;get(); input(‘get.’);</td>
<td>$request-&gt;getJSON();</td>
</tr>
<tr>
<td>ThinkPHP3.*</td>
<td>I(‘get.’)</td>
<td>I(‘post.’)</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>Codeigniter2&#x2F;3</td>
<td>$this-&gt;input-&gt;get()</td>
<td>$this-&gt;input-&gt;post()</td>
<td>$this-&gt;input-&gt;file()</td>
<td>$this-&gt;input-&gt;cookie()</td>
<td>$this-&gt;input-&gt;server()</td>
<td>$this-&gt;input-&gt;post()</td>
<td>$this-&gt;input-&gt;raw_input_stream</td>
<td>无</td>
</tr>
<tr>
<td>Codeigniter4</td>
<td>$request-&gt;getGet()</td>
<td>$request-&gt;getPost()</td>
<td>$request-&gt;getFiles()</td>
<td>$request-&gt;getCookie()</td>
<td>$request-&gt;getServer()</td>
<td>$request-&gt;getPost(); $request-&gt;getJSON();</td>
<td>$request-&gt;getJSON()</td>
<td>$this-&gt;request-&gt;getFiles();</td>
</tr>
<tr>
<td>CakePHP 4.*</td>
<td>$this-&gt;request-&gt;getQuery(‘’);</td>
<td>$this-&gt;request-&gt;getData(‘’);</td>
<td>$this-&gt;request-&gt;getUploadedFile(‘’);</td>
<td>无</td>
<td>$this-&gt;request-&gt;getServer();</td>
<td>$this-&gt;request-&gt;getData(‘’);</td>
<td>$this-&gt;request-&gt;input(‘json_decode’);</td>
<td>无</td>
</tr>
<tr>
<td>Yii 2.0</td>
<td>$request-&gt;get();</td>
<td>$request-&gt;post();</td>
<td>$request-&gt;getBodyParam(‘’);</td>
<td>$request-&gt;getCookies();</td>
<td>$request-&gt;getHeaders();</td>
<td>$request-&gt;getBodyParam(‘’);</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>Laravel</td>
<td>$request-&gt;query(‘’);</td>
<td>$request-&gt;input(‘’);</td>
<td>$request-&gt;file(‘’);</td>
<td>$request-&gt;cookie(‘’);</td>
<td>无</td>
<td>$request-&gt;input(‘’);</td>
<td>$request-&gt;json();</td>
<td>$request-&gt;file(‘’);</td>
</tr>
</tbody></table>
<h2 id="PHP-敏感函数"><a href="#PHP-敏感函数" class="headerlink" title="PHP 敏感函数"></a>PHP 敏感函数</h2><table>
<thead>
<tr>
<th>函数&#x2F;语法</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>system</td>
<td>执行命令并输出结果</td>
<td>system(‘id’);</td>
</tr>
<tr>
<td>exec</td>
<td>执行命令 只可获取最后一行结果</td>
<td>exec(‘id’, $a); print_r($a);</td>
</tr>
<tr>
<td>passthru</td>
<td>同 system</td>
<td>passthru(‘id’);</td>
</tr>
<tr>
<td>shell_exec</td>
<td>执行命令并返回结果</td>
<td>$a&#x3D;shell_exec(‘id’); print_r($a);</td>
</tr>
<tr>
<td>&#96; (反引号)</td>
<td>执行命令并返回结果</td>
<td>$a&#x3D;<code>id</code>; print_r($a);</td>
</tr>
<tr>
<td>popen</td>
<td>执行命令并建立管道 返回一个指针 使用fread等函数操作指针进行读写</td>
<td>$a&#x3D;popen(“id”, “r”); echo fread($a, 2096);</td>
</tr>
<tr>
<td>proc_open</td>
<td>同 popen (进程控制功能更强大)</td>
<td>见PHP手册</td>
</tr>
<tr>
<td>pcntl_exec</td>
<td>执行命令 只返回是否发生错误</td>
<td>pcntl_exec(‘id’);</td>
</tr>
</tbody></table>
<h2 id="代码注入-文件包含"><a href="#代码注入-文件包含" class="headerlink" title="代码注入&#x2F;文件包含"></a>代码注入&#x2F;文件包含</h2><table>
<thead>
<tr>
<th>函数&#x2F;语法结构</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>eval</td>
<td>将传入的参数内容作为PHP代码执行，eval不是函数，是一种语法结构，不能当做函数动态调用</td>
<td><code>eval(&#39;phpinfo();&#39;);</code></td>
</tr>
<tr>
<td>assert</td>
<td>将传入的参数内容作为PHP代码执行，PHP7以下是函数，PHP7及以上为语法结构</td>
<td><code>assert(&#39;phpinfo();&#39;);</code></td>
</tr>
<tr>
<td>preg_replace</td>
<td>当<code>preg_replace</code>使用&#x2F;e修饰符且原字符串可控时，有可能执行PHP代码</td>
<td><code>echo preg_replace(&quot;/e&quot;,&quot;&#123;$&#123;PHPINFO()&#125;&#125;&quot;,&quot;123&quot;);</code></td>
</tr>
<tr>
<td>call_user_func</td>
<td>把第一个参数作为回调函数调用，两个参数都完全可控时可利用，传入一个参数调用</td>
<td><code>call_user_func(&#39;assert&#39;, &#39;phpinfo();&#39;);</code></td>
</tr>
<tr>
<td>call_user_func_array</td>
<td>同<code>call_user_func</code>，可传入一个数组带入多个参数调用函数</td>
<td><code>call_user_func_array(&#39;file_put_contents&#39;, [&#39;1.txt&#39;,&#39;6666&#39;]);</code></td>
</tr>
<tr>
<td>create_function</td>
<td>根据传递的参数创建匿名函数，并返回唯一名称，利用时第二个参数可控</td>
<td><code>$f = create_function(&#39;&#39;,&#39;system($_GET[123]);&#39;); $f();</code></td>
</tr>
<tr>
<td>include</td>
<td>包含并运行指定文件，执行出错会抛出错误</td>
<td><code>include &#39;vars.php&#39;;</code> (括号可有可无)</td>
</tr>
<tr>
<td>require</td>
<td>同<code>include</code>，执行出错会抛出警告</td>
<td><code>require(&#39;somefile.php&#39;);</code> (括号可有可无)</td>
</tr>
<tr>
<td>require_once</td>
<td>同<code>require</code>，但会检查之前是否已经包含该文件，确保不重复包含</td>
<td></td>
</tr>
<tr>
<td>include_once</td>
<td>同<code>include</code>，但会检查之前是否已经包含该文件，确保不重复包含</td>
<td></td>
</tr>
</tbody></table>
<h2 id="SQL-LDAP注入"><a href="#SQL-LDAP注入" class="headerlink" title="SQL&#x2F;LDAP注入"></a>SQL&#x2F;LDAP注入</h2><table>
<thead>
<tr>
<th>函数&#x2F;方法</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>mysql_query</code></td>
<td></td>
</tr>
<tr>
<td><code>odbc_exec</code></td>
<td></td>
</tr>
<tr>
<td><code>mysqli_query</code></td>
<td></td>
</tr>
<tr>
<td><code>mysql_db_query</code></td>
<td></td>
</tr>
<tr>
<td><code>mysql_unbuffered_query</code></td>
<td></td>
</tr>
<tr>
<td><code>mysqli::query</code></td>
<td>用法示例：<code>$mysqli = new mysqli(&quot;localhost&quot;, &quot;my_user&quot;, &quot;my_password&quot;, &quot;world&quot;); $mysqli-&gt;query();</code></td>
</tr>
<tr>
<td><code>pg_query</code></td>
<td></td>
</tr>
<tr>
<td><code>pg_query_params</code></td>
<td></td>
</tr>
<tr>
<td><code>pg_send_query</code></td>
<td></td>
</tr>
<tr>
<td><code>pg_send_query_params</code></td>
<td></td>
</tr>
<tr>
<td><code>sqlsrv_query</code></td>
<td></td>
</tr>
<tr>
<td><code>pdo::query</code></td>
<td>用法示例：<code>$pdo = new PDO(&quot;mysql:host=localhost;dbname=phpdemo&quot;, &quot;root&quot;, &quot;1234&quot;); $pdo-&gt;query($sql);</code></td>
</tr>
<tr>
<td><code>SQLite3::query</code></td>
<td></td>
</tr>
<tr>
<td><code>SQLite3::exec</code></td>
<td>用法示例：<code>$db = new SQLite3(&#39;mysqlitedb.db&#39;); $db-&gt;query(&#39;SELECT bar FROM foo&#39;); $db-&gt;exec(&#39;CREATE TABLE bar (bar STRING)&#39;);</code></td>
</tr>
<tr>
<td><code>$mongo = new mongoclient(); $data = $coll-&gt;find($data);</code></td>
<td>参考：<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Mongodb%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB.html">MongoDB注入攻击</a></td>
</tr>
<tr>
<td><code>$ld = ldap_connect(&quot;localhost&quot;); $lb = @ldap_bind($ld, &quot;cn=test,dc=test,dc=com&quot;, &quot;test&quot;);</code></td>
<td>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/0nc3/p/12063436.html">LDAP注入攻击</a></td>
</tr>
<tr>
<td><code>Db::query</code></td>
<td>ThinkPHP框架</td>
</tr>
<tr>
<td><code>Db::execute</code></td>
<td>ThinkPHP框架</td>
</tr>
</tbody></table>
<h2 id="文件读取-SSRF"><a href="#文件读取-SSRF" class="headerlink" title="文件读取&#x2F;SSRF"></a>文件读取&#x2F;SSRF</h2><table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><code>file_get_contents</code></td>
<td>读入文件并返回字符串</td>
<td><code>echo file_get_contents(&quot;flag.txt&quot;);</code> <br> <code>echo file_get_contents(&quot;https://www.bilibili.com/&quot;);</code></td>
</tr>
<tr>
<td><code>curl_setopt</code>, <code>curl_exec</code></td>
<td>Curl访问URL获取信息</td>
<td><code>function curl($url)&#123; $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_exec($ch); curl_close($ch); &#125; $url = $_GET[&#39;url&#39;]; curl($url);</code></td>
</tr>
<tr>
<td><code>fsockopen</code></td>
<td>打开一个套接字连接（远程TCP&#x2F;UDP&#x2F;raw）</td>
<td><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.fsockopen.php">fsockopen函数说明</a></td>
</tr>
<tr>
<td><code>readfile</code></td>
<td>读取文件并写入输出缓冲区</td>
<td>类似于<code>file_get_contents</code>，读取文件流</td>
</tr>
<tr>
<td><code>fopen</code>, <code>fread</code>, <code>fgets</code>, etc.</td>
<td>打开文件或URL并读取文件流</td>
<td><code>$file = fopen(&quot;test.txt&quot;,&quot;r&quot;); echo fread($file,&quot;1234&quot;); fclose($file);</code></td>
</tr>
<tr>
<td><code>file</code></td>
<td>将整个文件读入数组</td>
<td><code>echo implode(&#39;&#39;, file(&#39;https://www.bilibili.com/&#39;));</code></td>
</tr>
<tr>
<td><code>highlight_file</code>, <code>show_source</code></td>
<td>语法高亮显示文件内容</td>
<td><code>highlight_file(&quot;1.php&quot;);</code></td>
</tr>
<tr>
<td><code>parse_ini_file</code></td>
<td>读取并解析一个ini配置文件</td>
<td><code>print_r(parse_ini_file(&#39;1.ini&#39;));</code></td>
</tr>
<tr>
<td><code>simplexml_load_file</code></td>
<td>将文件读取并作为XML文档解析</td>
<td><code>simplexml_load_file(&#39;test.xml&#39;);</code></td>
</tr>
<tr>
<td><strong><code>stream_socket_client</code></strong></td>
<td>打开一个基于流的套接字连接，用于更灵活的网络通信</td>
<td><code>$fp = stream_socket_client(&quot;tcp://example.com:80&quot;, $errno, $errstr, 30);</code></td>
</tr>
<tr>
<td><strong><code>get_headers</code></strong></td>
<td>获取HTTP请求头信息</td>
<td><code>print_r(get_headers(&quot;https://www.example.com&quot;));</code></td>
</tr>
<tr>
<td><strong><code>file_put_contents</code></strong></td>
<td>将字符串写入文件</td>
<td><code>file_put_contents(&quot;test.txt&quot;, &quot;data to write&quot;);</code></td>
</tr>
<tr>
<td><strong><code>copy</code></strong></td>
<td>拷贝文件到另一个位置</td>
<td><code>copy(&quot;source.txt&quot;, &quot;destination.txt&quot;);</code></td>
</tr>
<tr>
<td><strong><code>move_uploaded_file</code></strong></td>
<td>将上传的文件移动到新位置</td>
<td><code>move_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;], &quot;upload_dir/&quot;.$_FILES[&#39;file&#39;][&#39;name&#39;]);</code></td>
</tr>
<tr>
<td><strong><code>parse_url</code></strong></td>
<td>解析URL并返回其组成部分</td>
<td><code>$url_components = parse_url(&quot;http://www.example.com/path?query=string&quot;);</code></td>
</tr>
<tr>
<td><strong><code>stream_context_create</code></strong></td>
<td>创建并设置流上下文用于文件或网络连接</td>
<td><code>$context = stream_context_create([&#39;http&#39; =&gt; [&#39;method&#39; =&gt; &#39;GET&#39;]]); file_get_contents(&quot;https://www.example.com&quot;, false, $context);</code></td>
</tr>
</tbody></table>
<p>补充：</p>
<ul>
<li>**<code>stream_socket_client</code>**：比<code>fsockopen</code>更加灵活，用于创建各种类型的网络连接（如TCP、UDP）。</li>
<li>**<code>get_headers</code>**：可以获取指定URL的HTTP响应头。</li>
<li>**<code>file_put_contents</code>**：可以写入文件，功能类似于<code>fopen</code>+<code>fwrite</code>，但更简便。</li>
<li>**<code>copy</code>**：可以直接将文件从一个路径复制到另一个路径。</li>
<li>**<code>move_uploaded_file</code>**：处理文件上传时使用，用于将临时文件移动到指定目录。</li>
<li>**<code>parse_url</code>**：用于解析URL，返回其组成部分，例如协议、主机名、路径等。</li>
<li>**<code>stream_context_create</code>**：用于为文件读取&#x2F;写入创建和设置流上下文，比如可以设置HTTP请求头。</li>
</ul>
<h2 id="文件上传-写入"><a href="#文件上传-写入" class="headerlink" title="文件上传&#x2F;写入"></a>文件上传&#x2F;写入</h2><table>
<thead>
<tr>
<th>函数&#x2F;方法</th>
<th>描述</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><code>file_put_contents</code></td>
<td>将一个字符串写入文件</td>
<td><code>file_put_contents(&quot;1.txt&quot;, &quot;6666&quot;);</code></td>
</tr>
<tr>
<td><code>move_uploaded_file</code></td>
<td>将上传的临时文件移动到新的位置</td>
<td><code>move_uploaded_file($_FILES[&quot;pictures&quot;][&quot;tmp_name&quot;], &quot;1.php&quot;);</code></td>
</tr>
<tr>
<td><code>rename</code></td>
<td>重命名文件&#x2F;目录</td>
<td><code>rename($oldname, $newname);</code></td>
</tr>
<tr>
<td><code>rmdir</code></td>
<td>删除目录</td>
<td><code>rmdir(&quot;directory_name&quot;);</code></td>
</tr>
<tr>
<td><code>mkdir</code></td>
<td>创建目录</td>
<td><code>mkdir(&quot;new_directory&quot;);</code></td>
</tr>
<tr>
<td><code>unlink</code></td>
<td>删除文件</td>
<td><code>unlink(&quot;file.txt&quot;);</code></td>
</tr>
<tr>
<td><code>copy</code></td>
<td>复制文件</td>
<td><code>copy(&quot;source.txt&quot;, &quot;destination.txt&quot;);</code></td>
</tr>
<tr>
<td><code>fopen</code>, <code>fputs</code>, <code>fwrite</code></td>
<td>打开文件或URL</td>
<td><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.fwrite.php">fwrite官方文档</a></td>
</tr>
<tr>
<td><code>link</code></td>
<td>创建文件硬链接</td>
<td><code>link($target, $link);</code></td>
</tr>
<tr>
<td><code>symlink</code></td>
<td>创建符号链接（软链接）</td>
<td><code>symlink($target, $link);</code></td>
</tr>
<tr>
<td><code>tmpfile</code></td>
<td>创建一个临时文件（在临时目录存放，随机文件名，返回句柄）</td>
<td><code>$temp = tmpfile(); fwrite($temp, &quot;123456&quot;); fclose($temp);</code></td>
</tr>
<tr>
<td><code>request()-&gt;file()-&gt;move()</code></td>
<td>ThinkPHP文件上传</td>
<td><code>$file = request()-&gt;file($name); $file-&gt;move($filepath);</code></td>
</tr>
<tr>
<td><code>request()-&gt;file()-&gt;file()</code></td>
<td>ThinkPHP文件上传</td>
<td><code>$file = request()-&gt;file(&#39;upload&#39;);</code></td>
</tr>
<tr>
<td><code>extractTo</code></td>
<td>解压ZIP到目录</td>
<td><code>$zip-&gt;extractTo(&#39;path/to/extract&#39;);</code></td>
</tr>
<tr>
<td><code>DOMDocument loadXML simplexml_import_dom</code></td>
<td>加载解析XML，可能存在XXE漏洞，通过<code>file_get_contents</code>获取客户端输入并加载XML内容</td>
<td><code>&lt;?php $xmlfile = file_get_contents(&#39;php://input&#39;); $dom = new DOMDocument(); $dom-&gt;loadXML($xmlfile); ?&gt;</code></td>
</tr>
<tr>
<td><code>simplexml_load_string</code></td>
<td>加载解析XML字符串，可能存在XXE漏洞</td>
<td><code>$xml = simplexml_load_string($_REQUEST[&#39;xml&#39;]); print_r($xml);</code></td>
</tr>
<tr>
<td><code>simplexml_load_file</code></td>
<td>读取文件并作为XML文档解析，可能存在XXE漏洞</td>
<td><code>simplexml_load_file(&#39;file.xml&#39;);</code></td>
</tr>
<tr>
<td><code>unserialize</code></td>
<td>反序列化对象</td>
<td><code>$data = unserialize($_POST[&#39;data&#39;]);</code></td>
</tr>
<tr>
<td><strong><code>fgetcsv</code></strong></td>
<td>读取并解析CSV格式的行</td>
<td><code>$handle = fopen(&quot;data.csv&quot;, &quot;r&quot;); while (($data = fgetcsv($handle)) !== FALSE) &#123; print_r($data); &#125; fclose($handle);</code></td>
</tr>
<tr>
<td><strong><code>file_exists</code></strong></td>
<td>检查文件或目录是否存在</td>
<td><code>if (file_exists(&quot;file.txt&quot;)) &#123; echo &quot;File exists&quot;; &#125;</code></td>
</tr>
<tr>
<td><strong><code>is_readable</code></strong></td>
<td>判断文件是否可读</td>
<td><code>if (is_readable(&quot;file.txt&quot;)) &#123; echo &quot;File is readable&quot;; &#125;</code></td>
</tr>
<tr>
<td><strong><code>is_writable</code></strong></td>
<td>判断文件是否可写</td>
<td><code>if (is_writable(&quot;file.txt&quot;)) &#123; echo &quot;File is writable&quot;; &#125;</code></td>
</tr>
<tr>
<td><strong><code>flock</code></strong></td>
<td>锁定文件防止并发读写</td>
<td><code>$fp = fopen(&quot;file.txt&quot;, &quot;r+&quot;); if (flock($fp, LOCK_EX)) &#123; fwrite($fp, &quot;Lock test&quot;); flock($fp, LOCK_UN); &#125; fclose($fp);</code></td>
</tr>
<tr>
<td><strong><code>readlink</code></strong></td>
<td>返回符号链接指向的目标</td>
<td><code>echo readlink(&quot;/path/to/symlink&quot;);</code></td>
</tr>
<tr>
<td><strong><code>realpath</code></strong></td>
<td>返回文件或目录的绝对路径</td>
<td><code>echo realpath(&quot;test.txt&quot;);</code></td>
</tr>
<tr>
<td><strong><code>chmod</code></strong></td>
<td>改变文件或目录的权限</td>
<td><code>chmod(&quot;file.txt&quot;, 0755);</code></td>
</tr>
<tr>
<td><strong><code>chown</code></strong></td>
<td>改变文件的所有者</td>
<td><code>chown(&quot;file.txt&quot;, &quot;username&quot;);</code></td>
</tr>
</tbody></table>
<h2 id="PHP原生过滤方法"><a href="#PHP原生过滤方法" class="headerlink" title="PHP原生过滤方法"></a>PHP原生过滤方法</h2><h3 id="1-命令注入防护"><a href="#1-命令注入防护" class="headerlink" title="1. 命令注入防护"></a>1. <strong>命令注入防护</strong></h3><ul>
<li><strong><code>escapeshellarg</code></strong><ul>
<li><strong>描述</strong>：将传入的参数添加单引号并转义原有的单引号，主要用于防止命令注入。处理后的字符串可安全地作为命令参数。</li>
<li><strong>例子</strong>：传入<code>id</code>后处理为<code>&#39;id&#39;</code>。如果传入<code>&#39;id #</code>，处理后为<code>&#39;\&#39;id #&#39;</code>，防止命令注入。</li>
<li><strong>用法</strong>：<code>escapeshellarg($arg);</code></li>
</ul>
</li>
<li><strong><code>escapeshellcmd</code></strong><ul>
<li><strong>描述</strong>：转义字符串中的特殊符号，用于防止命令注入。反斜线会在以下字符之前插入：<code>&amp;#;</code>|*?~&lt;&gt;^()[]{}$, \x0A 和 \xFF。’ 和 “ 仅在不配对时被转义。</li>
<li><strong>例子</strong>：<code>escapeshellcmd(&#39;ls; rm -rf /&#39;)</code>将转义命令中的特殊字符，避免命令注入。</li>
<li><strong>用法</strong>：<code>escapeshellcmd($cmd);</code></li>
</ul>
</li>
</ul>
<h3 id="2-SQL注入防护"><a href="#2-SQL注入防护" class="headerlink" title="2. SQL注入防护"></a>2. <strong>SQL注入防护</strong></h3><ul>
<li><strong><code>addslashes</code></strong><ul>
<li><strong>描述</strong>：在单引号（’）、双引号（”）、反斜线（\）与 NUL 前加上反斜线，用于防止SQL注入。</li>
<li><strong>例子</strong>：<code>addslashes(&quot;O&#39;Reilly&quot;)</code>返回<code>O\&#39;Reilly</code>，可以减少SQL注入风险。</li>
<li><strong>用法</strong>：<code>addslashes($input);</code></li>
</ul>
</li>
<li><strong><code>mysqli::real_escape_string</code> &#x2F; <code>mysqli_real_escape_string</code></strong><ul>
<li><strong>描述</strong>：这些函数在 NULL (<code>\x00</code>), 换行符 (<code>\n</code>), 回车符 (<code>\r</code>), 空格字符 (<code>\x1a</code>), 单引号 (<code>&#39;</code>), 双引号 (<code>&quot;</code>) 和反斜线 (<code>\</code>) 前加上反斜线，并考虑到当前数据库连接的字符集。用于防止SQL注入。</li>
<li><strong>注意</strong>：处理后的字符串需要使用引号包裹后拼接到SQL语句中，否则仍可导致SQL注入。</li>
<li><strong>例子</strong>：<code>$conn-&gt;real_escape_string($input);</code></li>
</ul>
</li>
<li><strong><code>PDO::quote</code></strong><ul>
<li><strong>描述</strong>：将字符串中的特殊字符进行转义，并为字符串添加引号。适用于防止SQL注入。</li>
<li><strong>例子</strong>：<code>$pdo-&gt;quote(&quot;O&#39;Reilly&quot;);</code> 返回 <code>&#39;O\&#39;Reilly&#39;</code></li>
<li><strong>用法</strong>：<code>$pdo-&gt;quote($input);</code></li>
</ul>
</li>
<li><strong><code>PDO::prepare</code></strong><ul>
<li><strong>描述</strong>：预处理SQL语句，确保参数传递时不会破坏SQL语句的结构，是防止SQL注入的最佳实践。</li>
<li><strong>例子</strong>：<code>$stmt = $pdo-&gt;prepare(&#39;SELECT * FROM users WHERE id = :id&#39;);</code></li>
<li><strong>用法</strong>：<code>$stmt-&gt;execute([&#39;:id&#39; =&gt; $id]);</code></li>
</ul>
</li>
</ul>
<h3 id="3-XSS防护"><a href="#3-XSS防护" class="headerlink" title="3. XSS防护"></a>3. <strong>XSS防护</strong></h3><ul>
<li><strong><code>htmlspecialchars</code></strong><ul>
<li><strong>描述</strong>：将特殊字符（如 <code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>, <code>&#39;</code>, <code>&quot;</code>）转义为HTML实体，防止恶意脚本通过HTML注入XSS攻击。</li>
<li><strong>例子</strong>：<code>htmlspecialchars(&#39;&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;&#39;)</code> 将输出 <code>&amp;lt;script&amp;gt;alert(&amp;quot;XSS&amp;quot;)&amp;lt;/script&amp;gt;</code></li>
<li><strong>用法</strong>：<code>htmlspecialchars($input, ENT_QUOTES, &#39;UTF-8&#39;);</code></li>
</ul>
</li>
<li><strong><code>htmlentities</code></strong><ul>
<li><strong>描述</strong>：将所有的适合的字符转义为HTML实体，与<code>htmlspecialchars</code>类似，但更加严格。</li>
<li><strong>例子</strong>：<code>htmlentities(&#39;&lt;b&gt;bold&lt;/b&gt;&#39;)</code> 返回 <code>&amp;lt;b&amp;gt;bold&amp;lt;/b&amp;gt;</code></li>
<li><strong>用法</strong>：<code>htmlentities($input, ENT_QUOTES, &#39;UTF-8&#39;);</code></li>
</ul>
</li>
</ul>
<h3 id="4-数字类型过滤"><a href="#4-数字类型过滤" class="headerlink" title="4. 数字类型过滤"></a>4. <strong>数字类型过滤</strong></h3><ul>
<li><strong><code>intval</code> &#x2F; <code>floatval</code> &#x2F; <code>(int)</code> &#x2F; <code>num+0</code></strong><ul>
<li><strong>描述</strong>：将输入强制转换为整数或浮点数。通常用于确保输入为数字，防止SQL注入或逻辑漏洞。</li>
<li><strong>例子</strong>：<ul>
<li><code>intval(&#39;42abc&#39;)</code> 返回 <code>42</code></li>
<li><code>floatval(&#39;42.42abc&#39;)</code> 返回 <code>42.42</code></li>
<li><code>(int) &#39;123abc&#39;</code> 返回 <code>123</code></li>
</ul>
</li>
<li><strong>用法</strong>：<code>intval($input);</code> 或 <code>(int)$input;</code></li>
</ul>
</li>
</ul>
<h3 id="5-其他防护配置项"><a href="#5-其他防护配置项" class="headerlink" title="5. 其他防护配置项"></a>5. <strong>其他防护配置项</strong></h3><ul>
<li><strong>配置防止命令注入</strong>：<ul>
<li><strong>禁用危险函数</strong>：通过PHP的配置文件<code>php.ini</code>，可以禁用危险函数如<code>system()</code>、<code>exec()</code>、<code>shell_exec()</code>等。</li>
<li><strong>配置</strong>：<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">disable_functions</span> = <span class="string">&quot;exec, passthru, shell_exec, system, proc_open, popen, curl_exec&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>限制文件操作</strong>：可以通过<code>open_basedir</code>限制PHP对特定目录的访问，防止通过路径注入或文件包含漏洞来执行恶意文件。</li>
<li><strong>配置</strong>：<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">open_basedir</span> = <span class="string">&quot;/var/www/html:/tmp&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="in-array-缺陷"><a href="#in-array-缺陷" class="headerlink" title="in_array() 缺陷"></a>in_array() 缺陷</h2><p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image.png"><br>分析上面的代码流程，是一个文件上传的接口，但是对文件名有白名单，利用了<code>in_array()</code>方法，这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">in_array ：(PHP 4, PHP 5, PHP 7)</span><br><span class="line">功能 ：检查数组中是否存在某个值</span><br><span class="line">定义 ： bool in_array ( mixed $needle , array $haystack [, bool $strict = FALSE ] )</span><br><span class="line">在 $haystack 中搜索 $needle ，如果第三个参数 $strict 的值为 TRUE ，则 in_array() 函数会进行强检查，检查 $needle 的类型是否和 $haystack 中的相同。如果找到 $haystack ，则返回 TRUE，否则返回 FALSE。</span><br></pre></td></tr></table></figure>
<p>由于该函数并未将第三个参数设置为 true ，这导致攻击者可以通过构造的文件名来绕过服务端的检测，例如文件名为 7shell.php 。因为PHP在使用 in_array() 函数判断时，会将 7shell.php 强制转换成数字7，而数字7在 range(1,24) 数组中，最终绕过 in_array() 函数判断，导致任意文件上传漏洞。（这里之所以会发生强制类型转换，是因为目标数组中的元素为数字类型）我们来看看PHP手册对 in_array() 函数的定义。</p>
<h3 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h3><p>下面看一个具体的真实案例：piwigo2.7.1 版本。该版本由于SQL语句直接拼接 $rate 变量，而 $rate 变量也仅是用 in_array() 函数简单处理，并未使用第三个参数进行严格匹配，最终导致sql注入漏洞发生。下面我们来看看具体的漏洞位置。漏洞的入口文件在<code>picture.php</code>文件中，<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-1.png"><br>当 <code>$_GET[&#39;action&#39;]</code> 为 rate 的时候，就会调用文件 include&#x2F;functions_rate.inc.php 中的 rate_picture 方法，而漏洞便存在这个方法中。我们可以看到下图第23行处直接拼接 $rate 变量，而在第2行使用 in_array() 函数对 $rate 变量进行检测，判断 $rate 是否在 <code>$conf[&#39;rate_items&#39;]</code> 中， <code>$conf[&#39;rate_items&#39;]</code> 的内容可以在 include\config_default.inc.php 中找到，为 <code>$conf[&#39;rate_items&#39;] = array(0,1,2,3,4,5)</code>;<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-2.png"><br>由于这里（上图第6行）并没有将 in_array() 函数的第三个参数设置为 true ，所以会进行弱比较，可以绕过。比如我们将 $rate 的值设置成 <code>1,1 and if(ascii(substr((select database()),1,1))=112,1,sleep(3)));#</code> 那么SQL语句就变成：<br><code>INSERT INTO piwigo_rate (user_id,anonymous_id,element_id,rate,date) VALUES (2,&#39;192.168.2&#39;,1,1,1 and if(ascii(substr((select database()),1,1))=112,1,sleep(3)));#,NOW()) ;</code><br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-3.png" alt="流程可以简化为此图"><br>可以看到这个漏洞的原因是弱类型比较问题，那么我们就可以使用强匹配进行修复。例如将 in_array() 函数的第三个参数设置为 true ，或者使用 intval() 函数将变量强转成数字，又或者使用正则匹配来处理变量。这里我将 in_array() 函数的第三个参数设置为 true ，代码及防护效果如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-4.png"></p>
<h3 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h3><p>审计下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;连接失败: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT COUNT(*) FROM users&quot;</span>;</span><br><span class="line"><span class="variable">$whitelist</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">    <span class="variable">$whitelist</span> = <span class="title function_ invoke__">range</span>(<span class="number">1</span>, <span class="variable">$row</span>[<span class="string">&#x27;COUNT(*)&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="title function_ invoke__">stop_hack</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM users WHERE id=<span class="subst">$id</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$id</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;id <span class="subst">$id</span> is not in whitelist.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;center&gt;&lt;table border=&#x27;1&#x27;&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$row</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;tr&gt;&lt;td&gt;&lt;center&gt;<span class="subst">$key</span>&lt;/center&gt;&lt;/td&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;td&gt;&lt;center&gt;<span class="subst">$value</span>&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/table&gt;&lt;/center&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$conn</span>-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;fire&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;fire&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;day1&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stop_hack</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$pattern</span> = <span class="string">&quot;insert|delete|or|concat|concat_ws|group_concat|join|floor|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex|file_put_contents|fwrite|curl|system|eval&quot;</span>;</span><br><span class="line">	<span class="variable">$back_list</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;|&quot;</span>,<span class="variable">$pattern</span>);</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$back_list</span> <span class="keyword">as</span> <span class="variable">$hack</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/<span class="subst">$hack</span>/i&quot;</span>, <span class="variable">$value</span>))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;<span class="subst">$hack</span> detected!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>题目可以看出，首先需要绕过in_array之后由于sql语句过滤，需要考虑绕过。前者加个数字就好，后者可以用 updatexml 注入。当 updatexml 中存在特殊字符或字母时，会出现报错，报错信息为特殊字符、字母及之后的内容，也就是说如果我们想要查询的数据是数字开头，例如 7701HongRi ，那么查询结果只会显示 HongRi 。所以我们会看到很多 updatexml 注入的 payload 是长这样的 and updatexml(1,concat(0x7e,(SELECT user()),0x7e),1) ,在所要查询的数据前面凭借一个特殊符号(这里的 0x7e 为符号 ‘<del>‘ )。使用下面的payload可以获得题解：<br>&#96;<a target="_blank" rel="noopener" href="http://localhost/index.php?id=4">http://localhost/index.php?id=4</a> and (select updatexml(1,make_set(3,’</del>‘,(select flag from flag)),1))&#96;</p>
<h2 id="Twig-过滤不充分"><a href="#Twig-过滤不充分" class="headerlink" title="Twig 过滤不充分"></a>Twig 过滤不充分</h2><p>题目叫做Twig，代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-5.png"><br><strong>漏洞解析</strong> ：<br>这一关题目实际上用的是PHP的一个模板引擎 <a target="_blank" rel="noopener" href="https://twig.symfony.com/">Twig</a> ，本题考察XSS(跨站脚本攻击)漏洞。虽然题目代码分别用了 <strong>escape</strong> 和 <strong>filter_var</strong> 两个过滤方法，但是还是可以被攻击者绕过。在上图 <strong>第8行</strong> 中，程序使用 <a target="_blank" rel="noopener" href="https://twig.symfony.com/">Twig</a> 模板引擎定义的 <strong>escape</strong> 过滤器来过滤link，而实际上这里的 <strong>escape</strong> 过滤器，是用PHP内置函数 <strong>htmlspecialchars</strong> 来实现的，具体可以点击 <a target="_blank" rel="noopener" href="https://twig.symfony.com/doc/2.x/filters/escape.html">这里</a> 了解 <strong>escape</strong> 过滤器， <strong>htmlspecialchars</strong> 函数定义如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.htmlspecialchars.php"> <strong>htmlspecialchars</strong> </a> ：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：将特殊字符转换为 HTML 实体</p>
<p><strong>定义</strong> ：string <strong>htmlspecialchars</strong> ( string <code>$string</code> [, int <code>$flags</code> &#x3D; ENT_COMPAT | ENT_HTML401 [, string<code>$encoding</code> &#x3D; ini_get(“default_charset”) [, bool <code>$double_encode</code> &#x3D; <strong>TRUE</strong> ]]] )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp; (&amp; 符号)  ===============  &amp;amp;</span><br><span class="line"><span class="string">&quot; (双引号)  ===============  &amp;quot;</span></span><br><span class="line"><span class="string">&#x27; (单引号)  ===============  &amp;apos;</span></span><br><span class="line"><span class="string">&lt; (小于号)  ===============  &amp;lt;</span></span><br><span class="line"><span class="string">&gt; (大于号)  ===============  &amp;gt;</span></span><br></pre></td></tr></table></figure>
<p>第二处过滤在 <strong>第17行</strong> ，这里用了 <strong>filter_var</strong> 函数来过滤 <strong>nextSlide</strong> 变量，且用了 <strong>FILTER_VALIDATE_URL</strong> 过滤器来判断是否是一个合法的url，具体的 <strong>filter_var</strong> 定义如下：<br><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.filter-var.php"> <strong>filter_var</strong> </a>： (PHP 5 &gt;&#x3D; 5.2.0, PHP 7)</p>
<p><strong>功能</strong> ：使用特定的过滤器过滤一个变量</p>
<p><strong>定义</strong> ：<a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.pseudo-types.php#language.types.mixed">mixed</a> <strong>filter_var</strong> ( <a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.pseudo-types.php#language.types.mixed">mixed</a> <code>$variable</code> [, int <code>$filter</code> &#x3D; FILTER_DEFAULT [, <a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.pseudo-types.php#language.types.mixed">mixed</a> <code>$options</code> ]] )<br><strong>函数原型</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">mixed</span> <span class="title function_ invoke__">filter_var</span> ( <span class="keyword">mixed</span> <span class="variable">$variable</span> [, <span class="keyword">int</span> <span class="variable">$filter</span> = FILTER_DEFAULT [, <span class="keyword">mixed</span> <span class="variable">$options</span> ]] )</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>$variable</strong>: 要过滤的变量。</li>
<li><strong>$filter</strong>: 用于过滤的过滤器 ID。如果不提供，默认为 <code>FILTER_DEFAULT</code>。</li>
<li><strong>$options</strong>: 一个关联数组或单一的标志，指定额外的过滤器选项和标志。<br>常用的过滤器选项<br>PHP 提供了多种过滤器，可以分为两类：验证过滤器和清理过滤器。验证过滤器用于验证数据格式，如果数据无效，则返回 <code>false</code>；清理过滤器用于清理数据，如去除非法字符等。<br>验证过滤器</li>
<li><strong>FILTER_VALIDATE_BOOLEAN</strong>: 验证布尔值。</li>
<li><strong>FILTER_VALIDATE_EMAIL</strong>: 验证电子邮件地址。</li>
<li><strong>FILTER_VALIDATE_FLOAT</strong>: 验证浮点数。</li>
<li><strong>FILTER_VALIDATE_INT</strong>: 验证整数。</li>
<li><strong>FILTER_VALIDATE_IP</strong>: 验证 IP 地址。</li>
<li><strong>FILTER_VALIDATE_URL</strong>: 验证 URL。</li>
</ul>
<p>清理过滤器</p>
<ul>
<li><strong>FILTER_SANITIZE_EMAIL</strong>: 清理电子邮件地址（去除所有除字母、数字以及<code>!#$%&amp;&#39;*+-/=?^_</code>{|}~@.[]&#96;之外的字符）。</li>
<li><strong>FILTER_SANITIZE_NUMBER_INT</strong>: 清理整数（去除所有除数字、加号、减号之外的字符）。</li>
<li><strong>FILTER_SANITIZE_SPECIAL_CHARS</strong>: 将特殊字符转换为 HTML 实体。</li>
<li><strong>FILTER_SANITIZE_STRING</strong>: 去除标签并去除或编码特殊字符。</li>
</ul>
<p>验证电子邮件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="variable">$email</span> = <span class="string">&quot;user@example.com&quot;</span>;</span><br><span class="line">&gt;<span class="keyword">if</span> (<span class="title function_ invoke__">filter_var</span>(<span class="variable">$email</span>, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;This (<span class="subst">&#123;$email&#125;</span>) is a valid email address.&quot;</span>;</span><br><span class="line">&gt;&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;This (<span class="subst">&#123;$email&#125;</span>) is not a valid email address.&quot;</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<p>清理字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="variable">$string</span> = <span class="string">&quot;&lt;h1&gt;Hello, World!&lt;/h1&gt;&quot;</span>;</span><br><span class="line">&gt;<span class="variable">$sanitized_string</span> = <span class="title function_ invoke__">filter_var</span>(<span class="variable">$string</span>, FILTER_SANITIZE_STRING);</span><br><span class="line">&gt;<span class="keyword">echo</span> <span class="variable">$sanitized_string</span>; <span class="comment">// 输出: Hello, World!</span></span><br></pre></td></tr></table></figure>
<p>使用选项和标志<br><code>filter_var()</code> 还可以使用第三个参数 <code>$options</code> 来提供额外的指令，比如在验证整数时设置最小和最大值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">   <span class="string">&quot;options&quot;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">       <span class="string">&quot;min_range&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">       <span class="string">&quot;max_range&quot;</span> =&gt; <span class="number">100</span></span><br><span class="line">   )</span><br><span class="line">&gt;);</span><br><span class="line">&gt;<span class="variable">$number</span> = <span class="number">50</span>;</span><br><span class="line">&gt;<span class="keyword">if</span> (<span class="title function_ invoke__">filter_var</span>(<span class="variable">$number</span>, FILTER_VALIDATE_INT, <span class="variable">$options</span>)) &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;The number is within the accepted range.&quot;</span>;</span><br><span class="line">&gt;&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;The number is not within the accepted range.&quot;</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>针对这两处的过滤，我们可以考虑使用 <strong>javascript伪协议</strong> 来绕过。为了让大家更好理解，请看下面的demo代码：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-6.png"></p>
<p>我们使用 <strong>payload</strong> ：<code>?nextSlide=javascript://comment％250aalert(1)</code> ，可以执行 <strong>alert</strong> 函数：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-7.png"><br>实际上，这里的 <strong>&#x2F;&#x2F;</strong> 在JavaScript中表示单行注释，所以后面的内容均为注释，那为什么会执行 <strong>alert</strong> 函数呢？那是因为我们这里用了字符 <strong>%0a</strong> ，该字符为换行符，所以 <strong>alert</strong> 语句与注释符 <strong>&#x2F;&#x2F;</strong> 就不在同一行，就能执行。当然，这里我们要对 <strong>%</strong> 百分号编码成 <strong>%25</strong> ，因为程序将浏览器发来的payload：<code>javascript://comment％250aalert(1)</code> 先解码成： <code>javascript://comment%0aalert(1)</code> 存储在变量 <strong>$url</strong> 中（上图第二行代码），然后用户点击a标签链接就会触发 <strong>alert</strong> 函数。</p>
<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong>Anchor 0.9.2</strong> 版本，在该版本中，当用户访问一个不存在的URL链接时，程序会调用404模板，而这个模板则存在XSS漏洞，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-8.png"><br>该代码在 <strong>themes\default\404.php</strong> 中，看第4行 <strong>code</strong> 标签中的 <strong>current_url</strong> 函数，我们可在 <strong>anchor\functions\helpers.php</strong> 文件中，看到 <strong>current_url</strong> 函数是由 <strong>Uri</strong> 类的  <strong>current</strong> 方法实现的，具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">current_url</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">Uri</span>::<span class="title function_ invoke__">current</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进到 <strong>Uri</strong> 类，在 <strong>system\uri.php</strong> 文件中，我们发现这里调用了 <strong>static::detect</strong> 方法( <strong>statci::</strong> 是在PHP5.3版本之后引入的延迟静态绑定写法)。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-9.png"></p>
<p>在 <strong>current</strong> 方法下面，我们就可以找到 <strong>detect</strong> 方法，该方法会获取 <strong>$_SERVER</strong> 数组中的 <strong>‘REQUEST_URI’ 、’PATH_INFO’, 、’ORIG_PATH_INFO’</strong> 三个键的值(下图第3-4行代码)，如果存在其中的某一个键，并且符合 <strong>filter_var($uri, FILTER_SANITIZE_URL)</strong> 和 <strong>parse_url($uri, PHP_URL_PATH)</strong> ，则直接将 <strong>$uri</strong> 传入 <strong>static::format</strong> 方法，下图第10-14行代码，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-10.png"><br>我们跟进 <strong>static::format</strong> 方法，可以发现程序过滤了三次(下图第3-7行)，但是都没有针对XSS攻击进行过滤，只是为了获取用户访问的文件名，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-11.png"><br>由于没有针对XSS攻击进行过滤，导致攻击十分容易，我们来看看XSS攻击具体是如何进行的。<br><strong>漏洞利用</strong><br>我们构造payload如下：  <code>http://localhost/anchor/index.php/&lt;script&gt;alert(&#39;www.sec-redclub.com&#39;)&lt;/script&gt;</code> 。根据上面的分析，当我们访问这个并不存在的链接时，程序会调用404模板页面，然后调用 <strong>current_url</strong> 函数来获取当前用户访问的文件名，也就是最后一个 <strong>&#x2F;</strong> 符号后面的内容，所以最终payload里的 <code>&lt;script&gt;alert(&#39;www.sec-redclub.com&#39;)&lt;/script&gt;</code> 部分会嵌入到 <code>&lt;code&gt;</code> 标签中，造成XSS攻击<br><strong>修复建议</strong><br>这对XSS漏洞，我们最好就是过滤关键词，将特殊字符进行HTML实体编码替换，这里给出的修复代码为Dedecms中防御XSS的方法，可以在 <strong>uploads&#x2F;include&#x2F;helpers&#x2F;filter.helper.php</strong> 路径下找到对应代码，具体防护代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-12.png"></p>
<h3 id="作业题目-1"><a href="#作业题目-1" class="headerlink" title="作业题目"></a>作业题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$url</span>) &amp;&amp; <span class="title function_ invoke__">filter_var</span>(<span class="variable">$url</span>, FILTER_VALIDATE_URL))&#123;</span><br><span class="line">    <span class="variable">$site_info</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sec-redclub.com$/&#x27;</span>,<span class="variable">$site_info</span>[<span class="string">&#x27;host&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;curl &quot;&#x27;</span>.<span class="variable">$site_info</span>[<span class="string">&#x27;host&#x27;</span>].<span class="string">&#x27;&quot;&#x27;</span>, <span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;center&gt;&lt;h1&gt;You have curl <span class="subst">&#123;$site_info[&#x27;host&#x27;]&#125;</span> successfully!&lt;/h1&gt;&lt;/center&gt;</span></span><br><span class="line"><span class="string">              &lt;center&gt;&lt;textarea rows=&#x27;20&#x27; cols=&#x27;90&#x27;&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>, <span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;&lt;center&gt;&lt;h1&gt;Error: Host not allowed&lt;/h1&gt;&lt;/center&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;center&gt;&lt;h1&gt;Just curl sec-redclub.com!&lt;/h1&gt;&lt;/center&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">          &lt;center&gt;&lt;h3&gt;For example:?url=http://sec-redclub.com&lt;/h3&gt;&lt;/center&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出来只需要绕过两个部分，第一个是 filter_var 的过滤，第二个是 preg_match 对 url 的判断，是否是以sec-redclub.com结尾。对于filter_var可以用下面的方式绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/index.php?url=http://demo.com@sec-redclub.com</span><br><span class="line">http://localhost/index.php?url=http://demo.com&amp;sec-redclub.com</span><br><span class="line">http://localhost/index.php?url=http://demo.com?sec-redclub.com</span><br><span class="line">http://localhost/index.php?url=http://demo.com/sec-redclub.com</span><br><span class="line">http://localhost/index.php?url=demo://demo.com,sec-redclub.com</span><br><span class="line">http://localhost/index.php?url=demo://demo.com:80;sec-redclub.com:80/</span><br><span class="line">http://localhost/index.php?url=http://demo.com#sec-redclub.com</span><br><span class="line">PS:最后一个payload的#符号，请换成对应的url编码 %23</span><br></pre></td></tr></table></figure>
<p>接着要绕过 parse_url 函数，并且满足 <code>$site_info[&#39;host&#39;]</code> 的值以 sec-redclub.com 结尾，payload如下：<br><code>http://localhost/index.php?url=demo://%22;ls;%23;sec-redclub.com:80/</code><br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-13.png"><br>当我们直接用 cat f1agi3hEre.php 命令的时候，过不了 filter_var 函数检测，因为包含空格，具体payload如下：<br><code>http://localhost/index.php?url=demo://%22;cat%20f1agi3hEre.php;%23;sec-redclub.com:80/</code><br>所以我们可以换成 <code>cat&lt;f1agi3hEre.php</code>命令，即可成功获取flag。</p>
<h2 id="Snow-Flake"><a href="#Snow-Flake" class="headerlink" title="Snow Flake"></a>Snow Flake</h2><p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-14.png"><br><strong>漏洞解析</strong> ：<br>这段代码中存在两个安全漏洞。第一个是文件包含漏洞，上图第8行中使用了 <strong>class_exists()</strong> 函数来判断用户传过来的控制器是否存在，默认情况下，如果程序存在 <strong>__autoload</strong> 函数，那么在使用 <strong>class_exists()</strong> 函数就会自动调用本程序中的 <strong>__autoload</strong> 函数，这题的文件包含漏洞就出现在这个地方。攻击者可以使用 <strong>路径穿越</strong> 来包含任意文件，当然使用路径穿越符号的前提是 <strong>PHP5~5.3(包含5.3版本)版本</strong> 之间才可以。例如类名为： <strong>..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</strong> 的查找，将查看passwd文件内容，我们来看一下PHP手册对 <strong>class_exists()</strong> 函数的定义：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.class-exists.php"> class_exists </a> ：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：检查类是否已定义</p>
<p><strong>定义</strong> ： <code>bool class_exists ( string $class_name[, bool $autoload = true ] )</code> </p>
<p><strong>$class_name</strong> 为类的名字，在匹配的时候不区分大小写。默认情况下 <strong>$autoload</strong> 为 <strong>true</strong> ，当 <strong>$autoload</strong> 为 <strong>true</strong> 时，会自动加载本程序中的 <strong>__autoload</strong> 函数；当 <strong>$autoload</strong> 为 <strong>false</strong> 时，则不调用 <strong>__autoload</strong> 函数。</p>
</blockquote>
<p>我们再来说说第二个漏洞。在上图第9行中，我们发现实例化类的类名和传入类的参数均在用户的控制之下。攻击者可以通过该漏洞，调用PHP代码库的任意构造函数。即使代码本身不包含易受攻击的构造函数，我们也可以使用PHP的内置类 <strong>SimpleXMLElement</strong> 来进行 <strong>XXE</strong> 攻击，进而读取目标文件的内容，甚至命令执行（前提是安装了PHP拓展插件expect），我们来看一下PHP手册对 <strong>SimpleXMLElement</strong> 类的定义：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/class.simplexmlelement.php">SimpleXMLElement</a> ：(PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：用来表示XML文档中的元素，为PHP的内置类。</p>
</blockquote>
<p>关于 <strong>SimpleXMLElement</strong> 导致的XXE攻击，下面再给出一个demo案例，方便大家理解：</p>
<p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-15.png"></p>
<h3 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong>Shopware 5.3.3</strong> 版本，对 <strong>SimpleXMLElement</strong> 类导致的 <strong>XXE漏洞</strong> 进行分析，而 <strong>class_exists()</strong> 函数，我们将会在本次给出的CTF题目中深入讨论。我们来看一下本次漏洞的文件，在 <strong>engine\Shopware\Controllers\Backend\ProductStream.php</strong> 文件中有一个 <strong>loadPreviewAction</strong> 方法，其作用是用来预览产品流的详细信息，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-16.png"><br>该方法接收从用户传来的参数 <strong>sort</strong> ，然后传入 <strong>Repository</strong> 类的 <strong>unserialize</strong> 方法（如上图第11-14行代码），我们跟进 <strong>Repository</strong> 类，查看 <strong>unserialize</strong> 方法的实现。该方法我们可以在 <strong>engine\Shopware\Components\ProductStream\Repository.php</strong> 文件中找到，代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-17.png"><br>可以看到 <strong>Repository</strong> 类的 <strong>unserialize</strong> 方法，调用的是 <strong>LogawareReflectionHelper</strong> 类的 <strong>unserialize</strong> 方法（如上图第5行代码），该方法我们可以在 <strong>engine\Shopware\Components\LogawareReflectionHelper.php</strong> 文件中找到，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-18.png"><br>这里的 <strong>$serialized</strong> 就是我们刚刚传入的 <strong>sort</strong> （上图第3行），程序分别从 <strong>sort</strong> 中提取出值赋给 <strong>$className</strong> 和 <strong>$arguments</strong> 变量，然后这两个变量被传入 <strong>ReflectionHelper</strong> 类的 <strong>createInstanceFromNamedArguments</strong> 方法。该方法位于 <strong>engine\Shopware\Components\ReflectionHelper.php</strong> 文件，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-19.png"><br>这里我们关注 <strong>第6行</strong> 代码，这里创建了一个反射类，而类的名称就是从 <strong>$sort</strong> 变量来的，可被用户控制利用。继续往下看，在代码第28行处用 <strong>$newParams</strong> 作为参数，创建一个新的实例对象。而这里的  <strong>$newParams</strong> 是从 <strong>$arguments[$paramName]</strong> 中取值的， <strong>$arguments</strong> 又是我们可以控制的，因为也是从 <strong>$sort</strong> 变量来，所以我们可以通过这里来实例化一个 <strong>SimpleXMLElement</strong> 类对象，形成一个XXE漏洞。下面，我们来看看具体如何利用这个漏洞。</p>
<p><strong>漏洞利用</strong><br>首先，我们需要登录后台，找到调用 <strong>loadPreviewAction</strong> 接口的位置，发现其调用位置如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-20.png"><br>当我们点击 <strong>Refresh preview</strong> 按钮时，就会调用 <strong>loadPreviewAction</strong> 方法，用BurpSuite抓到包如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/shopware520/backend/ProductStream/loadPreview?_dc=1530963660916&amp;sort=&#123;&quot;Shopware\\Bundle\\SearchBundle\\Sorting\\PriceSorting&quot;:&#123;&quot;direction&quot;:&quot;asc&quot;&#125;&#125;&amp;conditions=&#123;&#125;&amp;shopId=1&amp;currencyId=1&amp;customerGroupKey=EK&amp;page=1&amp;start=0&amp;limit=2</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost</span><br><span class="line"><span class="attribute">X-CSRF-Token</span><span class="punctuation">: </span>IKiwilE7pecuIUmEAJigyg6fVXY6vR</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://localhost/shopware520/backend/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>SHOPWAREBACKEND=78ghtddjn8n8efpv1cudj6eao0; KCFINDER_showname=on; KCFINDER_showsize=off; KCFINDER_showtime=off; KCFINDER_order=name; KCFINDER_orderDesc=off; KCFINDER_view=thumbs; KCFINDER_displaySettings=off; goods[cart]=180615151154565652; XDEBUG_SESSION=PHPSTORM</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure>
<p>我们可以看到 <strong>sort</strong> 值为 <code>&#123;&quot;Shopware\\Bundle\\SearchBundle\\Sorting\\PriceSorting&quot;:&#123;&quot;direction&quot;:&quot;asc&quot;&#125;&#125;</code> ,于是我们按照其格式构造payload： <code>&#123;&quot;SimpleXMLElement&quot;:&#123;&quot;data&quot;:&quot;http://localhost/xxe.xml&quot;,&quot;options&quot;:2,&quot;data_is_url&quot;:1,&quot;ns&quot;:&quot;&quot;,&quot;is_prefix&quot;:0&#125;&#125;</code> ，关于payload的含义，可以看看 <strong>SimpleXMLElement</strong> 类的 <strong>__construct</strong> 函数定义，具体点 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/simplexmlelement.construct.php">这里</a> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="title class_">SimpleXMLElement</span>::<span class="variable constant_">__construct</span> ( <span class="keyword">string</span> <span class="variable">$data</span> [, <span class="keyword">int</span> <span class="variable">$options</span> = <span class="number">0</span> [, <span class="keyword">bool</span> <span class="variable">$data_is_url</span> = <span class="literal">FALSE</span> [, <span class="keyword">string</span> <span class="variable">$ns</span> = <span class="string">&quot;&quot;</span> [, <span class="keyword">bool</span> <span class="variable">$is_prefix</span> = <span class="literal">FALSE</span> ]]]] )</span><br></pre></td></tr></table></figure>
<p>笔者所用的xxe.xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;ISO-8859-1&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [ </span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///C:/phpStudy/PHPTutorial/WWW/flag.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们发送payload，并用xdebug调试程序，最后程序将我们读取的值存储在 <strong>$conditions</strong> 变量中，如下图所示：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-21.png"><br>关于PHP中XXE漏洞的修复，我们可以过滤关键词，如： <strong>ENTITY</strong> 、 <strong>SYSTEM</strong> 等，另外，我们还可以通过禁止加载XML实体对象的方式，来防止XXE漏洞（如下图第2行代码），具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-22.png"><br>我感觉上面实例的利用关键点在于，类的初始化和参数的传递都是我们可控的。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>(</span><br><span class="line">	function (<span class="variable">$class</span>)&#123;</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">NotFound</span>();</span><br><span class="line">	&#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">class_exists</span>(<span class="variable">$classname</span>))&#123;</span><br><span class="line">	<span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$newclass</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$newclass</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$key</span>.<span class="string">&#x27;=&gt;&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>定义一个 <code>NotFound</code> 类<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>这个 <code>NotFound</code> 类有一个构造函数，该函数调用了 <code>die(&#39;404&#39;);</code>。这意味着当这个类被实例化时，脚本会立即终止并输出 <code>404</code>。这通常用于表示未找到（如页面或资源）。</li>
</ul>
<ol start="2">
<li>注册一个自动加载函数<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">spl_autoload_register</span>(</span><br><span class="line">	function (<span class="variable">$class</span>)&#123;</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">NotFound</span>();</span><br><span class="line">	&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><code>spl_autoload_register</code> 函数用于注册任意数量的自动加载器，这些加载器在PHP执行过程中试图使用未定义的类或接口时被调用。</li>
<li>这里注册的匿名函数在尝试自动加载一个类时创建一个 <code>NotFound</code> 类的实例，因此无论什么类名被请求，都将输出404并终止执行。</li>
</ul>
<ol start="3">
<li>获取HTTP GET参数<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>这段代码通过GET请求读取 <code>name</code>、<code>param</code> 和 <code>param2</code> 参数，并将它们保存在变量 <code>$classname</code>、<code>$param</code> 和 <code>$param2</code> 中。如果这些GET参数不存在，则相应的变量被设置为 <code>null</code>。</li>
</ul>
<ol start="4">
<li>检查类是否存在并实例化<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">class_exists</span>(<span class="variable">$classname</span>))&#123;</span><br><span class="line">	<span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$newclass</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$newclass</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$key</span>.<span class="string">&#x27;=&gt;&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><code>class_exists($classname)</code> 函数检查一个类是否已定义，这也会触发自动加载机制。</li>
<li>如果类存在，代码将使用动态传入的参数 <code>$param</code> 和 <code>$param2</code> 创建这个类的实例。</li>
<li>使用 <code>var_dump($newclass);</code> 输出新创建对象的详细信息。</li>
<li>使用 <code>foreach</code> 循环遍历对象的公开属性并打印它们。</li>
</ul>
<p>这道题目考察的是实例化漏洞结合XXE漏洞。我们在上图第18行处可以看到使用了 <strong>class_exists</strong> 函数来判断类是否存在，如果不存在的话，就会调用程序中的 <strong>__autoload</strong> 函数，但是这里没有 <strong>__autoload</strong> 函数，而是用 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.spl-autoload-register.php"><strong>spl_autoload_register</strong></a> 注册了一个类似 <strong>__autoload</strong> 作用的函数，即这里输出404信息。</p>
<p>我们这里直接利用PHP的内置类，先用 <strong>GlobIterator</strong> 类搜索 <strong>flag文件</strong> 名字，来看一下PHP手册对 <strong>GlobIterator</strong> 类的 构造函数的定义：</p>
<blockquote>
<p>public <strong>GlobIterator::__construct</strong> ( string <code>$pattern</code> [, int <code>$flags</code> &#x3D; FilesystemIterator::KEY_AS_PATHNAME | FilesystemIterator::CURRENT_AS_FILEINFO ] )</p>
</blockquote>
<p>第一个参数为要搜索的文件名，第二个参数为选择文件的哪个信息作为键名，这里我选择用 <strong>FilesystemIterator::CURRENT_AS_FILEINFO</strong> ，其对应的常量值为0，你可以在 <a target="_blank" rel="noopener" href="http://php.net/manual/en/globiterator.construct.php">这里</a> 找到这些常量的值，所以最终搜索文件的 <strong>payload</strong> 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/CTF/index.php?name=GlobIterator&amp;param=./*.php&amp;param2=0</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-24.png"><br>我们将会发现flag的文件名为 <strong>f1agi3hEre.php</strong> ，接下来我们使用内置类 <strong>SimpleXMLElement</strong> 读取 <strong>f1agi3hEre.php</strong> 文件的内容,，这里我们要结合使用PHP流的使用，因为当文件中存在： <strong>&lt;   &gt;   &amp;   ‘   “</strong> 这5个符号时，会导致XML文件解析错误，所以我们这里利用PHP文件流，将要读取的文件内容经过 <strong>base64编码</strong> 后输出即可，具体payload如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/CTF/index.php?name=SimpleXMLElement&amp;param=&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/var/www/html/CTF/f1agi3hEre.php&quot;</span>&gt;]&gt;&lt;x&gt;%26xxe;&lt;/x&gt;&amp;param2=2</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-23.png"><br>上面payload中的param2&#x3D;2，实际上这里2对应的模式是 <strong>LIBXML_NOENT</strong> ，具体可以参考 <a target="_blank" rel="noopener" href="http://php.net/manual/en/simplexmlelement.construct.php">这里</a> 。</p>
<h2 id="False-Beard"><a href="#False-Beard" class="headerlink" title="False Beard"></a>False Beard</h2><p>题目名字叫假胡子，代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-25.png"><br><strong>题目解析：</strong><br>我们看到 <strong>第11行</strong> 和 <strong>第12行</strong> ，程序通过格式化字符串的方式，使用 <strong>xml</strong> 结构存储用户的登录信息。实际上这样很容易造成数据注入。然后 <strong>第21行</strong> 实例化 <strong>Login</strong> 类，并在 <strong>第16行</strong> 处调用 <strong>login</strong> 方法进行登陆操作。在进行登录操作之前，代码在 <strong>第8行</strong> 和 <strong>第9行</strong> 使用 <strong>strpos</strong> 函数来防止输入的参数含有 <strong>&lt;** 和 **&gt;</strong> 符号，猜测开发者应该是考虑到非法字符注入问题。我们先来看一下 <strong>strpos</strong> 函数的定义：</p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.strpos.php">strpos</a></strong> — 查找字符串首次出现的位置<br>作用：主要是用来查找字符在字符串中首次出现的位置。<br>结构：<code>int strpos ( string $haystack , mixed $needle [, int $offset = 0 ] )</code><br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-26.png"><br>在上面这个例子中，<strong>strpos</strong> 函数返回查找到的子字符串的下标。如果字符串开头就是我们要搜索的目标，则返回下标 <strong>0</strong> ；如果搜索不到，则返回 <strong>false</strong> 。在这道题目中，开发者只考虑到 <strong>strpos</strong> 函数返回 <strong>false</strong> 的情况，却忽略了匹配到的字符在首位时会返回 <strong>0</strong> 的情况，因为 <strong>false</strong> 和 <strong>0</strong> 的取反均为 <strong>true</strong> 。这样我们就可以在用户名和密码首字符注入 <strong>&lt;</strong> 符号，从而注入xml数据。我们尝试使用以下 <strong>payload</strong> ，观察 <strong>strpos</strong> 函数的返回结果。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&lt;<span class="string">&quot;&gt;&lt;injected-tag%20property=&quot;</span>&amp;pass=&lt;injected-tag&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-27.png"></p>
<p>如上图所示，很明显是可以注入xml数据的。</p>
<h3 id="实例分析-2"><a href="#实例分析-2" class="headerlink" title="实例分析"></a>实例分析</h3><p>实际上，本次漏洞是开发者对 <strong>strpos</strong> 函数理解不够，或者说是开发者考虑不周，导致过滤方法可被绕过。由于我们暂时没有在互联网上找到 <strong>strpos</strong> 使用不当导致漏洞的CMS案例，所以这里只能选取一个相似的漏洞进行分析，同样是开发者验证不够周全导致的漏洞。<br>本次案例，我们选取 <strong>DeDecms V5.7SP2正式版</strong> 进行分析，该CMS存在未修复的任意用户密码重置漏洞。漏洞的触发点在 <strong>member&#x2F;resetpassword.php</strong> 文件中，由于对接收的参数 <strong>safeanswer</strong> 没有进行严格的类型判断，导致可以使用弱类型比较绕过。我们来看看相关代码：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-28.png"><br>针对上面的代码做个分析，当 <strong>$dopost</strong> 等于 <strong>safequestion</strong> 的时候，通过传入的 <strong>$mid</strong> 对应的 <strong>id</strong> 值来查询对应用户的安全问题、安全答案、用户id、电子邮件等信息。跟进到 <strong>第11行</strong> ，当我们传入的问题和答案非空，而且等于之前设置的问题和答案，则进入 <strong>sn</strong> 函数。然而这里使用的是 <strong>&#x3D;&#x3D;</strong> 而不是 <strong>&#x3D;&#x3D;&#x3D;</strong> 来判断，所以是可以绕过的。假设用户没有设置安全问题和答案，那么默认情况下安全问题的值为 <strong>0</strong> ，答案的值为 <strong>null</strong> （这里是数据库中的值，即 <strong>$row[‘safequestion’]&#x3D;”0”</strong> 、 <strong>$row[‘safeanswer’]&#x3D;null</strong> ）。当没有设置 <strong>safequestion</strong> 和 <strong>safeanswer</strong> 的值时，它们的值均为空字符串。第11行的if表达式也就变成了 <strong>if(‘0’ &#x3D;&#x3D; ‘’ &amp;&amp; null &#x3D;&#x3D; ‘’)</strong> ，即 <strong>if(false &amp;&amp; true)</strong> ，所以我们只要让表达式 <strong>$row[‘safequestion’] &#x3D;&#x3D; $safequestion</strong> 为 <strong>true</strong> 即可。下图是 <strong>null &#x3D;&#x3D; ‘’</strong> 的判断结果：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-30.png"><br>我们可以利用 <strong>php弱类型</strong> 的特点，来绕过这里 <strong>$row[‘safequestion’] &#x3D;&#x3D; $safequestion</strong> 的判断，如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-31.png"><br>通过测试找到了三个的payload，分别是 <strong>0.0</strong> 、 <strong>0.</strong> 、 <strong>0e1</strong> ，这三种类型payload均能使得 <strong>$row[‘safequestion’] &#x3D;&#x3D; $safequestion</strong>  为 <strong>true</strong> ，即成功进入 <strong>sn</strong> 函数。跟进 <strong>sn</strong> 函数，相关代码在 <strong>member&#x2F;inc&#x2F;inc_pwd_functions.php</strong> 文件中，具体代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-32.png"><br>在 <strong>sn</strong> 函数内部，会根据id到pwd_tmp表中判断是否存在对应的临时密码记录，根据结果确定分支，走向 <strong>newmail</strong> 函数。假设当前我们第一次进行忘记密码操作，那么此时的 <strong>$row</strong> 应该为空，所以进入第一个 <strong>if(!is_array($row))</strong> 分支，在 <strong>newmail</strong> 函数中执行 <strong>INSERT</strong> 操作，相关操作代码位置在 <strong>member&#x2F;inc&#x2F;inc_pwd_functions.php</strong> 文件中，关键代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-33.png"><br>该代码主要功能是发送邮件至相关邮箱，并且插入一条记录至 <strong>dede_pwd_tmp</strong> 表中。而恰好漏洞的触发点就在这里，我们看看 <strong>第13行</strong> 至 <strong>第18行</strong> 的代码，如果 <strong>($send &#x3D;&#x3D; ‘N’)</strong> 这个条件为真，通过 <strong>ShowMsg</strong> 打印出修改密码功能的链接。 <strong>第17行</strong> 修改密码链接中的 <strong>$mid</strong> 参数对应的值是用户id，而 <strong>$randval</strong> 是在第一次 <strong>insert</strong> 操作的时候将其 <strong>md5</strong> 加密之后插入到 <strong>dede_pwd_tmp</strong> 表中，并且在这里已经直接回显给用户。那么这里拼接的url其实是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/member/resetpassword.php?dopost=getpasswd&amp;id=$mid&amp;key=$randval</span><br></pre></td></tr></table></figure>

<p>继续跟进一下 <strong>dopost&#x3D;getpasswd</strong> 的操作，相关代码位置在 <strong>member&#x2F;resetpassword.php</strong> 中，<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-34.png"><br>在重置密码的时候判断输入的用户id是否执行过重置密码，如果id为空则退出；如果 <strong>$row</strong> 不为空，则会执行以下操作内容，相关代码在 <strong>member&#x2F;resetpassword.php</strong> 中。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-36.png"><br>上图代码会先判断是否超时，如果没有超时，则进入密码修改页面。在密码修改页面会将 <strong>$setp</strong> 赋值为2。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-37.png"><br>由于现在的数据包中 <strong>$setp&#x3D;2</strong> ，因此这部分功能代码实现又回到了 <strong>member&#x2F;resetpassword.php</strong> 文件中。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-38.png"><br>上图代码 <strong>第6行</strong> 判断传入的 <strong>$key</strong> 是否等于数据库中的 <strong>$row[‘pwd’]</strong> ，如果相等就完成重置密码操作，至此也就完成了整个攻击的分析过程。</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>我们分别注册 <strong>test1</strong> ， <strong>test2</strong> 两个账号<br>第一步访问 <strong>payload</strong> 中的 <strong>url</strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/dedecms/member/resetpassword.php?dopost=safequestion&amp;safequestion=0.0&amp;safeanswer=&amp;<span class="built_in">id</span>=9</span><br></pre></td></tr></table></figure>
<p>这里 <strong>test2</strong> 的id是9<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-39.png"><br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-40.png"><br>通过抓包获取到 <strong>key</strong> 值。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-41.png"><br>去掉多余的字符访问修改密码链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.240/dedecms/member/resetpassword.php?dopost=getpasswd&amp;id=9&amp;key=OTyEGJtg</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-42.png"><br>最后成功修改密码，我将密码修改成 <strong>123456</strong> ，数据库中 <strong>test2</strong> 的密码字段也变成了 <strong>123456</strong> 加密之后的值。<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-43.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>针对上面 <strong>DeDecms任意用户密码重置</strong> 漏洞，我们只需要使用 <strong>&#x3D;&#x3D;&#x3D;</strong> 来代替 <strong>&#x3D;&#x3D;</strong> 就行了。因为 <strong>&#x3D;&#x3D;&#x3D;</strong> 操作会同时判断左右两边的值和数据类型是否相等，若有一个不等，即返回 <strong>false</strong> 。具体修复代码如下：<br><img src="/2024/10/02/WebSecurity/codeaudit/phpaudit/image-44.png"></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E7%94%A8%E6%88%B7%E5%8F%AF%E6%8E%A7%E8%BE%93%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">PHP 用户可控输入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E6%95%8F%E6%84%9F%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">PHP 敏感函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">3.</span> <span class="toc-text">代码注入&#x2F;文件包含</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-LDAP%E6%B3%A8%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">SQL&#x2F;LDAP注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-SSRF"><span class="toc-number">5.</span> <span class="toc-text">文件读取&#x2F;SSRF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-%E5%86%99%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">文件上传&#x2F;写入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E5%8E%9F%E7%94%9F%E8%BF%87%E6%BB%A4%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">PHP原生过滤方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E9%98%B2%E6%8A%A4"><span class="toc-number">7.1.</span> <span class="toc-text">1. 命令注入防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SQL%E6%B3%A8%E5%85%A5%E9%98%B2%E6%8A%A4"><span class="toc-number">7.2.</span> <span class="toc-text">2. SQL注入防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-XSS%E9%98%B2%E6%8A%A4"><span class="toc-number">7.3.</span> <span class="toc-text">3. XSS防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B%E8%BF%87%E6%BB%A4"><span class="toc-number">7.4.</span> <span class="toc-text">4. 数字类型过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%85%B6%E4%BB%96%E9%98%B2%E6%8A%A4%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">7.5.</span> <span class="toc-text">5. 其他防护配置项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#in-array-%E7%BC%BA%E9%99%B7"><span class="toc-number">8.</span> <span class="toc-text">in_array() 缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">8.1.</span> <span class="toc-text">案例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E9%A2%98%E7%9B%AE"><span class="toc-number">8.2.</span> <span class="toc-text">作业题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Twig-%E8%BF%87%E6%BB%A4%E4%B8%8D%E5%85%85%E5%88%86"><span class="toc-number">9.</span> <span class="toc-text">Twig 过滤不充分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">9.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E9%A2%98%E7%9B%AE-1"><span class="toc-number">9.2.</span> <span class="toc-text">作业题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snow-Flake"><span class="toc-number">10.</span> <span class="toc-text">Snow Flake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">10.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">10.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#False-Beard"><span class="toc-number">11.</span> <span class="toc-text">False Beard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">11.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">11.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">11.3.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&text=【代码审计】PHP代码审计"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&is_video=false&description=【代码审计】PHP代码审计"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计&body=Check out this article: https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&title=【代码审计】PHP代码审计"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&name=【代码审计】PHP代码审计&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/02/WebSecurity/codeaudit/phpaudit/&t=【代码审计】PHP代码审计"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
